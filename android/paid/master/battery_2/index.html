<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/paid/master/battery_2/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>19 | 耗电优化（下）：耗电的优化方法与线上监控</title><link rel=stylesheet href=../../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../../assets/fonts/material-icons.css><link rel=manifest href=../../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - 19 | 耗电优化（下）：耗电的优化方法与线上监控"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/paid/master/battery_2/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - 19 | 耗电优化（下）：耗电的优化方法与线上监控"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#_1 tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../3rd-library/3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../3rd-library/3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2 checked> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </label> <a href=./ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class="md-nav__link md-nav__link--active"> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 耗电优化 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 什么是耗电优化 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 耗电优化的难点 </a> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> 3. 耗电优化的方法 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 耗电监控 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-android-vitals class=md-nav__link> 1. Android Vitals </a> </li> <li class=md-nav__item> <a href=#2_1 class=md-nav__link> 2. 耗电监控都监控什么 </a> </li> <li class=md-nav__item> <a href=#3_1 class=md-nav__link> 3. 如何监控耗电 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#java-hook class=md-nav__link> Java Hook </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 插桩 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 课后作业 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 耗电优化 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 什么是耗电优化 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 耗电优化的难点 </a> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> 3. 耗电优化的方法 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 耗电监控 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-android-vitals class=md-nav__link> 1. Android Vitals </a> </li> <li class=md-nav__item> <a href=#2_1 class=md-nav__link> 2. 耗电监控都监控什么 </a> </li> <li class=md-nav__item> <a href=#3_1 class=md-nav__link> 3. 如何监控耗电 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#java-hook class=md-nav__link> Java Hook </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 插桩 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 课后作业 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>19 | 耗电优化（下）：耗电的优化方法与线上监控</h1> <p>相比启动、卡顿、内存和网络的优化来说，可能大多数应用对耗电优化的关注不是太多。当然并不是我们不想做耗电优化，更多时候是感觉有些无从下手。</p> <p>不同于启动时间、卡顿率，耗电在线上一直缺乏一个可以量化的指标。Android 系统通过计算获得的应用耗电数据只是一个估算值，从 Android 4.4 开始，连这个估算值也无法拿到了。当有用户投诉我们应用耗电的时候，我们一般也无所适从，不知道该如何定位、如何分析。</p> <p>耗电优化究竟需要做哪些工作？我们如何快速定位代码中的不合理调用，并且持续监控应用的耗电情况呢？今天我们就一起来学习耗电的优化方法和线上监控方案。</p> <h2 id=_1>耗电优化<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>在开始讲如何做耗电优化之前，你需要先明确什么是耗电优化，做这件事情的目的究竟是什么。</p> <h3 id=1>1. 什么是耗电优化<a class=headerlink href=#1 title="Permanent link">&para;</a></h3> <p>有些同学可能会疑惑，所谓的耗电优化不就是减少应用的耗电，增加用户的续航时间吗？但是落到实践中，如果我们的应用需要播放视频、需要获取 GPS 信息、需要拍照，这些耗电看起来是无法避免的。</p> <p>如何判断哪些耗电是可以避免，或者是需要去优化的呢？你可以看下面这张图，当用户去看耗电排行榜的时候，发现“王者荣耀”使用了 7 个多小时，这时用户对“王者荣耀”的耗电是有预期的。</p> <p><img alt=battery_2_1 src=/assets/images/android/master/battery_2_1.png></p> <p>假设这个时候发现某个应用他根本没怎么使用（前台时间很少），但是耗电却非常多。这种情况会跟用户的预期差别很大，他可能就会想去投诉。</p> <p><strong>所以耗电优化的第一个方向是优化应用的后台耗电</strong>。知道了系统是如何计算耗电的，那反过来看，我们也就可以知道应用在后台不应该做什么，例如长时间获取 WakeLock、WiFi 和蓝牙的扫描等。为什么说耗电优化第一个方向就是优化应用后台耗电，因为大部分厂商预装项目要求最严格的正是应用后台待机耗电。</p> <p><img alt=battery_2_2 src=/assets/images/android/master/battery_2_2.png></p> <p>当然前台耗电我们不会完全不管，但是标准会放松很多。你再来看看下面这张图，如果系统对你的应用弹出这个对话框，可能对于微信来说，用户还可以忍受，但是对其他大多数的应用来说，可能很多用户就直接把你加入到后台限制的名单中了。</p> <p><img alt=battery_2_2 src=/assets/images/android/master/battery_1_9.png></p> <p><strong>耗电优化的第二个方向是符合系统的规则，让系统认为你耗电是正常的</strong>。而 Android P 是通过 Android Vitals 监控后台耗电，所以我们需要符合 Android Vitals 的规则，目前它的具体规则如下：</p> <p><img alt=battery_2_3 src=/assets/images/android/master/battery_2_3.png></p> <p>虽然上面的标准可能随时会改变，但是可以看到，Android 系统目前比较关心后台 Alarm 唤醒、后台网络、后台 WiFi 扫描以及部分长时间 WakeLock 阻止系统后台休眠。</p> <h3 id=2>2. 耗电优化的难点<a class=headerlink href=#2 title="Permanent link">&para;</a></h3> <p>既然已经明确了耗电优化的目的和方向，那我们就开始动手吧。但我想说的是，只有当你跳进去的时候，才能发现耗电优化这个坑有多深。它主要有下面几个问题：</p> <ul> <li><strong>缺乏现场，无法复现</strong>。用户上传某个截图，你的应用耗电占比 30%。通过电量的详细使用情况，我们可能会有一些猜测。但是用户也无法给出更丰富的信息，以及具体是在什么场景发生的，可以说是毫无头绪。</li> </ul> <p><img alt=battery_2_4 src=/assets/images/android/master/battery_2_4.png></p> <ul> <li><strong>信息不全，难以定位</strong>。如果是开发人员或者厂商可以提供 bug report，利用 Battery Historian 可以得到非常全的耗电统计信息。但是 Battery Historian 缺失了最重要的堆栈信息，代码调用那么复杂，可能还有很多的第三方 SDK，我们根本不知道是哪一行代码申请了 WakeLock、使用了 Sensor、调用了网络等。</li> </ul> <p><img alt=battery_2_5 src=/assets/images/android/master/battery_2_5.png></p> <ul> <li><strong>无法评估结果</strong>。通过猜测，我们可能会尝试一些解决方案。但是从 Android 4.4 开始，我们无法拿到应用的耗电信息。尽管我们解决了某个耗电问题，也很难去评估它是否已经生效，以及对用户产生的价值有多大。</li> </ul> <h3 id=3>3. 耗电优化的方法<a class=headerlink href=#3 title="Permanent link">&para;</a></h3> <p>无法复现、难以定位，也无法评估结果，耗电优化之路实在是不容易。在真正去做优化之前，先来看看我们的应用为什么需要在后台耗电？</p> <p>大部分的开发者不是为了“报复社会”，故意去浪费用户的电量，主要可能有以下一些原因：</p> <ul> <li><strong>某个需求场景</strong>。最普遍的场景就是推送，为了实现推送我们只能做各种各样的保活。在需求面前，用户的价值可能被排到第二位。</li> <li><strong>代码的 Bug</strong>。因为某些逻辑考虑不周，可能导致 GPS 没有关闭、WakeLock 没有释放。</li> </ul> <p>所以相反地，耗电优化的思路也非常简单。</p> <ul> <li> <p><strong>找到需求场景的替代方案</strong>。以推送为例，我们是否可以更多地利用厂商通道，或者定时的拉取最新消息这种模式。如果真是迫不得已，是不是可以使用 foreground service 或者引导用户加入白名单。后台任务的总体指导思想是 <strong>减少、延迟和合并</strong>，可以参考微信一个小伙写的<a href=https://blog.dreamtobe.cn/2016/08/15/android_scheduler_and_battery/ >《Android 后台调度任务与省电》</a>。在后台运行某个任务之前，我们都需要经过下面的思考：<br> <img alt=battery_2_6 src=/assets/images/android/master/battery_2_6.png></p> </li> <li> <p><strong>符合 Android 规则</strong>。首先系统的大部分耗电监控，都是在手机在没有充电的时候。我们可以选择在用户充电时才去做一些耗电的工作，具体方法可查看官方文档<a href="https://developer.android.com/training/monitoring-device-state/battery-monitoring?hl=zh-cn">《监控电池电量和充电状态》</a>。其次是尽早适配最新的 Target API，因为高版本系统后台限制本来就非常严格，应用在后台耗电本身就变得比较困难了。 <div class=codehilite><pre><span></span><span class=n>IntentFilter</span> <span class=n>ifilter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IntentFilter</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>ACTION_BATTERY_CHANGED</span><span class=p>);</span>
<span class=n>Intent</span> <span class=n>batteryStatus</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>registerReceiver</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=n>ifilter</span><span class=p>);</span>

<span class=c1>//获取用户是否在充电的状态或者已经充满电了</span>
<span class=kt>int</span> <span class=n>status</span> <span class=o>=</span> <span class=n>batteryStatus</span><span class=p>.</span><span class=na>getIntExtra</span><span class=p>(</span><span class=n>BatteryManager</span><span class=p>.</span><span class=na>EXTRA_STATUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
<span class=kt>boolean</span> <span class=n>isCharging</span> <span class=o>=</span> <span class=n>status</span> <span class=o>==</span> <span class=n>BatteryManager</span><span class=p>.</span><span class=na>BATTERY_STATUS_CHARGING</span> <span class=o>||</span> <span class=n>status</span> <span class=o>==</span> <span class=n>BatteryManager</span><span class=p>.</span><span class=na>BATTERY_STATUS_FULL</span><span class=p>;</span>
</pre></div></p> </li> <li> <p><strong>异常情况监控</strong>。即使是<a href=https://mp.weixin.qq.com/s/APhUH7MBDUZ6tQv0xDgaWQ>最严格的 Android P</a>，系统也会允许应用部分地使用后台网络、Alarm 以及 JobSheduler 事件（<a href=https://developer.android.google.cn/topic/performance/power/power-details>不同的分组，限制次数不同</a>）。因此出现异常情况的可能性还是存在的，更不用说低版本的系统。对于异常的情况，我们需要类似 Android Vitals 电量监控一样，将规则抽象出来，并且增加上更多辅助我们定位问题的信息。</p> </li> </ul> <h2 id=_2>耗电监控<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>在 I/O 监控中，我指定了重复 I/O、主线程 I/O、Buffer 过大以及 I/O 泄漏这四个规则。对于耗电监控也是如此，我们首先需要抽象出具体的规则，然后收集尽量多的辅助信息，帮助问题的排查。</p> <h3 id=1-android-vitals>1. Android Vitals<a class=headerlink href=#1-android-vitals title="Permanent link">&para;</a></h3> <p>前面已经说过 Android Vitals 的几个关于电量的监控方案与规则，我们先复习一下。</p> <ul> <li><a href=https://developer.android.com/topic/performance/vitals/wakeup>Alarm Manager wakeup 唤醒过多</a></li> <li><a href=https://developer.android.google.cn/topic/performance/vitals/wakelock>频繁使用局部唤醒锁</a></li> <li><a href=https://developer.android.com/topic/performance/vitals/bg-network-usage>后台网络使用量过高</a></li> <li><a href=https://developer.android.com/topic/performance/vitals/bg-wifi>后台 WiFi scans 过多</a></li> </ul> <p>在使用了一段时间之后，我发现它并不是那么好用。以 Alarm wakeup 为例，Vitals 以每小时超过 10 次作为规则。由于这个规则无法做修改，很多时候我们可能希望针对不同的系统版本做更加细致的区分。</p> <p>其次跟 Battery Historian 一样，我们只能拿到 wakeup 的标记的组件，拿不到申请的堆栈，也拿不到当时手机是否在充电、剩余电量等信息。</p> <p><img alt=battery_2_7 src=/assets/images/android/master/battery_2_7.png></p> <p>对于网络、WiFi scans 以及 WakeLock 也是如此。虽然 Vitals 帮助我们缩小了排查的范围，但是依然需要在茫茫的代码中寻找对应的可疑代码。</p> <h3 id=2_1>2. 耗电监控都监控什么<a class=headerlink href=#2_1 title="Permanent link">&para;</a></h3> <p>Android Vitals 并不是那么好用，而且对于国内的应用来说其实也根本无法使用。不管怎样，我们还是需要搭建自己的耗电监控系统。</p> <p>那我们的耗电监控系统应该监控哪些内容，怎么样才能比 Android Vitals 做得更好呢？</p> <ul> <li><strong>监控信息</strong>。简单来说系统关心什么，我们就监控什么，而且应该以 <strong>后台耗电监控为主</strong>。类似 Alarm wakeup、WakeLock、WiFi scans、Network 都是必须的，其他的可以根据应用的实际情况。如果是地图应用，后台获取 GPS 是被允许的；如果是计步器应用，后台获取 Sensor 也没有太大问题。</li> <li><strong>现场信息</strong>。监控系统希望可以获得完整的堆栈信息，比如哪一行代码发起了 WiFi scans、哪一行代码申请了 WakeLock 等。还有当时手机是否在充电、手机的电量水平、应用前台和后台时间、CPU 状态等一些信息也可以帮助我们排查某些问题。</li> <li><strong>提炼规则</strong>。最后我们需要将监控的内容抽象成规则，当然不同应用监控的事项或者参数都不太一样。</li> </ul> <p>由于每个应用的具体情况都不太一样，下面是一些可以用来参考的简单规则。</p> <p><img alt=battery_2_8 src=/assets/images/android/master/battery_2_8.png></p> <p>在安卓绿色联盟的会议中，华为公开过他们后台资源使用的“红线”，你也可以参考里面的一些规则：</p> <p><img alt=battery_2_9 src=/assets/images/android/master/battery_2_9.png></p> <h3 id=3_1>3. 如何监控耗电<a class=headerlink href=#3_1 title="Permanent link">&para;</a></h3> <p>明确了我们需要监控什么以及具体的规则之后，终于可以来到实现这个环节了。跟 I/O 监控、网络监控一样，我首先想到的还是 Hook 方案。</p> <h4 id=java-hook>Java Hook<a class=headerlink href=#java-hook title="Permanent link">&para;</a></h4> <p>Hook 方案的好处在于使用者接入非常简单，不需要去修改自己的代码。下面我以几个比较常用的规则为例，看看如果使用 Java Hook 达到监控的目的。</p> <ul> <li> <p><a href=https://developer.android.com/training/scheduling/wakelock>WakeLock</a>。WakeLock 用来阻止 CPU、屏幕甚至是键盘的休眠。类似 Alarm、JobService 也会申请 WakeLock 来完成后台 CPU 操作。WakeLock 的核心控制代码都在<a href=http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java>PowerManagerService</a>中，实现的方法非常简单。<br> <div class=codehilite><pre><span></span><span class=c1>// 代理PowerManagerService</span>
<span class=n>ProxyHook</span><span class=p>().</span><span class=na>proxyHook</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>POWER_SERVICE</span><span class=p>),</span> <span class=s>&quot;mService&quot;</span><span class=p>,</span> <span class=k>this</span><span class=p>)</span><span class=err>；</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>beforeInvoke</span><span class=p>(</span><span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 申请Wakelock</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;acquireWakeLock&quot;</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isAppBackground</span><span class=p>())</span> <span class=p>{</span>
            <span class=c1>// 应用后台逻辑，获取应用堆栈等等     </span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 应用前台逻辑，获取应用堆栈等等</span>
        <span class=p>}</span>
    <span class=c1>// 释放Wakelock</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;releaseWakeLock&quot;</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// 释放的逻辑    </span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></p> </li> <li> <p><a href=https://developer.android.com/training/scheduling/alarms>Alarm</a>。Alarm 用来做一些定时的重复任务，它一共有四个类型，其中<a href=https://developer.android.com/reference/android/app/AlarmManager.html#ELAPSED_REALTIME_WAKEUP>ELAPSED_REALTIME_WAKEUP</a><a href=https://developer.android.com/reference/android/app/AlarmManager.html#RTC_WAKEUP>和RTC_WAKEUP</a>类型都会唤醒设备。同样，Alarm 的核心控制逻辑都在<a href=http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java>AlarmManagerService</a>中，实现如下：<br> <div class=codehilite><pre><span></span><span class=c1>// 代理AlarmManagerService</span>
<span class=k>new</span> <span class=n>ProxyHook</span><span class=p>().</span><span class=na>proxyHook</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span>
<span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>ALARM_SERVICE</span><span class=p>),</span> <span class=s>&quot;mService&quot;</span><span class=p>,</span> <span class=k>this</span><span class=p>)</span><span class=err>；</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>beforeInvoke</span><span class=p>(</span><span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 设置Alarm</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;set&quot;</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// 不同版本参数类型的适配，获取应用堆栈等等</span>
    <span class=c1>// 清除Alarm</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;remove&quot;</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// 清除的逻辑</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></p> </li> <li> <p>其他。对于后台 CPU，我们可以使用卡顿监控学到的方法。对于后台网络，同样我们可以通过网络监控学到的方法。对于 GPS 监控，我们可以通过 Hook 代理<a href=http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/LocationManagerService.java>LOCATION_SERVICE</a>。对于 Sensor，我们通过 Hook <a href=http://androidxref.com/7.0.0_r1/xref/frameworks/base/core/java/android/hardware/SystemSensorManager.java>SENSOR_SERVICE</a>中的“mSensorListeners”，可以拿到部分信息。</p> </li> </ul> <p><strong>通过 Hook，我们可以在申请资源的时候将堆栈信息保存起来。当我们触发某个规则上报问题的时候，可以将收集到的堆栈信息、电池是否充电、CPU 信息、应用前后台时间等辅助信息也一起带上。</strong></p> <h4 id=_3>插桩<a class=headerlink href=#_3 title="Permanent link">&para;</a></h4> <p>虽然使用 Hook 非常简单，但是某些规则可能不太容易找到合适的 Hook 点。而且在 Android P 之后，很多的 Hook 点都不支持了。</p> <p>出于兼容性考虑，我首先想到的是写一个基础类，然后在统一的调用接口中增加监控逻辑。以 WakeLock 为例：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WakelockMetrics</span> <span class=p>{</span>
    <span class=c1>// Wakelock 申请</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>acquire</span><span class=p>(</span><span class=n>PowerManager</span><span class=p>.</span><span class=na>WakeLock</span> <span class=n>wakelock</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>wakeLock</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
        <span class=c1>// 在这里增加Wakelock 申请监控逻辑</span>
    <span class=p>}</span>
    <span class=c1>// Wakelock 释放</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>release</span><span class=p>(</span><span class=n>PowerManager</span><span class=p>.</span><span class=na>WakeLock</span> <span class=n>wakelock</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>wakelock</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
        <span class=c1>// 在这里增加Wakelock 释放监控逻辑</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>Facebook 也有一个耗电监控的开源库<a href=https://github.com/facebookincubator/Battery-Metrics>Battery-Metrics</a>，它监控的数据非常全，包括 Alarm、WakeLock、Camera、CPU、Network 等，而且也有收集电量充电状态、电量水平等信息。</p> <p>Battery-Metrics 只是提供了一系列的基础类，在实际使用中，接入者可能需要修改大量的源码。但对于一些第三方 SDK 或者后续增加的代码，我们可能就不太能保证可以监控到了。这些场景也就无法监控了，所以 Facebook 内部是使用插桩来动态替换。</p> <p>遗憾的是，Facebook 并没有开源它们内部的插桩具体实现方案。不过这实现起来其实并不困难，事实上在我们前面的 Sample 中，已经使用过 ASM、Aspectj 这两种插桩方案了。后面我也安排单独一期内容来讲不同插桩方案的实现。</p> <p>插桩方案使用起来兼容性非常好，并且使用者也没有太大的接入成本。但是它并不是完美无缺的，对于系统的代码插桩方案是无法替换的，例如 JobService 申请 PARTIAL_WAKE_LOCK 的场景。</p> <h2 id=_4>总结<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>从 Android 系统计算耗电的方法，我们知道了需要关注哪些模块的耗电。从 Android 耗电优化的演进历程，我们知道了 Android 在耗电优化的一些方向以及在意的点。从 Android Vitals 的耗电监控，我们知道了耗电优化的监控方式。</p> <p>但是系统的方法不一定可以完全适合我们的应用，还是需要通过进一步阅读源码、思考，沉淀出一套我们自己的优化实践方案。这也是我的 <strong>性能优化方法论</strong>，在其他的领域也是如此。</p> <h2 id=_5>课后作业<a class=headerlink href=#_5 title="Permanent link">&para;</a></h2> <p>今天的课后练习是，按照文中的思路，使用 Java Hook 实现 Alarm、WakeLock 和 GPS 的耗电监控。具体的规则跟文中表格一致，请将完善后的代码通过 Pull requests 提交到<a href=https://github.com/AndroidAdvanceWithGeektime/Chapter19/ >Chapter19</a>中。</p> <p>练习中都可以通过hook替换上面三个Service中的远程代理Service，然后通过方法名过滤出来对应的操作。下面代码仅仅hook了相应的Service，并打印出了调用堆栈，其他统计信息需要进一步的实现：</p> <div class=superfences-tabs> <input name=__tabs_1 type=radio id=__tab_1_0 checked=checked> <label for=__tab_1_0>AndroidManifest.xml</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=cp>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class=nt>&lt;manifest</span> <span class=na>package=</span><span class=s>&quot;com.sample.battery&quot;</span>
          <span class=na>xmlns:android=</span><span class=s>&quot;http://schemas.android.com/apk/res/android&quot;</span><span class=nt>&gt;</span>

    <span class=c>&lt;!-- 注意权限 --&gt;</span>
<span class=hll>    <span class=nt>&lt;uses-permission</span> <span class=na>android:name=</span><span class=s>&quot;android.permission.WAKE_LOCK&quot;</span> <span class=nt>/&gt;</span>
</span><span class=hll>    <span class=nt>&lt;uses-permission</span> <span class=na>android:name=</span><span class=s>&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span> <span class=nt>/&gt;</span>
</span><span class=hll>    <span class=nt>&lt;uses-permission</span> <span class=na>android:name=</span><span class=s>&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span> <span class=nt>/&gt;</span>
</span>
    <span class=nt>&lt;application</span>
        <span class=na>android:allowBackup=</span><span class=s>&quot;true&quot;</span>
        <span class=na>android:icon=</span><span class=s>&quot;@mipmap/ic_launcher&quot;</span>
        <span class=na>android:label=</span><span class=s>&quot;@string/app_name&quot;</span>
        <span class=na>android:roundIcon=</span><span class=s>&quot;@mipmap/ic_launcher_round&quot;</span>
        <span class=na>android:supportsRtl=</span><span class=s>&quot;true&quot;</span><span class=nt>&gt;</span>
        <span class=nt>&lt;activity</span>
                <span class=na>android:name=</span><span class=s>&quot;com.sample.battery.MainActivity&quot;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;intent-filter&gt;</span>
                <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&quot;android.intent.action.MAIN&quot;</span><span class=nt>/&gt;</span>
                <span class=nt>&lt;category</span> <span class=na>android:name=</span><span class=s>&quot;android.intent.category.LAUNCHER&quot;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;/intent-filter&gt;</span>
        <span class=nt>&lt;/activity&gt;</span>
<span class=hll>        <span class=nt>&lt;receiver</span> <span class=na>android:name=</span><span class=s>&quot;.MainActivity$MyAlarmReceiver&quot;</span><span class=nt>&gt;</span>
</span><span class=hll>            <span class=nt>&lt;intent-filter&gt;</span>
</span><span class=hll>                <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&quot;intent_alarm&quot;</span><span class=nt>/&gt;</span>
</span><span class=hll>            <span class=nt>&lt;/intent-filter&gt;</span>
</span><span class=hll>        <span class=nt>&lt;/receiver&gt;</span>
</span>    <span class=nt>&lt;/application&gt;</span>

<span class=nt>&lt;/manifest&gt;</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_1> <label for=__tab_1_1>MainActivity.java</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm> * 本类都是一些Alarm、WakeLock、Location的使用</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>MainActivity</span> <span class=kd>extends</span> <span class=n>Activity</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Context</span> <span class=n>sContext</span><span class=p>;</span>

    <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span> <span class=n>savedInstanceState</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span>
        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_main</span><span class=p>);</span>
        <span class=n>sContext</span> <span class=o>=</span> <span class=n>getApplicationContext</span><span class=p>();</span>
        <span class=kd>final</span> <span class=n>Button</span> <span class=n>hookAlarm</span> <span class=o>=</span> <span class=p>(</span><span class=n>Button</span><span class=p>)</span> <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>hook_alarm</span><span class=p>);</span>
        <span class=n>hookAlarm</span><span class=p>.</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Hooker</span><span class=p>.</span><span class=na>hookAlarm</span><span class=p>(</span><span class=n>getApplicationContext</span><span class=p>());</span>
            <span class=p>}</span>
        <span class=p>});</span>


        <span class=kd>final</span> <span class=n>Button</span> <span class=n>hookWakelock</span> <span class=o>=</span> <span class=p>(</span><span class=n>Button</span><span class=p>)</span> <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>hook_wakelock</span><span class=p>);</span>
        <span class=n>hookWakelock</span><span class=p>.</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Hooker</span><span class=p>.</span><span class=na>hookWakeLock</span><span class=p>(</span><span class=n>getApplicationContext</span><span class=p>());</span>
            <span class=p>}</span>
        <span class=p>});</span>

        <span class=kd>final</span> <span class=n>Button</span> <span class=n>hookGPS</span> <span class=o>=</span> <span class=p>(</span><span class=n>Button</span><span class=p>)</span> <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>hook_gps</span><span class=p>);</span>
        <span class=n>hookGPS</span><span class=p>.</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Hooker</span><span class=p>.</span><span class=na>hookLocation</span><span class=p>(</span><span class=n>getApplicationContext</span><span class=p>());</span>
            <span class=p>}</span>
        <span class=p>});</span>

        <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>btn_set_alarm</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>setAlarm</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>
        <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>btn_cancel_alarm</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>cancelAlarm</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>

        <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>btn_acquire_wakelock</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>acquireWakeLock</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>
        <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>btn_release_wakelock</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>releaseWakeLock</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>

        <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>btn_request_location</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>requestLocation</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>
        <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>btn_remove_location</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>removeLocation</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>setAlarm</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>AlarmManager</span> <span class=n>alarmService</span> <span class=o>=</span> <span class=p>(</span><span class=n>AlarmManager</span><span class=p>)</span> <span class=n>sContext</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>ALARM_SERVICE</span><span class=p>);</span>
        <span class=n>Intent</span> <span class=n>alarmIntent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=p>(</span><span class=n>sContext</span><span class=p>,</span> <span class=n>MyAlarmReceiver</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>setAction</span><span class=p>(</span><span class=s>&quot;intent_alarm&quot;</span><span class=p>);</span>
        <span class=n>PendingIntent</span> <span class=n>broadcast</span> <span class=o>=</span> <span class=n>PendingIntent</span><span class=p>.</span><span class=na>getBroadcast</span><span class=p>(</span><span class=n>sContext</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>alarmIntent</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span><span class=c1>//通过广播接收</span>
        <span class=n>alarmService</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>AlarmManager</span><span class=p>.</span><span class=na>RTC_WAKEUP</span><span class=p>,</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span> <span class=o>+</span> <span class=mi>2000</span><span class=p>,</span> <span class=n>broadcast</span><span class=p>);</span><span class=c1>//INTERVAL毫秒后触</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>cancelAlarm</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>AlarmManager</span> <span class=n>alarmService</span> <span class=o>=</span> <span class=p>(</span><span class=n>AlarmManager</span><span class=p>)</span> <span class=n>sContext</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>ALARM_SERVICE</span><span class=p>);</span>
        <span class=n>Intent</span> <span class=n>alarmIntent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=p>(</span><span class=n>sContext</span><span class=p>,</span> <span class=n>MyAlarmReceiver</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>setAction</span><span class=p>(</span><span class=s>&quot;intent_alarm&quot;</span><span class=p>);</span>
        <span class=n>PendingIntent</span> <span class=n>broadcast</span> <span class=o>=</span> <span class=n>PendingIntent</span><span class=p>.</span><span class=na>getBroadcast</span><span class=p>(</span><span class=n>sContext</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>alarmIntent</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
        <span class=n>alarmService</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=n>broadcast</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MyAlarmReceiver</span> <span class=kd>extends</span> <span class=n>BroadcastReceiver</span> <span class=p>{</span>
        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onReceive</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;onReceive&quot;</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=n>PowerManager</span><span class=p>.</span><span class=na>WakeLock</span> <span class=n>wakeLock</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>acquireWakeLock</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>PowerManager</span> <span class=n>powerManager</span> <span class=o>=</span> <span class=p>(</span><span class=n>PowerManager</span><span class=p>)</span> <span class=n>sContext</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>POWER_SERVICE</span><span class=p>);</span>
        <span class=n>wakeLock</span> <span class=o>=</span> <span class=n>powerManager</span><span class=p>.</span><span class=na>newWakeLock</span><span class=p>(</span><span class=n>PowerManager</span><span class=p>.</span><span class=na>PARTIAL_WAKE_LOCK</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=c1>//持有唤醒锁</span>
        <span class=n>wakeLock</span><span class=p>.</span><span class=na>setReferenceCounted</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
        <span class=n>wakeLock</span><span class=p>.</span><span class=na>acquire</span><span class=p>(</span><span class=mi>60</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>);</span> <span class=c1>//亮屏60s</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>releaseWakeLock</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>wakeLock</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>wakeLock</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=n>LocationManager</span> <span class=n>locationManager</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>requestLocation</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>ContextCompat</span><span class=p>.</span><span class=na>checkSelfPermission</span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>,</span> <span class=n>ACCESS_FINE_LOCATION</span><span class=p>)</span>
                <span class=o>!=</span> <span class=n>PackageManager</span><span class=p>.</span><span class=na>PERMISSION_GRANTED</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ActivityCompat</span><span class=p>.</span><span class=na>requestPermissions</span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>,</span>
                    <span class=k>new</span> <span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=n>ACCESS_FINE_LOCATION</span><span class=p>},</span> <span class=mi>100</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>locationManager</span> <span class=o>=</span> <span class=p>(</span><span class=n>LocationManager</span><span class=p>)</span> <span class=n>sContext</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>LOCATION_SERVICE</span><span class=p>);</span>
            <span class=n>locationManager</span><span class=p>.</span><span class=na>requestLocationUpdates</span><span class=p>(</span><span class=n>LocationManager</span><span class=p>.</span><span class=na>GPS_PROVIDER</span><span class=p>,</span> <span class=mi>3000</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locationListener</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>removeLocation</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>locationManager</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>locationListener</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 关闭程序时将监听器移除</span>
            <span class=n>locationManager</span><span class=p>.</span><span class=na>removeUpdates</span><span class=p>(</span><span class=n>locationListener</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=n>LocationListener</span> <span class=n>locationListener</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LocationListener</span><span class=p>()</span> <span class=p>{</span>
        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLocationChanged</span><span class=p>(</span><span class=n>Location</span> <span class=n>location</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;onLocationChanged &gt;&gt; &quot;</span> <span class=o>+</span> <span class=n>location</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onStatusChanged</span><span class=p>(</span><span class=n>String</span> <span class=n>provider</span><span class=p>,</span> <span class=kt>int</span> <span class=n>status</span><span class=p>,</span> <span class=n>Bundle</span> <span class=n>extras</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;onStatusChanged &gt;&gt; &quot;</span> <span class=o>+</span> <span class=n>provider</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onProviderEnabled</span><span class=p>(</span><span class=n>String</span> <span class=n>provider</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;onProviderEnabled &gt;&gt; &quot;</span> <span class=o>+</span> <span class=n>provider</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onProviderDisabled</span><span class=p>(</span><span class=n>String</span> <span class=n>provider</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;onProviderDisabled &gt;&gt; &quot;</span> <span class=o>+</span> <span class=n>provider</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>};</span>
<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_2> <label for=__tab_1_2>Hooker.java</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm> * Hook响应的Service，并在对应的方法调用中打印堆栈</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Hooker</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>hookAlarm</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Object</span> <span class=n>alarmManager</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>ALARM_SERVICE</span><span class=p>);</span>
        <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>hookedMethodName</span> <span class=o>=</span> <span class=p>{</span><span class=s>&quot;set&quot;</span><span class=p>,</span> <span class=s>&quot;remove&quot;</span><span class=p>};</span>
        <span class=n>hookInner</span><span class=p>(</span><span class=n>alarmManager</span><span class=p>,</span> <span class=n>hookedMethodName</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>hookWakeLock</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Object</span> <span class=n>powerManager</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>POWER_SERVICE</span><span class=p>);</span>
        <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>hookedMethodName</span> <span class=o>=</span> <span class=p>{</span><span class=s>&quot;acquireWakeLock&quot;</span><span class=p>,</span> <span class=s>&quot;releaseWakeLock&quot;</span><span class=p>};</span>
        <span class=n>hookInner</span><span class=p>(</span><span class=n>powerManager</span><span class=p>,</span> <span class=n>hookedMethodName</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>hookLocation</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Object</span> <span class=n>powerManager</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>LOCATION_SERVICE</span><span class=p>);</span>
        <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>hookedMethodName</span> <span class=o>=</span> <span class=p>{</span><span class=s>&quot;requestLocationUpdates&quot;</span><span class=p>,</span> <span class=s>&quot;removeUpdates&quot;</span><span class=p>};</span>
        <span class=n>hookInner</span><span class=p>(</span><span class=n>powerManager</span><span class=p>,</span> <span class=n>hookedMethodName</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>hookInner</span><span class=p>(</span><span class=n>Object</span> <span class=n>object</span><span class=p>,</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>hookedMethodName</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ProxyHook</span><span class=p>.</span><span class=na>hook</span><span class=p>(</span><span class=n>object</span><span class=p>,</span> <span class=s>&quot;mService&quot;</span><span class=p>,</span> <span class=k>new</span> <span class=n>MethodCalledListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handleMethod</span><span class=p>(</span><span class=n>Object</span> <span class=n>object</span><span class=p>,</span> <span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>isMatch</span><span class=p>(</span><span class=n>hookedMethodName</span><span class=p>,</span> <span class=n>methodName</span><span class=p>))</span> <span class=p>{</span>
                    <span class=n>StackTracePrinter</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>(</span><span class=n>methodName</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>});</span>
    <span class=p>}</span>


    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isMatch</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>methodNameList</span><span class=p>,</span> <span class=n>String</span> <span class=n>method</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>str</span><span class=p>:</span> <span class=n>methodNameList</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>str</span><span class=p>))</span> <span class=p>{</span>
                <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_3> <label for=__tab_1_3>ProxyHook.java</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ProxyHook</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>hook</span><span class=p>(</span><span class=n>Object</span> <span class=n>object</span><span class=p>,</span> <span class=n>String</span> <span class=n>fieldName</span><span class=p>,</span> <span class=n>MethodCalledListener</span> <span class=n>methodCalledListener</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>object</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>Field</span> <span class=n>field</span> <span class=o>=</span> <span class=n>clazz</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=n>fieldName</span><span class=p>);</span>
            <span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
            <span class=kd>final</span> <span class=n>Object</span> <span class=n>oldService</span> <span class=o>=</span> <span class=n>field</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>object</span><span class=p>);</span>
            <span class=n>Object</span> <span class=n>newService</span> <span class=o>=</span> <span class=n>Proxy</span><span class=p>.</span><span class=na>newProxyInstance</span><span class=p>(</span>
                <span class=n>oldService</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getClassLoader</span><span class=p>(),</span>
                <span class=n>oldService</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getInterfaces</span><span class=p>(),</span>
                <span class=k>new</span> <span class=n>SystemInvocationHandler</span><span class=p>(</span><span class=n>oldService</span><span class=p>,</span> <span class=n>methodCalledListener</span><span class=p>)</span>
            <span class=p>);</span>
            <span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>object</span><span class=p>,</span> <span class=n>newService</span><span class=p>);</span>
            <span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;hook success&quot;</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;hook failed &quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_4> <label for=__tab_1_4>SystemInvocationHandler.java</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=kd>class</span> <span class=nc>SystemInvocationHandler</span> <span class=kd>implements</span> <span class=n>InvocationHandler</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=n>Object</span> <span class=n>mOriginObject</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>MethodCalledListener</span> <span class=n>mMethodCalledListener</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>SystemInvocationHandler</span><span class=p>(</span><span class=n>Object</span> <span class=n>originObject</span><span class=p>,</span> <span class=n>MethodCalledListener</span> <span class=n>methodCalledListener</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mOriginObject</span> <span class=o>=</span> <span class=n>originObject</span><span class=p>;</span>
        <span class=n>mMethodCalledListener</span> <span class=o>=</span> <span class=n>methodCalledListener</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=p>(</span><span class=n>Object</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mMethodCalledListener</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>boolean</span> <span class=n>handled</span> <span class=o>=</span> <span class=n>mMethodCalledListener</span><span class=p>.</span><span class=na>handleMethod</span><span class=p>(</span><span class=n>mOriginObject</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>handled</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>mOriginObject</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_5> <label for=__tab_1_5>MethodCalledListener.java</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MethodCalledListener</span> <span class=p>{</span>
    <span class=kt>boolean</span> <span class=nf>handleMethod</span><span class=p>(</span><span class=n>Object</span> <span class=n>object</span><span class=p>,</span> <span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_6> <label for=__tab_1_6>StackTracePrinter.java</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>StackTracePrinter</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>printStackTrace</span><span class=p>(</span><span class=n>String</span> <span class=n>methodName</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=n>stackTraceToString</span><span class=p>(</span><span class=n>methodName</span> <span class=o>+</span> <span class=s>&quot; called\n&quot;</span><span class=p>,</span> <span class=k>new</span> <span class=n>Throwable</span><span class=p>().</span><span class=na>getStackTrace</span><span class=p>()));</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>stackTraceToString</span><span class=p>(</span><span class=n>String</span> <span class=n>methodName</span><span class=p>,</span> <span class=kd>final</span> <span class=n>StackTraceElement</span><span class=o>[]</span> <span class=n>arr</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>arr</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=s>&quot;&quot;</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>StringBuffer</span> <span class=n>sb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuffer</span><span class=p>(</span><span class=n>methodName</span><span class=p>);</span>

        <span class=k>for</span> <span class=p>(</span><span class=n>StackTraceElement</span> <span class=n>stackTraceElement</span> <span class=p>:</span> <span class=n>arr</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>String</span> <span class=n>className</span> <span class=o>=</span> <span class=n>stackTraceElement</span><span class=p>.</span><span class=na>getClassName</span><span class=p>();</span>
            <span class=c1>// remove unused stacks</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>className</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>StackTracePrinter</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getCanonicalName</span><span class=p>()))</span> <span class=p>{</span>
                <span class=k>continue</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>stackTraceElement</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>sb</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></div> </div> <p>最后，做完上面的练习题，最后发现hook系统service真的不难，只不过上面的这些hook在Android高版本中都是灰名单了。</p> <hr> <div class=md-source-date> <small> 最后更新: 2020年8月5日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/paid/master/battery_2/";
      this.page.identifier =
        "/android/paid/master/battery_2/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </span> </div> </a> <a href=../ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> 20 | UI 优化（上）：UI 渲染的几个关键概念 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
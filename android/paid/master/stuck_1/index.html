<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/paid/master/stuck_1/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>05 | 卡顿优化（上）：你要掌握的卡顿分析方法</title><link rel=stylesheet href=../../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../../assets/fonts/material-icons.css><link rel=manifest href=../../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - 05 | 卡顿优化（上）：你要掌握的卡顿分析方法"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/paid/master/stuck_1/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - 05 | 卡顿优化（上）：你要掌握的卡顿分析方法"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#_1 tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../3rd-library/3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../3rd-library/3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2 checked> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </label> <a href=./ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class="md-nav__link md-nav__link--active"> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 基础知识 </a> </li> <li class=md-nav__item> <a href=#android class=md-nav__link> Android 卡顿排查工具 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#traceview class=md-nav__link> TraceView </a> </li> <li class=md-nav__item> <a href=#nanoscope class=md-nav__link> Nanoscope </a> </li> <li class=md-nav__item> <a href=#systrace class=md-nav__link> systrace </a> </li> <li class=md-nav__item> <a href=#simpleperf class=md-nav__link> Simpleperf </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 可视化方法 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-call-chart class=md-nav__link> 1. Call Chart </a> </li> <li class=md-nav__item> <a href=#2-flame-chart class=md-nav__link> 2. Flame Chart </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 课后作业 </a> </li> <li class=md-nav__item> <a href=#demo class=md-nav__link> Demo </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 基础知识 </a> </li> <li class=md-nav__item> <a href=#android class=md-nav__link> Android 卡顿排查工具 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#traceview class=md-nav__link> TraceView </a> </li> <li class=md-nav__item> <a href=#nanoscope class=md-nav__link> Nanoscope </a> </li> <li class=md-nav__item> <a href=#systrace class=md-nav__link> systrace </a> </li> <li class=md-nav__item> <a href=#simpleperf class=md-nav__link> Simpleperf </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 可视化方法 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-call-chart class=md-nav__link> 1. Call Chart </a> </li> <li class=md-nav__item> <a href=#2-flame-chart class=md-nav__link> 2. Flame Chart </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 课后作业 </a> </li> <li class=md-nav__item> <a href=#demo class=md-nav__link> Demo </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>05 | 卡顿优化（上）：你要掌握的卡顿分析方法</h1> <h3 id=_1>基础知识<a class=headerlink href=#_1 title="Permanent link">&para;</a></h3> <p>在具体讲卡顿工具前，你需要了解一些基础知识，它们主要都和 CPU 相关。造成卡顿的原因可能有千百种，不过最终都会反映到 <strong>CPU 时间</strong> 上。我们可以把 CPU 时间分为两种：用户时间和系统时间。用户时间就是执行用户态应用程序代码所消耗的时间；系统时间就是执行内核态系统调用所消耗的时间，包括 I/O、锁、中断以及其他系统调用的时间。</p> <ol> <li> <p>CPU性能<br> 也因此在开发过程中，我们需要根据设备 CPU 性能来“看菜下饭”，例如线程池使用线程数根据 CPU 的核心数，一些高级的 AI 功能只在主频比较高或者带有 NPU 的设备开启。</p> </li> <li> <p>卡顿问题分析指标<br> 出现卡顿问题后，首先我们应该查看 <strong>CPU 的使用率</strong>。怎么查呢？我们可以通过/proc/stat得到整个系统的 CPU 使用情况，通过/proc/[pid]/stat可以得到某个进程的 CPU 使用情况。比较重要的字段有：<br> <div class=codehilite><pre><span></span>proc/self/stat:
    utime:       用户时间，反应用户代码执行的耗时  
    stime:       系统时间，反应系统调用执行的耗时
    majorFaults：需要硬盘拷贝的缺页次数
    minorFaults：无需硬盘拷贝的缺页次数
</pre></div> 关于 stat 文件各个属性的含义和 CPU 使用率的计算，你可以阅读<a href=http://www.samirchen.com/linux-cpu-performance/ >《Linux 环境下进程的 CPU 占用率》</a>和<a href=https://man7.org/linux/man-pages/man5/proc.5.html>Linux 文档</a>。<br> 如果 CPU 使用率长期大于 60% ，表示系统处于繁忙状态，就需要进一步分析用户时间和系统时间的比例。对于普通应用程序，系统时间不会长期高于 30%，如果超过这个值，我们就应该进一步检查是 I/O 过多，还是其他的系统调用问题。 </p> <p>Android 是站在 Linux 巨人的肩膀上，虽然做了不少修改也砍掉了一些工具，但还是保留了很多有用的工具可以协助我们更容易地排查问题，这里我给你介绍几个常用的命令。例如，<strong>top 命令</strong> 可以帮助我们查看哪个进程是 CPU 的消耗大户； <strong>vmstat 命令</strong> 可以实时动态监视操作系统的虚拟内存和 CPU 活动； <strong>strace 命令</strong> 可以跟踪某个进程中所有的系统调用。</p> <p>除了 CPU 的使用率，我们还需要查看 <strong>CPU 饱和度</strong>。CPU 饱和度反映的是线程排队等待 CPU 的情况，也就是 CPU 的负载情况。 </p> <p>CPU 饱和度首先会跟应用的线程数有关，如果启动的线程过多，容易导致系统不断地切换执行的线程，把大量的时间浪费在上下文切换，我们知道每一次 CPU 上下文切换都需要刷新寄存器和计数器，至少需要几十纳秒的时间。 </p> <p>我们可以通过使用vmstat命令或者/proc/[pid]/schedstat文件来查看 CPU 上下文切换次数，这里特别需要注意nr_involuntary_switches被动切换的次数。</p> <div class=codehilite><pre><span></span>proc/self/sched:
    nr_voluntary_switches：     
    主动上下文切换次数，因为线程无法获取所需资源导致上下文切换，最普遍的是IO。    
    nr_involuntary_switches：   
    被动上下文切换次数，线程被系统强制调度导致上下文切换，例如大量线程在抢占CPU。
    se.statistics.iowait_count：IO 等待的次数
    se.statistics.iowait_sum：  IO 等待的时间
</pre></div> <p>此外也可以通过 uptime 命令可以检查 CPU 在 1 分钟、5 分钟和 15 分钟内的平均负载。比如一个 4 核的 CPU，如果当前平均负载是 8，这意味着每个 CPU 上有一个线程在运行，还有一个线程在等待。一般平均负载建议控制在“0.7 × 核数”以内。</p> <div class=codehilite><pre><span></span>00:02:39 up 7 days, 46 min,  0 users,  
load average: 13.91, 14.70, 14.32
</pre></div> <p>另外一个会影响 CPU 饱和度的是线程优先级，线程优先级会影响 Android 系统的调度策略，它主要由 nice 和 cgroup 类型共同决定。nice 值越低，抢占 CPU 时间片的能力越强。当 CPU 空闲时，线程的优先级对执行效率的影响并不会特别明显，但在 CPU 繁忙的时候，线程调度会对执行效率有非常大的影响。<br> <img alt src=/assets/images/android/master/android_master_stuck_1.png> </p> <p>关于线程优先级，你需要注意 <strong>是否存在高优先级的线程空等低优先级线程，例如主线程等待某个后台线程的锁</strong>。从应用程序的角度来看，无论是用户时间、系统时间，还是等待 CPU 的调度，都是程序运行花费的时间。</p> </li> </ol> <h3 id=android>Android 卡顿排查工具<a class=headerlink href=#android title="Permanent link">&para;</a></h3> <p>可能你会觉得按照上面各种 Linux 命令组合来排查问题太麻烦了，有没有更简单的、图形化的操作界面呢？Traceview 和 systrace 都是我们比较熟悉的排查卡顿的工具，从实现上这些工具分为两个流派。<br> 第一个流派是 instrument。获取一段时间内所有函数的调用过程，可以通过分析这段时间内的函数调用流程，再进一步分析待优化的点。<br> 第二个流派是 sample。有选择性或者采用抽样的方式观察某些函数调用过程，可以通过这些有限的信息推测出流程中的可疑点，然后再继续细化分析。</p> <p>这两种流派有什么差异？我们在什么场景应该选择哪种合适的工具呢？还有没有其他有用的工具可以使用呢？下面我们一一来看。</p> <h4 id=traceview>TraceView<a class=headerlink href=#traceview title="Permanent link">&para;</a></h4> <p>Traceview利用 Android Runtime 函数调用的 event 事件，将函数运行的耗时和调用关系写入 trace 文件中。</p> <p>由此可见，Traceview 属于 instrument 类型，它可以用来查看整个过程有哪些函数调用，但是工具本身带来的性能开销过大，有时无法反映真实的情况。比如一个函数本身的耗时是 1 秒，开启 Traceview 后可能会变成 5 秒，而且这些函数的耗时变化并不是成比例放大。</p> <p>在 Android 5.0 之后，新增了startMethodTracingSampling方法，可以使用基于样本的方式进行分析，以减少分析对运行时的性能影响。新增了 sample 类型后，就需要我们在开销和信息丰富度之间做好权衡。</p> <h4 id=nanoscope>Nanoscope<a class=headerlink href=#nanoscope title="Permanent link">&para;</a></h4> <p>那在 instrument 类型的性能分析工具里，有没有性能损耗比较小的呢？</p> <p>答案是有的，Uber 开源的<a href=https://github.com/uber/nanoscope>Nanoscope</a>就能达到这个效果。它的实现原理是直接修改 Android 虚拟机源码，在ArtMethod执行入口和执行结束位置增加埋点代码，将所有的信息先写到内存，等到 trace 结束后才统一生成结果文件。</p> <p>在使用过程可以明显感觉到应用不会因为开启 Nanoscope 而感到卡顿，但是 trace 结束生成结果文件这一步需要的时间比较长。<strong>另一方面它可以支持分析任意一个应用，可用于做竞品分析。</strong></p> <p>但是它也有不少限制：</p> <ul> <li>需要自己刷 ROM，并且当前只支持 Nexus 6P，或者采用其提供的 x86 架构的模拟器。</li> <li>默认只支持主线程采集，其他线程需要<a href=https://github.com/uber/nanoscope/wiki/Architecture%3A-Nanoscope-ROM#java-api>代码手动设置</a>。考虑到内存大小的限制，每个线程的内存数组只能支持大约 20 秒左右的时间段。</li> </ul> <p>Uber 写了一系列自动化脚本协助整个流程，使用起来还算简单。Nanoscope 作为基本没有性能损耗的 instrument 工具，它非常适合做启动耗时的自动化分析。 Nanoscope 生成的是符合 Chrome tracing 规范的 HTML 文件。我们可以通过脚本来实现两个功能：</p> <ol> <li>第一个是反混淆。通过 mapping 自动反混淆结果文件。</li> <li>第二个是自动化分析。传入相同的起点和终点，实现两个结果文件的 diff，自动分析差异点。</li> </ol> <p>这样我们可以每天定期去跑自动化启动测试，查看是否存在新增的耗时点。<strong>我们有时候为了实现更多定制化功能或者拿到更加丰富的信息，这个时候不得不使用定制 ROM 的方式。而 Nanoscope 恰恰是一个很好的工具，可以让我们更方便地实现定制 ROM，在后面启动和 I/O 优化里我还会提到更多类似的案例。</strong></p> <h4 id=systrace>systrace<a class=headerlink href=#systrace title="Permanent link">&para;</a></h4> <p><a href="https://source.android.com/devices/tech/debug/systrace?hl=zh-cn">systrace</a>是 Android 4.1 新增的性能分析工具。我通常使用 systrace 跟踪系统的 I/O 操作、CPU 负载、Surface 渲染、GC 等事件。</p> <p>systrace 利用了 Linux 的<a href=https://source.android.com/devices/tech/debug/ftrace>ftrace</a>调试工具，相当于在系统各个关键位置都添加了一些性能探针，也就是在代码里加了一些性能监控的埋点。Android 在 ftrace 的基础上封装了<a href=https://android.googlesource.com/platform/frameworks/native/+/master/cmds/atrace/atrace.cpp>atrace</a>，并增加了更多特有的探针，例如 Graphics、Activity Manager、Dalvik VM、System Server 等。</p> <p>systrace 工具只能监控特定系统调用的耗时情况，所以它是属于 sample 类型，而且性能开销非常低。但是它不支持应用程序代码的耗时分析，所以在使用时有一些局限性。</p> <p>由于系统预留了<code>Trace.beginSection</code>接口来监听应用程序的调用耗时，那我们有没有办法在 systrace 上面自动增加应用程序的耗时分析呢？<br> 划重点了，我们可以通过 <strong>编译时给每个函数插桩</strong> 的方式来实现，也就是在重要函数的入口和出口分别增加<code>Trace.beginSection</code>和<code>Trace.endSection</code>。当然出于性能的考虑，我们会过滤大部分指令数比较少的函数，这样就实现了在 systrace 基础上增加应用程序耗时的监控。通过这样方式的好处有：</p> <ul> <li>可以看到整个流程系统和应用程序的调用流程。包括系统关键线程的函数调用，例如渲染耗时、线程锁，GC 耗时等。</li> <li>性能损耗可以接受。由于过滤了大部分的短函数，而且没有放大 I/O，所以整个运行耗时不到原来的两倍，基本可以反映真实情况。</li> </ul> <p>systrace 生成的也是 HTML 格式的结果，我们利用跟 Nanoscope 相似方式实现对反混淆的支持。<br> <img alt=systrace src=/assets/images/android/master/systrace.jpg></p> <h4 id=simpleperf>Simpleperf<a class=headerlink href=#simpleperf title="Permanent link">&para;</a></h4> <p>那如果我们想分析 Native 函数的调用，上面的三个工具都不能满足这个需求。</p> <p>Android 5.0 新增了<a href=https://android.googlesource.com/platform/system/extras/+/master/simpleperf/doc/README.md>Simpleperf</a>性能分析工具，它利用 CPU 的性能监控单元（PMU）提供的硬件 perf 事件。使用 Simpleperf 可以看到所有的 Native 代码的耗时，有时候一些 Android 系统库的调用对分析问题有比较大的帮助，例如加载 dex、verify class 的耗时等。</p> <p>Simpleperf 同时封装了 systrace 的监控功能，通过 Android 几个版本的优化，现在 Simpleperf 比较友好地支持 Java 代码的性能分析。具体来说分几个阶段：</p> <p>第一个阶段：在 Android M 和以前，Simpleperf 不支持 Java 代码分析。<br> 第二个阶段：在 Android O 和以前，需要手动指定编译 OAT 文件。 <br> 第三个阶段：在 Android P 和以后，无需做任何事情，Simpleperf 就可以支持 Java 代码分析。</p> <p>从这个过程可以看到 Google 还是比较看重这个功能，在 Android Studio 3.2 也在 Profiler 中直接支持 Simpleperf。 </p> <p>顾名思义，从名字就能看出 Simpleperf 是属于 sample 类型，它的性能开销非常低，使用火焰图展示分析结果。火焰图示例如下：<br> <img alt=flame_graph src=/assets/images/android/master/flame_graph.jpg></p> <p>目前除了 Nanoscope 之外的三个工具都只支持 debugable 的应用程序，如果想测试 release 包，需要将测试机器 root。对于这个限制，我们在实践中会专门打出 debugable 的测试包，然后自己实现针对 mapping 的反混淆功能。<strong>其中 Simpleperf 的反混淆比较难实现，因为在函数聚合后会抛弃参数，无法直接对生成的 HTML 文件做处理</strong>。当然我们也可以根据各个工具的实现思路，自己重新打造一套支持非 debugable 的自动化测试工具。</p> <p><strong>选择哪种工具，需要看具体的场景。我来汇总一下，如果需要分析 Native 代码的耗时，可以选择 Simpleperf；如果想分析系统调用，可以选择 systrace；如果想分析整个程序执行流程的耗时，可以选择 Traceview 或者插桩版本的 systrace。</strong></p> <h3 id=_2>可视化方法<a class=headerlink href=#_2 title="Permanent link">&para;</a></h3> <p>随着 Android 版本的演进，Google 不仅提供了更多的性能分析工具，而且也在慢慢优化现有工具的体验，使功能更强大、使用门槛更低。而 Android Studio 则肩负另外一个重任，那就是让开发者使用起来更加简单的，图形界面也更加直观。</p> <p>在 Android Studio 3.2 的 Profiler 中直接集成了几种性能分析工具，其中：</p> <ul> <li>Sample Java Methods 的功能类似于 Traceview 的 sample 类型。</li> <li>Trace Java Methods 的功能类似于 Traceview 的 instrument 类型。</li> <li>Trace System Calls 的功能类似于 systrace。</li> <li>SampleNative (API Level 26+) 的功能类似于 Simpleperf。</li> </ul> <p>坦白来说，Profiler 界面在某些方面不如这些工具自带的界面，支持配置的参数也不如命令行，不过 Profiler 的确大大降低了开发者的使用门槛。<br> 另外一个比较大的变化是分析结果的展示方式，这些分析工具都支持了 Call Chart 和 Flame Chart 两种展示方式。下面我来讲讲这两种展示方式适合的场景。</p> <h4 id=1-call-chart>1. Call Chart<a class=headerlink href=#1-call-chart title="Permanent link">&para;</a></h4> <p>Call Chart 是 Traceview 和 systrace 默认使用的展示方式。它按照应用程序的函数执行顺序来展示，适合用于分析整个流程的调用。举一个最简单的例子，A 函数调用 B 函数，B 函数调用 C 函数，循环三次，就得到了下面的 Call Chart。</p> <p><img alt=call_chart src=/assets/images/android/master/call_chart.jpg></p> <p>Call Chart 就像给应用程序做一个心电图，我们可以看到在这一段时间内，各个线程的具体工作，比如是否存在线程间的锁、主线程是否存在长时间的 I/O 操作、是否存在空闲等。</p> <h4 id=2-flame-chart>2. Flame Chart<a class=headerlink href=#2-flame-chart title="Permanent link">&para;</a></h4> <p>Flame Chart 也就是大名鼎鼎的<a href=http://www.brendangregg.com/flamegraphs.html>火焰图</a>。它跟 Call Chart 不同的是，Flame Chart 以一个全局的视野来看待一段时间的调用分布，它就像给应用程序拍 X 光片，可以很自然地把时间和空间两个维度上的信息融合在一张图上。上面函数调用的例子，换成火焰图的展示结果如下。</p> <p><img alt=flame_chart_demo src=/assets/images/android/master/flame_chart_demo.jpg></p> <p>当我们不想知道应用程序的整个调用流程，只想直观看出哪些代码路径花费的 CPU 时间较多时，火焰图就是一个非常好的选择。例如，之前我的一个反序列化实现非常耗时，通过火焰图发现耗时最多的是大量 Java 字符串的创建和拷贝，通过将核心实现转为 Native，最终使性能提升了很多倍。</p> <p>火焰图还可以使用在各种各样的维度，例如内存、I/O 的分析。有些内存可能非常缓慢地泄漏，通过一个内存的火焰图，我们就知道哪些路径申请的内存最多，有了火焰图我们根本不需要分析源代码，也不需要分析整个流程。</p> <p>最后我想说，每个工具都可以生成不同的展示方式，我们需要根据不同的使用场景选择合适的方式。</p> <h3 id=_3>课后作业<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>当发生 ANR 的时候，Android 系统会打印 CPU 相关的信息到日志中，使用的是<a href=http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/os/ProcessCpuTracker.java>ProcessCpuTracker.java</a>。但是这样好像并没有权限可以拿到其他应用进程的 CPU 信息，那能不能换一个思路？</p> <p>当发现应用的某个进程 CPU 使用率比较高的时候，可以通过下面几个文件检查该进程下各个线程的 CPU 使用率，继而统计出该进程各个线程的时间占比。</p> <div class=codehilite><pre><span></span>/proc/[pid]/stat             // 进程CPU使用情况
/proc/[pid]/task/[tid]/stat  // 进程下面各个线程的CPU使用情况
/proc/[pid]/sched            // 进程CPU调度相关
/proc/loadavg                // 系统平均负载，uptime命令对应文件
</pre></div> <p>如果线程销毁了，它的 CPU 运行信息也会被删除，所以我们一般只会计算某一段时间内 CPU 使用率。下面是计算 5 秒间隔内一个 Sample 进程的 CPU 使用示例。<strong>有的时候可能找不到耗时的线程，有可能是有大量生命周期很短的线程，这个时候可以把时间间隔缩短来看看</strong>。</p> <div class=codehilite><pre><span></span>usage: CPU usage 5000ms(from 23:23:33.000 to 23:23:38.000):
System TOTAL: 2.1% user + 16% kernel + 9.2% iowait + 0.2% irq + 0.1% softirq + 72% idle
CPU Core: 8
Load Average: 8.74 / 7.74 / 7.36

Process:com.sample.app 
  50% 23468/com.sample.app(S): 11% user + 38% kernel faults:4965

Threads:
  43% 23493/singleThread(R): 6.5% user + 36% kernel faults：3094
  3.2% 23485/RenderThread(S): 2.1% user + 1% kernel faults：329
  0.3% 23468/.sample.app(S): 0.3% user + 0% kernel faults：6
  0.3% 23479/HeapTaskDaemon(S): 0.3% user + 0% kernel faults：982
  ...
</pre></div> <details class=answer open=open><summary>Answer</summary><p>8核cpu，平均负载8，idle时间去到72%，说明应用运行中系统CPU性能有很大的盈余。<br> sample应用时间分布大头在kernel。再看线程，线程状态R表示正在运行，S表示TASK_INTERRUPTIBLE，在等待某件事情发生（多数是IO）。SingleThread是主要耗时线程，并且共发生了3094次缺页异常(faults字段)。缺页异常的处理是在内核空间，也解释了kernel 耗时大头的原因，而这里做的操作就是读写磁盘。猜测可能是很多小文件的读写。<br> 综合分析瓶颈应该是sample将io集中在一个线程中处理，系统的全部cpu没有利用上，一核忙死，其他3核闲死。</p> </details> <h3 id=demo>Demo<a class=headerlink href=#demo title="Permanent link">&para;</a></h3> <p><a href=https://github.com/AndroidAdvanceWithGeektime/Chapter05>Sample Github</a></p> <p>基本就是仿照<a href=http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/os/ProcessCpuTracker.java>ProcessCpuTracker.java</a>的实现，读取的API换成了IO流实现。</p> <details class=notice open=open><summary>Notice</summary><p>在Android 8.0及以上，部分权限收紧，导致<code>/proc/stat</code>以及<code>/proc/loadavg</code>无法读取到。<br> 使用<code>Runtime.getRuntime().exec()</code>直接cat对应文件也不行。可能是手法错误？不过loadavg可以通过Runtime执行<code>uptime</code>得到。</p> </details> <div class=superfences-tabs> <input name=__tabs_1 type=radio id=__tab_1_0 checked=checked> <label for=__tab_1_0>MainActivity</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MainActivity</span> <span class=kd>extends</span> <span class=n>Activity</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Context</span> <span class=n>sContext</span><span class=p>;</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>ProcessCpuTracker</span> <span class=n>processCpuTracker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ProcessCpuTracker</span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Process</span><span class=p>.</span><span class=na>myPid</span><span class=p>());</span>

    <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span> <span class=n>savedInstanceState</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span>
        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_main</span><span class=p>);</span>
        <span class=n>sContext</span> <span class=o>=</span> <span class=n>getApplicationContext</span><span class=p>();</span>
        <span class=kd>final</span> <span class=n>Button</span> <span class=n>testGc</span> <span class=o>=</span> <span class=p>(</span><span class=n>Button</span><span class=p>)</span> <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>test_gc</span><span class=p>);</span>
        <span class=n>testGc</span><span class=p>.</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>update</span><span class=p>();</span>
                <span class=n>testGc</span><span class=p>();</span>
                <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>update</span><span class=p>();</span>
                <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;ProcessCpuTracker&quot;</span><span class=p>,</span>
                        <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>printCurrentState</span><span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()));</span>
            <span class=p>}</span>
        <span class=p>});</span>


        <span class=kd>final</span> <span class=n>Button</span> <span class=n>testIO</span> <span class=o>=</span> <span class=p>(</span><span class=n>Button</span><span class=p>)</span> <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>test_io</span><span class=p>);</span>
        <span class=n>testIO</span><span class=p>.</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>update</span><span class=p>();</span>

                <span class=n>testIO</span><span class=p>();</span>
                <span class=n>handler</span><span class=p>.</span><span class=na>postDelayed</span><span class=p>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
                    <span class=nd>@Override</span>
                    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
                        <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>update</span><span class=p>();</span>
                        <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;ProcessCpuTracker&quot;</span><span class=p>,</span>
                                <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>printCurrentState</span><span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()));</span>
                    <span class=p>}</span>
                <span class=p>},</span> <span class=mi>5000</span><span class=p>);</span>


            <span class=p>}</span>
        <span class=p>});</span>

        <span class=kd>final</span> <span class=n>Button</span> <span class=n>processOut</span> <span class=o>=</span> <span class=p>(</span><span class=n>Button</span><span class=p>)</span> <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>test_process</span><span class=p>);</span>
        <span class=n>processOut</span><span class=p>.</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>update</span><span class=p>();</span>
                <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;ProcessCpuTracker&quot;</span><span class=p>,</span>
                        <span class=n>processCpuTracker</span><span class=p>.</span><span class=na>printCurrentState</span><span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()));</span>

            <span class=p>}</span>
        <span class=p>});</span>

        <span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>test_uptime</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span> <span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>execUpTime</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>

    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>testIO</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
                <span class=n>writeSth</span><span class=p>();</span>

                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=mi>100000</span><span class=p>);</span>
                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>});</span>
        <span class=n>thread</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&quot;SingleThread&quot;</span><span class=p>);</span>
        <span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
    <span class=p>}</span>


    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>testGc</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span><span class=o>[]</span> <span class=n>test</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>int</span><span class=o>[</span><span class=mi>100000</span><span class=o>]</span><span class=p>;</span>
            <span class=n>System</span><span class=p>.</span><span class=na>gc</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>execUpTime</span><span class=p>()</span> <span class=p>{</span>
       <span class=n>ShellExecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=s>&quot;uptime&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>writeSth</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>File</span> <span class=n>f</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>getFilesDir</span><span class=p>(),</span> <span class=s>&quot;aee.txt&quot;</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span> <span class=p>{</span>
                <span class=n>f</span><span class=p>.</span><span class=na>delete</span><span class=p>();</span>
            <span class=p>}</span>
            <span class=n>FileOutputStream</span> <span class=n>fos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileOutputStream</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>

            <span class=kt>byte</span><span class=o>[]</span> <span class=n>data</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=mi>1024</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>*</span> <span class=mi>3000</span><span class=o>]</span><span class=p>;</span>

            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>30</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Arrays</span><span class=p>.</span><span class=na>fill</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=n>i</span><span class=p>);</span>
                <span class=n>fos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
                <span class=n>fos</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span>
            <span class=p>}</span>
            <span class=n>fos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>

        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>FileNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_1> <label for=__tab_1_1>ProcessCpuTracker</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm> * 有bug, 之前没有现在有，而且更新的时候也有问题</span>
<span class=cm> * 之前有，现在没有，当0处理</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ProcessCpuTracker</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&quot;ProcessCpuTracker&quot;</span><span class=p>;</span>

    <span class=c1>// /proc/self/stat</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PROCESS_STATS_STATUS</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PROCESS_STATS_MINOR_FAULTS</span> <span class=o>=</span> <span class=mi>9</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PROCESS_STATS_MAJOR_FAULTS</span> <span class=o>=</span> <span class=mi>11</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PROCESS_STATS_UTIME</span> <span class=o>=</span> <span class=mi>13</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PROCESS_STATS_STIME</span> <span class=o>=</span> <span class=mi>14</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>

    <span class=c1>// /proc/</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NR_VOLUNTARY_SWITCHES</span> <span class=o>=</span> <span class=s>&quot;nr_voluntary_switches&quot;</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NR_INVOLUNTARY_SWITCHES</span> <span class=o>=</span> <span class=s>&quot;nr_involuntary_switches&quot;</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>SE_IOWAIT_COUNT</span> <span class=o>=</span> <span class=s>&quot;se.statistics.iowait_count&quot;</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>SE_IOWAIT_SUM</span> <span class=o>=</span> <span class=s>&quot;se.statistics.iowait_sum&quot;</span><span class=p>;</span>

    <span class=c1>// /proc/stat</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYSTEM_STATS_USER_TIME</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYSTEM_STATS_NICE_TIME</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYSTEM_STATS_SYS_TIME</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYSTEM_STATS_IDLE_TIME</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYSTEM_STATS_IOWAIT_TIME</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYSTEM_STATS_IRQ_TIME</span> <span class=o>=</span> <span class=mi>7</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SYSTEM_STATS_SOFT_IRQ_TIME</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>

    <span class=c1>// /proc/loadavg</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>LOAD_AVERAGE_1_MIN</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>LOAD_AVERAGE_5_MIN</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>LOAD_AVERAGE_15_MIN</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>

    <span class=c1>// How long a CPU jiffy is in milliseconds.</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>float</span> <span class=n>mLoad1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>float</span> <span class=n>mLoad5</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>float</span> <span class=n>mLoad15</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=c1>// All times are in milliseconds. They are converted from jiffies to milliseconds</span>
    <span class=c1>// when extracted from the kernel.</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mCurrentSampleTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mLastSampleTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mCurrentSampleRealTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mLastSampleRealTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mCurrentSampleWallTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mLastSampleWallTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mBaseUserTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mBaseSystemTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mBaseIoWaitTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mBaseIrqTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mBaseSoftIrqTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mBaseIdleTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mRelUserTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mRelSystemTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mRelIoWaitTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mRelIrqTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mRelSoftIrqTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mRelIdleTime</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>mRelStatsAreGood</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>mBuffer</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=mi>4096</span><span class=o>]</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>DEBUG</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>Stats</span> <span class=n>mCurrentProcStat</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mCurrentProcID</span><span class=p>;</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Stats</span> <span class=p>{</span>
        <span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>pid</span><span class=p>;</span>
        <span class=kd>final</span> <span class=n>String</span> <span class=n>statFile</span><span class=p>;</span>
        <span class=kd>final</span> <span class=n>String</span> <span class=n>cmdlineFile</span><span class=p>;</span>
        <span class=kd>final</span> <span class=n>String</span> <span class=n>threadsDir</span><span class=p>;</span>
        <span class=kd>final</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Stats</span><span class=o>&gt;</span> <span class=n>workingThreads</span><span class=p>;</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=n>baseName</span><span class=p>;</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=n>name</span><span class=p>;</span>
        <span class=cm>/**</span>
<span class=cm>         * Time in milliseconds.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=n>base_uptime</span><span class=p>;</span>
        <span class=cm>/**</span>
<span class=cm>         * Time in milliseconds.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=n>rel_uptime</span><span class=p>;</span>
        <span class=cm>/**</span>
<span class=cm>         * Time in milliseconds.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=n>base_utime</span><span class=p>;</span>
        <span class=cm>/**</span>
<span class=cm>         * Time in milliseconds.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=n>base_stime</span><span class=p>;</span>
        <span class=cm>/**</span>
<span class=cm>         * Time in milliseconds.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=kt>int</span> <span class=n>rel_utime</span><span class=p>;</span>
        <span class=cm>/**</span>
<span class=cm>         * Time in milliseconds.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=kt>int</span> <span class=n>rel_stime</span><span class=p>;</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=n>base_minfaults</span><span class=p>;</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=n>base_majfaults</span><span class=p>;</span>
        <span class=kd>public</span> <span class=kt>int</span> <span class=n>rel_minfaults</span><span class=p>;</span>
        <span class=kd>public</span> <span class=kt>int</span> <span class=n>rel_majfaults</span><span class=p>;</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=n>status</span><span class=p>;</span>

        <span class=n>Stats</span><span class=p>(</span><span class=kt>int</span> <span class=n>_pid</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isThread</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pid</span> <span class=o>=</span> <span class=n>_pid</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>isThread</span><span class=p>)</span> <span class=p>{</span>
                <span class=kd>final</span> <span class=n>File</span> <span class=n>procDir</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=s>&quot;/proc/self/task&quot;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>pid</span><span class=p>));</span>
                <span class=n>workingThreads</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
                <span class=n>statFile</span> <span class=o>=</span> <span class=n>procDir</span> <span class=o>+</span> <span class=s>&quot;/stat&quot;</span><span class=p>;</span>
                <span class=n>cmdlineFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>procDir</span><span class=p>,</span> <span class=s>&quot;comm&quot;</span><span class=p>).</span><span class=na>toString</span><span class=p>();</span>
                <span class=n>threadsDir</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=kd>final</span> <span class=n>File</span> <span class=n>procDir</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=s>&quot;/proc&quot;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>pid</span><span class=p>));</span>
                <span class=n>statFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>procDir</span><span class=p>,</span> <span class=s>&quot;stat&quot;</span><span class=p>).</span><span class=na>toString</span><span class=p>();</span>
                <span class=n>cmdlineFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>procDir</span><span class=p>,</span> <span class=s>&quot;cmdline&quot;</span><span class=p>).</span><span class=na>toString</span><span class=p>();</span>
                <span class=n>threadsDir</span> <span class=o>=</span> <span class=p>(</span><span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>procDir</span><span class=p>,</span> <span class=s>&quot;task&quot;</span><span class=p>)).</span><span class=na>toString</span><span class=p>();</span>
                <span class=n>workingThreads</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Stats</span><span class=o>&gt;</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>


    <span class=kd>public</span> <span class=nf>ProcessCpuTracker</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>long</span> <span class=n>jiffyHz</span> <span class=o>=</span> <span class=n>Sysconf</span><span class=p>.</span><span class=na>getScClkTck</span><span class=p>();</span>
        <span class=n>mJiffyMillis</span> <span class=o>=</span> <span class=mi>1000</span> <span class=o>/</span> <span class=n>jiffyHz</span><span class=p>;</span>
        <span class=n>mCurrentProcID</span> <span class=o>=</span> <span class=n>id</span><span class=p>;</span>
        <span class=n>mCurrentProcStat</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Stats</span><span class=p>(</span><span class=n>mCurrentProcID</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>

    <span class=p>}</span>

    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>update</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Update: &quot;</span> <span class=o>+</span> <span class=k>this</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>nowUptime</span> <span class=o>=</span> <span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>nowRealtime</span> <span class=o>=</span> <span class=n>SystemClock</span><span class=p>.</span><span class=na>elapsedRealtime</span><span class=p>();</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>nowWallTime</span> <span class=o>=</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span>
        <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>sysCpu</span> <span class=o>=</span> <span class=n>readProcFile</span><span class=p>(</span><span class=s>&quot;/proc/stat&quot;</span><span class=p>);</span>

        <span class=c1>//for (int i = 0; i &lt; sysCpu.length; i++) {</span>
        <span class=c1>//    android.util.Log.e(TAG,&quot;i:&quot; + i + &quot;, sys:&quot; + sysCpu[i]);</span>
        <span class=c1>//}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>sysCpu</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Total user time is user + nice time.</span>
            <span class=kd>final</span> <span class=kt>long</span> <span class=n>usertime</span> <span class=o>=</span> <span class=p>(</span><span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>sysCpu</span><span class=o>[</span><span class=n>SYSTEM_STATS_USER_TIME</span><span class=o>]</span><span class=p>)</span>
                    <span class=o>+</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>sysCpu</span><span class=o>[</span><span class=n>SYSTEM_STATS_NICE_TIME</span><span class=o>]</span><span class=p>))</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
            <span class=c1>// Total system time is simply system time.</span>
            <span class=kd>final</span> <span class=kt>long</span> <span class=n>systemtime</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>sysCpu</span><span class=o>[</span><span class=n>SYSTEM_STATS_SYS_TIME</span><span class=o>]</span><span class=p>)</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
            <span class=c1>// Total idle time is simply idle time.</span>
            <span class=kd>final</span> <span class=kt>long</span> <span class=n>idletime</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>sysCpu</span><span class=o>[</span><span class=n>SYSTEM_STATS_IDLE_TIME</span><span class=o>]</span><span class=p>)</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
            <span class=c1>// Total irq time is iowait + irq + softirq time.</span>
            <span class=kd>final</span> <span class=kt>long</span> <span class=n>iowaittime</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>sysCpu</span><span class=o>[</span><span class=n>SYSTEM_STATS_IOWAIT_TIME</span><span class=o>]</span><span class=p>)</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
            <span class=kd>final</span> <span class=kt>long</span> <span class=n>irqtime</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>sysCpu</span><span class=o>[</span><span class=n>SYSTEM_STATS_IRQ_TIME</span><span class=o>]</span><span class=p>)</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
            <span class=kd>final</span> <span class=kt>long</span> <span class=n>softirqtime</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>sysCpu</span><span class=o>[</span><span class=n>SYSTEM_STATS_SOFT_IRQ_TIME</span><span class=o>]</span><span class=p>)</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
            <span class=c1>// This code is trying to avoid issues with idle time going backwards,</span>
            <span class=c1>// but currently it gets into situations where it triggers most of the time. :(</span>

            <span class=n>mRelUserTime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>usertime</span> <span class=o>-</span> <span class=n>mBaseUserTime</span><span class=p>);</span>
            <span class=n>mRelSystemTime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>systemtime</span> <span class=o>-</span> <span class=n>mBaseSystemTime</span><span class=p>);</span>
            <span class=n>mRelIoWaitTime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>iowaittime</span> <span class=o>-</span> <span class=n>mBaseIoWaitTime</span><span class=p>);</span>
            <span class=n>mRelIrqTime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>irqtime</span> <span class=o>-</span> <span class=n>mBaseIrqTime</span><span class=p>);</span>
            <span class=n>mRelSoftIrqTime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>softirqtime</span> <span class=o>-</span> <span class=n>mBaseSoftIrqTime</span><span class=p>);</span>
            <span class=n>mRelIdleTime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>idletime</span> <span class=o>-</span> <span class=n>mBaseIdleTime</span><span class=p>);</span>
            <span class=n>mRelStatsAreGood</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Total U:&quot;</span> <span class=o>+</span> <span class=p>(</span><span class=n>usertime</span><span class=p>)</span>
                        <span class=o>+</span> <span class=s>&quot; S:&quot;</span> <span class=o>+</span> <span class=p>(</span><span class=n>systemtime</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot; I:&quot;</span> <span class=o>+</span> <span class=p>(</span><span class=n>idletime</span><span class=p>)</span>
                        <span class=o>+</span> <span class=s>&quot; W:&quot;</span> <span class=o>+</span> <span class=p>(</span><span class=n>iowaittime</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot; Q:&quot;</span> <span class=o>+</span> <span class=p>(</span><span class=n>irqtime</span><span class=p>)</span>
                        <span class=o>+</span> <span class=s>&quot; O:&quot;</span> <span class=o>+</span> <span class=p>(</span><span class=n>softirqtime</span><span class=p>));</span>
                <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Rel U:&quot;</span> <span class=o>+</span> <span class=n>mRelUserTime</span> <span class=o>+</span> <span class=s>&quot; S:&quot;</span> <span class=o>+</span> <span class=n>mRelSystemTime</span>
                        <span class=o>+</span> <span class=s>&quot; I:&quot;</span> <span class=o>+</span> <span class=n>mRelIdleTime</span> <span class=o>+</span> <span class=s>&quot; Q:&quot;</span> <span class=o>+</span> <span class=n>mRelIrqTime</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>mBaseUserTime</span> <span class=o>=</span> <span class=n>usertime</span><span class=p>;</span>
            <span class=n>mBaseSystemTime</span> <span class=o>=</span> <span class=n>systemtime</span><span class=p>;</span>
            <span class=n>mBaseIoWaitTime</span> <span class=o>=</span> <span class=n>iowaittime</span><span class=p>;</span>
            <span class=n>mBaseIrqTime</span> <span class=o>=</span> <span class=n>irqtime</span><span class=p>;</span>
            <span class=n>mBaseSoftIrqTime</span> <span class=o>=</span> <span class=n>softirqtime</span><span class=p>;</span>
            <span class=n>mBaseIdleTime</span> <span class=o>=</span> <span class=n>idletime</span><span class=p>;</span>

        <span class=p>}</span>
        <span class=n>mLastSampleTime</span> <span class=o>=</span> <span class=n>mCurrentSampleTime</span><span class=p>;</span>
        <span class=n>mCurrentSampleTime</span> <span class=o>=</span> <span class=n>nowUptime</span><span class=p>;</span>
        <span class=n>mLastSampleRealTime</span> <span class=o>=</span> <span class=n>mCurrentSampleRealTime</span><span class=p>;</span>
        <span class=n>mCurrentSampleRealTime</span> <span class=o>=</span> <span class=n>nowRealtime</span><span class=p>;</span>
        <span class=n>mLastSampleWallTime</span> <span class=o>=</span> <span class=n>mCurrentSampleWallTime</span><span class=p>;</span>
        <span class=n>mCurrentSampleWallTime</span> <span class=o>=</span> <span class=n>nowWallTime</span><span class=p>;</span>

        <span class=n>getName</span><span class=p>(</span><span class=n>mCurrentProcStat</span><span class=p>,</span> <span class=n>mCurrentProcStat</span><span class=p>.</span><span class=na>cmdlineFile</span><span class=p>);</span>
        <span class=n>collectProcsStats</span><span class=p>(</span><span class=s>&quot;/proc/self/stat&quot;</span><span class=p>,</span> <span class=n>mCurrentProcStat</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mCurrentProcStat</span><span class=p>.</span><span class=na>workingThreads</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>File</span><span class=o>[]</span> <span class=n>threadsProcFiles</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>mCurrentProcStat</span><span class=p>.</span><span class=na>threadsDir</span><span class=p>).</span><span class=na>listFiles</span><span class=p>();</span>
            <span class=k>for</span> <span class=p>(</span><span class=n>File</span> <span class=n>thread</span> <span class=p>:</span> <span class=n>threadsProcFiles</span><span class=p>)</span> <span class=p>{</span>
                <span class=kt>int</span> <span class=n>threadID</span> <span class=o>=</span> <span class=n>Integer</span><span class=p>.</span><span class=na>parseInt</span><span class=p>(</span><span class=n>thread</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span>
                <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&quot;xxxxx&quot;</span><span class=p>,</span> <span class=s>&quot;threadId:&quot;</span> <span class=o>+</span> <span class=n>threadID</span><span class=p>);</span>
                <span class=n>Stats</span> <span class=n>threadStat</span> <span class=o>=</span> <span class=n>findThreadStat</span><span class=p>(</span><span class=n>threadID</span><span class=p>,</span> <span class=n>mCurrentProcStat</span><span class=p>.</span><span class=na>workingThreads</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>threadStat</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>threadStat</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Stats</span><span class=p>(</span><span class=n>threadID</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>

                    <span class=n>getName</span><span class=p>(</span><span class=n>threadStat</span><span class=p>,</span> <span class=n>threadStat</span><span class=p>.</span><span class=na>cmdlineFile</span><span class=p>);</span>
                    <span class=n>mCurrentProcStat</span><span class=p>.</span><span class=na>workingThreads</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>threadStat</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=n>collectProcsStats</span><span class=p>(</span><span class=n>threadStat</span><span class=p>.</span><span class=na>statFile</span><span class=p>,</span> <span class=n>threadStat</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>Collections</span><span class=p>.</span><span class=na>sort</span><span class=p>(</span><span class=n>mCurrentProcStat</span><span class=p>.</span><span class=na>workingThreads</span><span class=p>,</span> <span class=n>sLoadComparator</span><span class=p>);</span>
        <span class=p>}</span>


        <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>loadAverages</span> <span class=o>=</span> <span class=n>readProcFile</span><span class=p>(</span><span class=s>&quot;/proc/loadavg&quot;</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>loadAverages</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>float</span> <span class=n>load1</span> <span class=o>=</span> <span class=n>Float</span><span class=p>.</span><span class=na>parseFloat</span><span class=p>(</span><span class=n>loadAverages</span><span class=o>[</span><span class=n>LOAD_AVERAGE_1_MIN</span><span class=o>]</span><span class=p>);</span>
            <span class=kt>float</span> <span class=n>load5</span> <span class=o>=</span> <span class=n>Float</span><span class=p>.</span><span class=na>parseFloat</span><span class=p>(</span><span class=n>loadAverages</span><span class=o>[</span><span class=n>LOAD_AVERAGE_5_MIN</span><span class=o>]</span><span class=p>);</span>
            <span class=kt>float</span> <span class=n>load15</span> <span class=o>=</span> <span class=n>Float</span><span class=p>.</span><span class=na>parseFloat</span><span class=p>(</span><span class=n>loadAverages</span><span class=o>[</span><span class=n>LOAD_AVERAGE_15_MIN</span><span class=o>]</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>load1</span> <span class=o>!=</span> <span class=n>mLoad1</span> <span class=o>||</span> <span class=n>load5</span> <span class=o>!=</span> <span class=n>mLoad5</span> <span class=o>||</span> <span class=n>load15</span> <span class=o>!=</span> <span class=n>mLoad15</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>mLoad1</span> <span class=o>=</span> <span class=n>load1</span><span class=p>;</span>
                <span class=n>mLoad5</span> <span class=o>=</span> <span class=n>load5</span><span class=p>;</span>
                <span class=n>mLoad15</span> <span class=o>=</span> <span class=n>load15</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;*** TIME TO COLLECT STATS: &quot;</span>
                    <span class=o>+</span> <span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()</span> <span class=o>-</span> <span class=n>mCurrentSampleTime</span><span class=p>));</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nd>@Nullable</span>
    <span class=kd>private</span> <span class=n>Stats</span> <span class=nf>findThreadStat</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>,</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Stats</span><span class=o>&gt;</span> <span class=n>stats</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Stats</span> <span class=n>stat</span> <span class=p>:</span> <span class=n>stats</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>stat</span><span class=p>.</span><span class=na>pid</span> <span class=o>==</span> <span class=n>id</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=n>stat</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>collectProcsStats</span><span class=p>(</span><span class=n>String</span> <span class=n>procFile</span><span class=p>,</span> <span class=n>Stats</span> <span class=n>st</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>String</span><span class=o>[]</span> <span class=n>procStats</span> <span class=o>=</span> <span class=n>readProcFile</span><span class=p>(</span><span class=n>procFile</span><span class=p>);</span>
        <span class=c1>//for (int i = 0; i &lt; procStats.length; i++) {</span>
        <span class=c1>//    android.util.Log.e(TAG,&quot;i:&quot; + i + &quot;, sys:&quot; + procStats[i]);</span>
        <span class=c1>//}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>procStats</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=kd>final</span> <span class=n>String</span> <span class=n>status</span> <span class=o>=</span> <span class=n>procStats</span><span class=o>[</span><span class=n>PROCESS_STATS_STATUS</span><span class=o>]</span><span class=p>;</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>minfaults</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>procStats</span><span class=o>[</span><span class=n>PROCESS_STATS_MINOR_FAULTS</span><span class=o>]</span><span class=p>);</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>majfaults</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>procStats</span><span class=o>[</span><span class=n>PROCESS_STATS_MAJOR_FAULTS</span><span class=o>]</span><span class=p>);</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>utime</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>procStats</span><span class=o>[</span><span class=n>PROCESS_STATS_UTIME</span><span class=o>]</span><span class=p>)</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>stime</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>procStats</span><span class=o>[</span><span class=n>PROCESS_STATS_STIME</span><span class=o>]</span><span class=p>)</span> <span class=o>*</span> <span class=n>mJiffyMillis</span><span class=p>;</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Stats changed &quot;</span> <span class=o>+</span> <span class=n>st</span><span class=p>.</span><span class=na>name</span> <span class=o>+</span> <span class=s>&quot; status:&quot;</span> <span class=o>+</span> <span class=n>status</span> <span class=o>+</span> <span class=s>&quot; pid=&quot;</span> <span class=o>+</span> <span class=n>st</span><span class=p>.</span><span class=na>pid</span>
                    <span class=o>+</span> <span class=s>&quot; utime=&quot;</span> <span class=o>+</span> <span class=n>utime</span> <span class=o>+</span> <span class=s>&quot;-&quot;</span> <span class=o>+</span> <span class=n>st</span><span class=p>.</span><span class=na>base_utime</span>
                    <span class=o>+</span> <span class=s>&quot; stime=&quot;</span> <span class=o>+</span> <span class=n>stime</span> <span class=o>+</span> <span class=s>&quot;-&quot;</span> <span class=o>+</span> <span class=n>st</span><span class=p>.</span><span class=na>base_stime</span>
                    <span class=o>+</span> <span class=s>&quot; minfaults=&quot;</span> <span class=o>+</span> <span class=n>minfaults</span> <span class=o>+</span> <span class=s>&quot;-&quot;</span> <span class=o>+</span> <span class=n>st</span><span class=p>.</span><span class=na>base_minfaults</span>
                    <span class=o>+</span> <span class=s>&quot; majfaults=&quot;</span> <span class=o>+</span> <span class=n>majfaults</span> <span class=o>+</span> <span class=s>&quot;-&quot;</span> <span class=o>+</span> <span class=n>st</span><span class=p>.</span><span class=na>base_majfaults</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=kd>final</span> <span class=kt>long</span> <span class=n>uptime</span> <span class=o>=</span> <span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span>

        <span class=n>st</span><span class=p>.</span><span class=na>rel_uptime</span> <span class=o>=</span> <span class=n>uptime</span> <span class=o>-</span> <span class=n>st</span><span class=p>.</span><span class=na>base_uptime</span><span class=p>;</span>
        <span class=n>st</span><span class=p>.</span><span class=na>base_uptime</span> <span class=o>=</span> <span class=n>uptime</span><span class=p>;</span>
        <span class=n>st</span><span class=p>.</span><span class=na>rel_utime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>utime</span> <span class=o>-</span> <span class=n>st</span><span class=p>.</span><span class=na>base_utime</span><span class=p>);</span>
        <span class=n>st</span><span class=p>.</span><span class=na>rel_stime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>stime</span> <span class=o>-</span> <span class=n>st</span><span class=p>.</span><span class=na>base_stime</span><span class=p>);</span>
        <span class=n>st</span><span class=p>.</span><span class=na>base_utime</span> <span class=o>=</span> <span class=n>utime</span><span class=p>;</span>
        <span class=n>st</span><span class=p>.</span><span class=na>base_stime</span> <span class=o>=</span> <span class=n>stime</span><span class=p>;</span>
        <span class=n>st</span><span class=p>.</span><span class=na>rel_minfaults</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>minfaults</span> <span class=o>-</span> <span class=n>st</span><span class=p>.</span><span class=na>base_minfaults</span><span class=p>);</span>
        <span class=n>st</span><span class=p>.</span><span class=na>rel_majfaults</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>majfaults</span> <span class=o>-</span> <span class=n>st</span><span class=p>.</span><span class=na>base_majfaults</span><span class=p>);</span>
        <span class=n>st</span><span class=p>.</span><span class=na>base_minfaults</span> <span class=o>=</span> <span class=n>minfaults</span><span class=p>;</span>
        <span class=n>st</span><span class=p>.</span><span class=na>base_majfaults</span> <span class=o>=</span> <span class=n>majfaults</span><span class=p>;</span>
        <span class=n>st</span><span class=p>.</span><span class=na>status</span> <span class=o>=</span> <span class=n>status</span><span class=p>;</span>
    <span class=p>}</span>


    <span class=kd>private</span> <span class=kd>final</span> <span class=kd>static</span> <span class=n>Comparator</span><span class=o>&lt;</span><span class=n>Stats</span><span class=o>&gt;</span> <span class=n>sLoadComparator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Comparator</span><span class=o>&lt;</span><span class=n>Stats</span><span class=o>&gt;</span><span class=p>()</span> <span class=p>{</span>
        <span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span>
        <span class=nf>compare</span><span class=p>(</span><span class=n>Stats</span> <span class=n>sta</span><span class=p>,</span> <span class=n>Stats</span> <span class=n>stb</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>ta</span> <span class=o>=</span> <span class=n>sta</span><span class=p>.</span><span class=na>rel_utime</span> <span class=o>+</span> <span class=n>sta</span><span class=p>.</span><span class=na>rel_stime</span><span class=p>;</span>
            <span class=kt>int</span> <span class=n>tb</span> <span class=o>=</span> <span class=n>stb</span><span class=p>.</span><span class=na>rel_utime</span> <span class=o>+</span> <span class=n>stb</span><span class=p>.</span><span class=na>rel_stime</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>ta</span> <span class=o>!=</span> <span class=n>tb</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=n>ta</span> <span class=o>&gt;</span> <span class=n>tb</span> <span class=o>?</span> <span class=o>-</span><span class=mi>1</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>};</span>

    <span class=cm>/**</span>
<span class=cm>     * @return time in milliseconds.</span>
<span class=cm>     */</span>
    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getLastUserTime</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>mRelUserTime</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * @return time in milliseconds.</span>
<span class=cm>     */</span>
    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getLastSystemTime</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>mRelSystemTime</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * @return time in milliseconds.</span>
<span class=cm>     */</span>
    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getLastIoWaitTime</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>mRelIoWaitTime</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * @return time in milliseconds.</span>
<span class=cm>     */</span>
    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getLastIrqTime</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>mRelIrqTime</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * @return time in milliseconds.</span>
<span class=cm>     */</span>
    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getLastSoftIrqTime</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>mRelSoftIrqTime</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * @return time in milliseconds.</span>
<span class=cm>     */</span>
    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getLastIdleTime</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>mRelIdleTime</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>hasGoodLastStats</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>mRelStatsAreGood</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>final</span> <span class=kd>public</span> <span class=kt>float</span> <span class=nf>getTotalCpuPercent</span><span class=p>()</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>denom</span> <span class=o>=</span> <span class=n>mRelUserTime</span> <span class=o>+</span> <span class=n>mRelSystemTime</span> <span class=o>+</span> <span class=n>mRelIrqTime</span> <span class=o>+</span> <span class=n>mRelIdleTime</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>denom</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=p>((</span><span class=kt>float</span><span class=p>)</span> <span class=p>(</span><span class=n>mRelUserTime</span> <span class=o>+</span> <span class=n>mRelSystemTime</span> <span class=o>+</span> <span class=n>mRelIrqTime</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span> <span class=o>/</span> <span class=n>denom</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>final</span> <span class=kd>private</span> <span class=n>String</span> <span class=nf>printCurrentLoad</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>StringWriter</span> <span class=n>sw</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringWriter</span><span class=p>();</span>
        <span class=n>PrintWriter</span> <span class=n>pw</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrintWriter</span><span class=p>(</span><span class=n>sw</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;Load: &quot;</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>mLoad1</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; / &quot;</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>mLoad5</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; / &quot;</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>mLoad15</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span>
        <span class=k>return</span> <span class=n>sw</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;SimpleDateFormat&quot;</span><span class=p>)</span>
    <span class=kd>final</span> <span class=kd>public</span> <span class=n>String</span> <span class=nf>printCurrentState</span><span class=p>(</span><span class=kt>long</span> <span class=n>now</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=n>SimpleDateFormat</span> <span class=n>sdf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span><span class=p>);</span>
        <span class=n>StringWriter</span> <span class=n>sw</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringWriter</span><span class=p>();</span>
        <span class=n>PrintWriter</span> <span class=n>pw</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrintWriter</span><span class=p>(</span><span class=n>sw</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;&quot;</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;CPU usage from &quot;</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>now</span> <span class=o>&gt;</span> <span class=n>mLastSampleTime</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>now</span> <span class=o>-</span> <span class=n>mLastSampleTime</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;ms to &quot;</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>now</span> <span class=o>-</span> <span class=n>mCurrentSampleTime</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;ms ago&quot;</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>mLastSampleTime</span> <span class=o>-</span> <span class=n>now</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;ms to &quot;</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>mCurrentSampleTime</span> <span class=o>-</span> <span class=n>now</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;ms later&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; (&quot;</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>sdf</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=k>new</span> <span class=n>Date</span><span class=p>(</span><span class=n>mLastSampleWallTime</span><span class=p>)));</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; to &quot;</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>sdf</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=k>new</span> <span class=n>Date</span><span class=p>(</span><span class=n>mCurrentSampleWallTime</span><span class=p>)));</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;)&quot;</span><span class=p>);</span>
        <span class=kt>long</span> <span class=n>sampleTime</span> <span class=o>=</span> <span class=n>mCurrentSampleTime</span> <span class=o>-</span> <span class=n>mLastSampleTime</span><span class=p>;</span>
        <span class=kt>long</span> <span class=n>sampleRealTime</span> <span class=o>=</span> <span class=n>mCurrentSampleRealTime</span> <span class=o>-</span> <span class=n>mLastSampleRealTime</span><span class=p>;</span>
        <span class=kt>long</span> <span class=n>percAwake</span> <span class=o>=</span> <span class=n>sampleRealTime</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=p>((</span><span class=n>sampleTime</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span> <span class=o>/</span> <span class=n>sampleRealTime</span><span class=p>)</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>percAwake</span> <span class=o>!=</span> <span class=mi>100</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; with &quot;</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>percAwake</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% awake&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;:&quot;</span><span class=p>);</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>totalTime</span> <span class=o>=</span> <span class=n>mRelUserTime</span> <span class=o>+</span> <span class=n>mRelSystemTime</span> <span class=o>+</span> <span class=n>mRelIoWaitTime</span>
                <span class=o>+</span> <span class=n>mRelIrqTime</span> <span class=o>+</span> <span class=n>mRelSoftIrqTime</span> <span class=o>+</span> <span class=n>mRelIdleTime</span><span class=p>;</span>

        <span class=n>Stats</span> <span class=n>st</span> <span class=o>=</span> <span class=n>mCurrentProcStat</span><span class=p>;</span>
        <span class=n>printProcessCPU</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span>
                <span class=n>st</span><span class=p>.</span><span class=na>pid</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=na>name</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=na>status</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>st</span><span class=p>.</span><span class=na>rel_uptime</span><span class=p>,</span>
                <span class=n>st</span><span class=p>.</span><span class=na>rel_utime</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=na>rel_stime</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=na>rel_minfaults</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=na>rel_majfaults</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=na>workingThreads</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;thread stats:&quot;</span><span class=p>);</span>
            <span class=kt>int</span> <span class=n>M</span> <span class=o>=</span> <span class=n>st</span><span class=p>.</span><span class=na>workingThreads</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>M</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Stats</span> <span class=n>tst</span> <span class=o>=</span> <span class=n>st</span><span class=p>.</span><span class=na>workingThreads</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>);</span>
                <span class=n>printProcessCPU</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span>
                        <span class=n>tst</span><span class=p>.</span><span class=na>pid</span><span class=p>,</span> <span class=n>tst</span><span class=p>.</span><span class=na>name</span><span class=p>,</span> <span class=n>tst</span><span class=p>.</span><span class=na>status</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>st</span><span class=p>.</span><span class=na>rel_uptime</span><span class=p>,</span>
                        <span class=n>tst</span><span class=p>.</span><span class=na>rel_utime</span><span class=p>,</span> <span class=n>tst</span><span class=p>.</span><span class=na>rel_stime</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>tst</span><span class=p>.</span><span class=na>rel_minfaults</span><span class=p>,</span> <span class=n>tst</span><span class=p>.</span><span class=na>rel_majfaults</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=n>printProcessCPU</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=s>&quot;TOTAL&quot;</span><span class=p>,</span> <span class=s>&quot;&quot;</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>,</span> <span class=n>mRelUserTime</span><span class=p>,</span> <span class=n>mRelSystemTime</span><span class=p>,</span>
                <span class=n>mRelIoWaitTime</span><span class=p>,</span> <span class=n>mRelIrqTime</span><span class=p>,</span> <span class=n>mRelSoftIrqTime</span><span class=p>,</span> <span class=n>mRelIdleTime</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>printCurrentLoad</span><span class=p>());</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;totalTime &quot;</span> <span class=o>+</span> <span class=n>totalTime</span> <span class=o>+</span> <span class=s>&quot; over sample time &quot;</span>
                    <span class=o>+</span> <span class=p>(</span><span class=n>mCurrentSampleTime</span> <span class=o>-</span> <span class=n>mLastSampleTime</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot;, real uptime:&quot;</span> <span class=o>+</span> <span class=n>st</span><span class=p>.</span><span class=na>rel_uptime</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span>
        <span class=k>return</span> <span class=n>sw</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>printRatio</span><span class=p>(</span><span class=n>PrintWriter</span> <span class=n>pw</span><span class=p>,</span> <span class=kt>long</span> <span class=n>numerator</span><span class=p>,</span> <span class=kt>long</span> <span class=n>denominator</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>long</span> <span class=n>thousands</span> <span class=o>=</span> <span class=p>(</span><span class=n>numerator</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>/</span> <span class=n>denominator</span><span class=p>;</span>
        <span class=kt>long</span> <span class=n>hundreds</span> <span class=o>=</span> <span class=n>thousands</span> <span class=o>/</span> <span class=mi>10</span><span class=p>;</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>hundreds</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>hundreds</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>long</span> <span class=n>remainder</span> <span class=o>=</span> <span class=n>thousands</span> <span class=o>-</span> <span class=p>(</span><span class=n>hundreds</span> <span class=o>*</span> <span class=mi>10</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>remainder</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=sc>&#39;.&#39;</span><span class=p>);</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>remainder</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>printProcessCPU</span><span class=p>(</span><span class=n>PrintWriter</span> <span class=n>pw</span><span class=p>,</span> <span class=kt>int</span> <span class=n>pid</span><span class=p>,</span> <span class=n>String</span> <span class=n>label</span><span class=p>,</span> <span class=n>String</span> <span class=n>status</span><span class=p>,</span>
                                 <span class=kt>int</span> <span class=n>totalTime</span><span class=p>,</span> <span class=kt>int</span> <span class=n>user</span><span class=p>,</span> <span class=kt>int</span> <span class=n>system</span><span class=p>,</span> <span class=kt>int</span> <span class=n>iowait</span><span class=p>,</span> <span class=kt>int</span> <span class=n>irq</span><span class=p>,</span> <span class=kt>int</span> <span class=n>softIrq</span><span class=p>,</span> <span class=kt>int</span> <span class=n>idle</span><span class=p>,</span>
                                 <span class=kt>int</span> <span class=n>minFaults</span><span class=p>,</span> <span class=kt>int</span> <span class=n>majFaults</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>totalTime</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>totalTime</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>printRatio</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>user</span> <span class=o>+</span> <span class=n>system</span> <span class=o>+</span> <span class=n>iowait</span> <span class=o>+</span> <span class=n>irq</span> <span class=o>+</span> <span class=n>softIrq</span> <span class=o>+</span> <span class=n>idle</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% &quot;</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>pid</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;/&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>label</span> <span class=o>+</span> <span class=s>&quot;(&quot;</span> <span class=o>+</span> <span class=n>status</span> <span class=o>+</span> <span class=s>&quot;)&quot;</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;: &quot;</span><span class=p>);</span>
        <span class=n>printRatio</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>user</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% user + &quot;</span><span class=p>);</span>
        <span class=n>printRatio</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>system</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>);</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% kernel&quot;</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>iowait</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; + &quot;</span><span class=p>);</span>
            <span class=n>printRatio</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>iowait</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% iowait&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>irq</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; + &quot;</span><span class=p>);</span>
            <span class=n>printRatio</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>irq</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% irq&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>softIrq</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; + &quot;</span><span class=p>);</span>
            <span class=n>printRatio</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>softIrq</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% softirq&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>idle</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; + &quot;</span><span class=p>);</span>
            <span class=n>printRatio</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>idle</span><span class=p>,</span> <span class=n>totalTime</span><span class=p>);</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot;% idle&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>minFaults</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>majFaults</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; / faults:&quot;</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>minFaults</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; &quot;</span><span class=p>);</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>minFaults</span><span class=p>);</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; minor&quot;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>majFaults</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; &quot;</span><span class=p>);</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>majFaults</span><span class=p>);</span>
                <span class=n>pw</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&quot; major&quot;</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=n>pw</span><span class=p>.</span><span class=na>println</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=n>String</span> <span class=nf>readFile</span><span class=p>(</span><span class=n>String</span> <span class=n>file</span><span class=p>,</span> <span class=kt>char</span> <span class=n>endChar</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Permit disk reads here, as /proc/meminfo isn&#39;t really &quot;on</span>
        <span class=c1>// disk&quot; and should be fast.  TODO: make BlockGuard ignore</span>
        <span class=c1>// /proc/ and /sys/ files perhaps?</span>
        <span class=n>FileInputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>

        <span class=k>try</span> <span class=p>{</span>
            <span class=n>is</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
            <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>is</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>mBuffer</span><span class=p>);</span>
            <span class=n>is</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
                <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>mBuffer</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=n>endChar</span> <span class=o>||</span> <span class=n>mBuffer</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
                        <span class=k>break</span><span class=p>;</span>
                    <span class=p>}</span>
                <span class=p>}</span>
                <span class=k>return</span> <span class=k>new</span> <span class=n>String</span><span class=p>(</span><span class=n>mBuffer</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>FileNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>//</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>//</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>SystemInfo</span><span class=p>.</span><span class=na>closeQuietly</span><span class=p>(</span><span class=n>is</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>getName</span><span class=p>(</span><span class=n>Stats</span> <span class=n>st</span><span class=p>,</span> <span class=n>String</span> <span class=n>cmdlineFile</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>newName</span> <span class=o>=</span> <span class=n>st</span><span class=p>.</span><span class=na>name</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=na>name</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>st</span><span class=p>.</span><span class=na>name</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;app_process&quot;</span><span class=p>)</span>
                <span class=o>||</span> <span class=n>st</span><span class=p>.</span><span class=na>name</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;&lt;pre-initialized&gt;&quot;</span><span class=p>))</span> <span class=p>{</span>
            <span class=n>String</span> <span class=n>cmdName</span> <span class=o>=</span> <span class=n>readFile</span><span class=p>(</span><span class=n>cmdlineFile</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>cmdName</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>cmdName</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>newName</span> <span class=o>=</span> <span class=n>cmdName</span><span class=p>;</span>
                <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>newName</span><span class=p>.</span><span class=na>lastIndexOf</span><span class=p>(</span><span class=s>&quot;/&quot;</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>newName</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>newName</span> <span class=o>=</span> <span class=n>newName</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>newName</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>newName</span> <span class=o>=</span> <span class=n>st</span><span class=p>.</span><span class=na>baseName</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=na>name</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>newName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=na>name</span><span class=p>))</span> <span class=p>{</span>
            <span class=n>st</span><span class=p>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>newName</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nd>@Nullable</span>
    <span class=kd>protected</span> <span class=n>String</span><span class=o>[]</span> <span class=nf>readProcFile</span><span class=p>(</span><span class=n>String</span> <span class=n>file</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>RandomAccessFile</span> <span class=n>procFile</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
        <span class=n>String</span> <span class=n>procFileContents</span><span class=p>;</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>procFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RandomAccessFile</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=s>&quot;r&quot;</span><span class=p>);</span>
            <span class=n>procFileContents</span> <span class=o>=</span> <span class=n>procFile</span><span class=p>.</span><span class=na>readLine</span><span class=p>();</span>
            <span class=kt>int</span> <span class=n>rightIndex</span> <span class=o>=</span> <span class=n>procFileContents</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=s>&quot;)&quot;</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>rightIndex</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>procFileContents</span> <span class=o>=</span> <span class=n>procFileContents</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>rightIndex</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
            <span class=p>}</span>

            <span class=k>return</span> <span class=n>procFileContents</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&quot; &quot;</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>ioe</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ioe</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>SystemInfo</span><span class=p>.</span><span class=na>closeQuietly</span><span class=p>(</span><span class=n>procFile</span><span class=p>);</span>
        <span class=p>}</span>

    <span class=p>}</span>

<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_2> <label for=__tab_1_2>Sysconf</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm> * Use {@link libcore.io.Posix} to obtain values from SysConf without having to include call through</span>
<span class=cm> * to JNI directly, and let the Android Framework&#39;s classes do that for us.</span>
<span class=cm> *</span>
<span class=cm> * &lt;p&gt;The singleton instance of the Posix class was made directly accessible from Lollipop (SDK 21)</span>
<span class=cm> * onwards; from ICS to Lollipop we can access an instance at {@code libcore.io.Libcore.os} using</span>
<span class=cm> * reflection.</span>
<span class=cm> *</span>
<span class=cm> * @see &lt;a href=&quot;https://fburl.com/8o3hnt3k&quot;&gt;The Posix Class in AOSP&lt;/a&gt;</span>
<span class=cm> * @see &lt;a href=&quot;https://fburl.com/wf5sbpjs&quot;&gt;The CPP implementation of Posix&lt;/a&gt;</span>
<span class=cm> * @see &lt;a href=&quot;https://fburl.com/9kyylxzu&quot;&gt;Libcore singleton with a Posix instance&lt;/a&gt;</span>
<span class=cm> */</span>
<span class=cm>/*package*/</span> <span class=kd>class</span> <span class=nc>Sysconf</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&quot;Sysconf&quot;</span><span class=p>;</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>DEFAULT_CLOCK_TICKS_PER_SECOND</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>


    <span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;ObsoleteSdkInt&quot;</span><span class=p>)</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>long</span> <span class=nf>getScClkTck</span><span class=p>(</span><span class=kt>long</span> <span class=n>fallback</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>long</span> <span class=n>result</span> <span class=o>=</span> <span class=n>fallback</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>21</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>Os</span><span class=p>.</span><span class=na>sysconf</span><span class=p>(</span><span class=n>OsConstants</span><span class=p>.</span><span class=na>_SC_CLK_TCK</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>14</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>fromLibcore</span><span class=p>(</span><span class=s>&quot;_SC_CLK_TCK&quot;</span><span class=p>,</span> <span class=n>fallback</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=n>result</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=n>result</span> <span class=p>:</span> <span class=n>fallback</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>long</span> <span class=nf>getScClkTck</span><span class=p>()</span> <span class=p>{</span>
       <span class=k>return</span> <span class=n>getScClkTck</span><span class=p>(</span><span class=n>DEFAULT_CLOCK_TICKS_PER_SECOND</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;ObsoleteSdkInt&quot;</span><span class=p>)</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>long</span> <span class=nf>getScNProcessorsConf</span><span class=p>(</span><span class=kt>long</span> <span class=n>fallback</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>21</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>Os</span><span class=p>.</span><span class=na>sysconf</span><span class=p>(</span><span class=n>OsConstants</span><span class=p>.</span><span class=na>_SC_NPROCESSORS_CONF</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>14</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>fromLibcore</span><span class=p>(</span><span class=s>&quot;_SC_NPROCESSORS_CONF&quot;</span><span class=p>,</span> <span class=n>fallback</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=n>fallback</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>long</span> <span class=nf>fromLibcore</span><span class=p>(</span><span class=n>String</span> <span class=n>field</span><span class=p>,</span> <span class=kt>long</span> <span class=n>fallback</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>Class</span> <span class=n>osConstantsClass</span> <span class=o>=</span> <span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&quot;libcore.io.OsConstants&quot;</span><span class=p>);</span>
            <span class=kt>int</span> <span class=n>scClkTck</span> <span class=o>=</span> <span class=n>osConstantsClass</span><span class=p>.</span><span class=na>getField</span><span class=p>(</span><span class=n>field</span><span class=p>).</span><span class=na>getInt</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
            <span class=n>Class</span> <span class=n>libcoreClass</span> <span class=o>=</span> <span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&quot;libcore.io.Libcore&quot;</span><span class=p>);</span>
            <span class=n>Class</span> <span class=n>osClass</span> <span class=o>=</span> <span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&quot;libcore.io.Os&quot;</span><span class=p>);</span>
            <span class=n>Object</span> <span class=n>osInstance</span> <span class=o>=</span> <span class=n>libcoreClass</span><span class=p>.</span><span class=na>getField</span><span class=p>(</span><span class=s>&quot;os&quot;</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
            <span class=k>return</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=n>osClass</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&quot;sysconf&quot;</span><span class=p>,</span> <span class=kt>int</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>invoke</span><span class=p>(</span><span class=n>osInstance</span><span class=p>,</span> <span class=n>scClkTck</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>NoSuchMethodException</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logReflectionException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>NoSuchFieldException</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logReflectionException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IllegalAccessException</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logReflectionException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InvocationTargetException</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logReflectionException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logReflectionException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=n>fallback</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>logReflectionException</span><span class=p>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Unable to read _SC_CLK_TCK by reflection&quot;</span><span class=p>,</span> <span class=n>ex</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_3> <label for=__tab_1_3>ShellExecutor</label> <div class=superfences-content><div class=codehilite><pre><span></span><span class=kd>class</span> <span class=nc>ShellExecutor</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>(</span><span class=n>String</span><span class=p>...</span> <span class=n>cmd</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>Process</span> <span class=n>process</span> <span class=o>=</span> <span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=s>&quot;cat /proc/loadavg&quot;</span><span class=p>);</span>
            <span class=n>process</span><span class=p>.</span><span class=na>waitFor</span><span class=p>();</span>
            <span class=n>BufferedReader</span> <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span> <span class=n>InputStreamReader</span><span class=p>(</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span>
            <span class=n>StringBuilder</span> <span class=n>stringBuilder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>(</span><span class=s>&quot;result=&quot;</span><span class=p>);</span>
            <span class=n>String</span> <span class=n>line</span><span class=p>;</span>
            <span class=k>while</span> <span class=p>((</span><span class=n>line</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>stringBuilder</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>line</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=s>&quot;\n&quot;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>android</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;ProcessCpuTracker&quot;</span><span class=p>,</span> <span class=n>stringBuilder</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></div> </div> <hr> <div class=md-source-date> <small> 最后更新: 2020年11月11日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/paid/master/stuck_1/";
      this.page.identifier =
        "/android/paid/master/stuck_1/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </span> </div> </a> <a href=../stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> 06 | 卡顿优化（下）：如何监控应用卡顿？ </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
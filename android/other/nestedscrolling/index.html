<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/other/nestedscrolling/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>NestedScrolling机制</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - NestedScrolling机制"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/other/nestedscrolling/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - NestedScrolling机制"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1-nestedscrolling tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> NestedScrolling机制 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../3rd-library/3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3rd-library/3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../3rd-library/eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5 checked> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> NestedScrolling机制 </label> <a href=./ title=NestedScrolling机制 class="md-nav__link md-nav__link--active"> NestedScrolling机制 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-nestedscrolling class=md-nav__link> 1. NestedScrolling机制源码解析 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 嵌套滑动实战 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-nestedscrolling class=md-nav__link> 1. NestedScrolling机制源码解析 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 嵌套滑动实战 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>NestedScrolling机制</h1> <p>NestedScrolling机制是解决嵌套滑动的一大神器，在Android 5.0 Lollipop (API 21)中提出，但是以兼容包的形式出现在了v4 support包中，所以兼容性是得到了保证的。</p> <p>嵌套滑动既然是嵌套的，那么肯定有parent与child之分，与这两个角色相关的接口分别是<code>NestedScrollingParent</code>和<code>NestedScrollingChild</code>。但是对于fling的传递，child只是简单的将fling结果抛给parent。它的处理只有两种结果，要么child消费fling，要么parent消费fling，但它并不能让child消费一部分，再由parent消费剩余fling这样的消费效果。为了解决这个问题，在8.0之后推出了<code>NestedScrollingParent2</code>和<code>NestedScrollingChild2</code>。v2接口也是以兼容包的形式出现在了v4 support包中，兼容性也得到了保证，所以可以使用v2来代替v1。</p> <p>v1与v2之间的差别在于，v2在接口的方法中新增了一个type用来表示是scroll还是fling，type取值如下：</p> <div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm>  * @hide</span>
<span class=cm>  */</span>
<span class=nd>@IntDef</span><span class=p>({</span><span class=n>TYPE_TOUCH</span><span class=p>,</span> <span class=n>TYPE_NON_TOUCH</span><span class=p>})</span>
<span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span>
<span class=nd>@RestrictTo</span><span class=p>(</span><span class=n>LIBRARY_GROUP</span><span class=p>)</span>
<span class=kd>public</span> <span class=nd>@interface</span> <span class=n>NestedScrollType</span> <span class=p>{}</span>

<span class=cm>/**</span>
<span class=cm>  * Indicates that the input type for the gesture is from a user touching the screen.</span>
<span class=cm>  */</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>TYPE_TOUCH</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

<span class=cm>/**</span>
<span class=cm>  * Indicates that the input type for the gesture is caused by something which is not a user</span>
<span class=cm>  * touching a screen. This is usually from a fling which is settling.</span>
<span class=cm>  */</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>TYPE_NON_TOUCH</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</pre></div> <p>注释中已经注释的很清楚了，<code>TYPE_TOUCH</code>是用户触摸屏幕造成的scroll，<code>TYPE_NON_TOUCH</code>通常是fling。</p> <p>另外，从5.0开始，<code>View</code>和<code>ViewParent</code>都默认实现了v1 <strong>接口里面的</strong> 方法，而<code>ViewGroup</code>实现了<code>ViewParent</code>接口。因此，NestedScrolling机制就一共涉及到三对对象了，这三个Parent侧的对象的统一调用靠<code>ViewParentCompat</code>，调用规则为：如果Parent实现了<code>NestedScrollingParent2</code>接口，就调用v2的相关接口，否则会转交给<code>IMPL</code>。而<code>IMPL</code>是版本相关的，如果API &gt;= 21，就调用<code>ViewParent</code>的接口，否则调用v1接口。</p> <p><strong>ViewParentCompat.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>static</span> <span class=kd>final</span> <span class=n>ViewParentCompatBaseImpl</span> <span class=n>IMPL</span><span class=p>;</span>
<span class=kd>static</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>21</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>IMPL</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ViewParentCompatApi21Impl</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>19</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>IMPL</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ViewParentCompatApi19Impl</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>IMPL</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ViewParentCompatBaseImpl</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>static</span> <span class=kd>class</span> <span class=nc>ViewParentCompatBaseImpl</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=n>ViewParent</span> <span class=n>parent</span><span class=p>,</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span>
            <span class=kt>int</span> <span class=n>nestedScrollAxes</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>parent</span> <span class=k>instanceof</span> <span class=n>NestedScrollingParent</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=p>((</span><span class=n>NestedScrollingParent</span><span class=p>)</span> <span class=n>parent</span><span class=p>).</span><span class=na>onStartNestedScroll</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span>
                    <span class=n>nestedScrollAxes</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>

<span class=nd>@RequiresApi</span><span class=p>(</span><span class=mi>19</span><span class=p>)</span>
<span class=kd>static</span> <span class=kd>class</span> <span class=nc>ViewParentCompatApi19Impl</span> <span class=kd>extends</span> <span class=n>ViewParentCompatBaseImpl</span> <span class=p>{</span>
    <span class=p>...</span>
<span class=p>}</span>

<span class=nd>@RequiresApi</span><span class=p>(</span><span class=mi>21</span><span class=p>)</span>
<span class=kd>static</span> <span class=kd>class</span> <span class=nc>ViewParentCompatApi21Impl</span> <span class=kd>extends</span> <span class=n>ViewParentCompatApi19Impl</span> <span class=p>{</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=n>ViewParent</span> <span class=n>parent</span><span class=p>,</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span>
            <span class=kt>int</span> <span class=n>nestedScrollAxes</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>parent</span><span class=p>.</span><span class=na>onStartNestedScroll</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>nestedScrollAxes</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>AbstractMethodError</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;ViewParent &quot;</span> <span class=o>+</span> <span class=n>parent</span> <span class=o>+</span> <span class=s>&quot; does not implement interface &quot;</span>
                    <span class=o>+</span> <span class=s>&quot;method onStartNestedScroll&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=n>ViewParent</span> <span class=n>parent</span><span class=p>,</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span>
        <span class=kt>int</span> <span class=n>nestedScrollAxes</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>onStartNestedScroll</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>nestedScrollAxes</span><span class=p>,</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>TYPE_TOUCH</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=n>ViewParent</span> <span class=n>parent</span><span class=p>,</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span>
        <span class=kt>int</span> <span class=n>nestedScrollAxes</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>parent</span> <span class=k>instanceof</span> <span class=n>NestedScrollingParent2</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// First try the NestedScrollingParent2 API</span>
        <span class=k>return</span> <span class=p>((</span><span class=n>NestedScrollingParent2</span><span class=p>)</span> <span class=n>parent</span><span class=p>).</span><span class=na>onStartNestedScroll</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span>
                <span class=n>nestedScrollAxes</span><span class=p>,</span> <span class=n>type</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>TYPE_TOUCH</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Else if the type is the default (touch), try the NestedScrollingParent API</span>
        <span class=k>return</span> <span class=n>IMPL</span><span class=p>.</span><span class=na>onStartNestedScroll</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>nestedScrollAxes</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>此外，Parent和Child两边各有一个辅助对象，Child侧的辅助对象会进行事件的分发，Parent侧的辅助对象则很简单了。</p> <p>总结一下NestedScrolling机制出现的几个对象：</p> <table> <thead> <tr> <th>类名</th> <th>解释</th> </tr> </thead> <tbody> <tr> <td>NestedScrollingChild</td> <td>让View产生嵌套滑动事件</td> </tr> <tr> <td>NestedScrollingParent</td> <td>让ViewGroup能够接收从子View发送过来的嵌套滑动事件</td> </tr> <tr> <td>NestedScrollingChildHelper</td> <td>在实现NestedScrollChild接口的View里面使用，用来将子View产生的嵌套滑动事件分发给Parent</td> </tr> <tr> <td>NestedScrollingParentHelper</td> <td>在实现NestedScrollingParent接口的View中使用，用来记录axes</td> </tr> </tbody> </table> <p><code>NestedScrollingParent</code>和<code>NestedScrollingChild</code>的v1、v2接口以及解释如下：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>NestedScrollingChild</span> <span class=p>{</span>
    <span class=c1>//  View是否允许嵌套滑动</span>
    <span class=kt>void</span> <span class=nf>setNestedScrollingEnabled</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>enabled</span><span class=p>);</span>
    <span class=kt>boolean</span> <span class=nf>isNestedScrollingEnabled</span><span class=p>();</span>

    <span class=c1>// View将在axes表示的方向上开始进行滚动</span>
    <span class=c1>// axes可以是SCROLL_AXIS_NONE、SCROLL_AXIS_HORIZONTAL、SCROLL_AXIS_VERTICAL中的一个或多个</span>
    <span class=kt>boolean</span> <span class=nf>startNestedScroll</span><span class=p>(</span><span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>);</span>

    <span class=c1>// 停止嵌套滑动</span>
    <span class=kt>void</span> <span class=nf>stopNestedScroll</span><span class=p>();</span>

    <span class=c1>// 是否有正在接收嵌套滑动的Parent</span>
    <span class=kt>boolean</span> <span class=nf>hasNestedScrollingParent</span><span class=p>();</span>

    <span class=c1>// 分发正在进行中的嵌套滑动</span>
    <span class=kt>boolean</span> <span class=nf>dispatchNestedScroll</span><span class=p>(</span><span class=kt>int</span> <span class=n>dxConsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyConsumed</span><span class=p>,</span>
            <span class=kt>int</span> <span class=n>dxUnconsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyUnconsumed</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>offsetInWindow</span><span class=p>);</span>

    <span class=c1>// 分发正在进行中的未消耗的嵌套滑动</span>
    <span class=kt>boolean</span> <span class=nf>dispatchNestedPreScroll</span><span class=p>(</span><span class=kt>int</span> <span class=n>dx</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dy</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>consumed</span><span class=p>,</span>
            <span class=nd>@Nullable</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>offsetInWindow</span><span class=p>);</span>

    <span class=c1>// 分发正在进行中的嵌套fling</span>
    <span class=kt>boolean</span> <span class=nf>dispatchNestedFling</span><span class=p>(</span><span class=kt>float</span> <span class=n>velocityX</span><span class=p>,</span> <span class=kt>float</span> <span class=n>velocityY</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>consumed</span><span class=p>);</span>

    <span class=c1>// 分发正在进行中的未消耗的嵌套fling</span>
    <span class=kt>boolean</span> <span class=nf>dispatchNestedPreFling</span><span class=p>(</span><span class=kt>float</span> <span class=n>velocityX</span><span class=p>,</span> <span class=kt>float</span> <span class=n>velocityY</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// 在NestedScrollingChild的基础上新增了5个带type的方法，方法作用相同</span>
<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>NestedScrollingChild2</span> <span class=kd>extends</span> <span class=n>NestedScrollingChild</span> <span class=p>{</span>
    <span class=kt>boolean</span> <span class=nf>startNestedScroll</span><span class=p>(</span><span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>,</span> <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>
    <span class=kt>void</span> <span class=nf>stopNestedScroll</span><span class=p>(</span><span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>
    <span class=kt>boolean</span> <span class=nf>hasNestedScrollingParent</span><span class=p>(</span><span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>
    <span class=kt>boolean</span> <span class=nf>dispatchNestedScroll</span><span class=p>(</span><span class=kt>int</span> <span class=n>dxConsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyConsumed</span><span class=p>,</span>
            <span class=kt>int</span> <span class=n>dxUnconsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyUnconsumed</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>offsetInWindow</span><span class=p>,</span>
            <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>
    <span class=kt>boolean</span> <span class=nf>dispatchNestedPreScroll</span><span class=p>(</span><span class=kt>int</span> <span class=n>dx</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dy</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>consumed</span><span class=p>,</span>
            <span class=nd>@Nullable</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>offsetInWindow</span><span class=p>,</span> <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>NestedScrollingParent</span> <span class=p>{</span>
    <span class=c1>// 是否要对子View的嵌套滑动做出反应</span>
    <span class=kt>boolean</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>);</span>

    <span class=c1>// 接受子View的嵌套滑动事件，需要调用Helper记录axes</span>
    <span class=kt>void</span> <span class=nf>onNestedScrollAccepted</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>);</span>

    <span class=c1>// 子View的嵌套滑动终止时调用</span>
    <span class=kt>void</span> <span class=nf>onStopNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>);</span>

    <span class=c1>// 对进行中的嵌套滑动做出处理</span>
    <span class=kt>void</span> <span class=nf>onNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dxConsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyConsumed</span><span class=p>,</span>
            <span class=kt>int</span> <span class=n>dxUnconsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyUnconsumed</span><span class=p>);</span>

    <span class=c1>// 对进行中的还没有开始消耗的嵌套滑动做出处理</span>
    <span class=kt>void</span> <span class=nf>onNestedPreScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dx</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dy</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>consumed</span><span class=p>);</span>

    <span class=c1>// 对进行中的嵌套fling做出处理</span>
    <span class=kt>boolean</span> <span class=nf>onNestedFling</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>float</span> <span class=n>velocityX</span><span class=p>,</span> <span class=kt>float</span> <span class=n>velocityY</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>consumed</span><span class=p>);</span>

   <span class=c1>// 对进行中的还没有开始消耗的嵌套fling做出处理</span>
    <span class=kt>boolean</span> <span class=nf>onNestedPreFling</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>float</span> <span class=n>velocityX</span><span class=p>,</span> <span class=kt>float</span> <span class=n>velocityY</span><span class=p>);</span>

    <span class=c1>// 返回进行中的嵌套滑动的axes</span>
    <span class=nd>@ScrollAxis</span>
    <span class=kt>int</span> <span class=nf>getNestedScrollAxes</span><span class=p>();</span>
<span class=p>}</span>

<span class=c1>// 在NestedScrollingParent的基础上新增了5个带type的方法，方法作用相同</span>
<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>NestedScrollingParent2</span> <span class=kd>extends</span> <span class=n>NestedScrollingParent</span> <span class=p>{</span>
    <span class=kt>boolean</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>,</span>
            <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>

    <span class=kt>void</span> <span class=nf>onNestedScrollAccepted</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>,</span>
            <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>

    <span class=kt>void</span> <span class=nf>onStopNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>

    <span class=kt>void</span> <span class=nf>onNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dxConsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyConsumed</span><span class=p>,</span>
            <span class=kt>int</span> <span class=n>dxUnconsumed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dyUnconsumed</span><span class=p>,</span> <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>

    <span class=kt>void</span> <span class=nf>onNestedPreScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dx</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dy</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>consumed</span><span class=p>,</span>
            <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>上面理论知识介绍得差不多了，只缺少一个Child与Parent两侧联动的顺序图了，这里给出典型的<code>RecyclerView</code>与<code>SwipeRefreshLayout</code>两者的嵌套滑动顺序图：</p> <p><a href=/assets/images/android/nestedscrolling.png><img alt=RecyclerView与SwipeRefreshLayout两者的嵌套滑动顺序图 src=/assets/images/android/nestedscrolling.png></a></p> <p>值得一提的是，这里SwipeRefreshLayout相对RecyclerView而言是Parent；相对于自己的Parent而言又是Child。所以这里SwipeRefreshLayout也会将嵌套滑动事件分发给上一级，这就是一个三级嵌套滑动的典型例子了。但是，本章只研究两级，SwipeRefreshLayout的Parent暂不考虑。</p> <p>在上面介绍了这么多理论之后，我们通过源码验证一下。源码并不难，只需要我们有足够的勇气去看一眼。</p> <h2 id=1-nestedscrolling>1. NestedScrolling机制源码解析<a class=headerlink href=#1-nestedscrolling title="Permanent link">&para;</a></h2> <p>嵌套滑动的事件分发与一般的事件传递机制相反，嵌套滑动是由子View向父View传递的，但嵌套滑动的实现还是基于事件传递机制的，具体思想可以参考<a href=/android/framework/View的事件体系/#522>View的滑动冲突处理——内部拦截法</a>。由于本章是以<code>RecyclerView</code>与<code>SwipeRefreshLayout</code>两者的嵌套滑动为例，显然<code>RecyclerView</code>是作为Child的，因此嵌套滑动事件也是从它的<code>onTouchEvent</code>开始。 </p> <p>在<code>ACTION_DOWN</code>时，<code>RecyclerView</code>借助<code>NestedScrollingChildHelper</code>向Parent发出通知，表明自己即将开始滚动。<code>RecyclerView</code>相关代码如下：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTouchEvent</span><span class=p>(</span><span class=n>MotionEvent</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=k>case</span> <span class=n>MotionEvent</span><span class=p>.</span><span class=na>ACTION_DOWN</span><span class=p>:</span> <span class=p>{</span>
        <span class=n>mScrollPointerId</span> <span class=o>=</span> <span class=n>e</span><span class=p>.</span><span class=na>getPointerId</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
        <span class=n>mInitialTouchX</span> <span class=o>=</span> <span class=n>mLastTouchX</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getX</span><span class=p>()</span> <span class=o>+</span> <span class=mf>0.5f</span><span class=p>);</span>
        <span class=n>mInitialTouchY</span> <span class=o>=</span> <span class=n>mLastTouchY</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getY</span><span class=p>()</span> <span class=o>+</span> <span class=mf>0.5f</span><span class=p>);</span>

        <span class=kt>int</span> <span class=n>nestedScrollAxis</span> <span class=o>=</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_NONE</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>canScrollHorizontally</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>nestedScrollAxis</span> <span class=o>|=</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_HORIZONTAL</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>canScrollVertically</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>nestedScrollAxis</span> <span class=o>|=</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_VERTICAL</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>startNestedScroll</span><span class=p>(</span><span class=n>nestedScrollAxis</span><span class=p>,</span> <span class=n>TYPE_TOUCH</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>break</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNestedScroll</span><span class=p>(</span><span class=kt>int</span> <span class=n>axes</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>getScrollingChildHelper</span><span class=p>().</span><span class=na>startNestedScroll</span><span class=p>(</span><span class=n>axes</span><span class=p>,</span> <span class=n>type</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>NestedScrollingChildHelper</span> <span class=nf>getScrollingChildHelper</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mScrollingChildHelper</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mScrollingChildHelper</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NestedScrollingChildHelper</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>mScrollingChildHelper</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p><code>RecyclerView</code>的代码就转接到了<code>NestedScrollingChildHelper</code>中了，接着看看相关代码：</p> <p><strong>NestedScrollingChildHelper.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNestedScroll</span><span class=p>(</span><span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>,</span> <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>hasNestedScrollingParent</span><span class=p>(</span><span class=n>type</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// Already in progress</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isNestedScrollingEnabled</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>ViewParent</span> <span class=n>p</span> <span class=o>=</span> <span class=n>mView</span><span class=p>.</span><span class=na>getParent</span><span class=p>();</span>
        <span class=n>View</span> <span class=n>child</span> <span class=o>=</span> <span class=n>mView</span><span class=p>;</span>
        <span class=k>while</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>ViewParentCompat</span><span class=p>.</span><span class=na>onStartNestedScroll</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>child</span><span class=p>,</span> <span class=n>mView</span><span class=p>,</span> <span class=n>axes</span><span class=p>,</span> <span class=n>type</span><span class=p>))</span> <span class=p>{</span>
                <span class=n>setNestedScrollingParentForType</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
                <span class=n>ViewParentCompat</span><span class=p>.</span><span class=na>onNestedScrollAccepted</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>child</span><span class=p>,</span> <span class=n>mView</span><span class=p>,</span> <span class=n>axes</span><span class=p>,</span> <span class=n>type</span><span class=p>);</span>
                <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=k>instanceof</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>child</span> <span class=o>=</span> <span class=p>(</span><span class=n>View</span><span class=p>)</span> <span class=n>p</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=p>.</span><span class=na>getParent</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>首先调用<code>hasNestedScrollingParent</code>方法看看嵌套滑动Parent是否已经设置，如果有设置，表明正在进行嵌套滑动。接着判断Child侧接口的代理方法<code>isNestedScrollingEnabled()</code>是否Child允许嵌套滑动。如果允许滑动，会从Child的Parent开始，看看当前的ViewParent是否响应此处的嵌套滑动（<code>ViewParentCompat.onStartNestedScroll</code>返回true），如果当前ViewParent不响应，则判断ViewParent的Parent，就这么沿着控件树一直往上一直找到一个可以响应的。<br> 一旦有一个ViewParent响应了，就会调用<code>setNestedScrollingParentForType</code>方法设置正在嵌套滑动的Parent，这样后面调用第2行的<code>hasNestedScrollingParent</code>方法就会返回true了。然后调用<code>ViewParentCompat.onNestedScrollAccepted</code>方法通知<code>SwipeRefreshLayout.onNestedScrollAccepted</code>方法，此时SwipeRefreshLayout已经接受了此次的嵌套滑动请求：</p> <p><strong>SwipeRefreshLayout.java</strong></p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>nestedScrollAxes</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>isEnabled</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mReturningToStart</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mRefreshing</span>
            <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>nestedScrollAxes</span> <span class=o>&amp;</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_VERTICAL</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onNestedScrollAccepted</span><span class=p>(</span><span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Reset the counter of how much leftover scroll needs to be consumed.</span>
    <span class=n>mNestedScrollingParentHelper</span><span class=p>.</span><span class=na>onNestedScrollAccepted</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>axes</span><span class=p>);</span>
    <span class=c1>// Dispatch up to the nested parent</span>
    <span class=n>startNestedScroll</span><span class=p>(</span><span class=n>axes</span> <span class=o>&amp;</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_VERTICAL</span><span class=p>);</span>
    <span class=n>mTotalUnconsumed</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>mNestedScrollInProgress</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在<code>SwipeRefreshLayout.onNestedScrollAccepted</code>方法中会调用Helper对象的相同签名方法，并且会以Child的身份向Parent发出嵌套滑动的事件，最后会设置一下自身的变量，等待后续处理嵌套滑动。</p> <p><code>NestedScrollingParentHelper.onNestedScrollAccepted</code>方法只是很简单的记录了一下嵌套滑动的axes，在最后<code>onStopNestedScroll</code>方法中复位了变量，此类的源码非常简单，所以一次性贴出来：</p> <p><strong>NestedScrollingParentHelper.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onNestedScrollAccepted</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span>
        <span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>onNestedScrollAccepted</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>axes</span><span class=p>,</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>TYPE_TOUCH</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onNestedScrollAccepted</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span>
        <span class=nd>@ScrollAxis</span> <span class=kt>int</span> <span class=n>axes</span><span class=p>,</span> <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>mNestedScrollAxes</span> <span class=o>=</span> <span class=n>axes</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onStopNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>onStopNestedScroll</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>TYPE_TOUCH</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onStopNestedScroll</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@NestedScrollType</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>mNestedScrollAxes</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>目前为止，伴随着手指按下触发的<code>ACTION_DOWN</code>事件，Child与Parent之间的嵌套滑动的关系已经建立了，下面手指滑动触发的<code>ACTION_MOVE</code>事件会真正开始嵌套滑动。</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTouchEvent</span><span class=p>(</span><span class=n>MotionEvent</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=k>case</span> <span class=n>MotionEvent</span><span class=p>.</span><span class=na>ACTION_MOVE</span><span class=p>:</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>e</span><span class=p>.</span><span class=na>findPointerIndex</span><span class=p>(</span><span class=n>mScrollPointerId</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Error processing scroll; pointer index for id &quot;</span>
                    <span class=o>+</span> <span class=n>mScrollPointerId</span> <span class=o>+</span> <span class=s>&quot; not found. Did any MotionEvents get skipped?&quot;</span><span class=p>);</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=kd>final</span> <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getX</span><span class=p>(</span><span class=n>index</span><span class=p>)</span> <span class=o>+</span> <span class=mf>0.5f</span><span class=p>);</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getY</span><span class=p>(</span><span class=n>index</span><span class=p>)</span> <span class=o>+</span> <span class=mf>0.5f</span><span class=p>);</span>
        <span class=kt>int</span> <span class=n>dx</span> <span class=o>=</span> <span class=n>mLastTouchX</span> <span class=o>-</span> <span class=n>x</span><span class=p>;</span>
        <span class=kt>int</span> <span class=n>dy</span> <span class=o>=</span> <span class=n>mLastTouchY</span> <span class=o>-</span> <span class=n>y</span><span class=p>;</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>dispatchNestedPreScroll</span><span class=p>(</span><span class=n>dx</span><span class=p>,</span> <span class=n>dy</span><span class=p>,</span> <span class=n>mScrollConsumed</span><span class=p>,</span> <span class=n>mScrollOffset</span><span class=p>,</span> <span class=n>TYPE_TOUCH</span><span class=p>))</span> <span class=p>{</span>
            <span class=n>dx</span> <span class=o>-=</span> <span class=n>mScrollConsumed</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
            <span class=n>dy</span> <span class=o>-=</span> <span class=n>mScrollConsumed</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
            <span class=n>vtev</span><span class=p>.</span><span class=na>offsetLocation</span><span class=p>(</span><span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>,</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>);</span>
            <span class=c1>// Updated the nested offsets</span>
            <span class=n>mNestedOffsets</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>+=</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
            <span class=n>mNestedOffsets</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=o>+=</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>mScrollState</span> <span class=o>!=</span> <span class=n>SCROLL_STATE_DRAGGING</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>boolean</span> <span class=n>startScroll</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>canScrollHorizontally</span> <span class=o>&amp;&amp;</span> <span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>dx</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>mTouchSlop</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>dx</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>dx</span> <span class=o>-=</span> <span class=n>mTouchSlop</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=n>dx</span> <span class=o>+=</span> <span class=n>mTouchSlop</span><span class=p>;</span>
                <span class=p>}</span>
                <span class=n>startScroll</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>canScrollVertically</span> <span class=o>&amp;&amp;</span> <span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>dy</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>mTouchSlop</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>dy</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>dy</span> <span class=o>-=</span> <span class=n>mTouchSlop</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=n>dy</span> <span class=o>+=</span> <span class=n>mTouchSlop</span><span class=p>;</span>
                <span class=p>}</span>
                <span class=n>startScroll</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>startScroll</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>setScrollState</span><span class=p>(</span><span class=n>SCROLL_STATE_DRAGGING</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>mScrollState</span> <span class=o>==</span> <span class=n>SCROLL_STATE_DRAGGING</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>mLastTouchX</span> <span class=o>=</span> <span class=n>x</span> <span class=o>-</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
            <span class=n>mLastTouchY</span> <span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>scrollByInternal</span><span class=p>(</span>
                    <span class=n>canScrollHorizontally</span> <span class=o>?</span> <span class=n>dx</span> <span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
                    <span class=n>canScrollVertically</span> <span class=o>?</span> <span class=n>dy</span> <span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
                    <span class=n>vtev</span><span class=p>))</span> <span class=p>{</span>
                <span class=n>getParent</span><span class=p>().</span><span class=na>requestDisallowInterceptTouchEvent</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>mGapWorker</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>dx</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>dy</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
                <span class=n>mGapWorker</span><span class=p>.</span><span class=na>postFromTraversal</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>dx</span><span class=p>,</span> <span class=n>dy</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>break</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>}</span>
</pre></div> <p>在17行会将原始的没有经过消耗的dx、dy经过<code>NestedScrollingChildHelper</code>分发给Parent的<code>onNestedPreScroll</code>方法，Parent在需要的时候会消耗部分dx和dy并做出滑动响应，并在二维数组consumed中减掉这部分的消耗。<code>NestedScrollingChildHelper</code>部分的处理比较简单，这里直接看Parent也就是<code>SwipeRefreshLayout.onNestedPreScroll</code>方法是如何做出响应的：</p> <p><strong>SwipeRefreshLayout.java</strong></p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onNestedPreScroll</span><span class=p>(</span><span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dx</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dy</span><span class=p>,</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>consumed</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// If we are in the middle of consuming, a scroll, then we want to move the spinner back up</span>
    <span class=c1>// before allowing the list to scroll</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>dy</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>mTotalUnconsumed</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>dy</span> <span class=o>&gt;</span> <span class=n>mTotalUnconsumed</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>consumed</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=o>=</span> <span class=n>dy</span> <span class=o>-</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>mTotalUnconsumed</span><span class=p>;</span>
            <span class=n>mTotalUnconsumed</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>mTotalUnconsumed</span> <span class=o>-=</span> <span class=n>dy</span><span class=p>;</span>
            <span class=n>consumed</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=o>=</span> <span class=n>dy</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>moveSpinner</span><span class=p>(</span><span class=n>mTotalUnconsumed</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// If a client layout is using a custom start position for the circle</span>
    <span class=c1>// view, they mean to hide it again before scrolling the child view</span>
    <span class=c1>// If we get back to mTotalUnconsumed == 0 and there is more to go, hide</span>
    <span class=c1>// the circle so it isn&#39;t exposed if its blocking content is moved</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mUsingCustomStart</span> <span class=o>&amp;&amp;</span> <span class=n>dy</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>mTotalUnconsumed</span> <span class=o>==</span> <span class=mi>0</span>
            <span class=o>&amp;&amp;</span> <span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>dy</span> <span class=o>-</span> <span class=n>consumed</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mCircleView</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>GONE</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Now let our nested parent consume the leftovers</span>
    <span class=kd>final</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>parentConsumed</span> <span class=o>=</span> <span class=n>mParentScrollConsumed</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>dispatchNestedPreScroll</span><span class=p>(</span><span class=n>dx</span> <span class=o>-</span> <span class=n>consumed</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>,</span> <span class=n>dy</span> <span class=o>-</span> <span class=n>consumed</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>,</span> <span class=n>parentConsumed</span><span class=p>,</span> <span class=kc>null</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>consumed</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>+=</span> <span class=n>parentConsumed</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
        <span class=n>consumed</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=o>+=</span> <span class=n>parentConsumed</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>抛开最后一段作为Child的代码不谈，这里消耗dx、dy的情况只有第5行的if里面的代码了。在这行代码中会先计算dy消耗量，然后移动指示器的位置。</p> <p>回到<code>RecyclerView.onTouchEvent</code>的<code>ACTION_MOVE</code>方法中，随着手指的移动，mScrollState会由初始状态变成<code>SCROLL_STATE_DRAGGING</code>状态，这样会调用第53行的<code>scrollByInternal</code>方法。在该方法中会先由<code>LayoutManager</code>进行滚动，消耗掉一部分的dx、dy，然后在第28行会调用<code>dispatchNestedScroll</code>方法将消息分发给Parent：</p> <div class=codehilite><pre><span></span><span class=kt>boolean</span> <span class=nf>scrollByInternal</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>,</span> <span class=n>MotionEvent</span> <span class=n>ev</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>unconsumedX</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>unconsumedY</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>consumedX</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>consumedY</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=n>consumePendingUpdateOperations</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mAdapter</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>eatRequestLayout</span><span class=p>();</span>
        <span class=n>onEnterLayoutOrScroll</span><span class=p>();</span>
        <span class=n>TraceCompat</span><span class=p>.</span><span class=na>beginSection</span><span class=p>(</span><span class=n>TRACE_SCROLL_TAG</span><span class=p>);</span>
        <span class=n>fillRemainingScrollValues</span><span class=p>(</span><span class=n>mState</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>x</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>consumedX</span> <span class=o>=</span> <span class=n>mLayout</span><span class=p>.</span><span class=na>scrollHorizontallyBy</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>mRecycler</span><span class=p>,</span> <span class=n>mState</span><span class=p>);</span>
            <span class=n>unconsumedX</span> <span class=o>=</span> <span class=n>x</span> <span class=o>-</span> <span class=n>consumedX</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>y</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>consumedY</span> <span class=o>=</span> <span class=n>mLayout</span><span class=p>.</span><span class=na>scrollVerticallyBy</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>mRecycler</span><span class=p>,</span> <span class=n>mState</span><span class=p>);</span>
            <span class=n>unconsumedY</span> <span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=n>consumedY</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>TraceCompat</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
        <span class=n>repositionShadowingViews</span><span class=p>();</span>
        <span class=n>onExitLayoutOrScroll</span><span class=p>();</span>
        <span class=n>resumeRequestLayout</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mItemDecorations</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>invalidate</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>dispatchNestedScroll</span><span class=p>(</span><span class=n>consumedX</span><span class=p>,</span> <span class=n>consumedY</span><span class=p>,</span> <span class=n>unconsumedX</span><span class=p>,</span> <span class=n>unconsumedY</span><span class=p>,</span> <span class=n>mScrollOffset</span><span class=p>,</span>
            <span class=n>TYPE_TOUCH</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// Update the last touch co-ords, taking any scroll offset into account</span>
        <span class=n>mLastTouchX</span> <span class=o>-=</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
        <span class=n>mLastTouchY</span> <span class=o>-=</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>ev</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ev</span><span class=p>.</span><span class=na>offsetLocation</span><span class=p>(</span><span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>,</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>mNestedOffsets</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>+=</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
        <span class=n>mNestedOffsets</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=o>+=</span> <span class=n>mScrollOffset</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>getOverScrollMode</span><span class=p>()</span> <span class=o>!=</span> <span class=n>View</span><span class=p>.</span><span class=na>OVER_SCROLL_NEVER</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>ev</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>MotionEventCompat</span><span class=p>.</span><span class=na>isFromSource</span><span class=p>(</span><span class=n>ev</span><span class=p>,</span> <span class=n>InputDevice</span><span class=p>.</span><span class=na>SOURCE_MOUSE</span><span class=p>))</span> <span class=p>{</span>
            <span class=n>pullGlows</span><span class=p>(</span><span class=n>ev</span><span class=p>.</span><span class=na>getX</span><span class=p>(),</span> <span class=n>unconsumedX</span><span class=p>,</span> <span class=n>ev</span><span class=p>.</span><span class=na>getY</span><span class=p>(),</span> <span class=n>unconsumedY</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>considerReleasingGlowsOnScroll</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>consumedX</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>consumedY</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>dispatchOnScrolled</span><span class=p>(</span><span class=n>consumedX</span><span class=p>,</span> <span class=n>consumedY</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>awakenScrollBars</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>invalidate</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>consumedX</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>consumedY</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p><code>dispatchNestedScroll</code>还是经过<code>NestedScrollingChildHelper</code>的代理分发到Parent上，Parent这边会拿着<code>dyUnconsumed</code>进行一些操作：</p> <p><strong>SwipeRefreshLayout.java</strong></p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onNestedScroll</span><span class=p>(</span><span class=kd>final</span> <span class=n>View</span> <span class=n>target</span><span class=p>,</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>dxConsumed</span><span class=p>,</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>dyConsumed</span><span class=p>,</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>dxUnconsumed</span><span class=p>,</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>dyUnconsumed</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Dispatch up to the nested parent first</span>
    <span class=n>dispatchNestedScroll</span><span class=p>(</span><span class=n>dxConsumed</span><span class=p>,</span> <span class=n>dyConsumed</span><span class=p>,</span> <span class=n>dxUnconsumed</span><span class=p>,</span> <span class=n>dyUnconsumed</span><span class=p>,</span>
            <span class=n>mParentOffsetInWindow</span><span class=p>);</span>

    <span class=c1>// This is a bit of a hack. Nested scrolling works from the bottom up, and as we are</span>
    <span class=c1>// sometimes between two nested scrolling views, we need a way to be able to know when any</span>
    <span class=c1>// nested scrolling parent has stopped handling events. We do that by using the</span>
    <span class=c1>// &#39;offset in window &#39;functionality to see if we have been moved from the event.</span>
    <span class=c1>// This is a decent indication of whether we should take over the event stream or not.</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>dy</span> <span class=o>=</span> <span class=n>dyUnconsumed</span> <span class=o>+</span> <span class=n>mParentOffsetInWindow</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>dy</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>canChildScrollUp</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>mTotalUnconsumed</span> <span class=o>+=</span> <span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>dy</span><span class=p>);</span>
        <span class=n>moveSpinner</span><span class=p>(</span><span class=n>mTotalUnconsumed</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>可以看到，在<code>ACTION_MOVE</code>阶段，<code>SwipeRefreshLayout</code>会响应<code>RecyclerView</code>的嵌套滑动，此时刷新指示器会随着用的操作而上下移动。在我们自定义二级嵌套滑动时，这两个方法就是所有需要我们自己处理的Parent内容了，因为<code>RecyclerView</code>会自动发送嵌套滑动事件。</p> <p>在经历若干个<code>ACTION_MOVE</code>之后，伴随着用户的操作，就会触发<code>ACTION_UP</code>事件，这里会先尝试fling，最后stop。</p> <p><strong>RecyclerView.java</strong></p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTouchEvent</span><span class=p>(</span><span class=n>MotionEvent</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=k>case</span> <span class=n>MotionEvent</span><span class=p>.</span><span class=na>ACTION_UP</span><span class=p>:</span> <span class=p>{</span>
        <span class=n>mVelocityTracker</span><span class=p>.</span><span class=na>addMovement</span><span class=p>(</span><span class=n>vtev</span><span class=p>);</span>
        <span class=n>eventAddedToVelocityTracker</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=n>mVelocityTracker</span><span class=p>.</span><span class=na>computeCurrentVelocity</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=n>mMaxFlingVelocity</span><span class=p>);</span>
        <span class=kd>final</span> <span class=kt>float</span> <span class=n>xvel</span> <span class=o>=</span> <span class=n>canScrollHorizontally</span>
                <span class=o>?</span> <span class=o>-</span><span class=n>mVelocityTracker</span><span class=p>.</span><span class=na>getXVelocity</span><span class=p>(</span><span class=n>mScrollPointerId</span><span class=p>)</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
        <span class=kd>final</span> <span class=kt>float</span> <span class=n>yvel</span> <span class=o>=</span> <span class=n>canScrollVertically</span>
                <span class=o>?</span> <span class=o>-</span><span class=n>mVelocityTracker</span><span class=p>.</span><span class=na>getYVelocity</span><span class=p>(</span><span class=n>mScrollPointerId</span><span class=p>)</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>((</span><span class=n>xvel</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>yvel</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>fling</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span> <span class=n>xvel</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>yvel</span><span class=p>)))</span> <span class=p>{</span>
            <span class=n>setScrollState</span><span class=p>(</span><span class=n>SCROLL_STATE_IDLE</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>resetTouch</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>break</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>}</span>
</pre></div> <p>第12行中会调用<code>fling</code>方法进行fling，这里面和scroll一样会调用<code>dispatchNestedPreFling</code>和<code>dispatchNestedFling</code>方法，这两个方法<code>SwipeRefreshLayout</code>的实现都是作为Child转发给Parent了。在最后在开始fling前会调用<code>startNestedScroll(nestedScrollAxis, TYPE_NON_TOUCH)</code>，注意这里的type就是<code>TYPE_NON_TOUCH</code>了：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>fling</span><span class=p>(</span><span class=kt>int</span> <span class=n>velocityX</span><span class=p>,</span> <span class=kt>int</span> <span class=n>velocityY</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mLayout</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Cannot fling without a LayoutManager set. &quot;</span>
                <span class=o>+</span> <span class=s>&quot;Call setLayoutManager with a non-null argument.&quot;</span><span class=p>);</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mLayoutFrozen</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>canScrollHorizontal</span> <span class=o>=</span> <span class=n>mLayout</span><span class=p>.</span><span class=na>canScrollHorizontally</span><span class=p>();</span>
    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>canScrollVertical</span> <span class=o>=</span> <span class=n>mLayout</span><span class=p>.</span><span class=na>canScrollVertically</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>canScrollHorizontal</span> <span class=o>||</span> <span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>velocityX</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>mMinFlingVelocity</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>velocityX</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>canScrollVertical</span> <span class=o>||</span> <span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>velocityY</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>mMinFlingVelocity</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>velocityY</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>velocityX</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>velocityY</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// If we don&#39;t have any velocity, return false</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dispatchNestedPreFling</span><span class=p>(</span><span class=n>velocityX</span><span class=p>,</span> <span class=n>velocityY</span><span class=p>))</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>canScroll</span> <span class=o>=</span> <span class=n>canScrollHorizontal</span> <span class=o>||</span> <span class=n>canScrollVertical</span><span class=p>;</span>
        <span class=n>dispatchNestedFling</span><span class=p>(</span><span class=n>velocityX</span><span class=p>,</span> <span class=n>velocityY</span><span class=p>,</span> <span class=n>canScroll</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>mOnFlingListener</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mOnFlingListener</span><span class=p>.</span><span class=na>onFling</span><span class=p>(</span><span class=n>velocityX</span><span class=p>,</span> <span class=n>velocityY</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>canScroll</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>nestedScrollAxis</span> <span class=o>=</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_NONE</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>canScrollHorizontal</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>nestedScrollAxis</span> <span class=o>|=</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_HORIZONTAL</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>canScrollVertical</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>nestedScrollAxis</span> <span class=o>|=</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=na>SCROLL_AXIS_VERTICAL</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>startNestedScroll</span><span class=p>(</span><span class=n>nestedScrollAxis</span><span class=p>,</span> <span class=n>TYPE_NON_TOUCH</span><span class=p>);</span>

            <span class=n>velocityX</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=o>-</span><span class=n>mMaxFlingVelocity</span><span class=p>,</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>velocityX</span><span class=p>,</span> <span class=n>mMaxFlingVelocity</span><span class=p>));</span>
            <span class=n>velocityY</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=o>-</span><span class=n>mMaxFlingVelocity</span><span class=p>,</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>velocityY</span><span class=p>,</span> <span class=n>mMaxFlingVelocity</span><span class=p>));</span>
            <span class=n>mViewFlinger</span><span class=p>.</span><span class=na>fling</span><span class=p>(</span><span class=n>velocityX</span><span class=p>,</span> <span class=n>velocityY</span><span class=p>);</span>
            <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>fling完成后调用<code>resetTouch</code>方法进行，里面会调用<code>stopNestedScroll(TYPE_TOUCH)</code>方法，该方法还是经过<code>NestedScrollingChildHelper</code>转发给Parent的<code>onStopNestedScroll</code>方法了：</p> <p><strong>SwipeRefreshLayout.java</strong> </p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onStopNestedScroll</span><span class=p>(</span><span class=n>View</span> <span class=n>target</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>mNestedScrollingParentHelper</span><span class=p>.</span><span class=na>onStopNestedScroll</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
    <span class=n>mNestedScrollInProgress</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=c1>// Finish the spinner for nested scrolling if we ever consumed any</span>
    <span class=c1>// unconsumed nested scroll</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mTotalUnconsumed</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>finishSpinner</span><span class=p>(</span><span class=n>mTotalUnconsumed</span><span class=p>);</span>
        <span class=n>mTotalUnconsumed</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>// Dispatch up our nested parent</span>
    <span class=n>stopNestedScroll</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>这里<code>SwipeRefreshLayout</code>会将刷新指示器复位，并重置一些变量。 </p> <p>限于篇幅，且代码比较简单，所以上面也只是大致理了一下整个流程。整个流程可以按照MotionEvent的action分为三个步骤：</p> <ol> <li><code>ACTION_DOWN</code>阶段 —— Child准备开始嵌套滑动，此时会通知可以响应的Parent做好准备</li> <li><code>ACTION_MOVE</code>阶段 —— Child进行嵌套滑动，Parent根据情况消耗dx、dy</li> <li><code>ACTION_UP</code>阶段 —— Child和Parent开始fling，最后进行stop状态</li> </ol> <p>Child的事件通过<code>NestedScrollingChildHelper</code>分发到Parent中。此时回过头来看<a href=/assets/images/android/nestedscrolling.png>RecyclerView与SwipeRefreshLayout两者的嵌套滑动顺序图</a>，应该有进一步的认识了。</p> <h2 id=2>2. 嵌套滑动实战<a class=headerlink href=#2 title="Permanent link">&para;</a></h2> <p>在嵌套滑动中，基本上都是<code>RecyclerView</code>作为Child，所以我们只需要处理一下Parent就好了。 </p> <p>下面来一个非常简单又常见的例子，效果图如下：</p> <p><img alt=嵌套滑动实战 src=/assets/images/android/nestedscrolling-demo-v2.gif></p> <p>整个页面的整体是一个线性布局，为了能够响应RecyclerView的滑动，我们需要自定义一下LinearLayout。布局代码如下：</p> <div class=codehilite><pre><span></span><span class=cp>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class=nt>&lt;yorek.demoandtest.nestedscroll.NestedScrollingLinearLayout</span>
    <span class=na>xmlns:android=</span><span class=s>&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class=na>android:layout_width=</span><span class=s>&quot;match_parent&quot;</span>
    <span class=na>android:layout_height=</span><span class=s>&quot;match_parent&quot;</span>
    <span class=na>android:orientation=</span><span class=s>&quot;vertical&quot;</span><span class=nt>&gt;</span>

    <span class=nt>&lt;FrameLayout</span>
        <span class=na>android:layout_width=</span><span class=s>&quot;match_parent&quot;</span>
        <span class=na>android:layout_height=</span><span class=s>&quot;wrap_content&quot;</span><span class=nt>&gt;</span>
        <span class=nt>&lt;ImageView</span>
            <span class=na>android:layout_width=</span><span class=s>&quot;match_parent&quot;</span>
            <span class=na>android:layout_height=</span><span class=s>&quot;200dp&quot;</span>
            <span class=na>android:src=</span><span class=s>&quot;@mipmap/ic_launcher&quot;</span>
            <span class=na>android:background=</span><span class=s>&quot;@color/colorAccent&quot;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;/FrameLayout&gt;</span>

    <span class=nt>&lt;TextView</span>
        <span class=na>android:layout_width=</span><span class=s>&quot;match_parent&quot;</span>
        <span class=na>android:layout_height=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:background=</span><span class=s>&quot;@color/colorPrimary&quot;</span>
        <span class=na>android:text=</span><span class=s>&quot;Title&quot;</span>
        <span class=na>android:textAlignment=</span><span class=s>&quot;center&quot;</span>
        <span class=na>android:textSize=</span><span class=s>&quot;20sp&quot;</span>
        <span class=na>android:textColor=</span><span class=s>&quot;#FF0000&quot;</span><span class=nt>/&gt;</span>

    <span class=nt>&lt;android.support.v7.widget.RecyclerView</span>
        <span class=na>android:id=</span><span class=s>&quot;@+id/list&quot;</span>
        <span class=na>android:layout_width=</span><span class=s>&quot;match_parent&quot;</span>
        <span class=na>android:layout_height=</span><span class=s>&quot;match_parent&quot;</span> <span class=nt>/&gt;</span>

<span class=nt>&lt;/yorek.demoandtest.nestedscroll.NestedScrollingLinearLayout&gt;</span>
</pre></div> <p>页面逻辑代码只需要向RecyclerView中填充数据就好了，代码如下：</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>NestedScrollActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_nested_scroll</span><span class=p>)</span>

        <span class=n>list</span><span class=p>.</span><span class=n>layoutManager</span> <span class=p>=</span> <span class=n>LinearLayoutManager</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
        <span class=n>list</span><span class=p>.</span><span class=n>adapter</span> <span class=p>=</span> <span class=k>object</span> <span class=p>:</span> <span class=nc>RecyclerView</span><span class=p>.</span><span class=n>Adapter</span><span class=p>&lt;</span><span class=n>Holder</span><span class=p>&gt;()</span> <span class=p>{</span>

            <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreateViewHolder</span><span class=p>(</span><span class=n>parent</span><span class=p>:</span> <span class=n>ViewGroup</span><span class=p>,</span> <span class=n>viewType</span><span class=p>:</span> <span class=n>Int</span><span class=p>):</span> <span class=n>Holder</span> <span class=p>{</span>
                <span class=k>val</span> <span class=py>itemView</span> <span class=p>=</span> <span class=n>LayoutInflater</span><span class=p>.</span><span class=n>from</span><span class=p>(</span><span class=k>this</span><span class=n>@NestedScrollActivity</span><span class=p>).</span><span class=n>inflate</span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>simple_list_item_1</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=k>false</span><span class=p>)</span>
                <span class=k>return</span> <span class=n>Holder</span><span class=p>(</span><span class=n>itemView</span><span class=p>)</span>
            <span class=p>}</span>

            <span class=k>override</span> <span class=k>fun</span> <span class=nf>onBindViewHolder</span><span class=p>(</span><span class=n>holder</span><span class=p>:</span> <span class=n>Holder</span><span class=p>,</span> <span class=n>position</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>holder</span><span class=p>.</span><span class=n>textView</span><span class=p>.</span><span class=n>text</span> <span class=p>=</span> <span class=s>&quot;item $position&quot;</span>
            <span class=p>}</span>

            <span class=k>override</span> <span class=k>fun</span> <span class=nf>getItemCount</span><span class=p>()</span> <span class=p>=</span> <span class=m>100</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>class</span> <span class=nc>Holder</span><span class=p>(</span>
        <span class=n>itemView</span><span class=p>:</span> <span class=n>View</span>
    <span class=p>)</span> <span class=p>:</span> <span class=n>RecyclerView</span><span class=p>.</span><span class=n>ViewHolder</span><span class=p>(</span><span class=n>itemView</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>textView</span><span class=p>:</span> <span class=n>TextView</span> <span class=p>=</span> <span class=n>itemView</span><span class=p>.</span><span class=n>findViewById</span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=n>R</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>text1</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>最关键的自定义的LinearLayout代码如下：</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>NestedScrollingLinearLayout</span><span class=p>(</span>
    <span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span>
    <span class=n>attributeSet</span><span class=p>:</span> <span class=n>AttributeSet</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
<span class=p>)</span> <span class=p>:</span> <span class=n>LinearLayout</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>attributeSet</span><span class=p>),</span>
    <span class=n>NestedScrollingParent2</span> <span class=p>{</span>

    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>mHeader</span><span class=p>:</span> <span class=n>View</span>
    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>mTarget</span><span class=p>:</span> <span class=n>View</span>
    <span class=k>private</span> <span class=k>var</span> <span class=py>mHeaderHeight</span> <span class=p>=</span> <span class=m>0</span>

    <span class=k>private</span> <span class=k>val</span> <span class=py>mNestedScrollingParentHelper</span> <span class=k>by</span> <span class=n>lazy</span> <span class=p>{</span> <span class=n>NestedScrollingParentHelper</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onFinishInflate</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>super</span><span class=p>.</span><span class=n>onFinishInflate</span><span class=p>()</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>childCount</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>mHeader</span> <span class=p>=</span> <span class=n>getChildAt</span><span class=p>(</span><span class=m>0</span><span class=p>)</span>

            <span class=c1>// 遍历出RecyclerView</span>
            <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=k>in</span> <span class=m>0</span> <span class=n>until</span> <span class=n>childCount</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>getChildAt</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=k>is</span> <span class=n>RecyclerView</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>mTarget</span> <span class=p>=</span> <span class=n>getChildAt</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
                    <span class=k>break</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onMeasure</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=n>heightMeasureSpec</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>super</span><span class=p>.</span><span class=n>onMeasure</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=n>heightMeasureSpec</span><span class=p>)</span>
        <span class=n>mHeaderHeight</span> <span class=p>=</span> <span class=n>mHeader</span><span class=p>.</span><span class=n>measuredHeight</span>

        <span class=c1>// 需要正确的测量出RecyclerView在header折叠时的高度，不然ReclcyerView显示不全</span>
        <span class=n>mTarget</span><span class=p>.</span><span class=n>measure</span><span class=p>(</span>
            <span class=n>widthMeasureSpec</span><span class=p>,</span>
            <span class=n>MeasureSpec</span><span class=p>.</span><span class=n>makeMeasureSpec</span><span class=p>(</span>
                <span class=n>mHeaderHeight</span> <span class=p>+</span> <span class=n>mTarget</span><span class=p>.</span><span class=n>measuredHeight</span><span class=p>,</span>
                <span class=n>MeasureSpec</span><span class=p>.</span><span class=n>EXACTLY</span><span class=p>)</span>
        <span class=p>)</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onStartNestedScroll</span><span class=p>(</span><span class=n>child</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>target</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>axes</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=n>type</span><span class=p>:</span> <span class=n>Int</span><span class=p>):</span> <span class=n>Boolean</span> <span class=p>{</span>
        <span class=c1>// 允许竖直方向上的滑动</span>
        <span class=k>return</span> <span class=n>isEnabled</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=n>axes</span> <span class=n>and</span> <span class=n>ViewCompat</span><span class=p>.</span><span class=n>SCROLL_AXIS_VERTICAL</span> <span class=p>!=</span> <span class=m>0</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onNestedScrollAccepted</span><span class=p>(</span><span class=n>child</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>target</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>axes</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=n>type</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 代理给NestedScrollingParentHelper</span>
        <span class=n>mNestedScrollingParentHelper</span><span class=p>.</span><span class=n>onNestedScrollAccepted</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>axes</span><span class=p>,</span> <span class=n>type</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onNestedPreScroll</span><span class=p>(</span><span class=n>target</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>dx</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=n>dy</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=n>consumed</span><span class=p>:</span> <span class=n>IntArray</span><span class=p>,</span> <span class=n>type</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>onNestedPreScroll</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>dx</span><span class=p>,</span> <span class=n>dy</span><span class=p>,</span> <span class=n>consumed</span><span class=p>)</span>
        <span class=c1>// dy大于0说明在向上滑动，此时需要判断header是不是还能显示</span>
        <span class=k>val</span> <span class=py>canScrollUp</span> <span class=p>=</span> <span class=n>dy</span> <span class=p>&gt;</span> <span class=m>0</span> <span class=p>&amp;&amp;</span> <span class=n>mHeaderHeight</span> <span class=p>&gt;</span> <span class=n>scrollY</span>
        <span class=c1>// dy小于0说明在向下滑动，此时需要判断header是不是已经显示完整</span>
        <span class=k>val</span> <span class=py>canScrollDown</span> <span class=p>=</span> <span class=n>dy</span> <span class=p>&lt;</span> <span class=m>0</span> <span class=p>&amp;&amp;</span> <span class=n>scrollY</span> <span class=p>&gt;</span> <span class=m>0</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>canScrollUp</span> <span class=p>||</span> <span class=n>canScrollDown</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>scrollBy</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>dy</span><span class=p>)</span>
            <span class=n>consumed</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>dy</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onNestedScroll</span><span class=p>(</span>
        <span class=n>target</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span>
        <span class=n>dxConsumed</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
        <span class=n>dyConsumed</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
        <span class=n>dxUnconsumed</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
        <span class=n>dyUnconsumed</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
        <span class=n>type</span><span class=p>:</span> <span class=n>Int</span>
    <span class=p>)</span> <span class=p>{</span>
        <span class=n>onNestedScroll</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>dxConsumed</span><span class=p>,</span> <span class=n>dyConsumed</span><span class=p>,</span> <span class=n>dxUnconsumed</span><span class=p>,</span> <span class=n>dyUnconsumed</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onStopNestedScroll</span><span class=p>(</span><span class=n>target</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>type</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 代理给NestedScrollingParentHelper</span>
        <span class=n>mNestedScrollingParentHelper</span><span class=p>.</span><span class=n>onStopNestedScroll</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>type</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>scrollTo</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>clampY</span> <span class=p>=</span> <span class=n>max</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>min</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>mHeaderHeight</span><span class=p>))</span>
        <span class=k>super</span><span class=p>.</span><span class=n>scrollTo</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>clampY</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在自定义Parent时有一些坑</p> <ol> <li>让header显示缩小，有很多方式，这里采用了整体scroll的方法；scroll的时候需要判断y的值，要clamp在[0, mHeaderHeight]之间，不然dy一旦过大，就会导致header上边留白或者其他部位被scroll。</li> <li>测量时，需要注意正确测量出RecyclerView的高度，不然当header折叠时，RecyclerView没有占满剩余空间</li> <li>Parent最好实现<code>NestedScrollingParent2</code>接口，这样可以响应fling时的scroll事件，体验更好（对比图如下，注意最后一个fling事件）</li> </ol> <figure style="width: 50%" class="half align-center"> <img src=/assets/images/android/nestedscrolling-demo-v1.gif> <img src=/assets/images/android/nestedscrolling-demo-v2.gif> <center>NestedScrollingParent v1 & v2 实现效果</center> </figure> <hr> <div class=md-source-date> <small> 最后更新: 2020年3月13日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/other/nestedscrolling/";
      this.page.identifier =
        "/android/other/nestedscrolling/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> FloatingActionButton上滑隐藏下滑显示 </span> </div> </a> <a href=../porterduff/ title=使用Porter-Duff合成数字图像 class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> 使用Porter-Duff合成数字图像 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
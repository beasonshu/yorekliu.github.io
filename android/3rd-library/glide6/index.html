<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/3rd-library/glide6/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Glide v4 源码解析（六）</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - Glide v4 源码解析（六）"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/3rd-library/glide6/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - Glide v4 源码解析（六）"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1 tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> Glide v4 源码解析（六） </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1 checked> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Glide v4 源码解析（六） </label> <a href=./ title="Glide v4 源码解析（六）" class="md-nav__link md-nav__link--active"> Glide v4 源码解析（六） </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 准备工作 </a> </li> <li class=md-nav__item> <a href=#2-glide class=md-nav__link> 2. Glide初始化流程解析 </a> </li> <li class=md-nav__item> <a href=#3-kapt class=md-nav__link> 3. 探索kapt生成文件 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-excludes class=md-nav__link> 3.1 @Excludes </a> </li> <li class=md-nav__item> <a href=#32-glideextension class=md-nav__link> 3.2 @GlideExtension </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-applyoptions class=md-nav__link> 4. 使用applyOptions更改默认配置 </a> </li> <li class=md-nav__item> <a href=#5-registercomponentsglide class=md-nav__link> 5. 使用registerComponents扩展Glide功能 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 准备工作 </a> </li> <li class=md-nav__item> <a href=#2-glide class=md-nav__link> 2. Glide初始化流程解析 </a> </li> <li class=md-nav__item> <a href=#3-kapt class=md-nav__link> 3. 探索kapt生成文件 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-excludes class=md-nav__link> 3.1 @Excludes </a> </li> <li class=md-nav__item> <a href=#32-glideextension class=md-nav__link> 3.2 @GlideExtension </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-applyoptions class=md-nav__link> 4. 使用applyOptions更改默认配置 </a> </li> <li class=md-nav__item> <a href=#5-registercomponentsglide class=md-nav__link> 5. 使用registerComponents扩展Glide功能 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Glide v4 源码解析（六）</h1> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>本系列文章参考3.7.0版本的<a href=https://blog.csdn.net/sinyu890807/column/info/15318>guolin - Glide最全解析</a>，并按此思路结合4.9.0版本源码以及使用文档进行更新。<br> ➟ <a href=https://github.com/bumptech/glide/tree/v4.9.0>Glide v4.9.0</a><br> ➟ <a href=https://muyangmin.github.io/glide-docs-cn/ >中文文档</a><br> ➟ <a href=https://bumptech.github.io/glide/ >英文文档</a>🚀🚀 </p> </div> <div class="admonition note"> <p class=admonition-title>Glide系列文章目录</p> <ul> <li><a href=/android/3rd-library/glide1/ >Glide1——Glide v4 的基本使用</a></li> <li><a href=/android/3rd-library/glide2/ >Glide2——从源码的角度理解Glide三步的执行流程</a></li> <li><a href=/android/3rd-library/glide3/ >Glide3——深入探究Glide缓存机制</a></li> <li><a href=/android/3rd-library/glide4/ >Glide4——RequestBuilder中高级点的API以及Target</a></li> <li><a href=/android/3rd-library/glide5/ >Glide5——Glide内置的transform以及自定义BitmapTransformation</a></li> <li><a href=/android/3rd-library/glide6/ >Glide6——Glide利用AppGlideModule、LibraryGlideModule更改默认配置、扩展Glide功能；GlideApp与Glide的区别在哪？</a></li> <li><a href=/android/3rd-library/glide7/ >Glide7——利用OkHttp、自定义Drawable、自定义ViewTarget实现带进度的图片加载功能</a></li> <li><a href=/android/3rd-library/migrate-to-glide/ >杂记：从Picasso迁移至Glide</a></li> </ul> </div> <hr> <p>本章的主角是<code>AppGlideModule</code>，全文围绕它的两个方法：</p> <ol> <li>负责改变Glide默认配置（比如磁盘、内存缓存的大小和位置等）的<code>applyOptions</code>方法</li> <li>以及负责扩展Glide功能的<code>registerComponents</code>方法</li> </ol> <p>相关文档来自<a href=http://bumptech.github.io/glide/doc/generatedapi.html#generated-api>Generated API</a>和<a href=http://bumptech.github.io/glide/doc/configuration.html>Configuration</a>。</p> <h2 id=1>1. 准备工作<a class=headerlink href=#1 title="Permanent link">&para;</a></h2> <p>在正式开始之前我们需要确保已经开启了这个功能，如果我们已经kapt了glide的complier，那么可以继承<code>AppGlideModule</code>抽象类并给该类打上<code>@GlideModule</code>注解：</p> <div class=codehilite><pre><span></span><span class=n>@GlideModule</span>
<span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>isManifestParsingEnabled</span><span class=p>()</span> <span class=p>=</span> <span class=k>super</span><span class=p>.</span><span class=n>isManifestParsingEnabled</span><span class=p>()</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{}</span>
<span class=p>}</span>
</pre></div> <p>这样在我们rebuild代码后，会生成一个<code>GeneratedAppGlideModuleImpl</code>类，然后Glide初始化的时候会反射实例化该类，并调用该类的<code>isManifestParsingEnabled</code>、<code>applyOptions</code>、<code>registerComponents</code>方法。<br> 上面的代码中，这三个方法都有默认实现，所以这里的<code>MyAppGlideModule</code>也可以这样：</p> <div class=codehilite><pre><span></span><span class=n>@GlideModule</span>
<span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span>
</pre></div> <p>annotation processor的入口代码为<a href=https://github.com/bumptech/glide/blob/v4.9.0/annotation/compiler/src/main/java/com/bumptech/glide/annotation/compiler/GlideAnnotationProcessor.java>GlideAnnotationProcessor.java</a>，不过这部分代码不是重点，我们只需要看processor生成的代码就够了。</p> <p><code>AppGlideModule</code>的两个重要方法其实是<code>AppliesOptions</code>、<code>RegistersComponents</code>两个接口提供的，但是<code>AppGlideModule</code>离<code>RegistersComponents</code>隔了一个抽象类<code>LibraryGlideModule</code>。 </p> <p>这两个货的差别在哪？<code>LibraryGlideModule</code>只实现了<code>RegistersComponents</code>接口，是专门为库准备的。而<code>AppGlideModule</code>显然就是为App准备的。</p> <blockquote> <p>Libraries must <strong>not</strong> include <code>AppGlideModule</code> implementations. Doing so will prevent any applications that depend on the library from managing their dependencies or configuring options like Glide’s cache sizes and locations.<br> In addition, if two libraries include <code>AppGlideModules</code>, applications will be unable to compile if they depend on both and will be forced to pick one or other other.<br> This does mean that libraries won’t be able to use Glide’s generated API, but loads with the standard <code>RequestBuilder</code> and <code>RequestOptions</code> will still work just fine (see the <a href=http://bumptech.github.io/glide/doc/options.html>options page</a> for examples).<br> <cite><a href=http://bumptech.github.io/glide/doc/configuration.html#avoid-appglidemodule-in-libraries>Avoid AppGlideModule in libraries</a></cite></p> </blockquote> <p>显然，Glide这么设计的原因，就是担心使用了Glide的library使宿主app的配置不生效。且如果存在两个这样的library，可能编译失败，然后将被强制选择一个。</p> <p><code>AppGlideModule</code>的相关UML图如下：</p> <figure style="width: 80%" class=align-center> <img src=/assets/images/android/glide-glide-module-uml.png> <figcaption>AppGlideModule的相关UML图</figcaption> </figure> <p>相当清晰，相当了然。等等，这里突然冒出了一个<code>GlideModule</code>。这是Glide v3的<code>AppGlideModule</code>，又或者说<code>AppGlideModule</code>是Glide v3 <code>GlideModule</code>的改良。注意，在UML图中可以看出<code>GlideModule</code>与<code>AppGlideModule</code>、<code>LibraryGlideModule</code>之间没有直接关系。</p> <p>在Glide v3中，需要在<code>AndroidManifest.xml</code>文件中通过<code>meta-data</code>进行配置：</p> <div class=codehilite><pre><span></span><span class=nt>&lt;application</span>
    <span class=err>...</span><span class=nt>&gt;</span>

    <span class=nt>&lt;meta-data</span>
        <span class=na>android:name=</span><span class=s>&quot;yorek.demoandtest.glide.MyGlideModule&quot;</span>
        <span class=na>android:value=</span><span class=s>&quot;GlideModule&quot;</span> <span class=nt>/&gt;</span>

    <span class=nt>&lt;activity</span> <span class=err>...</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;/application&gt;</span>
</pre></div> <p><code>yorek.demoandtest.glide.MyGlideModule</code>代码如下：</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>MyGlideModule</span> <span class=p>:</span> <span class=n>GlideModule</span> <span class=p>{</span>
   <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{}</span>
   <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{}</span>
<span class=p>}</span>
</pre></div> <p>由于现在已经是Glide v4的时代了，所以<code>GlideModule</code>已经被标记为<code>@Deprecated</code>，顺便接口<code>RegistersComponents</code>、<code>AppliesOptions</code>也被标记为<code>@Deprecated</code>了。且<code>AppGlideModule</code>中的<code>isManifestParsingEnabled</code>方法就是控制Glide是否需要从<code>AndroidManifest</code>中解析<code>GlideModule</code>。</p> <h2 id=2-glide>2. Glide初始化流程解析<a class=headerlink href=#2-glide title="Permanent link">&para;</a></h2> <p>在经过第1小节之后，我们已经初步了解了GlideModule。现在我们看看Glide到底以怎样的顺序来应用这些GlideModule的。</p> <p>相关源码其实在<a href=/android/3rd-library/glide2/#11-getretrievercontext>Glide2——从源码的角度理解Glide三步的执行流程</a>中提到过。调用<code>Glide.with</code>方法就会完成Glide单例的创建，代码在<code>initializeGlide</code>方法中。该方法的作用就是获取各种GlideModule，并调用对应的方法。</p> <div class=codehilite><pre><span></span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>();</span>
  <span class=c1>// 如果有配置@GlideModule注解，那么会反射构造kapt生成的GeneratedAppGlideModuleImpl类</span>
  <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span> <span class=o>=</span> <span class=n>getAnnotationGeneratedGlideModules</span><span class=p>();</span>
  <span class=c1>// 如果Impl存在，且允许解析manifest文件</span>
  <span class=c1>// 则遍历manifest中的meta-data，解析出所有的GlideModule类</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>manifestModules</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>isManifestParsingEnabled</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>manifestModules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ManifestParser</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>).</span><span class=na>parse</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// 根据Impl的黑名单，剔除manifest中的GlideModule类</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>().</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedModuleClasses</span> <span class=o>=</span>
        <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>();</span>
    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>manifestModules</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>current</span> <span class=o>=</span> <span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>excludedModuleClasses</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span> <span class=p>{</span>
        <span class=k>continue</span><span class=p>;</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;AppGlideModule excludes manifest GlideModule: &quot;</span> <span class=o>+</span> <span class=n>current</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=n>iterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>glideModule</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Discovered GlideModule from manifest: &quot;</span> <span class=o>+</span> <span class=n>glideModule</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// 如果Impl存在，那么设置为该类的RequestManagerFactory； 否则，设置为null</span>
  <span class=c1>// Impl的getRequestManagerFactory()方法默认会返回kapt生成的GeneratedRequestManagerFactory对象</span>
  <span class=c1>// 此对象的build方法就是直接new一个GlideRequests</span>
  <span class=n>RequestManagerRetriever</span><span class=p>.</span><span class=na>RequestManagerFactory</span> <span class=n>factory</span> <span class=o>=</span>
      <span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
          <span class=o>?</span> <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getRequestManagerFactory</span><span class=p>()</span> <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
  <span class=n>builder</span><span class=p>.</span><span class=na>setRequestManagerFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span>
  <span class=c1>// 依次调用manifest中GlideModule类的applyOptions方法，将配置写到builder里</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>module</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>builder</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// 写入Impl的配置</span>
  <span class=c1>// 也就是说Impl配置的优先级更高，如果有冲突的话</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>builder</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// 调用GlideBuilder.build方法创建Glide</span>
  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span>
  <span class=c1>// 依次调用manifest中GlideModule类的registerComponents方法，来替换Glide的默认配置</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>module</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// 调用Impl中替换Glide配置的方法</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// 注册内存管理的回调，因为Glide实现了ComponentCallbacks2接口</span>
  <span class=n>applicationContext</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=n>glide</span><span class=p>);</span>
  <span class=c1>// 保存glide实例到静态变量中</span>
  <span class=n>Glide</span><span class=p>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在上面的<code>initializeGlide</code>方法没有什么难度，注意一下<code>@GlideModule</code>注解修饰的类的优先级高于meta-data的配置的类。</p> <p>下面贴一下反射构造<code>GeneratedAppGlideModuleImpl</code>对象的<code>getAnnotationGeneratedGlideModules()</code>方法和从<code>AndroidManifest</code>中解析meta-data的<code>ManifestParser</code>对象：</p> <figcaption>反射构造GeneratedAppGlideModuleImpl对象的getAnnotationGeneratedGlideModules()方法</figcaption> <div class=codehilite><pre><span></span><span class=nd>@Nullable</span>
<span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&quot;unchecked&quot;</span><span class=p>,</span> <span class=s>&quot;deprecation&quot;</span><span class=p>,</span> <span class=s>&quot;TryWithIdenticalCatches&quot;</span><span class=p>})</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=n>GeneratedAppGlideModule</span> <span class=nf>getAnnotationGeneratedGlideModules</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>GeneratedAppGlideModule</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=k>try</span> <span class=p>{</span>
        <span class=n>Class</span><span class=o>&lt;</span><span class=n>GeneratedAppGlideModule</span><span class=o>&gt;</span> <span class=n>clazz</span> <span class=o>=</span>
            <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>GeneratedAppGlideModule</span><span class=o>&gt;</span><span class=p>)</span>
                <span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&quot;com.bumptech.glide.GeneratedAppGlideModuleImpl&quot;</span><span class=p>);</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>clazz</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>().</span><span class=na>newInstance</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>WARN</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Failed to find GeneratedAppGlideModule. You should include an&quot;</span>
            <span class=o>+</span> <span class=s>&quot; annotationProcessor compile dependency on com.github.bumptech.glide:compiler&quot;</span>
            <span class=o>+</span> <span class=s>&quot; in your application and a @GlideModule annotated AppGlideModule implementation or&quot;</span>
            <span class=o>+</span> <span class=s>&quot; LibraryGlideModules will be silently ignored&quot;</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=c1>// These exceptions can&#39;t be squashed across all versions of Android.</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InstantiationException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>throwIncorrectGlideModule</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IllegalAccessException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>throwIncorrectGlideModule</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>NoSuchMethodException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>throwIncorrectGlideModule</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InvocationTargetException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>throwIncorrectGlideModule</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>throwIncorrectGlideModule</span><span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;GeneratedAppGlideModuleImpl is implemented incorrectly.&quot;</span>
        <span class=o>+</span> <span class=s>&quot; If you&#39;ve manually implemented this class, remove your implementation. The Annotation&quot;</span>
        <span class=o>+</span> <span class=s>&quot; processor will generate a correct implementation.&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <figcaption>从AndroidManifest中解析meta-data的ManifestParser对象</figcaption> <div class=codehilite><pre><span></span><span class=nd>@Deprecated</span>
<span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ManifestParser</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&quot;ManifestParser&quot;</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>GLIDE_MODULE_VALUE</span> <span class=o>=</span> <span class=s>&quot;GlideModule&quot;</span><span class=p>;</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span><span class=p>;</span>

  <span class=kd>public</span> <span class=nf>ManifestParser</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>context</span> <span class=o>=</span> <span class=n>context</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
  <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>GlideModule</span><span class=o>&gt;</span> <span class=nf>parse</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Loading Glide modules&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>GlideModule</span><span class=o>&gt;</span> <span class=n>modules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>ApplicationInfo</span> <span class=n>appInfo</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>()</span>
          <span class=p>.</span><span class=na>getApplicationInfo</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>(),</span> <span class=n>PackageManager</span><span class=p>.</span><span class=na>GET_META_DATA</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>appInfo</span><span class=p>.</span><span class=na>metaData</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
          <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Got null app info metadata&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>modules</span><span class=p>;</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Got app info metadata: &quot;</span> <span class=o>+</span> <span class=n>appInfo</span><span class=p>.</span><span class=na>metaData</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>key</span> <span class=p>:</span> <span class=n>appInfo</span><span class=p>.</span><span class=na>metaData</span><span class=p>.</span><span class=na>keySet</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>GLIDE_MODULE_VALUE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>appInfo</span><span class=p>.</span><span class=na>metaData</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>)))</span> <span class=p>{</span>
          <span class=n>modules</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>parseModule</span><span class=p>(</span><span class=n>key</span><span class=p>));</span>
          <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
            <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Loaded Glide module: &quot;</span> <span class=o>+</span> <span class=n>key</span><span class=p>);</span>
          <span class=p>}</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>PackageManager</span><span class=p>.</span><span class=na>NameNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=s>&quot;Unable to find metadata to parse GlideModules&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Finished loading Glide modules&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>modules</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=n>GlideModule</span> <span class=nf>parseModule</span><span class=p>(</span><span class=n>String</span> <span class=n>className</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span><span class=p>;</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>clazz</span> <span class=o>=</span> <span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>className</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unable to find GlideModule implementation&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>Object</span> <span class=n>module</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>module</span> <span class=o>=</span> <span class=n>clazz</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>().</span><span class=na>newInstance</span><span class=p>();</span>
    <span class=c1>// These can&#39;t be combined until API minimum is 19.</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InstantiationException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>throwInstantiateGlideModuleException</span><span class=p>(</span><span class=n>clazz</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IllegalAccessException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>throwInstantiateGlideModuleException</span><span class=p>(</span><span class=n>clazz</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>NoSuchMethodException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>throwInstantiateGlideModuleException</span><span class=p>(</span><span class=n>clazz</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InvocationTargetException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>throwInstantiateGlideModuleException</span><span class=p>(</span><span class=n>clazz</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>module</span> <span class=k>instanceof</span> <span class=n>GlideModule</span><span class=p>))</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=s>&quot;Expected instanceof GlideModule, but found: &quot;</span> <span class=o>+</span> <span class=n>module</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>GlideModule</span><span class=p>)</span> <span class=n>module</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>throwInstantiateGlideModuleException</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span><span class=p>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=s>&quot;Unable to instantiate GlideModule implementation for &quot;</span> <span class=o>+</span> <span class=n>clazz</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>上面两段代码都很简单，不做过多赘述。<br> Glide的创建发生在<code>applyOptions</code>之后，<code>registerComponents</code>之后。也好理解，因为<code>applyOptions</code>是更改配置，肯定是初始化时就要确定的；而<code>registerComponents</code>针对的运行时的功能扩展，而且需要调用<code>Glide</code>对象的方法，所以在Glide创建之后调用。</p> <p>在<code>initializeGlide</code>方法的第54行中调用了<code>builder.build(applicationContext)</code>方法创建了<code>Glide</code>对象。我们看看<code>GlideBuilder.build</code>方法：</p> <div class=codehilite><pre><span></span><span class=nd>@NonNull</span>
<span class=n>Glide</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>sourceExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>sourceExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newSourceExecutor</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>diskCacheExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newDiskCacheExecutor</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>animationExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>animationExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newAnimationExecutor</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>memorySizeCalculator</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>memorySizeCalculator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MemorySizeCalculator</span><span class=p>.</span><span class=na>Builder</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>build</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>connectivityMonitorFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>connectivityMonitorFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultConnectivityMonitorFactory</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>bitmapPool</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getBitmapPoolSize</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>bitmapPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruBitmapPool</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>bitmapPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapPoolAdapter</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>arrayPool</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>arrayPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruArrayPool</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getArrayPoolSizeInBytes</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getMemoryCacheSize</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>engine</span> <span class=o>=</span>
            <span class=k>new</span> <span class=n>Engine</span><span class=p>(</span>
                <span class=n>memoryCache</span><span class=p>,</span>
                <span class=n>diskCacheFactory</span><span class=p>,</span>
                <span class=n>diskCacheExecutor</span><span class=p>,</span>
                <span class=n>sourceExecutor</span><span class=p>,</span>
                <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newUnlimitedSourceExecutor</span><span class=p>(),</span>
                <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newAnimationExecutor</span><span class=p>(),</span>
                <span class=n>isActiveResourceRetentionAllowed</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>defaultRequestListeners</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>defaultRequestListeners</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>defaultRequestListeners</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>defaultRequestListeners</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>RequestManagerRetriever</span> <span class=n>requestManagerRetriever</span> <span class=o>=</span>
        <span class=k>new</span> <span class=n>RequestManagerRetriever</span><span class=p>(</span><span class=n>requestManagerFactory</span><span class=p>);</span>

    <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=p>(</span>
        <span class=n>context</span><span class=p>,</span>
        <span class=n>engine</span><span class=p>,</span>
        <span class=n>memoryCache</span><span class=p>,</span>
        <span class=n>bitmapPool</span><span class=p>,</span>
        <span class=n>arrayPool</span><span class=p>,</span>
        <span class=n>requestManagerRetriever</span><span class=p>,</span>
        <span class=n>connectivityMonitorFactory</span><span class=p>,</span>
        <span class=n>logLevel</span><span class=p>,</span>
        <span class=n>defaultRequestOptions</span><span class=p>.</span><span class=na>lock</span><span class=p>(),</span>
        <span class=n>defaultTransitionOptions</span><span class=p>,</span>
        <span class=n>defaultRequestListeners</span><span class=p>,</span>
        <span class=n>isLoggingRequestOriginsEnabled</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>可以看到，<code>build</code>方法基本对每一个参数都进行了<code>null</code>判断，如果为<code>null</code>则使用默认的参数。那么，这些参数什么时候不为空呢？当在<code>AppliesOptions</code>接口的实现（也就是各种GlideModule）中通过传入参数<code>GlideBuilder</code>来设置后，这里build时就不会为null了。</p> <p>比如，我们可以在<code>MyAppGlideModule</code>中调用<code>GlideBuilder.setDiskCache</code>来使<code>diskCacheFactory</code>为我们指定的值，下面的代码可以将Glide磁盘缓存位置换到externalCacheDir中。</p> <div class=codehilite><pre><span></span><span class=nd>@GlideModule</span>
<span class=kd>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>override</span> <span class=n>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>builder</span><span class=p>.</span><span class=na>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>Glide v4中默认的图片格式是ARGB_8888，可以通过<code>BaseRequestOptions.format</code>方法来指定为RGB_565或ARGB_8888格式——<a href=http://bumptech.github.io/glide/doc/migrating.html#decodeformat>DecodeFormat</a>。</p> <h2 id=3-kapt>3. 探索kapt生成文件<a class=headerlink href=#3-kapt title="Permanent link">&para;</a></h2> <p>为了更好的看到<code>Glide</code>中annotation processor的作用，我们先<code>AppGlideModule</code>、<code>LibraryGlideModule</code>以及<code>GlideModule</code>各来一个：</p> <div class=codehilite><pre><span></span><span class=n>@GlideModule</span>
<span class=n>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=p>[</span><span class=n>MyGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>])</span>
<span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span>

<span class=n>@GlideModule</span>
<span class=k>class</span> <span class=nc>MyLibraryGlideModule</span> <span class=p>:</span> <span class=n>LibraryGlideModule</span><span class=p>()</span>

<span class=k>class</span> <span class=nc>MyGlideModule</span> <span class=p>:</span> <span class=n>GlideModule</span> <span class=p>{</span>
    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{}</span>
<span class=p>}</span>
</pre></div> <p>在AndroidManifest文件中配置好<code>MyGlideModule</code>之后，我们先rebuild一下，看一下生成的<code>GeneratedAppGlideModuleImpl</code>文件：</p> <div class=codehilite><pre><span></span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=kd>final</span> <span class=kd>class</span> <span class=nc>GeneratedAppGlideModuleImpl</span> <span class=kd>extends</span> <span class=n>GeneratedAppGlideModule</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>MyAppGlideModule</span> <span class=n>appGlideModule</span><span class=p>;</span>

  <span class=n>GeneratedAppGlideModuleImpl</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>appGlideModule</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MyAppGlideModule</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=s>&quot;Glide&quot;</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&quot;Glide&quot;</span><span class=p>,</span> <span class=s>&quot;Discovered AppGlideModule from annotation: yorek.demoandtest.glide.MyAppGlideModule&quot;</span><span class=p>);</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&quot;Glide&quot;</span><span class=p>,</span> <span class=s>&quot;Discovered LibraryGlideModule from annotation: yorek.demoandtest.glide.MyLibraryGlideModule&quot;</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>appGlideModule</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>builder</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
      <span class=nd>@NonNull</span> <span class=n>Registry</span> <span class=n>registry</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>new</span> <span class=n>MyLibraryGlideModule</span><span class=p>().</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>);</span>
    <span class=n>appGlideModule</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isManifestParsingEnabled</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>appGlideModule</span><span class=p>.</span><span class=na>isManifestParsingEnabled</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=nd>@NonNull</span>
  <span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getExcludedModuleClasses</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>Collections</span><span class=p>.</span><span class=na>emptySet</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=nd>@NonNull</span>
  <span class=n>GeneratedRequestManagerFactory</span> <span class=nf>getRequestManagerFactory</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>GeneratedRequestManagerFactory</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>代码很简单，属于<code>AppGlideModule</code>的三个方法基本都是调用的<code>MyAppGlideModule</code>的三个方法。在此基础上，每个<code>LibraryGlideModule</code>的<code>registerComponents</code>方法都会在<code>GeneratedAppGlideModuleImpl.registerComponents</code>方法中被调用。 </p> <p>另外，我们关注一下最后两个方法，这两个方法都是基类<code>GeneratedAppGlideModule</code>额外提供了的，代码如下所示：</p> <div class=codehilite><pre><span></span><span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>GeneratedAppGlideModule</span> <span class=kd>extends</span> <span class=n>AppGlideModule</span> <span class=p>{</span>
  <span class=cm>/**</span>
<span class=cm>   * This method can be removed when manifest parsing is no longer supported.</span>
<span class=cm>   */</span>
  <span class=nd>@NonNull</span>
  <span class=kd>abstract</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getExcludedModuleClasses</span><span class=p>();</span>

  <span class=nd>@Nullable</span>
  <span class=n>RequestManagerRetriever</span><span class=p>.</span><span class=na>RequestManagerFactory</span> <span class=nf>getRequestManagerFactory</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>getRequestManagerFactory</code>在子类的实现是固定的，就是<code>return new GeneratedRequestManagerFactory();</code>。annotation compiler的代码在<a href=https://github.com/bumptech/glide/blob/v4.9.0/annotation/compiler/src/main/java/com/bumptech/glide/annotation/compiler/AppModuleGenerator.java#L154>AppModuleGenerator.java#L154</a>：</p> <div class=codehilite><pre><span></span><span class=n>ClassName</span> <span class=n>generatedRequestManagerFactoryClassName</span> <span class=o>=</span>
    <span class=n>ClassName</span><span class=p>.</span><span class=na>get</span><span class=p>(</span>
        <span class=n>RequestManagerFactoryGenerator</span><span class=p>.</span><span class=na>GENERATED_REQUEST_MANAGER_FACTORY_PACKAGE_NAME</span><span class=p>,</span>
        <span class=n>RequestManagerFactoryGenerator</span><span class=p>.</span><span class=na>GENERATED_REQUEST_MANAGER_FACTORY_SIMPLE_NAME</span><span class=p>);</span>

<span class=n>builder</span><span class=p>.</span><span class=na>addMethod</span><span class=p>(</span>
    <span class=n>MethodSpec</span><span class=p>.</span><span class=na>methodBuilder</span><span class=p>(</span><span class=s>&quot;getRequestManagerFactory&quot;</span><span class=p>)</span>
        <span class=p>.</span><span class=na>addAnnotation</span><span class=p>(</span><span class=n>Override</span><span class=p>.</span><span class=na>class</span><span class=p>)</span>
        <span class=p>.</span><span class=na>addAnnotation</span><span class=p>(</span><span class=n>nonNull</span><span class=p>())</span>
        <span class=p>.</span><span class=na>returns</span><span class=p>(</span><span class=n>generatedRequestManagerFactoryClassName</span><span class=p>)</span>
        <span class=p>.</span><span class=na>addStatement</span><span class=p>(</span><span class=s>&quot;return new $T()&quot;</span><span class=p>,</span> <span class=n>generatedRequestManagerFactoryClassName</span><span class=p>)</span>
        <span class=p>.</span><span class=na>build</span><span class=p>());</span>
</pre></div> <h3 id=31-excludes><a href=http://bumptech.github.io/glide/doc/configuration.html#conflicts>3.1 @Excludes</a><a class=headerlink href=#31-excludes title="Permanent link">&para;</a></h3> <p><code>GeneratedAppGlideModuleImpl.getExcludedModuleClasses()</code>的实现，与<code>@Excludes</code>注解有关，使用该注解可以让Glide忽略指定的<code>GlideModule</code>或<code>LibraryGlideModule</code>。<code>@Excludes</code>注解只能用在<code>AppGlideModules</code>上，下面的例子将会让Glide忽略掉<code>MyLibraryGlideModule</code>、<code>MyGlideModule</code>的配置：</p> <div class=codehilite><pre><span></span><span class=nd>@GlideModule</span>
<span class=nd>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>[</span><span class=n>MyLibraryGlideModule</span><span class=p>::</span><span class=n>class</span><span class=p>,</span> <span class=n>MyGlideModule</span><span class=p>::</span><span class=n>class</span><span class=o>]</span><span class=p>)</span>
<span class=kd>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span>
</pre></div> <p>此时rebuild之后，生成的<code>GeneratedAppGlideModuleImpl</code>文件的相关方法如下：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Registry</span> <span class=n>registry</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 注意，没有new MyLibraryGlideModule().registerComponents(context, glide, registry);了</span>
    <span class=n>appGlideModule</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getExcludedModuleClasses</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=p>();</span>
    <span class=n>excludedClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>yorek</span><span class=p>.</span><span class=na>demoandtest</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>MyGlideModule</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
    <span class=n>excludedClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>yorek</span><span class=p>.</span><span class=na>demoandtest</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>MyLibraryGlideModule</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>excludedClasses</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>然后在Glide初始化的时候，在方法返回结果set里面的GlideModule将会从集合中移除。</p> <h3 id=32-glideextension><a href=http://bumptech.github.io/glide/doc/generatedapi.html#glideextension>3.2 @GlideExtension</a><a class=headerlink href=#32-glideextension title="Permanent link">&para;</a></h3> <p><code>@GlideExtension</code>注解修饰的类可以扩展Glide的API。该类必须是工具类的形式，里面的方法必须都是静态的，除了私有的空实现的构造器。 </p> <p>Application可以实现多个<code>@GlideExtension</code>注解类，Library也可以实现任意数量的<code>@GlideExtension</code>注解类。Glide在编译时，一旦发现一个<code>AppGlideModule</code>，所有可用的<code>GlideExtension</code>都会合并，并生成单个的API文件。任何冲突都会导致Glide注解生成器的编译错误。</p> <p>GlideExtension注解类可以定义两种扩展方法：</p> <ol> <li><code>@GlideOption</code>——为<code>RequestOptions</code>添加自定义的配置，扩展<code>RequestOptions</code>的静态方法。常见作用有：</li> <li>定义在整个应用程序中经常使用的一组选项</li> <li> <p>添加新选项，通常与Glide的<a href=http://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/Option.html>com.bumptech.glide.load.Option</a>一起使用。</p> </li> <li> <p><code>@GlideType</code>——为新资源类型（GIFs、SVG等）添加支持，扩展<code>RequestManager</code>的静态方法</p> </li> </ol> <p>下面的来自于官方文档<a href=http://bumptech.github.io/glide/doc/generatedapi.html#glideextension>GlideExtension</a>的示例：</p> <div class=codehilite><pre><span></span><span class=n>@GlideExtension</span>
<span class=k>object</span> <span class=nc>MyAppExtension</span> <span class=p>{</span>
    <span class=c1>// Size of mini thumb in pixels.</span>
    <span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>MINI_THUMB_SIZE</span> <span class=p>=</span> <span class=m>100</span>

    <span class=k>private</span> <span class=k>val</span> <span class=py>DECODE_TYPE_GIF</span> <span class=p>=</span> <span class=n>RequestOptions</span><span class=p>.</span><span class=n>decodeTypeOf</span><span class=p>(</span><span class=n>GifDrawable</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>).</span><span class=n>lock</span><span class=p>()</span>

    <span class=n>@GlideOption</span>
    <span class=n>@JvmStatic</span>
    <span class=k>fun</span> <span class=nf>miniThumb</span><span class=p>(</span><span class=n>options</span><span class=p>:</span> <span class=n>BaseRequestOptions</span><span class=p>&lt;*&gt;):</span> <span class=n>BaseRequestOptions</span><span class=p>&lt;*&gt;</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>options</span>
            <span class=p>.</span><span class=n>fitCenter</span><span class=p>()</span>
            <span class=p>.</span><span class=k>override</span><span class=p>(</span><span class=n>MINI_THUMB_SIZE</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=n>@GlideType</span><span class=p>(</span><span class=n>GifDrawable</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
    <span class=n>@JvmStatic</span>
    <span class=k>fun</span> <span class=nf>asGifTest</span><span class=p>(</span><span class=n>requestBuilder</span><span class=p>:</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>GifDrawable</span><span class=p>&gt;):</span> <span class=n>RequestBuilder</span><span class=p>&lt;</span><span class=n>GifDrawable</span><span class=p>&gt;</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>requestBuilder</span>
            <span class=p>.</span><span class=n>transition</span><span class=p>(</span><span class=n>DrawableTransitionOptions</span><span class=p>())</span>
            <span class=p>.</span><span class=n>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>这里为<code>RequestOptions</code>扩展了<code>miniThumb</code>方法，为<code>RequestManager</code>扩展了<code>asGifTest</code>方法。所以我们可以这样使用：</p> <div class=codehilite><pre><span></span><span class=n>GlideApp</span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
    <span class=p>.</span><span class=n>asGifTest</span><span class=p>()</span>
    <span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span>
    <span class=p>.</span><span class=n>miniThumb</span><span class=p>()</span>
    <span class=p>.</span><span class=n>into</span><span class=p>(</span><span class=n>ivGlide1</span><span class=p>)</span>
</pre></div> <p>注意这里使用的不再是<code>Glide</code>，而是<code>GlideApp</code>。<code>GlideApp</code>是专门用来处理这种扩展API的。 </p> <p>在Glide初始化的时候，会将<code>GeneratedAppGlideModuleImpl.getRequestManagerFactory()</code>方法返回的<code>GeneratedRequestManagerFactory</code>作为<code>requestManagerFactory</code>参数，这样创建<code>RequestManager</code>时都会调用<code>GeneratedRequestManagerFactory.build</code>方法生成<code>GlideRequests</code>。 </p> <p><code>GlideRequests</code>继承至<code>RequestManager</code>，里面包含了<code>@GlideType</code>注解修饰的API：</p> <p><strong>GlideRequests.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GlideRequests</span> <span class=kd>extends</span> <span class=n>RequestManager</span> <span class=p>{</span>
  <span class=kd>public</span> <span class=nf>GlideRequests</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=p>,</span>
                       <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>treeNode</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>super</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span> <span class=n>lifecycle</span><span class=p>,</span> <span class=n>treeNode</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=cm>/**</span>
<span class=cm>   * @see MyAppExtension#asGifTest(RequestBuilder)</span>
<span class=cm>   */</span>
  <span class=nd>@NonNull</span>
  <span class=nd>@CheckResult</span>
  <span class=kd>public</span> <span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGifTest</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>MyAppExtension</span><span class=p>.</span><span class=na>asGifTest</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=p>}</span>
</pre></div> <p><code>GlideRequest</code>则继承至<code>RequestBuilder</code>，包含了<code>@GlideOption</code>提供的API：</p> <p><strong>GlideRequest.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GlideRequest</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Cloneable</span> <span class=p>{</span>
  <span class=cm>/**</span>
<span class=cm>   * @see MyAppExtension#miniThumb(BaseRequestOptions)</span>
<span class=cm>   */</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
  <span class=nd>@CheckResult</span>
  <span class=nd>@NonNull</span>
  <span class=kd>public</span> <span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>miniThumb</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>MyAppExtension</span><span class=p>.</span><span class=na>miniThumb</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>此外，如果需要使用到<code>RequestOptions</code>，要使用Generated API生成的<code>GlideOptions</code>。</p> <p>总的来说，如果想使用Generated API，注意一下三个类的关系</p> <ul> <li><code>RequestManager</code> -&gt; <code>GlideRequests</code></li> <li><code>RequestBuilder</code> -&gt; <code>GlideRequest</code></li> <li><code>RequestOptions</code> -&gt; <code>GlideOptions</code></li> </ul> <p>OK，理论知识到这为止，下面的两节为<code>AppGlideModule</code>的两个方法的应用。</p> <h2 id=4-applyoptions>4. 使用applyOptions更改默认配置<a class=headerlink href=#4-applyoptions title="Permanent link">&para;</a></h2> <p>使用<code>applyOptions</code>更改默认配置主要通过<code>GlideBuilder</code>的一些set方法实现的，这里我们演示一个易验证的配置——<code>diskCacheFactory</code>：</p> <div class=codehilite><pre><span></span><span class=n>@GlideModule</span>
<span class=n>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=p>[</span><span class=n>MyLibraryGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>MyGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>])</span>
<span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>ExternalPreferredCacheDiskCacheFactory</code>是<code>ExternalCacheDiskCacheFactory</code>的替代类。 <code>ExternalCacheDiskCacheFactory</code>的存储路径为<code>${getExternalCacheDir()}/image_manager_disk_cache</code>。而<code>ExternalPreferredCacheDiskCacheFactory</code>的改进在于，如果外置存储不可用，会fallback到内置存储。</p> <p>我们卸载app后重新运行，并加载图片，然后可以在<code>${getExternalCacheDir()}/image_manager_disk_cache</code>目录下找到缓存的图片了。</p> <figure style="width: 30%" class=align-center> <img src=/assets/images/android/glide-external-disk-cache.png> <figcaption>Glide外置磁盘缓存</figcaption> </figure> <h2 id=5-registercomponentsglide>5. 使用registerComponents扩展Glide功能<a class=headerlink href=#5-registercomponentsglide title="Permanent link">&para;</a></h2> <p><code>registerComponents</code>能让我们扩展Glide的功能，这个功能比较高级，而且难度也比较大。正确的实现此方法，需要我们了解一下Glide内部各种Registry。</p> <blockquote> <p>Both Applications and Libraries can register a number of components that extend Glides functionality. Available components include:<br> 1. <code>ModelLoader</code>s to load custom Models (Urls, Uris, arbitrary POJOs) and Data (InputStreams, FileDescriptors). 2. <code>ResourceDecoder</code>s to decode new Resources (Drawables, Bitmaps) or new types of Data (InputStreams, FileDescriptors). 3. <code>Encoder</code>s to write Data (InputStreams, FileDescriptors) to Glide’s disk cache. 4. <code>ResourceTranscoder</code>s to convert Resources (BitmapResource) into other types of Resources (DrawableResource). 5. <code>ResourceEncoder</code>s to write Resources (BitmapResource, DrawableResource) to Glide’s disk cache. </p> <p>Components are registered using the <code>Registry</code> class in the <code>registerComponents()</code> method of <code>AppGlideModules</code> and <code>LibraryGlideModules</code>。<br> <cite><a href=http://bumptech.github.io/glide/doc/configuration.html#registering-components>Registering Components</a></cite></p> </blockquote> <p>我们在前文的分析中知道了，Glide加载网络图片默认使用的是<code>HttpUrlConnection</code>，我们想把这个位置的实现替换成<code>OkHttp3</code>或者<code>Volley</code>实现可以吗？显然是可以的，而且官方也提供了这个功能：</p> <ul> <li><a href=http://bumptech.github.io/glide/int/okhttp3.html>OkHttp3</a></li> <li><a href=http://bumptech.github.io/glide/int/volley.html>Volley</a></li> </ul> <p>用起来很简单，只需要集成一个library即可，非常符合Glide的风格。<code>build.gradle</code>的配置如下：</p> <div class=codehilite><pre><span></span>implementation &quot;com.github.bumptech.glide:okhttp3-integration:4.9.0&quot;
</pre></div> <p>sync之后，我们看看<code>OkHttp3</code>的library是怎么实现的吧。</p> <p>根据我们的经验，首先肯定找里面的<code>@GlideModule</code>修饰的类，而且应该是一个<code>LibraryGlideModule</code>类，library里面文件只有几个，我们一找就找到了<code>OkHttpLibraryGlideModule</code>类：</p> <p><strong>OkHttpLibraryGlideModule.java</strong></p> <div class=codehilite><pre><span></span><span class=nd>@GlideModule</span>
<span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>OkHttpLibraryGlideModule</span> <span class=kd>extends</span> <span class=n>LibraryGlideModule</span> <span class=p>{</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
      <span class=nd>@NonNull</span> <span class=n>Registry</span> <span class=n>registry</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>registry</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>GlideUrl</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=p>.</span><span class=na>Factory</span><span class=p>());</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>BTW，里面还有一个实现了<code>com.bumptech.glide.module.GlideModule</code>接口的废弃类<code>OkHttpGlideModule</code>：</p> <div class=codehilite><pre><span></span><span class=nd>@Deprecated</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>OkHttpGlideModule</span> <span class=kd>implements</span> <span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=p>{</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Do nothing.</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span> <span class=n>Registry</span> <span class=n>registry</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>registry</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>GlideUrl</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=p>.</span><span class=na>Factory</span><span class=p>());</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>这个类我们不需要关心，因为使用了上面的<code>OkHttpLibraryGlideModule</code>，而且我们也无需在<code>AndroidManifest.xml</code>中配置，自然也用不到这个类。</p> <p>回到<code>OkHttpLibraryGlideModule</code>类中，我们看到<code>registerComponents</code>方法的实现：</p> <div class=codehilite><pre><span></span><span class=n>registry</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>GlideUrl</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=p>.</span><span class=na>Factory</span><span class=p>());</span>
</pre></div> <p>对于此项，Glide的默认配置为：</p> <div class=codehilite><pre><span></span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>GlideUrl</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>HttpGlideUrlLoader</span><span class=p>.</span><span class=na>Factory</span><span class=p>())</span>
</pre></div> <p>所以我们可以理解为，原本交给<code>HttpGlideUrlLoader.Factory()</code>处理的任务会交给<code>OkHttpUrlLoader.Factory()</code>处理。</p> <p><code>OkHttpUrlLoader.Factory</code>的无参构造器会使用<a href=/design-pattern/singleton/#33-double-check-lockdcl>DCL单例模式</a>创建一个<code>OkHttpClient()</code>对象，其<code>build</code>方法会返回一个<code>new OkHttpUrlLoader(client)</code>：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Factory</span> <span class=kd>implements</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>volatile</span> <span class=n>Call</span><span class=p>.</span><span class=na>Factory</span> <span class=n>internalClient</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=p>.</span><span class=na>Factory</span> <span class=n>client</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Call</span><span class=p>.</span><span class=na>Factory</span> <span class=nf>getInternalClient</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>internalClient</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>synchronized</span> <span class=p>(</span><span class=n>Factory</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>internalClient</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>internalClient</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>internalClient</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>      * Constructor for a new Factory that runs requests using a static singleton client.</span>
<span class=cm>      */</span>
    <span class=kd>public</span> <span class=nf>Factory</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>(</span><span class=n>getInternalClient</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>      * Constructor for a new Factory that runs requests using given client.</span>
<span class=cm>      *</span>
<span class=cm>      * @param client this is typically an instance of {@code OkHttpClient}.</span>
<span class=cm>      */</span>
    <span class=kd>public</span> <span class=nf>Factory</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Call</span><span class=p>.</span><span class=na>Factory</span> <span class=n>client</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@NonNull</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>GlideUrl</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=n>MultiModelLoaderFactory</span> <span class=n>multiFactory</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>OkHttpUrlLoader</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>teardown</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// Do nothing, this instance doesn&#39;t own the client.</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>OkHttpUrlLoader.buildLoadData</code>方法会返回一个fetcher为<code>OkHttpStreamFetcher</code>的<code>LoadData</code>。当需要进行加载的时候，会调用fetcher的<code>loadData</code>方法：</p> <p><strong>OkHttpStreamFetcher.java</strong></p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Request</span><span class=p>.</span><span class=na>Builder</span> <span class=n>requestBuilder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=p>.</span><span class=na>Builder</span><span class=p>().</span><span class=na>url</span><span class=p>(</span><span class=n>url</span><span class=p>.</span><span class=na>toStringUrl</span><span class=p>());</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headerEntry</span> <span class=p>:</span> <span class=n>url</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>entrySet</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>headerEntry</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span>
        <span class=n>requestBuilder</span><span class=p>.</span><span class=na>addHeader</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>headerEntry</span><span class=p>.</span><span class=na>getValue</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>requestBuilder</span><span class=p>.</span><span class=na>build</span><span class=p>();</span>
    <span class=k>this</span><span class=p>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>callback</span><span class=p>;</span>

    <span class=n>call</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
    <span class=n>call</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFailure</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;OkHttp failed to obtain result&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResponse</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Response</span> <span class=n>response</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>responseBody</span> <span class=o>=</span> <span class=n>response</span><span class=p>.</span><span class=na>body</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>isSuccessful</span><span class=p>())</span> <span class=p>{</span>
        <span class=kt>long</span> <span class=n>contentLength</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>responseBody</span><span class=p>).</span><span class=na>contentLength</span><span class=p>();</span>
        <span class=n>stream</span> <span class=o>=</span> <span class=n>ContentLengthInputStream</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>responseBody</span><span class=p>.</span><span class=na>byteStream</span><span class=p>(),</span> <span class=n>contentLength</span><span class=p>);</span>
        <span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>message</span><span class=p>(),</span> <span class=n>response</span><span class=p>.</span><span class=na>code</span><span class=p>()));</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>OkHttpStreamFetcher</code>的实现比<code>HttpUrlFetcher</code>简单多了，而且看起来也没有什么难度。</p> <p>我们删掉app后重新运行，让资源重新从网络获取。在源码打上断点后可以看到Threads中出现了一个<code>OkHttp</code>的OkHttp线程，这就是OkHttp正在加载图片了。关于这OkHttp源码部分可以参考<a href=/android/3rd-library/okhttp/ >OkHttp3</a>。</p> <figure style="width: 50%" class=align-center> <img src=/assets/images/android/glide-okhttp-integration.jpg> <figcaption>Glide OkHttp Integration</figcaption> </figure> <p>如果我们想使用App现有的<code>OkHttpClient</code>而不是默认创建一个新的，我们可以先<code>@Excludes</code>掉<code>OkHttpLibraryGlideModule</code>；然后自己<code>replace</code>时，在<code>OkHttpUrlLoader.Factory(Call.Factory)</code>构造时传入现有的<code>OkHttpClient</code>。</p> <p>示例如下：</p> <div class=codehilite><pre><span></span><span class=n>@GlideModule</span>
<span class=n>@Excludes</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=p>[</span><span class=n>OkHttpLibraryGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>MyLibraryGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>MyGlideModule</span><span class=o>::</span><span class=k>class</span><span class=p>])</span>
<span class=k>class</span> <span class=nc>MyAppGlideModule</span> <span class=p>:</span> <span class=n>AppGlideModule</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>override</span> <span class=k>fun</span> <span class=nf>applyOptions</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>builder</span><span class=p>:</span> <span class=n>GlideBuilder</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>builder</span><span class=p>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>ExternalPreferredCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>))</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>registerComponents</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>glide</span><span class=p>:</span> <span class=n>Glide</span><span class=p>,</span> <span class=n>registry</span><span class=p>:</span> <span class=n>Registry</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>okHttpClient</span> <span class=p>=</span> <span class=n>OkHttpClient</span><span class=p>.</span><span class=n>Builder</span><span class=p>()</span>
            <span class=p>.</span><span class=n>connectTimeout</span><span class=p>(</span><span class=m>10</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
            <span class=p>.</span><span class=n>readTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
            <span class=p>.</span><span class=n>writeTimeout</span><span class=p>(</span><span class=m>30</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
            <span class=p>.</span><span class=n>addNetworkInterceptor</span><span class=p>(</span>
                <span class=n>HttpLoggingInterceptor</span> <span class=p>{</span>
                    <span class=n>Log</span><span class=p>.</span><span class=n>i</span><span class=p>(</span><span class=s>&quot;MyAppGlideModule&quot;</span><span class=p>,</span> <span class=n>it</span><span class=p>)</span>
                <span class=p>}.</span><span class=n>apply</span> <span class=p>{</span>
                    <span class=n>level</span> <span class=p>=</span> <span class=n>HttpLoggingInterceptor</span><span class=p>.</span><span class=n>Level</span><span class=p>.</span><span class=n>BODY</span>
                <span class=p>}</span>
            <span class=p>).</span><span class=n>build</span><span class=p>()</span>

        <span class=n>registry</span><span class=p>.</span><span class=n>replace</span><span class=p>(</span><span class=n>GlideUrl</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>,</span> <span class=n>OkHttpUrlLoader</span><span class=p>.</span><span class=n>Factory</span><span class=p>(</span><span class=n>okHttpClient</span><span class=p>))</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>现在我们清除缓存后重新运行一下，可以在控制台看到请求的log：</p> <div class=codehilite><pre><span></span>I/MyAppGlideModule: --&gt; GET http://cn.bing.com/az/hprichbg/rb/Dongdaemun_ZH-CN10736487148_1920x1080.jpg http/1.1
I/MyAppGlideModule: User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; MI 8 Build/PQ3A.190505.002)
I/MyAppGlideModule: Host: cn.bing.com
I/MyAppGlideModule: Connection: Keep-Alive
I/MyAppGlideModule: Accept-Encoding: gzip
I/MyAppGlideModule: --&gt; END GET
I/MyAppGlideModule: &lt;-- 302 http://cn.bing.com/az/hprichbg/rb/Dongdaemun_ZH-CN10736487148_1920x1080.jpg (355ms)
I/MyAppGlideModule: Cache-Control: private
I/MyAppGlideModule: Content-Length: 171
I/MyAppGlideModule: Content-Type: text/html; charset=utf-8
I/MyAppGlideModule: Content-Encoding: gzip
I/MyAppGlideModule: Location: http://cn.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg
I/MyAppGlideModule: Vary: Accept-Encoding
I/MyAppGlideModule: X-MSEdge-Ref: Ref A: 553334E70DD044ADA70680DD89A837EF Ref B: BJ1EDGE0315 Ref C: 2019-06-19T16:20:18Z
I/MyAppGlideModule: Set-Cookie: _EDGE_S=F=1&amp;SID=20419E3FBE596AFA1ED993BFBF776BB6; path=/; httponly; domain=bing.com
I/MyAppGlideModule: Set-Cookie: _EDGE_V=1; path=/; httponly; expires=Mon, 13-Jul-2020 16:20:18 GMT; domain=bing.com
I/MyAppGlideModule: Set-Cookie: MUID=360EA7C9E659656F0E3FAA49E7776482; path=/; expires=Mon, 13-Jul-2020 16:20:18 GMT; domain=bing.com
I/MyAppGlideModule: Set-Cookie: MUIDB=360EA7C9E659656F0E3FAA49E7776482; path=/; httponly; expires=Mon, 13-Jul-2020 16:20:18 GMT
I/MyAppGlideModule: Date: Wed, 19 Jun 2019 16:20:18 GMT
I/MyAppGlideModule: &lt;html&gt;&lt;head&gt;&lt;title&gt;Object moved&lt;/title&gt;&lt;/head&gt;&lt;body&gt;
    &lt;h2&gt;Object moved to &lt;a href=&quot;http://cn.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg&quot;&gt;here&lt;/a&gt;.&lt;/h2&gt;
    &lt;/body&gt;&lt;/html&gt;
I/MyAppGlideModule: &lt;-- END HTTP (185-byte, 171-gzipped-byte body)
I/MyAppGlideModule: --&gt; GET http://cn.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg http/1.1
I/MyAppGlideModule: User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; MI 8 Build/PQ3A.190505.002)
I/MyAppGlideModule: Host: cn.bing.com
I/MyAppGlideModule: Connection: Keep-Alive
I/MyAppGlideModule: Accept-Encoding: gzip
I/MyAppGlideModule: --&gt; END GET
I/MyAppGlideModule: &lt;-- 302 Found http://cn.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg (120ms)
I/MyAppGlideModule: Cache-Control: private
I/MyAppGlideModule: Content-Length: 183
I/MyAppGlideModule: Content-Type: text/html; charset=utf-8
I/MyAppGlideModule: Content-Encoding: gzip
I/MyAppGlideModule: Location: http://www.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg?setmkt=zh-CN
I/MyAppGlideModule: Vary: Accept-Encoding
I/MyAppGlideModule: Server: Microsoft-IIS/10.0
I/MyAppGlideModule: Set-Cookie: SNRHOP=TS=636965580238957830&amp;I=1; domain=.ap.gbl; path=/
I/MyAppGlideModule: X-MSEdge-Ref: Ref A: B88AC920B8AB4DD7B94FCEA619C9A788 Ref B: BJ1EDGE0315 Ref C: 2019-06-19T16:20:18Z
I/MyAppGlideModule: Set-Cookie: _EDGE_S=F=1&amp;SID=06D34DFC46DA62DF30D6407C47F463A4; path=/; httponly; domain=bing.com
I/MyAppGlideModule: Set-Cookie: _EDGE_V=1; path=/; httponly; expires=Mon, 13-Jul-2020 16:20:18 GMT; domain=bing.com
I/MyAppGlideModule: Set-Cookie: MUID=0A47BFC17CD96B5B23C3B2417DF76A0D; path=/; expires=Mon, 13-Jul-2020 16:20:18 GMT; domain=bing.com
I/MyAppGlideModule: Set-Cookie: MUIDB=0A47BFC17CD96B5B23C3B2417DF76A0D; path=/; httponly; expires=Mon, 13-Jul-2020 16:20:18 GMT
I/MyAppGlideModule: Date: Wed, 19 Jun 2019 16:20:18 GMT
I/MyAppGlideModule: &lt;html&gt;&lt;head&gt;&lt;title&gt;Object moved&lt;/title&gt;&lt;/head&gt;&lt;body&gt;
    &lt;h2&gt;Object moved to &lt;a href=&quot;http://www.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg?setmkt=zh-CN&quot;&gt;here&lt;/a&gt;.&lt;/h2&gt;
    &lt;/body&gt;&lt;/html&gt;
I/MyAppGlideModule: &lt;-- END HTTP (199-byte, 183-gzipped-byte body)
I/MyAppGlideModule: --&gt; GET http://www.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg?setmkt=zh-CN http/1.1
I/MyAppGlideModule: User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; MI 8 Build/PQ3A.190505.002)
I/MyAppGlideModule: Host: www.bing.com
I/MyAppGlideModule: Connection: Keep-Alive
I/MyAppGlideModule: Accept-Encoding: gzip
I/MyAppGlideModule: --&gt; END GET
I/MyAppGlideModule: &lt;-- 200 OK http://www.bing.com/sa/simg/hpb/LaDigue_EN-CA1115245085_1920x1080.jpg?setmkt=zh-CN (43ms)
I/MyAppGlideModule: Cache-Control: public, max-age=15552000
I/MyAppGlideModule: Content-Length: 347798
I/MyAppGlideModule: Content-Type: image/jpeg
I/MyAppGlideModule: Last-Modified: Tue, 18 Jun 2019 18:25:12 GMT
I/MyAppGlideModule: Vary: Accept-Encoding
I/MyAppGlideModule: Server: Microsoft-IIS/10.0
I/MyAppGlideModule: X-MSEdge-Ref: Ref A: 13EE5BF269914C8197F2E1D33212A182 Ref B: BJ1EDGE0306 Ref C: 2019-06-19T16:20:19Z
I/MyAppGlideModule: Date: Wed, 19 Jun 2019 16:20:18 GMT
I/MyAppGlideModule: &lt;-- END HTTP (binary 347798-byte body omitted)
</pre></div> <p>本章内容到此为止，目前我们已经掌握了Glide中各个注解的作用，知道了如何替换默认配置、扩展Glide功能。此外，还把annotation processor生成的6个文件全部探索了一遍，知道了GlideApp和Glide的区别，以后看到这些东西再也不慌了。</p> <hr> <div class=md-source-date> <small> 最后更新: 2020年5月16日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/3rd-library/glide6/";
      this.page.identifier =
        "/android/3rd-library/glide6/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../glide5/ title="Glide v4 源码解析（五）" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> Glide v4 源码解析（五） </span> </div> </a> <a href=../glide7/ title="Glide v4 源码解析（七）" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> Glide v4 源码解析（七） </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/3rd-library/retrofit/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Retrofit2源码解析</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - Retrofit2源码解析"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/3rd-library/retrofit/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - Retrofit2源码解析"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1 tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> Retrofit2源码解析 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1 checked> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Retrofit2源码解析 </label> <a href=./ title=Retrofit2源码解析 class="md-nav__link md-nav__link--active"> Retrofit2源码解析 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 使用例子 </a> </li> <li class=md-nav__item> <a href=#2-retrofitbuilder class=md-nav__link> 2. Retrofit.Builder </a> </li> <li class=md-nav__item> <a href=#3-retrofitcreate class=md-nav__link> 3. Retrofit.create </a> </li> <li class=md-nav__item> <a href=#4-loadservicemethod class=md-nav__link> 4. loadServiceMethod </a> </li> <li class=md-nav__item> <a href=#5-servicemethodcalladapteradapt class=md-nav__link> 5. serviceMethod.callAdapter.adapt </a> </li> <li class=md-nav__item> <a href=#6-okhttpcallexecute class=md-nav__link> 6. OkHttpCall.execute </a> </li> <li class=md-nav__item> <a href=#7 class=md-nav__link> 7. 小结 </a> </li> <li class=md-nav__item> <a href=#faq class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 使用例子 </a> </li> <li class=md-nav__item> <a href=#2-retrofitbuilder class=md-nav__link> 2. Retrofit.Builder </a> </li> <li class=md-nav__item> <a href=#3-retrofitcreate class=md-nav__link> 3. Retrofit.create </a> </li> <li class=md-nav__item> <a href=#4-loadservicemethod class=md-nav__link> 4. loadServiceMethod </a> </li> <li class=md-nav__item> <a href=#5-servicemethodcalladapteradapt class=md-nav__link> 5. serviceMethod.callAdapter.adapt </a> </li> <li class=md-nav__item> <a href=#6-okhttpcallexecute class=md-nav__link> 6. OkHttpCall.execute </a> </li> <li class=md-nav__item> <a href=#7 class=md-nav__link> 7. 小结 </a> </li> <li class=md-nav__item> <a href=#faq class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Retrofit2源码解析</h1> <p>本文代码基于<a href=https://github.com/square/retrofit/tree/parent-2.3.0>retrofit-2.3.0</a>，源码包含三个库：</p> <ul> <li>com.squareup.retrofit2:retrofit</li> <li>com.squareup.retrofit2:adapter-rxjava2</li> <li>com.squareup.retrofit2:converter-gson</li> </ul> <h2 id=1>1. 使用例子<a class=headerlink href=#1 title="Permanent link">&para;</a></h2> <p>首先看日常使用中最简单的一个例子：</p> <p><strong>1.&nbsp;&nbsp;Api接口的定义</strong></p> <div class=codehilite><pre><span></span><span class=kd>interface</span> <span class=nc>ApiService</span> <span class=p>{</span>
    <span class=nd>@GET</span><span class=p>(</span><span class=s>&quot;rest/app/update&quot;</span><span class=p>)</span>
    <span class=n>fun</span> <span class=nf>checkUpdate</span><span class=p>(</span><span class=nd>@Query</span><span class=p>(</span><span class=s>&quot;versionCode&quot;</span><span class=p>)</span> <span class=n>versionCode</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>VersionRes</span><span class=o>&gt;</span>
<span class=p>}</span>
</pre></div> <p><strong>2.&nbsp;&nbsp;利用Retrofit生成<code>ApiService</code>接口的实现</strong></p> <div class=codehilite><pre><span></span><span class=n>val</span> <span class=n>retrofit</span> <span class=o>=</span> <span class=n>Retrofit</span><span class=p>.</span><span class=na>Builder</span><span class=p>()</span>
    <span class=p>.</span><span class=na>client</span><span class=p>(</span><span class=n>okHttpClient</span><span class=p>)</span>
    <span class=p>.</span><span class=na>baseUrl</span><span class=p>(</span><span class=n>apiUrl</span><span class=p>)</span>
    <span class=p>.</span><span class=na>addCallAdapterFactory</span><span class=p>(</span><span class=n>RxJava2CallAdapterFactory</span><span class=p>.</span><span class=na>create</span><span class=p>())</span>
    <span class=p>.</span><span class=na>addConverterFactory</span><span class=p>(</span><span class=n>GsonConverterFactory</span><span class=p>.</span><span class=na>create</span><span class=p>())</span>
    <span class=p>.</span><span class=na>build</span><span class=p>()</span>
<span class=k>return</span> <span class=n>retrofit</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>ApiService</span><span class=p>::</span><span class=n>class</span><span class=p>.</span><span class=na>java</span><span class=p>)</span>
</pre></div> <p><strong>3.&nbsp;&nbsp;发送网络请求</strong></p> <div class=codehilite><pre><span></span><span class=n>RetrofitHelper</span><span class=p>.</span><span class=na>getApiService</span><span class=p>().</span><span class=na>checkUpdate</span><span class=p>(</span>
      <span class=n>BuildConfig</span><span class=p>.</span><span class=na>VERSION_NAME</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=s>&quot;\\p{Punct}&quot;</span><span class=p>.</span><span class=na>toRegex</span><span class=p>(),</span> <span class=s>&quot;0&quot;</span><span class=p>)</span>
  <span class=p>).</span><span class=na>subscribeOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=na>io</span><span class=p>())</span>
      <span class=p>.</span><span class=na>observeOn</span><span class=p>(</span><span class=n>AndroidSchedulers</span><span class=p>.</span><span class=na>mainThread</span><span class=p>())</span>
      <span class=p>.</span><span class=na>subscribe</span><span class=p>(...)</span>
</pre></div> <p>在正式开始前，先简单介绍一下几个关键词，供备忘：</p> <ul> <li><code>CallAdapter&lt;R, T&gt;</code><br> 将一个Call从响应类型R适配成T类型的适配器。<ul> <li><code>Type responseType()</code><br> 适配器将HTTP响应体转换为Java对象时，该对象的类型<br> 比如<code>Call&lt;Repo&gt;</code>的返回值是<code>Repo</code></li> <li><code>T adapt(Call&lt;R&gt; call)</code><br> 返回一个代理了call的T</li> </ul> </li> <li><code>CallAdapter.Factory</code><br> 用于创建CallAdapter实例的工厂<ul> <li><code>CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit)</code><br> 返回一个可以返回<code>returnType</code>的接口方法的CallAdapter，如果不能处理，则返回null</li> </ul> </li> <li><code>Converter&lt;F, T&gt;</code><br> 将F转换为T类型的值的转换器。<ul> <li><code>T convert(F value) throws IOException</code></li> </ul> </li> <li><code>Converter.Factory</code><br> 基于一个类型和目标类型创建一个<code>Converter</code>实例的工厂 <ul> <li><code>Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code><br> 返回一个可以转换HTTP响应体到<code>type</code>的转换器</li> <li><code>Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit)</code><br> 返回一个可以转换<code>type</code>到HTTP请求体的转换器</li> <li><code>Converter&lt;?, String&gt; stringConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code><br> 返回一个可以转换<code>type</code>到String的转换器</li> </ul> </li> </ul> <h2 id=2-retrofitbuilder>2. Retrofit.Builder<a class=headerlink href=#2-retrofitbuilder title="Permanent link">&para;</a></h2> <p>我们先看看<code>Retrofit.Builder</code>在创建<code>Retrofit</code>时干了些什么。 </p> <p>首先是<code>Builder</code>的构造器：</p> <div class=codehilite><pre><span></span><span class=n>Builder</span><span class=p>(</span><span class=n>Platform</span> <span class=n>platform</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>platform</span> <span class=o>=</span> <span class=n>platform</span><span class=p>;</span>
  <span class=c1>// Add the built-in converter factory first. This prevents overriding its behavior but also</span>
  <span class=c1>// ensures correct behavior when using converters that consume all types.</span>
  <span class=n>converterFactories</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>BuiltInConverters</span><span class=p>());</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=nf>Builder</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>(</span><span class=n>Platform</span><span class=p>.</span><span class=na>get</span><span class=p>());</span>
<span class=p>}</span>
</pre></div> <p>这里首先是调用了<code>Platform.get()</code>，然后保存到变量<code>platform</code>中。另外会添加一个内置转化器<code>BuiltInConverters</code>实例到转化器工厂数组<code>converterFactories</code>中。</p> <p><code>Platform.get()</code>调用了<code>findPlatform()</code>方法，最后在Android平台上得到了一个<code>Android</code>对象。该对象的两个方法（<code>defaultCallbackExecutor</code> 和<code>defaultCallAdapterFactory</code>）下面会用到，我们看一下这部分实现：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kd>static</span> <span class=n>Platform</span> <span class=nf>findPlatform</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&quot;android.os.Build&quot;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=k>new</span> <span class=n>Android</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>ignored</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>}</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&quot;java.util.Optional&quot;</span><span class=p>);</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>Java8</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>ignored</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>Platform</span><span class=p>();</span>
<span class=p>}</span>

<span class=kd>static</span> <span class=kd>class</span> <span class=nc>Android</span> <span class=kd>extends</span> <span class=n>Platform</span> <span class=p>{</span>
  <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Executor</span> <span class=nf>defaultCallbackExecutor</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>MainThreadExecutor</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=nd>@Override</span> <span class=n>CallAdapter</span><span class=p>.</span><span class=na>Factory</span> <span class=nf>defaultCallAdapterFactory</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>callbackExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>AssertionError</span><span class=p>();</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>ExecutorCallAdapterFactory</span><span class=p>(</span><span class=n>callbackExecutor</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=cm>/** 在主线程执行的执行器 */</span>
  <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MainThreadExecutor</span> <span class=kd>implements</span> <span class=n>Executor</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>());</span>

    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>handler</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=n>r</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>接下来我们设置了一些参数，这些参数都会保存到成员变量中，我们对照<code>build</code>方法进行解释：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=n>Retrofit</span> <span class=nf>build</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// 就是对应baseUrl</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>baseUrl</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Base URL required.&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// callFactory就是我们传入的OkHttpClient</span>
  <span class=c1>// 因为OkHttpClient实现了okhttp3.Call.Factory这个接口</span>
  <span class=n>okhttp3</span><span class=p>.</span><span class=na>Call</span><span class=p>.</span><span class=na>Factory</span> <span class=n>callFactory</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>callFactory</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>callFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>callFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// 没有设置过callbackExecutor，且此处platform为Android</span>
  <span class=c1>// 因此这里被赋值为了MainThreadExecutor</span>
  <span class=n>Executor</span> <span class=n>callbackExecutor</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>callbackExecutor</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>callbackExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>callbackExecutor</span> <span class=o>=</span> <span class=n>platform</span><span class=p>.</span><span class=na>defaultCallbackExecutor</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// 我们在配置的时候设置了一个RxJava2CallAdapterFactory</span>
  <span class=c1>// 然后这里另外填加了一个ExecutorCallAdapterFactory</span>
  <span class=c1>// Make a defensive copy of the adapters and add the default Call adapter.</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>CallAdapter</span><span class=p>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=n>adapterFactories</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>adapterFactories</span><span class=p>);</span>
  <span class=n>adapterFactories</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>platform</span><span class=p>.</span><span class=na>defaultCallAdapterFactory</span><span class=p>(</span><span class=n>callbackExecutor</span><span class=p>));</span>

  <span class=c1>// 在Retrofit.Builder的构造器里面就添加了一个内置的BuiltInConverters</span>
  <span class=c1>// 然后加上我们配置的一个GsonConverterFactory</span>
  <span class=c1>// Make a defensive copy of the converters.</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>Converter</span><span class=p>.</span><span class=na>Factory</span><span class=o>&gt;</span> <span class=n>converterFactories</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>converterFactories</span><span class=p>);</span>

  <span class=c1>// 创建一个Retrofit对象</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>Retrofit</span><span class=p>(</span><span class=n>callFactory</span><span class=p>,</span> <span class=n>baseUrl</span><span class=p>,</span> <span class=n>converterFactories</span><span class=p>,</span> <span class=n>adapterFactories</span><span class=p>,</span>
      <span class=n>callbackExecutor</span><span class=p>,</span> <span class=n>validateEagerly</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p><code>Retrofit</code>对象已经创建了，其构造器实现都是赋值语句，不用细看。接着我们看一下其<code>create</code>方法。这是探索<code>Retrofit</code>原理的必经之路。 </p> <h2 id=3-retrofitcreate>3. Retrofit.create<a class=headerlink href=#3-retrofitcreate title="Permanent link">&para;</a></h2> <p>先上代码，部分代码说明补充在了注释中：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>create</span><span class=p>(</span><span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>service</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// 检查类型是不是接口，定义的接口数是否大于0</span>
  <span class=n>Utils</span><span class=p>.</span><span class=na>validateServiceInterface</span><span class=p>(</span><span class=n>service</span><span class=p>);</span>
  <span class=c1>// 如果为true，则会先加载全部的非default方法，同时缓存到map中；默认为false</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>validateEagerly</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>eagerlyValidateMethods</span><span class=p>(</span><span class=n>service</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// 动态代理</span>
  <span class=k>return</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=n>Proxy</span><span class=p>.</span><span class=na>newProxyInstance</span><span class=p>(</span><span class=n>service</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>(),</span> <span class=k>new</span> <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=p>{</span> <span class=n>service</span> <span class=p>},</span>
      <span class=k>new</span> <span class=n>InvocationHandler</span><span class=p>()</span> <span class=p>{</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Platform</span> <span class=n>platform</span> <span class=o>=</span> <span class=n>Platform</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>

        <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=p>(</span><span class=n>Object</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span>
            <span class=kd>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
          <span class=c1>// 如果是调用的Object中的方法，那就直接执行此方法</span>
          <span class=c1>// If the method is a method from Object then defer to normal invocation.</span>
          <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>()</span> <span class=o>==</span> <span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
          <span class=p>}</span>
          <span class=c1>// 如果是default方法(Java8中引进)，那就调用default方法</span>
          <span class=c1>// 由于plaform是Android不是Java8，所以此处是false的</span>
          <span class=k>if</span> <span class=p>(</span><span class=n>platform</span><span class=p>.</span><span class=na>isDefaultMethod</span><span class=p>(</span><span class=n>method</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>platform</span><span class=p>.</span><span class=na>invokeDefaultMethod</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>service</span><span class=p>,</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
          <span class=p>}</span>
          <span class=c1>// 见正文分析</span>
          <span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>serviceMethod</span> <span class=o>=</span>
              <span class=p>(</span><span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>loadServiceMethod</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
          <span class=n>OkHttpCall</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>okHttpCall</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpCall</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>serviceMethod</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
          <span class=k>return</span> <span class=n>serviceMethod</span><span class=p>.</span><span class=na>callAdapter</span><span class=p>.</span><span class=na>adapt</span><span class=p>(</span><span class=n>okHttpCall</span><span class=p>);</span>
        <span class=p>}</span>
      <span class=p>});</span>
<span class=p>}</span>
</pre></div> <p>现在来到了<code>create</code>方法中非常核心的三行代码：</p> <div class=codehilite><pre><span></span><span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>serviceMethod</span> <span class=o>=</span>
    <span class=p>(</span><span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>loadServiceMethod</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
<span class=n>OkHttpCall</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>okHttpCall</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpCall</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>serviceMethod</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
<span class=k>return</span> <span class=n>serviceMethod</span><span class=p>.</span><span class=na>callAdapter</span><span class=p>.</span><span class=na>adapt</span><span class=p>(</span><span class=n>okHttpCall</span><span class=p>);</span>
</pre></div> <p>下面都是对这几行代码的分析了，我们先有一个大致的印象，知道每一行代码干了什么。</p> <ol> <li>在<code>loadServiceMethod</code>方法执行的时候，有一个取缓存的操作，若取不到则开始创建<br> 创建的时候会根据方法、方法注解、方法参数、方法参数注解这几个方面 </li> <li>决定采用哪个<code>CallAdapter</code>、哪个<code>Converter</code></li> <li>解析方法的注解，取出HTTP调用的方式<code>httpMethod</code>、是否有请求体<code>hasBody</code>、相对url<code>relativeUrl</code>等</li> <li> <p>将每个参数的注解包装成为一个个<code>ParameterHandler</code>对象，等待调用</p> </li> <li> <p>将上一步的结果与方法的入参包装成一个<code>OkHttpCall</code>对象</p> </li> <li>调用<code>serviceMethod.callAdapter.adapt(okHttpCall)</code>开始执行网络请求</li> </ol> <p>下面我们一步一步地进行分析。</p> <h2 id=4-loadservicemethod>4. loadServiceMethod<a class=headerlink href=#4-loadservicemethod title="Permanent link">&para;</a></h2> <p>先看看<code>loadServiceMethod</code>方法的相关代码：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Method</span><span class=p>,</span> <span class=n>ServiceMethod</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>serviceMethodCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>

<span class=n>ServiceMethod</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>loadServiceMethod</span><span class=p>(</span><span class=n>Method</span> <span class=n>method</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>ServiceMethod</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>

  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>serviceMethodCache</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServiceMethod</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>method</span><span class=p>).</span><span class=na>build</span><span class=p>();</span>
      <span class=n>serviceMethodCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>可以很明显的看出来，这里采取了缓存的设计，<strong>所以Retrofit也要单例实现才能发挥最大的作用</strong>。<br> 很明显，这段代码的重点就是<code>ServiceMethod.Builder</code>的创建以及其<code>build</code>方法了。 </p> <p>先看构造器的实现，这部分代码很简单，就是取出要调用方法的注解、参数以及参数注解：</p> <div class=codehilite><pre><span></span><span class=n>Builder</span><span class=p>(</span><span class=n>Retrofit</span> <span class=n>retrofit</span><span class=p>,</span> <span class=n>Method</span> <span class=n>method</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>retrofit</span> <span class=o>=</span> <span class=n>retrofit</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>method</span> <span class=o>=</span> <span class=n>method</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>methodAnnotations</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getAnnotations</span><span class=p>();</span>
  <span class=k>this</span><span class=p>.</span><span class=na>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getGenericParameterTypes</span><span class=p>();</span>
  <span class=k>this</span><span class=p>.</span><span class=na>parameterAnnotationsArray</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getParameterAnnotations</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>在我们的例子中（tips:<em>可以直接在aar包对应文件中打上断点</em>）： <div class=codehilite><pre><span></span><span class=n>methodAnnotations</span> <span class=o>=</span> <span class=o>[</span><span class=nd>@GET</span><span class=p>(</span><span class=s>&quot;rest/app/update&quot;</span><span class=p>)</span><span class=o>]</span>
<span class=n>parameterTypes</span> <span class=o>=</span> <span class=o>[</span><span class=n>String</span><span class=o>]</span>
<span class=n>parameterAnnotationsArray</span> <span class=o>=</span> <span class=o>[[</span><span class=nd>@Query</span><span class=p>(</span><span class=n>encoded</span><span class=o>=</span><span class=kc>false</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=n>versionCode</span><span class=p>)</span><span class=o>]]</span>
</pre></div></p> <p>再看<code>ServiceMethod.Builder.build</code>方法，这部分代码很长很关键，我们一行一行代码捋一下。<br> 先上源代码，做一个整体解释：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=n>ServiceMethod</span> <span class=nf>build</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// 根据method的返回值类型以及方法注解返回第一个可以处理的CallAdapter</span>
  <span class=c1>// 此处就是RxJava2CallAdapterFactory创建的RxJava2CallAdapter</span>
  <span class=n>callAdapter</span> <span class=o>=</span> <span class=n>createCallAdapter</span><span class=p>();</span>
  <span class=c1>// 我们可以直接使用的真正的返回值类型，在例子中此处是VersionRes</span>
  <span class=n>responseType</span> <span class=o>=</span> <span class=n>callAdapter</span><span class=p>.</span><span class=na>responseType</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>responseType</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>class</span> <span class=o>||</span> <span class=n>responseType</span> <span class=o>==</span> <span class=n>okhttp3</span><span class=p>.</span><span class=na>Response</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;&#39;&quot;</span>
        <span class=o>+</span> <span class=n>Utils</span><span class=p>.</span><span class=na>getRawType</span><span class=p>(</span><span class=n>responseType</span><span class=p>).</span><span class=na>getName</span><span class=p>()</span>
        <span class=o>+</span> <span class=s>&quot;&#39; is not a valid response body type. Did you mean ResponseBody?&quot;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// 根据responseType以及方法注解返回第一个可以处理的Converter</span>
  <span class=c1>// 由于内置的BuiltInConverters无法处理VersionRes类型的返回值，所以第二个尝试处理</span>
  <span class=c1>// 它做到了，因此此处为GsonConverterFactory创建的GsonResponseBodyConverter</span>
  <span class=n>responseConverter</span> <span class=o>=</span> <span class=n>createResponseConverter</span><span class=p>();</span>

  <span class=c1>// 根据注解的类型初始化一些参数</span>
  <span class=c1>// 在实例中，httpMethod为GET,hasBody为false，relativeUrl为rest/app/update</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>Annotation</span> <span class=n>annotation</span> <span class=p>:</span> <span class=n>methodAnnotations</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>parseMethodAnnotation</span><span class=p>(</span><span class=n>annotation</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>httpMethod</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;HTTP method annotation is required (e.g., @GET, @POST, etc.).&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hasBody</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isMultipart</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span>
          <span class=s>&quot;Multipart can only be specified on HTTP methods with request body (e.g., @POST).&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isFormEncoded</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;FormUrlEncoded can only be specified on HTTP methods with &quot;</span>
          <span class=o>+</span> <span class=s>&quot;request body (e.g., @POST).&quot;</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// 将每个参数以及其注解封装成为一个ParameterHandler对象</span>
  <span class=c1>// 因为只有一个参数，所以这里把对应的结果写到代码上了</span>
  <span class=kt>int</span> <span class=n>parameterCount</span> <span class=o>=</span> <span class=n>parameterAnnotationsArray</span><span class=p>.</span><span class=na>length</span><span class=p>;</span>
  <span class=n>parameterHandlers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ParameterHandler</span><span class=o>&lt;?&gt;[</span><span class=n>parameterCount</span><span class=o>]</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>p</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=n>parameterCount</span><span class=p>;</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// String</span>
    <span class=n>Type</span> <span class=n>parameterType</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=n>p</span><span class=o>]</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Utils</span><span class=p>.</span><span class=na>hasUnresolvableType</span><span class=p>(</span><span class=n>parameterType</span><span class=p>))</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=n>parameterError</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=s>&quot;Parameter type must not include a type variable or wildcard: %s&quot;</span><span class=p>,</span>
          <span class=n>parameterType</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// [@Query(encoded=false, value=versionCode)]</span>
    <span class=n>Annotation</span><span class=o>[]</span> <span class=n>parameterAnnotations</span> <span class=o>=</span> <span class=n>parameterAnnotationsArray</span><span class=o>[</span><span class=n>p</span><span class=o>]</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>parameterAnnotations</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=n>parameterError</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=s>&quot;No Retrofit annotation found.&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// ParameterHandler.Query(</span>
    <span class=c1>//   name = &quot;VersionCode&quot;,</span>
    <span class=c1>//   encoded = false,</span>
    <span class=c1>//   valueConverter = BuiltInConverters.ToStringConverter</span>
    <span class=c1>// )</span>
    <span class=n>parameterHandlers</span><span class=o>[</span><span class=n>p</span><span class=o>]</span> <span class=o>=</span> <span class=n>parseParameter</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>parameterType</span><span class=p>,</span> <span class=n>parameterAnnotations</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>relativeUrl</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>gotUrl</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;Missing either @%s URL or @Url parameter.&quot;</span><span class=p>,</span> <span class=n>httpMethod</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isFormEncoded</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isMultipart</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>hasBody</span> <span class=o>&amp;&amp;</span> <span class=n>gotBody</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;Non-body HTTP method cannot contain @Body.&quot;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isFormEncoded</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>gotField</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;Form-encoded method must contain at least one @Field.&quot;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isMultipart</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>gotPart</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;Multipart method must contain at least one @Part.&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// 创建ServiceMethod对象，内部就是一些赋值操作</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>ServiceMethod</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>整体分析完了，我们先看一下<code>CallAdapter</code>、<code>Converter</code>的创建，然后再看各种注解的解析。</p> <p>callAdapter的选择由<code>createCallAdapter</code>完成：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=nf>createCallAdapter</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// returnType为Observable&lt;VersionRes&gt;</span>
  <span class=n>Type</span> <span class=n>returnType</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getGenericReturnType</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Utils</span><span class=p>.</span><span class=na>hasUnresolvableType</span><span class=p>(</span><span class=n>returnType</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span>
        <span class=s>&quot;Method return type must not include a type variable or wildcard: %s&quot;</span><span class=p>,</span> <span class=n>returnType</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>returnType</span> <span class=o>==</span> <span class=kt>void</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=s>&quot;Service methods cannot return void.&quot;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// annotations为[@GET(&quot;rest/app/update&quot;)]</span>
  <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getAnnotations</span><span class=p>();</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=c1>// 转到retrofit进行处理</span>
    <span class=c1>//noinspection unchecked</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>CallAdapter</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>retrofit</span><span class=p>.</span><span class=na>callAdapter</span><span class=p>(</span><span class=n>returnType</span><span class=p>,</span> <span class=n>annotations</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// Wide exception range because factories are user code.</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=s>&quot;Unable to create call adapter for %s&quot;</span><span class=p>,</span> <span class=n>returnType</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>继续跟踪<code>Retrofit.callAdapter</code>方法：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=n>CallAdapter</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>callAdapter</span><span class=p>(</span><span class=n>Type</span> <span class=n>returnType</span><span class=p>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>nextCallAdapter</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=n>returnType</span><span class=p>,</span> <span class=n>annotations</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=n>CallAdapter</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>nextCallAdapter</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>CallAdapter</span><span class=p>.</span><span class=na>Factory</span> <span class=n>skipPast</span><span class=p>,</span> <span class=n>Type</span> <span class=n>returnType</span><span class=p>,</span>
    <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>checkNotNull</span><span class=p>(</span><span class=n>returnType</span><span class=p>,</span> <span class=s>&quot;returnType == null&quot;</span><span class=p>);</span>
  <span class=n>checkNotNull</span><span class=p>(</span><span class=n>annotations</span><span class=p>,</span> <span class=s>&quot;annotations == null&quot;</span><span class=p>);</span>

  <span class=c1>// start = -1 + 1 = 0，也就是顺序遍历</span>
  <span class=c1>// 从RxJava2CallAdapterFactory、ExecutorCallAdapterFactory中找到满足条件的</span>
  <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>adapterFactories</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=n>skipPast</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=p>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>adapterFactories</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>CallAdapter</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>adapter</span> <span class=o>=</span> <span class=n>adapterFactories</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>returnType</span><span class=p>,</span> <span class=n>annotations</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>adapter</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>adapter</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=p>...</span>
  <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(...);</span>
<span class=p>}</span>
</pre></div> <p><code>RxJava2CallAdapterFactory</code>是满足条件的，我们看看其<code>get</code>方法：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>CallAdapter</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>get</span><span class=p>(</span><span class=n>Type</span> <span class=n>returnType</span><span class=p>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=p>,</span> <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// returnType为Observable&lt;VersionRes&gt;，因此rawType就是Observable类型</span>
  <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>rawType</span> <span class=o>=</span> <span class=n>getRawType</span><span class=p>(</span><span class=n>returnType</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>rawType</span> <span class=o>==</span> <span class=n>Completable</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Completable is not parameterized (which is what the rest of this method deals with) so it</span>
    <span class=c1>// can only be created with a single configuration.</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>RxJava2CallAdapter</span><span class=p>(</span><span class=n>Void</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>scheduler</span><span class=p>,</span> <span class=n>isAsync</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span>
        <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kt>boolean</span> <span class=n>isFlowable</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Flowable</span><span class=p>.</span><span class=na>class</span><span class=p>;</span>
  <span class=kt>boolean</span> <span class=n>isSingle</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Single</span><span class=p>.</span><span class=na>class</span><span class=p>;</span>
  <span class=kt>boolean</span> <span class=n>isMaybe</span> <span class=o>=</span> <span class=n>rawType</span> <span class=o>==</span> <span class=n>Maybe</span><span class=p>.</span><span class=na>class</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>rawType</span> <span class=o>!=</span> <span class=n>Observable</span><span class=p>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isFlowable</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isSingle</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isMaybe</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=kt>boolean</span> <span class=n>isResult</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=kt>boolean</span> <span class=n>isBody</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=n>Type</span> <span class=n>responseType</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>returnType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>isFlowable</span> <span class=o>?</span> <span class=s>&quot;Flowable&quot;</span>
        <span class=p>:</span> <span class=n>isSingle</span> <span class=o>?</span> <span class=s>&quot;Single&quot;</span>
        <span class=p>:</span> <span class=n>isMaybe</span> <span class=o>?</span> <span class=s>&quot;Maybe&quot;</span> <span class=p>:</span> <span class=s>&quot;Observable&quot;</span><span class=p>;</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=n>name</span> <span class=o>+</span> <span class=s>&quot; return type must be parameterized&quot;</span>
        <span class=o>+</span> <span class=s>&quot; as &quot;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&quot;&lt;Foo&gt; or &quot;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&quot;&lt;? extends Foo&gt;&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// observableType为VersionRes类型</span>
  <span class=n>Type</span> <span class=n>observableType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=n>ParameterizedType</span><span class=p>)</span> <span class=n>returnType</span><span class=p>);</span>
  <span class=c1>// rawObservableType也为VersionRes类型</span>
  <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>rawObservableType</span> <span class=o>=</span> <span class=n>getRawType</span><span class=p>(</span><span class=n>observableType</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>rawObservableType</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>observableType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=p>))</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Response must be parameterized&quot;</span>
          <span class=o>+</span> <span class=s>&quot; as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=n>ParameterizedType</span><span class=p>)</span> <span class=n>observableType</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>rawObservableType</span> <span class=o>==</span> <span class=n>Result</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>observableType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=p>))</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Result must be parameterized&quot;</span>
          <span class=o>+</span> <span class=s>&quot; as Result&lt;Foo&gt; or Result&lt;? extends Foo&gt;&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>responseType</span> <span class=o>=</span> <span class=n>getParameterUpperBound</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=n>ParameterizedType</span><span class=p>)</span> <span class=n>observableType</span><span class=p>);</span>
    <span class=n>isResult</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// 因此走这个分支，responseType就是VersionRes类型了</span>
    <span class=n>responseType</span> <span class=o>=</span> <span class=n>observableType</span><span class=p>;</span>
    <span class=n>isBody</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// 返回了一个RxJava2CallAdapter，而不是null，也就意味着找到了满足条件的CallAdapter</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>RxJava2CallAdapter</span><span class=p>(</span><span class=n>responseType</span><span class=p>,</span> <span class=n>scheduler</span><span class=p>,</span> <span class=n>isAsync</span><span class=p>,</span> <span class=n>isResult</span><span class=p>,</span> <span class=n>isBody</span><span class=p>,</span> <span class=n>isFlowable</span><span class=p>,</span>
      <span class=n>isSingle</span><span class=p>,</span> <span class=n>isMaybe</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>从上面分析可以看出，这里的<code>callAdapter</code>就等于<code>RxJava2CallAdapter(VersionRes, null, false, false, true, false, false, false, false)</code>。</p> <p>接下来看<code>responseConverter</code>的创建方法<code>createResponseConverter()</code>：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=p>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>createResponseConverter</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// annotations为[@GET(&quot;rest/app/update&quot;)]</span>
  <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getAnnotations</span><span class=p>();</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=c1>// responseType为VersionRes</span>
    <span class=k>return</span> <span class=n>retrofit</span><span class=p>.</span><span class=na>responseBodyConverter</span><span class=p>(</span><span class=n>responseType</span><span class=p>,</span> <span class=n>annotations</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// Wide exception range because factories are user code.</span>
    <span class=k>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=s>&quot;Unable to create converter for %s&quot;</span><span class=p>,</span> <span class=n>responseType</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>还是转到了<code>Retrofit</code>中：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=p>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>responseBodyConverter</span><span class=p>(</span><span class=n>Type</span> <span class=n>type</span><span class=p>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>nextResponseBodyConverter</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=n>annotations</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=p>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=nf>nextResponseBodyConverter</span><span class=p>(</span>
    <span class=nd>@Nullable</span> <span class=n>Converter</span><span class=p>.</span><span class=na>Factory</span> <span class=n>skipPast</span><span class=p>,</span> <span class=n>Type</span> <span class=n>type</span><span class=p>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>checkNotNull</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=s>&quot;type == null&quot;</span><span class=p>);</span>
  <span class=n>checkNotNull</span><span class=p>(</span><span class=n>annotations</span><span class=p>,</span> <span class=s>&quot;annotations == null&quot;</span><span class=p>);</span>

  <span class=c1>// 依然是从0开始，依次尝试BuiltInConverters、GsonConverterFactory</span>
  <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=n>skipPast</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=p>,</span> <span class=n>count</span> <span class=o>=</span> <span class=n>converterFactories</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>converter</span> <span class=o>=</span>
        <span class=n>converterFactories</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>responseBodyConverter</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>annotations</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>converter</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>//noinspection unchecked</span>
      <span class=k>return</span> <span class=p>(</span><span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=p>,</span> <span class=n>T</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>converter</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(...);</span>
<span class=p>}</span>
</pre></div> <p>我们先看看<code>BuiltInConverters</code>能不能处理：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=p>(</span><span class=n>Type</span> <span class=n>type</span><span class=p>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=p>,</span>
    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>ResponseBody</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>Utils</span><span class=p>.</span><span class=na>isAnnotationPresent</span><span class=p>(</span><span class=n>annotations</span><span class=p>,</span> <span class=n>Streaming</span><span class=p>.</span><span class=na>class</span><span class=p>)</span>
        <span class=o>?</span> <span class=n>StreamingResponseBodyConverter</span><span class=p>.</span><span class=na>INSTANCE</span>
        <span class=p>:</span> <span class=n>BufferingResponseBodyConverter</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>Void</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>VoidResponseBodyConverter</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>我们可以看到<code>BuiltInConverters</code>只能处理<code>ResponseBody</code>类型和<code>Void</code>类型两种类型的返回值类型。<br> 所以，我们接着看第二个转换器<code>GsonConverterFactory</code>：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>Converter</span><span class=o>&lt;</span><span class=n>ResponseBody</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>responseBodyConverter</span><span class=p>(</span><span class=n>Type</span> <span class=n>type</span><span class=p>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=p>,</span>
    <span class=n>Retrofit</span> <span class=n>retrofit</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>TypeAdapter</span><span class=o>&lt;?&gt;</span> <span class=n>adapter</span> <span class=o>=</span> <span class=n>gson</span><span class=p>.</span><span class=na>getAdapter</span><span class=p>(</span><span class=n>TypeToken</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>type</span><span class=p>));</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>GsonResponseBodyConverter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>gson</span><span class=p>,</span> <span class=n>adapter</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>这里调用了Gson的相关方法，是可以完成任务的。所以就返回了<code>GsonResponseBodyConverter</code>。</p> <p>回到<code>ServiceMethod.Builder.build</code>方法，接下来就是处理方法注解以及参数注解了。代码很简单，if-else判断出属于约定好的哪种注解，就设置对应的值。这里就不展开说了。 </p> <p>最后是<code>return new ServiceMethod&lt;&gt;(this);</code>，这里面就是干了赋值的操作。</p> <h2 id=5-servicemethodcalladapteradapt>5. serviceMethod.callAdapter.adapt<a class=headerlink href=#5-servicemethodcalladapteradapt title="Permanent link">&para;</a></h2> <p><code>loadServiceMethod</code>完成之后，会将这个<code>ServiceMethod</code>与方法入参一起组成了一个<code>OkHttpCall</code>对象：</p> <div class=codehilite><pre><span></span><span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>serviceMethod</span> <span class=o>=</span>
    <span class=p>(</span><span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>loadServiceMethod</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
<span class=n>OkHttpCall</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>okHttpCall</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpCall</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>serviceMethod</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
<span class=k>return</span> <span class=n>serviceMethod</span><span class=p>.</span><span class=na>callAdapter</span><span class=p>.</span><span class=na>adapt</span><span class=p>(</span><span class=n>okHttpCall</span><span class=p>);</span>
</pre></div> <p>到目前为止，都只是做一些准备工作，还没有真正开始网络请求。那么这一步肯定就干了这件事。我们一点点往下看。</p> <p>我们在前面已经知道了<code>serviceMethod.callAdapter</code>是一个<code>RxJava2CallAdapter</code>对象，所以我们直接看其<code>adapt</code>方法：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Object</span> <span class=nf>adapt</span><span class=p>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// isAsync在RxJava2CallAdapterFactory.create()中被赋值，为false</span>
  <span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>responseObservable</span> <span class=o>=</span> <span class=n>isAsync</span>
      <span class=o>?</span> <span class=k>new</span> <span class=n>CallEnqueueObservable</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>call</span><span class=p>)</span>
      <span class=p>:</span> <span class=k>new</span> <span class=n>CallExecuteObservable</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>call</span><span class=p>);</span>

  <span class=n>Observable</span><span class=o>&lt;?&gt;</span> <span class=n>observable</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isResult</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>observable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResultObservable</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>responseObservable</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>isBody</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// isResult为false，isBody为true，所以走这个</span>
    <span class=n>observable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BodyObservable</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>responseObservable</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>observable</span> <span class=o>=</span> <span class=n>responseObservable</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// scheduler默认为null</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>scheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>observable</span> <span class=o>=</span> <span class=n>observable</span><span class=p>.</span><span class=na>subscribeOn</span><span class=p>(</span><span class=n>scheduler</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// 以下boolean都为false</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isFlowable</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>observable</span><span class=p>.</span><span class=na>toFlowable</span><span class=p>(</span><span class=n>BackpressureStrategy</span><span class=p>.</span><span class=na>LATEST</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isSingle</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>observable</span><span class=p>.</span><span class=na>singleOrError</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isMaybe</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>observable</span><span class=p>.</span><span class=na>singleElement</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isCompletable</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>observable</span><span class=p>.</span><span class=na>ignoreElements</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>observable</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>从上面可以看出，这里会经过两个Observable，分别是<code>CallExecuteObservable</code>以及<code>BodyObservable</code>。前者作为参数传递给了后者。</p> <p>我们先看看<code>CallExecuteObservable</code>干了什么：</p> <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallExecuteObservable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=p>{</span>
  <span class=c1>// originalCall实际上就是OkHttpCall</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>originalCall</span><span class=p>;</span>

  <span class=n>CallExecuteObservable</span><span class=p>(</span><span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>originalCall</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>originalCall</span> <span class=o>=</span> <span class=n>originalCall</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@Override</span> <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>subscribeActual</span><span class=p>(</span><span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>observer</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 此处的observer是BodyObservable.BodyObserver</span>
    <span class=c1>// Since Call is a one-shot type, clone it for each new observer.</span>
    <span class=n>Call</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>call</span> <span class=o>=</span> <span class=n>originalCall</span><span class=p>.</span><span class=na>clone</span><span class=p>();</span>
    <span class=c1>// 注意这里，如果dispose了Observable，call同时也会被cancel</span>
    <span class=c1>// 调用BodyObserver.onSubscribe</span>
    <span class=n>observer</span><span class=p>.</span><span class=na>onSubscribe</span><span class=p>(</span><span class=k>new</span> <span class=n>CallDisposable</span><span class=p>(</span><span class=n>call</span><span class=p>));</span>

    <span class=kt>boolean</span> <span class=n>terminated</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=c1>// 调用OkHttpCall.execute方法执行同步请求</span>
      <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>response</span> <span class=o>=</span> <span class=n>call</span><span class=p>.</span><span class=na>execute</span><span class=p>();</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>call</span><span class=p>.</span><span class=na>isCanceled</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// 调用BodyObserver.onNext</span>
        <span class=n>observer</span><span class=p>.</span><span class=na>onNext</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>call</span><span class=p>.</span><span class=na>isCanceled</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>terminated</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=c1>// 调用BodyObserver.onComplete</span>
        <span class=n>observer</span><span class=p>.</span><span class=na>onComplete</span><span class=p>();</span>
      <span class=p>}</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>Exceptions</span><span class=p>.</span><span class=na>throwIfFatal</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>terminated</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>RxJavaPlugins</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>call</span><span class=p>.</span><span class=na>isCanceled</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
          <span class=c1>// 调用BodyObserver.onError</span>
          <span class=n>observer</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>inner</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>Exceptions</span><span class=p>.</span><span class=na>throwIfFatal</span><span class=p>(</span><span class=n>inner</span><span class=p>);</span>
          <span class=n>RxJavaPlugins</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=k>new</span> <span class=n>CompositeException</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>inner</span><span class=p>));</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>CallDisposable</span> <span class=kd>implements</span> <span class=n>Disposable</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Call</span><span class=o>&lt;?&gt;</span> <span class=n>call</span><span class=p>;</span>

    <span class=n>CallDisposable</span><span class=p>(</span><span class=n>Call</span><span class=o>&lt;?&gt;</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>this</span><span class=p>.</span><span class=na>call</span> <span class=o>=</span> <span class=n>call</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>dispose</span><span class=p>()</span> <span class=p>{</span>
      <span class=n>call</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDisposed</span><span class=p>()</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>call</span><span class=p>.</span><span class=na>isCanceled</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在上面这段代码中，<code>call.execute()</code>是重点，在这段代码里面完成了<code>ServiceMethod</code>的乱七八糟的参数的组装，最后才执行<code>RealCall.execute</code>，我们最后再说。 </p> <p>接下来看看<code>BodyObservable</code>的相关代码：</p> <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=kd>class</span> <span class=nc>BodyObservable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=c1>// 上面的CallExecuteObservable</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>upstream</span><span class=p>;</span>

  <span class=n>BodyObservable</span><span class=p>(</span><span class=n>Observable</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>upstream</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>upstream</span> <span class=o>=</span> <span class=n>upstream</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@Override</span> <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>subscribeActual</span><span class=p>(</span><span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>T</span><span class=o>&gt;</span> <span class=n>observer</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 这里的入参observer就是我们客户端定义的用来响应网络请求的observer了</span>
    <span class=n>upstream</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=k>new</span> <span class=n>BodyObserver</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>observer</span><span class=p>));</span>
  <span class=p>}</span>

  <span class=cm>/** 该类的作用就是判断请求是否成功，并将成功的Response&lt;R&gt;转换为R，传给客户端 */</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>BodyObserver</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Observer</span><span class=o>&lt;</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>observer</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>terminated</span><span class=p>;</span>

    <span class=n>BodyObserver</span><span class=p>(</span><span class=n>Observer</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>observer</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>this</span><span class=p>.</span><span class=na>observer</span> <span class=o>=</span> <span class=n>observer</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onSubscribe</span><span class=p>(</span><span class=n>Disposable</span> <span class=n>disposable</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>observer</span><span class=p>.</span><span class=na>onSubscribe</span><span class=p>(</span><span class=n>disposable</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onNext</span><span class=p>(</span><span class=n>Response</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>response</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// 判断请求是否成功</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>isSuccessful</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// 若成功，将成功的Response&lt;R&gt;转换为R，传给客户端</span>
        <span class=n>observer</span><span class=p>.</span><span class=na>onNext</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>body</span><span class=p>());</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// 否则，向客户端抛出HttpException异常</span>
        <span class=n>terminated</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=n>Throwable</span> <span class=n>t</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>
        <span class=k>try</span> <span class=p>{</span>
          <span class=n>observer</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>inner</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>Exceptions</span><span class=p>.</span><span class=na>throwIfFatal</span><span class=p>(</span><span class=n>inner</span><span class=p>);</span>
          <span class=n>RxJavaPlugins</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=k>new</span> <span class=n>CompositeException</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>inner</span><span class=p>));</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span>

    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onComplete</span><span class=p>()</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>terminated</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>observer</span><span class=p>.</span><span class=na>onComplete</span><span class=p>();</span>
      <span class=p>}</span>
    <span class=p>}</span>

    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onError</span><span class=p>(</span><span class=n>Throwable</span> <span class=n>throwable</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>terminated</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>observer</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>throwable</span><span class=p>);</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// This should never happen! onNext handles and forwards errors automatically.</span>
        <span class=n>Throwable</span> <span class=n>broken</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AssertionError</span><span class=p>(</span>
            <span class=s>&quot;This should never happen! Report as a bug with the full stacktrace.&quot;</span><span class=p>);</span>
        <span class=c1>//noinspection UnnecessaryInitCause Two-arg AssertionError constructor is 1.7+ only.</span>
        <span class=n>broken</span><span class=p>.</span><span class=na>initCause</span><span class=p>(</span><span class=n>throwable</span><span class=p>);</span>
        <span class=n>RxJavaPlugins</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>broken</span><span class=p>);</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>小结一下，<code>CallExecuteObservable</code>就是用来执行网络请求的，<code>BodyObservable</code>会将网络请求的结果(<code>Response&lt;VersionRes&gt;</code>)转换为客户端需要的结果(<code>VersionRes</code>)。</p> <h2 id=6-okhttpcallexecute>6. OkHttpCall.execute<a class=headerlink href=#6-okhttpcallexecute title="Permanent link">&para;</a></h2> <p>回想一下<code>CallExecuteObservable</code>的关键代码，网络请求需要有一个<code>Request</code>，但是在<code>Retrofit</code>中目前没有发现任何设置的地方，所以这部分代码肯定在<code>OkHttpCall.execute</code>中：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>execute</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>okhttp3</span><span class=p>.</span><span class=na>Call</span> <span class=n>call</span><span class=p>;</span>

  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>executed</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already executed.&quot;</span><span class=p>);</span>
    <span class=n>executed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>creationFailure</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>creationFailure</span> <span class=k>instanceof</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=p>(</span><span class=n>IOException</span><span class=p>)</span> <span class=n>creationFailure</span><span class=p>;</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=p>(</span><span class=n>RuntimeException</span><span class=p>)</span> <span class=n>creationFailure</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>

    <span class=n>call</span> <span class=o>=</span> <span class=n>rawCall</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>call</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>try</span> <span class=p>{</span>
        <span class=n>call</span> <span class=o>=</span> <span class=n>rawCall</span> <span class=o>=</span> <span class=n>createRawCall</span><span class=p>();</span>
      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>RuntimeException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>creationFailure</span> <span class=o>=</span> <span class=n>e</span><span class=p>;</span>
        <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>canceled</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>call</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>parseResponse</span><span class=p>(</span><span class=n>call</span><span class=p>.</span><span class=na>execute</span><span class=p>());</span>
<span class=p>}</span>
</pre></div> <p>上面抛开一些同步处理、健康检查，其实就两行代码：</p> <div class=codehilite><pre><span></span><span class=n>call</span> <span class=o>=</span> <span class=n>rawCall</span> <span class=o>=</span> <span class=n>createRawCall</span><span class=p>();</span>
<span class=k>return</span> <span class=n>parseResponse</span><span class=p>(</span><span class=n>call</span><span class=p>.</span><span class=na>execute</span><span class=p>())</span>
</pre></div> <p>先看<code>createRawCall</code>方法：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=n>okhttp3</span><span class=p>.</span><span class=na>Call</span> <span class=nf>createRawCall</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=c1>// 构造一个Request对象</span>
  <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>serviceMethod</span><span class=p>.</span><span class=na>toRequest</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
  <span class=c1>// serviceMethod.callFactory是我们传入的OkHttpClient对象</span>
  <span class=c1>// 这行代码就是new一个RealCall对象</span>
  <span class=n>okhttp3</span><span class=p>.</span><span class=na>Call</span> <span class=n>call</span> <span class=o>=</span> <span class=n>serviceMethod</span><span class=p>.</span><span class=na>callFactory</span><span class=p>.</span><span class=na>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>call</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=p>(</span><span class=s>&quot;Call.Factory returned null.&quot;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>call</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>我们看看<code>serviceMethod.toRequest(args)</code>如何拼凑出一个<code>Request</code>对象：</p> <div class=codehilite><pre><span></span><span class=cm>/** Builds an HTTP request from method arguments. */</span>
<span class=n>Request</span> <span class=nf>toRequest</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Object</span><span class=p>...</span> <span class=n>args</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=c1>// 还是用例子来说，此处RequestBuilder里面的参数依次为</span>
  <span class=c1>// GET, http://aaa.bbb.ccc/, rest/app/update, null, null, false, false, false</span>
  <span class=n>RequestBuilder</span> <span class=n>requestBuilder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RequestBuilder</span><span class=p>(</span><span class=n>httpMethod</span><span class=p>,</span> <span class=n>baseUrl</span><span class=p>,</span> <span class=n>relativeUrl</span><span class=p>,</span> <span class=n>headers</span><span class=p>,</span>
      <span class=n>contentType</span><span class=p>,</span> <span class=n>hasBody</span><span class=p>,</span> <span class=n>isFormEncoded</span><span class=p>,</span> <span class=n>isMultipart</span><span class=p>);</span>

  <span class=c1>// handlers只有一个：</span>
  <span class=c1>// ParameterHandler.Query(</span>
  <span class=c1>//   name = &quot;VersionCode&quot;,</span>
  <span class=c1>//   encoded = false,</span>
  <span class=c1>//   valueConverter = BuiltInConverters.ToStringConverter</span>
  <span class=c1>// )</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span> <span class=c1>// It is an error to invoke a method with the wrong arg types.</span>
  <span class=n>ParameterHandler</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;[]</span> <span class=n>handlers</span> <span class=o>=</span> <span class=p>(</span><span class=n>ParameterHandler</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;[]</span><span class=p>)</span> <span class=n>parameterHandlers</span><span class=p>;</span>

  <span class=kt>int</span> <span class=n>argumentCount</span> <span class=o>=</span> <span class=n>args</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>args</span><span class=p>.</span><span class=na>length</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>argumentCount</span> <span class=o>!=</span> <span class=n>handlers</span><span class=p>.</span><span class=na>length</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Argument count (&quot;</span> <span class=o>+</span> <span class=n>argumentCount</span>
        <span class=o>+</span> <span class=s>&quot;) doesn&#39;t match expected count (&quot;</span> <span class=o>+</span> <span class=n>handlers</span><span class=p>.</span><span class=na>length</span> <span class=o>+</span> <span class=s>&quot;)&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// 调用ParameterHandler.apply方法</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>p</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=n>argumentCount</span><span class=p>;</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>handlers</span><span class=o>[</span><span class=n>p</span><span class=o>]</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>requestBuilder</span><span class=p>,</span> <span class=n>args</span><span class=o>[</span><span class=n>p</span><span class=o>]</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>requestBuilder</span><span class=p>.</span><span class=na>build</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>上面调用了<code>ParameterHandler.Query.apply</code>方法：</p> <div class=codehilite><pre><span></span><span class=c1>// 此处value就是实例中versionCode的值，假设是10000</span>
<span class=nd>@Override</span> <span class=kt>void</span> <span class=nf>apply</span><span class=p>(</span><span class=n>RequestBuilder</span> <span class=n>builder</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=n>T</span> <span class=n>value</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span> <span class=c1>// Skip null values.</span>

  <span class=c1>// valueConverter是BuiltInConverters.ToStringConverter</span>
  <span class=c1>// 所以queryValue的值也是10000</span>
  <span class=n>String</span> <span class=n>queryValue</span> <span class=o>=</span> <span class=n>valueConverter</span><span class=p>.</span><span class=na>convert</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>queryValue</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span> <span class=c1>// Skip converted but null values</span>

  <span class=c1>// 最后调用了`RequestBuilder.addQueryParam`方法</span>
  <span class=n>builder</span><span class=p>.</span><span class=na>addQueryParam</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>queryValue</span><span class=p>,</span> <span class=n>encoded</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>继续跟踪一下<code>RequestBuilder.addQueryParam</code>方法：</p> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>addQueryParam</span><span class=p>(</span><span class=n>String</span> <span class=n>name</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>value</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>encoded</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// relativeUrl为rest/app/update</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>relativeUrl</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Do a one-time combination of the built relative URL and the base URL.</span>
    <span class=c1>// 接口URL的拼接，urlBuilder可以简单理解为baseUrl+relativeUrl</span>
    <span class=n>urlBuilder</span> <span class=o>=</span> <span class=n>baseUrl</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>(</span><span class=n>relativeUrl</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>urlBuilder</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span>
          <span class=s>&quot;Malformed URL. Base: &quot;</span> <span class=o>+</span> <span class=n>baseUrl</span> <span class=o>+</span> <span class=s>&quot;, Relative: &quot;</span> <span class=o>+</span> <span class=n>relativeUrl</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>relativeUrl</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>encoded</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>//noinspection ConstantConditions Checked to be non-null by above &#39;if&#39; block.</span>
    <span class=n>urlBuilder</span><span class=p>.</span><span class=na>addEncodedQueryParameter</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// 不加密，走这里</span>
    <span class=c1>// 里面会将参数value以及参数name进行UTF-8编码，涉及到的特殊字符会进行转义</span>
    <span class=c1>// urlBuilder是OkHttp3库中的，这里不做深入了解了</span>
    <span class=c1>//noinspection ConstantConditions Checked to be non-null by above &#39;if&#39; block.</span>
    <span class=n>urlBuilder</span><span class=p>.</span><span class=na>addQueryParameter</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>回到上面，执行完<code>createRawCall</code>之后，就继续执行<code>parseResponse(call.execute())</code>。由于此时的<code>call</code>是<code>RealCall</code>类型了，所以也不用多说。接下来就是<code>parseResponse</code>方法。</p> <div class=codehilite><pre><span></span><span class=n>Response</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>parseResponse</span><span class=p>(</span><span class=n>okhttp3</span><span class=p>.</span><span class=na>Response</span> <span class=n>rawResponse</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>ResponseBody</span> <span class=n>rawBody</span> <span class=o>=</span> <span class=n>rawResponse</span><span class=p>.</span><span class=na>body</span><span class=p>();</span>

  <span class=c1>// Remove the body&#39;s source (the only stateful object) so we can pass the response along.</span>
  <span class=n>rawResponse</span> <span class=o>=</span> <span class=n>rawResponse</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
      <span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=k>new</span> <span class=n>NoContentResponseBody</span><span class=p>(</span><span class=n>rawBody</span><span class=p>.</span><span class=na>contentType</span><span class=p>(),</span> <span class=n>rawBody</span><span class=p>.</span><span class=na>contentLength</span><span class=p>()))</span>
      <span class=p>.</span><span class=na>build</span><span class=p>();</span>

  <span class=kt>int</span> <span class=n>code</span> <span class=o>=</span> <span class=n>rawResponse</span><span class=p>.</span><span class=na>code</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>code</span> <span class=o>&lt;</span> <span class=mi>200</span> <span class=o>||</span> <span class=n>code</span> <span class=o>&gt;=</span> <span class=mi>300</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=c1>// Buffer the entire body to avoid future I/O.</span>
      <span class=n>ResponseBody</span> <span class=n>bufferedBody</span> <span class=o>=</span> <span class=n>Utils</span><span class=p>.</span><span class=na>buffer</span><span class=p>(</span><span class=n>rawBody</span><span class=p>);</span>
      <span class=k>return</span> <span class=n>Response</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>bufferedBody</span><span class=p>,</span> <span class=n>rawResponse</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
      <span class=n>rawBody</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>code</span> <span class=o>==</span> <span class=mi>204</span> <span class=o>||</span> <span class=n>code</span> <span class=o>==</span> <span class=mi>205</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>rawBody</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>Response</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=n>rawResponse</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>ExceptionCatchingRequestBody</span> <span class=n>catchingBody</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ExceptionCatchingRequestBody</span><span class=p>(</span><span class=n>rawBody</span><span class=p>);</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>T</span> <span class=n>body</span> <span class=o>=</span> <span class=n>serviceMethod</span><span class=p>.</span><span class=na>toResponse</span><span class=p>(</span><span class=n>catchingBody</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>Response</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>body</span><span class=p>,</span> <span class=n>rawResponse</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// If the underlying source threw an exception, propagate that rather than indicating it was</span>
    <span class=c1>// a runtime exception.</span>
    <span class=n>catchingBody</span><span class=p>.</span><span class=na>throwIfCaught</span><span class=p>();</span>
    <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>该方法前面几部分比较原始，我们关注一下<code>T body = serviceMethod.toResponse(catchingBody);</code>，</p> <div class=codehilite><pre><span></span><span class=cm>/** Builds a method return value from an HTTP response body. */</span>
<span class=n>R</span> <span class=nf>toResponse</span><span class=p>(</span><span class=n>ResponseBody</span> <span class=n>body</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>responseConverter</span><span class=p>.</span><span class=na>convert</span><span class=p>(</span><span class=n>body</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>这里面的<code>responseConverter</code>就是很早之前就创建好的<code>GsonResponseBodyConverter</code>。其<code>convert</code>方法如下所示：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>T</span> <span class=nf>convert</span><span class=p>(</span><span class=n>ResponseBody</span> <span class=n>value</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>JsonReader</span> <span class=n>jsonReader</span> <span class=o>=</span> <span class=n>gson</span><span class=p>.</span><span class=na>newJsonReader</span><span class=p>(</span><span class=n>value</span><span class=p>.</span><span class=na>charStream</span><span class=p>());</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>adapter</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>jsonReader</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>value</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <h2 id=7>7. 小结<a class=headerlink href=#7 title="Permanent link">&para;</a></h2> <p>至此，我们把Retrofit部分整个流程捋了一遍，下面小结一下。</p> <p>Retrofit使用了动态代理实现了我们定义的接口。在实现接口方法时，Retrofit会为每一个接口方法构建了一个<code>ServiceMethod</code>对象，并会缓存到ConcurrentHashMap中。在<code>ServiceMethod</code>构建时，会根据接口方法的注解类型、参数类型以及参数注解来拼接请求参数、确定请求类型、构建请求体等，同时会根据接口方法的注解和返回类型确定使用哪个<code>CallAdapter</code>包装<code>OkHttpCall</code>，同时根据接口方法的泛型类型参数以及方法注解确定使用哪个<code>Converter</code>提供请求体、响应体以及字符串转换服务。所有准备工作完成之后，调用了<code>CallAdapter.adapt</code>，在这里面真正开始了网络请求。</p> <h2 id=faq>FAQ<a class=headerlink href=#faq title="Permanent link">&para;</a></h2> <ol> <li>OkHttpClient每次网络请求都需要创建一个吗?<br> 不，绝大多数情况下都可以使用单例模式。<br> <cite>Most applications should call <code>new OkHttpClient()</code> exactly once, configure it with their cache, and use that same instance everywhere.</cite></li> <li>Retrofit每次网络请求也需要创建一个吗?<br> 不。因为Retrofit每次加载新方法，都会缓存起来。如果每次都创建一个新的，那么缓存机制毫无作用。</li> <li>OkHttp+Retrofit如何给网络请求打上tag？如何获取请求的tag？如何批量取消某种tag的请求？<br> 使用Retrofit时绝大多数情况下不会直接接触到<code>Request</code>，所以无法有显而易见的方式来完成。不过好在<code>Retrofit.Builder.callFactory</code>可以完成由<code>Request</code>到<code>Call</code>的构造，在这里面我们可以打下tag。<br> <div class=codehilite><pre><span></span><span class=n>Retrofit</span><span class=p>.</span><span class=na>Builder</span><span class=p>()</span>
  <span class=p>.</span><span class=na>client</span><span class=p>(</span><span class=n>okHttpClient</span><span class=p>)</span>
  <span class=p>.</span><span class=na>baseUrl</span><span class=p>(</span><span class=n>apiUrl</span><span class=p>)</span>
  <span class=p>.</span><span class=na>addCallAdapterFactory</span><span class=p>(</span><span class=n>RxJava2CallAdapterFactory</span><span class=p>.</span><span class=na>create</span><span class=p>())</span>
  <span class=p>.</span><span class=na>addConverterFactory</span><span class=p>(</span><span class=n>GsonConverterFactory</span><span class=p>.</span><span class=na>create</span><span class=p>())</span>
  <span class=p>.</span><span class=na>callFactory</span> <span class=p>{</span>
      <span class=n>okHttpClient</span><span class=p>.</span><span class=na>newCall</span><span class=p>(</span><span class=n>it</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>().</span><span class=na>tag</span><span class=p>(</span><span class=s>&quot;Hello&quot;</span><span class=p>).</span><span class=na>build</span><span class=p>())</span>
  <span class=p>}</span>
  <span class=p>.</span><span class=na>build</span><span class=p>()</span>
</pre></div> 在<code>OkHttpClient</code>的拦截器中等可以接触到<code>Request</code>的位置使用其<code>tag()</code>方法获取到。<br> 取消带tag的请求参考<a href=https://blog.csdn.net/buyaoshitududongwo/article/details/80048179>okhttp3关于tag取消请求</a>，主要就是通过<code>OkHttpClient</code>实例的<code>dispatcher().queuedCalls()</code>和<code>dispatcher().runningCalls()</code>取得对应状态的Request队列，然后遍历取其tag，取消指定tag的Request。</li> </ol> <hr> <div class=md-source-date> <small> 最后更新: 2020年1月13日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/3rd-library/retrofit/";
      this.page.identifier =
        "/android/3rd-library/retrofit/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../okhttp/ title=OkHttp3源码解析 class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> OkHttp3源码解析 </span> </div> </a> <a href=../rxjava&rxandroid/ title=RxJava源码解析及使用实例 class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> RxJava源码解析及使用实例 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
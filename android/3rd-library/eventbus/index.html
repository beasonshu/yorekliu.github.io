<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/3rd-library/eventbus/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>EventBus源码解析</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - EventBus源码解析"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/3rd-library/eventbus/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - EventBus源码解析"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1 tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> EventBus源码解析 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1 checked> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> EventBus源码解析 </label> <a href=./ title=EventBus源码解析 class="md-nav__link md-nav__link--active"> EventBus源码解析 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 简单使用 </a> </li> <li class=md-nav__item> <a href=#2-eventbus class=md-nav__link> 2. EventBus源码解析 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21 class=md-nav__link> 2.1 注册过程 </a> </li> <li class=md-nav__item> <a href=#22 class=md-nav__link> 2.2 发送事件 </a> </li> <li class=md-nav__item> <a href=#23 class=md-nav__link> 2.3 注销过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-eventbus class=md-nav__link> 3. 跨进程EventBus </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31 class=md-nav__link> 3.1 简单实现 </a> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> 3.2 使用示例 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 简单使用 </a> </li> <li class=md-nav__item> <a href=#2-eventbus class=md-nav__link> 2. EventBus源码解析 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21 class=md-nav__link> 2.1 注册过程 </a> </li> <li class=md-nav__item> <a href=#22 class=md-nav__link> 2.2 发送事件 </a> </li> <li class=md-nav__item> <a href=#23 class=md-nav__link> 2.3 注销过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-eventbus class=md-nav__link> 3. 跨进程EventBus </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31 class=md-nav__link> 3.1 简单实现 </a> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> 3.2 使用示例 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>EventBus源码解析</h1> <div class="admonition info"> <p class=admonition-title>Info</p> <p>本文基于<a href=https://github.com/greenrobot/EventBus/tree/V3.1.1>EventBus</a>最新v3.1.1版本进行分析。</p> </div> <h2 id=1>1. 简单使用<a class=headerlink href=#1 title="Permanent link">&para;</a></h2> <p>EventBus有两种使用方式： - 可以配置注解处理器预先提取回调方法到辅助文件中，这样在运行时就不需要通过反射获取回调方法了 - 也可以不配置注解处理器，让EventBus在运行时通过反射获取</p> <p>EventBus如何使用注解处理器可以参考官网文档<a href=http://greenrobot.org/eventbus/documentation/subscriber-index/ >Subscriber Index</a>。在kotlin环境下步骤如下：</p> <ol> <li> <p>添加依赖项以及注解处理器，编译之后会将回调方法编译进<code>com.example.myapp.MyEventBusIndex</code>文件中 <div class=codehilite><pre><span></span>apply plugin: &#39;kotlin-kapt&#39; // ensure kapt plugin is applied

dependencies {
    implementation &#39;org.greenrobot:eventbus:3.1.1&#39;
    kapt &#39;org.greenrobot:eventbus-annotation-processor:3.1.1&#39;
}

kapt {
    arguments {
        arg(&#39;eventBusIndex&#39;, &#39;com.example.myapp.MyEventBusIndex&#39;)
    }
}
</pre></div></p> </li> <li> <p>使用<code>com.example.myapp.MyEventBusIndex</code>文件<br> 我们可以这样设置EventBus：<br> <div class=codehilite><pre><span></span><span class=n>EventBus</span> <span class=n>eventBus</span> <span class=o>=</span> <span class=n>EventBus</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>addIndex</span><span class=p>(</span><span class=k>new</span> <span class=n>MyEventBusIndex</span><span class=p>()).</span><span class=na>build</span><span class=p>();</span>
</pre></div> 或者，如果我们想要继续使用EventBus的默认实例： <div class=codehilite><pre><span></span><span class=n>EventBus</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>addIndex</span><span class=p>(</span><span class=k>new</span> <span class=n>MyEventBusIndex</span><span class=p>()).</span><span class=na>installDefaultEventBus</span><span class=p>();</span>
<span class=c1>// Now the default instance uses the given index. Use it like this:</span>
<span class=n>EventBus</span> <span class=n>eventBus</span> <span class=o>=</span> <span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span>
</pre></div></p> </li> <li> <p>使用Library的索引<br> 如果我们既有Library的索引，也有App的索引，我们可以在EventBus设置过程中全部添加它们，例如： <div class=codehilite><pre><span></span><span class=n>EventBus</span> <span class=n>eventBus</span> <span class=o>=</span> <span class=n>EventBus</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span>
    <span class=p>.</span><span class=na>addIndex</span><span class=p>(</span><span class=k>new</span> <span class=n>MyEventBusAppIndex</span><span class=p>())</span>
    <span class=p>.</span><span class=na>addIndex</span><span class=p>(</span><span class=k>new</span> <span class=n>MyEventBusLibIndex</span><span class=p>()).</span><span class=na>build</span><span class=p>();</span>
</pre></div></p> </li> </ol> <p>在上面的配置完成之后，下面给出简单的示例，以及所生成的辅助文件。</p> <figcaption>示例代码</figcaption> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>EventBusActivity</span> <span class=p>:</span> <span class=n>BaseActivity</span><span class=p>()</span> <span class=p>{</span>

    <span class=n>init</span> <span class=p>{</span>
        <span class=c1>// 初始化带Index文件的EventBus</span>
        <span class=n>EventBus</span><span class=p>.</span><span class=n>builder</span><span class=p>().</span><span class=n>addIndex</span><span class=p>(</span><span class=n>MyEventBusIndex</span><span class=p>()).</span><span class=n>installDefaultEventBus</span><span class=p>()</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
        <span class=c1>// EventBus的注册</span>
        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>

        <span class=c1>// 通过EventBus发送消息</span>
        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>post</span><span class=p>(</span><span class=n>Any</span><span class=p>())</span>
    <span class=p>}</span>

    <span class=n>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>BACKGROUND</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>1</span><span class=p>)</span>
    <span class=k>fun</span> <span class=nf>onTest</span><span class=p>(</span><span class=n>obj</span> <span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;&gt;&gt;&gt;&gt;&gt;&gt; trigger ${Thread.currentThread().name}&quot;</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=n>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>MAIN</span><span class=p>,</span> <span class=n>priority</span> <span class=p>=</span> <span class=m>2</span><span class=p>)</span>
    <span class=k>fun</span> <span class=nf>onTestMain</span><span class=p>(</span><span class=n>obj</span> <span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=s>&quot;Yorek&quot;</span><span class=p>,</span> <span class=s>&quot;&gt;&gt;&gt;&gt;&gt;&gt; trigger ${Thread.currentThread().name}&quot;</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// EventBus的注销</span>
        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <figcaption>编译后生成的辅助文件</figcaption> <div class=codehilite><pre><span></span><span class=cm>/** This class is generated by EventBus, do not edit. */</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyEventBusIndex</span> <span class=kd>implements</span> <span class=n>SubscriberInfoIndex</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span> <span class=n>SUBSCRIBER_INDEX</span><span class=p>;</span>

    <span class=kd>static</span> <span class=p>{</span>
        <span class=n>SUBSCRIBER_INDEX</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>SubscriberInfo</span><span class=o>&gt;</span><span class=p>();</span>

        <span class=n>putIndex</span><span class=p>(</span><span class=k>new</span> <span class=n>SimpleSubscriberInfo</span><span class=p>(</span><span class=n>yorek</span><span class=p>.</span><span class=na>demoandtest</span><span class=p>.</span><span class=na>eventbus</span><span class=p>.</span><span class=na>EventBusActivity</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span>
                <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=o>[]</span> <span class=p>{</span>
            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=p>(</span><span class=s>&quot;onTest&quot;</span><span class=p>,</span> <span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=na>BACKGROUND</span><span class=p>),</span>
            <span class=k>new</span> <span class=n>SubscriberMethodInfo</span><span class=p>(</span><span class=s>&quot;onTestMain&quot;</span><span class=p>,</span> <span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=na>MAIN</span><span class=p>),</span>
        <span class=p>}));</span>

    <span class=p>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>putIndex</span><span class=p>(</span><span class=n>SubscriberInfo</span> <span class=n>info</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>SUBSCRIBER_INDEX</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>getSubscriberClass</span><span class=p>(),</span> <span class=n>info</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>SUBSCRIBER_INDEX</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>info</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>通过生成的辅助文件，我们可以看到示例代码中两个回调方法都添加到了<code>SUBSCRIBER_INDEX</code>这个map中，这样后面在注册时，就可以直接获取方法了，不需要反射获取，为广大客户节约了一点点时间。</p> <h2 id=2-eventbus>2. EventBus源码解析<a class=headerlink href=#2-eventbus title="Permanent link">&para;</a></h2> <h3 id=21>2.1 注册过程<a class=headerlink href=#21 title="Permanent link">&para;</a></h3> <p>我们先看<code>EventBus.register</code>方法，在分析过程中遇到的字段再回过头来分析。</p> <p><strong>EventBus.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>register</span><span class=p>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span> <span class=o>=</span> <span class=n>subscriber</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>subscriberMethodFinder</span><span class=p>.</span><span class=na>findSubscriberMethods</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=p>:</span> <span class=n>subscriberMethods</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>subscribe</span><span class=p>(</span><span class=n>subscriber</span><span class=p>,</span> <span class=n>subscriberMethod</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>上面的代码可以分为两个部分，2~3行完成了注册对象中<code>@Subscribe</code>方法的解析，后面的代码真正完成了注册。<br> 我们先看看第3行<code>subscriberMethodFinder.findSubscriberMethods(subscriberClass)</code>是如何完成<code>@Subscribe</code>方法的解析的。<code>subscriberMethodFinder</code>在EventBus创建的时候就已经确定了，其构造方法如下：</p> <p><strong>SubscriberMethodFinder.java</strong></p> <div class=codehilite><pre><span></span><span class=n>SubscriberMethodFinder</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberInfoIndex</span><span class=o>&gt;</span> <span class=n>subscriberInfoIndexes</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>strictMethodVerification</span><span class=p>,</span>
                        <span class=kt>boolean</span> <span class=n>ignoreGeneratedIndex</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>subscriberInfoIndexes</span> <span class=o>=</span> <span class=n>subscriberInfoIndexes</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>strictMethodVerification</span> <span class=o>=</span> <span class=n>strictMethodVerification</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>ignoreGeneratedIndex</span> <span class=o>=</span> <span class=n>ignoreGeneratedIndex</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p><code>subscriberInfoIndexes</code>里面只有注解解释器生成的<code>MyEventBusIndex</code>对象，其他两个参数都是默认值false。下面我们深入<code>findSubscriberMethods</code>方法：</p> <div class=codehilite><pre><span></span><span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findSubscriberMethods</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>METHOD_CACHE</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscriberMethods</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>ignoreGeneratedIndex</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingReflection</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>subscriberMethods</span> <span class=o>=</span> <span class=n>findUsingInfo</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscriberMethods</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=p>(</span><span class=s>&quot;Subscriber &quot;</span> <span class=o>+</span> <span class=n>subscriberClass</span>
                <span class=o>+</span> <span class=s>&quot; and its super classes have no public methods with the @Subscribe annotation&quot;</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>METHOD_CACHE</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>,</span> <span class=n>subscriberMethods</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>subscriberMethods</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在<code>findSubscriberMethods</code>方法的2~5行，是取缓存的操作。假设一下，由于一个页面的生命周期频繁的发生变化，导致频繁的注册、注销，这时候缓存就非常有用了。方法最后返回返回值前，会进行缓存的更新。这就是一个完成的缓存流程了。<br> 第7行中，由于<code>ignoreGeneratedIndex</code>默认为false，所以执行第10行的<code>findUsingInfo</code>方法来获取订阅类的回调方法。顺便提一下，第8行的<code>findUsingReflection</code>方法顾名思义是使用反射来获取回调方法的，第10行的<code>findUsingInfo</code>方法在没有从注解处理器生成的Index文件中找到回调方法时，也会使用反射来获取回调方法。因此，<code>findUsingInfo</code>等于是<code>findUsingReflection</code>方法的加强版本。两个方法如下：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingReflection</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=p>();</span>
    <span class=n>findState</span><span class=p>.</span><span class=na>initForSubscriber</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>findUsingReflectionInSingleClass</span><span class=p>(</span><span class=n>findState</span><span class=p>);</span>
        <span class=n>findState</span><span class=p>.</span><span class=na>moveToSuperclass</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=p>(</span><span class=n>findState</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span> <span class=nf>findUsingInfo</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>subscriberClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>FindState</span> <span class=n>findState</span> <span class=o>=</span> <span class=n>prepareFindState</span><span class=p>();</span>
    <span class=n>findState</span><span class=p>.</span><span class=na>initForSubscriber</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>findState</span><span class=p>.</span><span class=na>subscriberInfo</span> <span class=o>=</span> <span class=n>getSubscriberInfo</span><span class=p>(</span><span class=n>findState</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>SubscriberMethod</span><span class=o>[]</span> <span class=n>array</span> <span class=o>=</span> <span class=n>findState</span><span class=p>.</span><span class=na>subscriberInfo</span><span class=p>.</span><span class=na>getSubscriberMethods</span><span class=p>();</span>
            <span class=k>for</span> <span class=p>(</span><span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span> <span class=p>:</span> <span class=n>array</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>checkAdd</span><span class=p>(</span><span class=n>subscriberMethod</span><span class=p>.</span><span class=na>method</span><span class=p>,</span> <span class=n>subscriberMethod</span><span class=p>.</span><span class=na>eventType</span><span class=p>))</span> <span class=p>{</span>
                    <span class=n>findState</span><span class=p>.</span><span class=na>subscriberMethods</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>subscriberMethod</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>findUsingReflectionInSingleClass</span><span class=p>(</span><span class=n>findState</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>findState</span><span class=p>.</span><span class=na>moveToSuperclass</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>getMethodsAndRelease</span><span class=p>(</span><span class=n>findState</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>我们顺着分析一下<code>findUsingInfo</code>方法。在第12行中，会通过<code>prepareFindState()</code>方法尝试从对象池中获取一个<code>FindState</code>对象，若对象池中没有可用的对象，则新建一个。第13行初始化<code>FindState</code>对象，使其内部的<code>subscriberClass</code>、<code>clazz</code>都是订阅类。后面的while循环就是从当前的订阅类开始，一直向父类进行循环操作，也就是说，这里**会解析当前订阅类的父类里面的方法**。<br> 接着，看第15行的<code>getSubscriberInfo</code>方法，在该方法中会将注解处理器生成的Index里面的回调方法返回：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=n>SubscriberInfo</span> <span class=nf>getSubscriberInfo</span><span class=p>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>subscriberInfo</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>findState</span><span class=p>.</span><span class=na>subscriberInfo</span><span class=p>.</span><span class=na>getSuperSubscriberInfo</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>SubscriberInfo</span> <span class=n>superclassInfo</span> <span class=o>=</span> <span class=n>findState</span><span class=p>.</span><span class=na>subscriberInfo</span><span class=p>.</span><span class=na>getSuperSubscriberInfo</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>clazz</span> <span class=o>==</span> <span class=n>superclassInfo</span><span class=p>.</span><span class=na>getSubscriberClass</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>superclassInfo</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscriberInfoIndexes</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>SubscriberInfoIndex</span> <span class=n>index</span> <span class=p>:</span> <span class=n>subscriberInfoIndexes</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>SubscriberInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>index</span><span class=p>.</span><span class=na>getSubscriberInfo</span><span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>clazz</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>info</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=n>info</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在通过<code>findState.checkAdd</code>校验之后，两个示例方法都加入了<code>findState.subscriberMethods</code>中，然后由<code>getMethodsAndRelease(findState)</code>方法返回。<code>getMethodsAndRelease</code>方法就是将<code>findState.subscriberMethods</code>复制了出来，然后回收了<code>FindState</code>对象。</p> <p>上面就是注解处理器生成的Index参与的时候的流程。在这里还是有必要说一下没有Index参与时的流程，也就是<code>findUsingReflectionInSingleClass</code>方法是如何获取订阅类的回调方法的。<br> 其实不用说我们也知道，肯定是反射，且从方法名上也可以看出来。该方法的源码以及解释如下：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>findUsingReflectionInSingleClass</span><span class=p>(</span><span class=n>FindState</span> <span class=n>findState</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Method</span><span class=o>[]</span> <span class=n>methods</span><span class=p>;</span>
    <span class=k>try</span> <span class=p>{</span>
        <span class=c1>// This is faster than getMethods, especially when subscribers are fat classes like Activities</span>
        <span class=c1>// 获取该类的所有方法，不包括父类</span>
        <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=p>.</span><span class=na>clazz</span><span class=p>.</span><span class=na>getDeclaredMethods</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>th</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span>
        <span class=c1>// 获取该类以及父类的所有public方法，同时指定忽略父类</span>
        <span class=n>methods</span> <span class=o>=</span> <span class=n>findState</span><span class=p>.</span><span class=na>clazz</span><span class=p>.</span><span class=na>getMethods</span><span class=p>();</span>
        <span class=n>findState</span><span class=p>.</span><span class=na>skipSuperClasses</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>Method</span> <span class=n>method</span> <span class=p>:</span> <span class=n>methods</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getModifiers</span><span class=p>();</span>
        <span class=c1>// 判断方法是否是PUBLIC且不是ABSTRACT、STATIC、SYNTHETIC</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>Modifier</span><span class=p>.</span><span class=na>PUBLIC</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>modifiers</span> <span class=o>&amp;</span> <span class=n>MODIFIERS_IGNORE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>();</span>
            <span class=c1>// 判断该方法的参数是不是只有一个</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>parameterTypes</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 判断方法是否有Subscribe注解</span>
                <span class=n>Subscribe</span> <span class=n>subscribeAnnotation</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getAnnotation</span><span class=p>(</span><span class=n>Subscribe</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>subscribeAnnotation</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// 方法是PUBLIC且不是ABSTRACT、STATIC、SYNTHETIC</span>
                    <span class=c1>// 同时方法参数只有一个，且带有Subscribe注解</span>
                    <span class=c1>// 以上条件都满足后，就进行最后的校验，然后添加到findState.subscriberMethods中</span>
                    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>findState</span><span class=p>.</span><span class=na>checkAdd</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>eventType</span><span class=p>))</span> <span class=p>{</span>
                        <span class=n>ThreadMode</span> <span class=n>threadMode</span> <span class=o>=</span> <span class=n>subscribeAnnotation</span><span class=p>.</span><span class=na>threadMode</span><span class=p>();</span>
                        <span class=n>findState</span><span class=p>.</span><span class=na>subscriberMethods</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>SubscriberMethod</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>eventType</span><span class=p>,</span> <span class=n>threadMode</span><span class=p>,</span>
                                <span class=n>subscribeAnnotation</span><span class=p>.</span><span class=na>priority</span><span class=p>(),</span> <span class=n>subscribeAnnotation</span><span class=p>.</span><span class=na>sticky</span><span class=p>()));</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=p>.</span><span class=na>isAnnotationPresent</span><span class=p>(</span><span class=n>Subscribe</span><span class=p>.</span><span class=na>class</span><span class=p>))</span> <span class=p>{</span>
                <span class=c1>// 如果开启了严格验证（默认不开启），且方法有Subscribe注解，则抛出异常</span>
                <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot;.&quot;</span> <span class=o>+</span> <span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=p>(</span><span class=s>&quot;@Subscribe method &quot;</span> <span class=o>+</span> <span class=n>methodName</span> <span class=o>+</span>
                        <span class=s>&quot;must have exactly 1 parameter but has &quot;</span> <span class=o>+</span> <span class=n>parameterTypes</span><span class=p>.</span><span class=na>length</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strictMethodVerification</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=p>.</span><span class=na>isAnnotationPresent</span><span class=p>(</span><span class=n>Subscribe</span><span class=p>.</span><span class=na>class</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 如果开启了严格验证（默认不开启），且方法有Subscribe注解，则抛出异常</span>
            <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot;.&quot;</span> <span class=o>+</span> <span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=p>(</span><span class=n>methodName</span> <span class=o>+</span>
                    <span class=s>&quot; is a illegal @Subscribe method: must be public, non-static, and non-abstract&quot;</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>从上面方法的分析我们可以看出，订阅类的方法要满足以下条件，才能够顺利的进行注册：</p> <ol> <li>方法必须是<code>public</code>的，且不能是<code>abstract</code>、<code>static</code>、<code>synthetic</code>的</li> <li>方法参数必须只有一个</li> <li>方法必须带有<code>@Subscribe</code>注解</li> </ol> <p>上面这些内容就是订阅类回调方法的获取过程了，下面说说回调方法是如何进行注册的。方法为<code>EventBus.subscribe</code>：</p> <p><strong>EventBus.java</strong></p> <div class=codehilite><pre><span></span><span class=c1>// Must be called in synchronized block</span>
<span class=kd>private</span> <span class=kt>void</span> <span class=nf>subscribe</span><span class=p>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=p>,</span> <span class=n>SubscriberMethod</span> <span class=n>subscriberMethod</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// eventType为回调方法的入参类型，Object类型</span>
    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=o>=</span> <span class=n>subscriberMethod</span><span class=p>.</span><span class=na>eventType</span><span class=p>;</span>
    <span class=c1>// 将订阅者以及订阅方法封装为一个Subscription类</span>
    <span class=n>Subscription</span> <span class=n>newSubscription</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Subscription</span><span class=p>(</span><span class=n>subscriber</span><span class=p>,</span> <span class=n>subscriberMethod</span><span class=p>);</span>
    <span class=c1>// subscriptionsByEventType：以订阅方法的参数为key，Subscription为value进行保存</span>
    <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscriptions</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>subscriptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
        <span class=n>subscriptionsByEventType</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>eventType</span><span class=p>,</span> <span class=n>subscriptions</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>subscriptions</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=p>(</span><span class=s>&quot;Subscriber &quot;</span> <span class=o>+</span> <span class=n>subscriber</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot; already registered to event &quot;</span>
                    <span class=o>+</span> <span class=n>eventType</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 在订阅参数对应的Subscription列表中按照订阅方法的优先级进行排序</span>
    <span class=c1>// priority的数值越高，越在列表的前面；相同priority的方法，后来的方法会在后面</span>
    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>size</span> <span class=o>||</span> <span class=n>subscriberMethod</span><span class=p>.</span><span class=na>priority</span> <span class=o>&gt;</span> <span class=n>subscriptions</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>priority</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>subscriptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>newSubscription</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// typesBySubscriber：以订阅者为key，订阅方法参数为value进行保存</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>subscribedEvents</span> <span class=o>=</span> <span class=n>typesBySubscriber</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>subscriber</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscribedEvents</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>subscribedEvents</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
        <span class=n>typesBySubscriber</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>subscriber</span><span class=p>,</span> <span class=n>subscribedEvents</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>subscribedEvents</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span>

    <span class=c1>// 最后，如果订阅方法为粘性的，则会在注册时接受到粘性事件</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscriberMethod</span><span class=p>.</span><span class=na>sticky</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>eventInheritance</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Existing sticky events of all subclasses of eventType have to be considered.</span>
            <span class=c1>// Note: Iterating over all events may be inefficient with lots of sticky events,</span>
            <span class=c1>// thus data structure should be changed to allow a more efficient lookup</span>
            <span class=c1>// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span>
            <span class=n>Set</span><span class=o>&lt;</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>stickyEvents</span><span class=p>.</span><span class=na>entrySet</span><span class=p>();</span>
            <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>candidateEventType</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>eventType</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>candidateEventType</span><span class=p>))</span> <span class=p>{</span>
                    <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
                    <span class=n>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>,</span> <span class=n>stickyEvent</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>stickyEvents</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span>
            <span class=n>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>,</span> <span class=n>stickyEvent</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在上面的方法中，会先将订阅者以及订阅事件包装成为一个<code>Subscription</code>对象，然后与其他参数一起保存起来，具体为下面两个保存的地方：</p> <ul> <li><code>subscriptionsByEventType</code> 以订阅事件参数为key，对应<code>Subscription</code>对象数组</li> <li><code>typesBySubscriber</code> 以订阅者对象为key，对应订阅事件参数数组</li> </ul> <p>另外，Subscription对象还会根据priority进行排序，具体来说：priority的数值越高，越在列表的前面；相同priority的方法，后来的方法会在后面。</p> <p>同时我们还可以看出粘性事件的触发机制：</p> <ol> <li>粘性事件发出时，会主动通知所有可以处理的方法，不管方法是否是粘性的 <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postSticky</span><span class=p>(</span><span class=n>Object</span> <span class=n>event</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>stickyEvents</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>stickyEvents</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span> <span class=n>event</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// Should be posted after it is putted, in case the subscriber wants to remove immediately</span>
    <span class=n>post</span><span class=p>(</span><span class=n>event</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></li> <li>在订阅者进行注册时，如果有可以响应的粘性事件，粘性方法会被触发 <div class=codehilite><pre><span></span><span class=k>if</span> <span class=p>(</span><span class=n>subscriberMethod</span><span class=p>.</span><span class=na>sticky</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>eventInheritance</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>...</span>
        <span class=k>for</span> <span class=p>(...)</span> <span class=p>{</span>
             <span class=p>...</span>
            <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
                <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
                <span class=n>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>,</span> <span class=n>stickyEvent</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>Object</span> <span class=n>stickyEvent</span> <span class=o>=</span> <span class=n>stickyEvents</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span>
        <span class=n>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>,</span> <span class=n>stickyEvent</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></li> </ol> <h3 id=22>2.2 发送事件<a class=headerlink href=#22 title="Permanent link">&para;</a></h3> <p>我们可以调用<code>EventBus.post</code>以及<code>EventBus.postSticky</code>这两个方法来发送事件，前者是普通事件，后者是粘性事件。</p> <p>粘性事件的发送比较简单，该方法除了保存了事件之外，还调用了<code>post</code>方法当做非粘性事件进行了分发。此时，会主动通知所有可以处理的方法，不管方法是否是粘性的：</p> <p><strong>EventBus.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>postSticky</span><span class=p>(</span><span class=n>Object</span> <span class=n>event</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>stickyEvents</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>stickyEvents</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span> <span class=n>event</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// Should be posted after it is putted, in case the subscriber wants to remove immediately</span>
    <span class=n>post</span><span class=p>(</span><span class=n>event</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>另外，在订阅者进行注册时，如果有可以响应的粘性事件，粘性方法会被触发，代码在<a href=/android/3rd-library/eventbus/#21>2.1节——注册过程</a>的末尾有讲解。</p> <p>粘性事件不会被消耗掉，除非手动remove掉</p> <ul> <li><code>removeStickyEvent(Class&lt;T&gt;)</code></li> <li><code>removeStickyEvent(Object)</code></li> <li><code>removeAllStickyEvents()</code></li> </ul> <p>更多可以参考<a href=http://greenrobot.org/eventbus/documentation/configuration/sticky-events/ >Sticky Events</a></p> <p>接下来，我们看看<code>EventBus.post</code>是如何触发订阅者的回调事件的。</p> <p><strong>EventBus.java</strong></p> <div class=codehilite><pre><span></span><span class=cm>/** For ThreadLocal, much faster to set (and get multiple values). */</span>
<span class=kd>final</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>PostingThreadState</span> <span class=p>{</span>
    <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>eventQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
    <span class=kt>boolean</span> <span class=n>isPosting</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>isMainThread</span><span class=p>;</span>
    <span class=n>Subscription</span> <span class=n>subscription</span><span class=p>;</span>
    <span class=n>Object</span> <span class=n>event</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>canceled</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kd>final</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;</span> <span class=n>currentPostingThreadState</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;</span><span class=p>()</span> <span class=p>{</span>
    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=n>PostingThreadState</span> <span class=nf>initialValue</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>PostingThreadState</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>};</span>

<span class=cm>/** Posts the given event to the event bus. */</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>post</span><span class=p>(</span><span class=n>Object</span> <span class=n>event</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>PostingThreadState</span> <span class=n>postingState</span> <span class=o>=</span> <span class=n>currentPostingThreadState</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>eventQueue</span> <span class=o>=</span> <span class=n>postingState</span><span class=p>.</span><span class=na>eventQueue</span><span class=p>;</span>
    <span class=n>eventQueue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>event</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>postingState</span><span class=p>.</span><span class=na>isPosting</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>postingState</span><span class=p>.</span><span class=na>isMainThread</span> <span class=o>=</span> <span class=n>isMainThread</span><span class=p>();</span>
        <span class=n>postingState</span><span class=p>.</span><span class=na>isPosting</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>postingState</span><span class=p>.</span><span class=na>canceled</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>EventBusException</span><span class=p>(</span><span class=s>&quot;Internal error. Abort state was not reset&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>eventQueue</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
                <span class=n>postSingleEvent</span><span class=p>(</span><span class=n>eventQueue</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>postingState</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>postingState</span><span class=p>.</span><span class=na>isPosting</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
            <span class=n>postingState</span><span class=p>.</span><span class=na>isMainThread</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>EventBus.post</code>的相关代码如上所示，<code>post</code>的事件会加入到一个事件队列里面，然后开始执行。当在极短时间内多次调用<code>post</code>方法时，只会将事件添加到队列里面，第24行的代码走不进去。而在31-33行代码里面，会取时间队列的头进行事件分发。最后所有事件处理完成后，标志位复位。<br> 下面我们看看<code>postSingleEvent</code>的方法，注释都在里面：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>postSingleEvent</span><span class=p>(</span><span class=n>Object</span> <span class=n>event</span><span class=p>,</span> <span class=n>PostingThreadState</span> <span class=n>postingState</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Error</span> <span class=p>{</span>
    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventClass</span> <span class=o>=</span> <span class=n>event</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span>
    <span class=kt>boolean</span> <span class=n>subscriptionFound</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>eventInheritance</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// lookupAllEventTypes方法的作用是查询class的父类以及接口，显然示例中就是一个Object</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>eventTypes</span> <span class=o>=</span> <span class=n>lookupAllEventTypes</span><span class=p>(</span><span class=n>eventClass</span><span class=p>);</span>
        <span class=kt>int</span> <span class=n>countTypes</span> <span class=o>=</span> <span class=n>eventTypes</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;</span> <span class=n>countTypes</span><span class=p>;</span> <span class=n>h</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>eventTypes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>h</span><span class=p>);</span>
            <span class=c1>// 调用postSingleEventForEventType方法</span>
            <span class=n>subscriptionFound</span> <span class=o>|=</span> <span class=n>postSingleEventForEventType</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>postingState</span><span class=p>,</span> <span class=n>clazz</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// 直接以当前的eventClass调用postSingleEventForEventType方法</span>
        <span class=n>subscriptionFound</span> <span class=o>=</span> <span class=n>postSingleEventForEventType</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>postingState</span><span class=p>,</span> <span class=n>eventClass</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// 最后，当没有订阅者可以处理该事件时，EventBus会抛出一个NoSubscriberEvent事件</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>subscriptionFound</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>logNoSubscriberMessages</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logger</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>FINE</span><span class=p>,</span> <span class=s>&quot;No subscribers registered for event &quot;</span> <span class=o>+</span> <span class=n>eventClass</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>sendNoSubscriberEvent</span> <span class=o>&amp;&amp;</span> <span class=n>eventClass</span> <span class=o>!=</span> <span class=n>NoSubscriberEvent</span><span class=p>.</span><span class=na>class</span> <span class=o>&amp;&amp;</span>
                <span class=n>eventClass</span> <span class=o>!=</span> <span class=n>SubscriberExceptionEvent</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>post</span><span class=p>(</span><span class=k>new</span> <span class=n>NoSubscriberEvent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>event</span><span class=p>));</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>接着看看<code>postSingleEventForEventType</code>方法</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>postSingleEventForEventType</span><span class=p>(</span><span class=n>Object</span> <span class=n>event</span><span class=p>,</span> <span class=n>PostingThreadState</span> <span class=n>postingState</span><span class=p>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// subscriptions就是示例中对应的两个方法</span>
    <span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span><span class=p>;</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventClass</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscriptions</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>subscriptions</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Subscription</span> <span class=n>subscription</span> <span class=p>:</span> <span class=n>subscriptions</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>postingState</span><span class=p>.</span><span class=na>event</span> <span class=o>=</span> <span class=n>event</span><span class=p>;</span>
            <span class=n>postingState</span><span class=p>.</span><span class=na>subscription</span> <span class=o>=</span> <span class=n>subscription</span><span class=p>;</span>
            <span class=kt>boolean</span> <span class=n>aborted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=c1>// 调用postToSubscription进行真正的分发</span>
                <span class=n>postToSubscription</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>,</span> <span class=n>postingState</span><span class=p>.</span><span class=na>isMainThread</span><span class=p>);</span>
                <span class=n>aborted</span> <span class=o>=</span> <span class=n>postingState</span><span class=p>.</span><span class=na>canceled</span><span class=p>;</span>
            <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
                <span class=n>postingState</span><span class=p>.</span><span class=na>event</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
                <span class=n>postingState</span><span class=p>.</span><span class=na>subscription</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
                <span class=n>postingState</span><span class=p>.</span><span class=na>canceled</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>aborted</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>break</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在上面的方法中，最终调用了<code>postToSubscription</code>方法完成了最终的事件分发。且这里需要注意一个系列，只要eventClass可以找到对应的Subscription，那么该方法就会返回true，也就是说已经发送给订阅者了。</p> <p>最后看看<code>postToSubscription</code>方法，该方法会根据方法的threaMode值，决定在哪如何触发回调方法：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>postToSubscription</span><span class=p>(</span><span class=n>Subscription</span> <span class=n>subscription</span><span class=p>,</span> <span class=n>Object</span> <span class=n>event</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isMainThread</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>threadMode</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=n>POSTING</span><span class=p>:</span>
            <span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=n>MAIN</span><span class=p>:</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>isMainThread</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>mainThreadPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=n>MAIN_ORDERED</span><span class=p>:</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>mainThreadPoster</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>mainThreadPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// temporary: technically not correct as poster not decoupled from subscriber</span>
                <span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=n>BACKGROUND</span><span class=p>:</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>isMainThread</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>backgroundPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=n>ASYNC</span><span class=p>:</span>
            <span class=n>asyncPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>default</span><span class=p>:</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Unknown thread mode: &quot;</span> <span class=o>+</span> <span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>threadMode</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>这里面5种ThreadMode，采取的手段也不一样。从该枚举值的定义可以看出，分为5种情况，下表就是每种情况的含义：</p> <figcaption>ThreadMode的含义</figcaption> <table> <thead> <tr> <th></th> <th>含义</th> <th>解决方式</th> </tr> </thead> <tbody> <tr> <td>POSTING</td> <td>在发送事件的线程中执行</td> <td>回调方法会立刻触发</td> </tr> <tr> <td>MAIN</td> <td>在主线程中执行</td> <td>如果事件的发送发生在主线程，则立刻执行；否则让mainThreadPoster将回调提交到主线程的队列中</td> </tr> <tr> <td>MAIN_ORDERED</td> <td>在主线程中按顺序执行</td> <td>让mainThreadPoster将回调提交到主线程的队列中</td> </tr> <tr> <td>BACKGROUND</td> <td>在后台线程中执行</td> <td>如果当前线程是UI线程，则让backgroundPoster提交回调到队列中；否则直接触发方法</td> </tr> <tr> <td>ASYNC</td> <td>在单独的线程中执行</td> <td>将任务提交到asyncPoster中</td> </tr> </tbody> </table> <p>无论在哪个线程中执行，最后都会调用<code>invokeSubscriber</code>方法来触发回调任务：</p> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>invokeSubscriber</span><span class=p>(</span><span class=n>Subscription</span> <span class=n>subscription</span><span class=p>,</span> <span class=n>Object</span> <span class=n>event</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>try</span> <span class=p>{</span>
        <span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriber</span><span class=p>,</span> <span class=n>event</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InvocationTargetException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>handleSubscriberException</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span> <span class=n>event</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=na>getCause</span><span class=p>());</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IllegalAccessException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Unexpected exception&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>这里通过反射调用了订阅者的回调方法。至此，事件的发送已经分析完毕。</p> <h3 id=23>2.3 注销过程<a class=headerlink href=#23 title="Permanent link">&para;</a></h3> <p>注销过程原理比较简单，就是将注册时保存到<code>subscriptionsByEventType</code>、<code>typesBySubscriber</code>两个集合中的元素删除。</p> <p>这两个集合在注册过程中分析过： - <code>subscriptionsByEventType</code> 以订阅事件参数为key，对应Subscription对象数组 - <code>typesBySubscriber</code> 以订阅者对象为key，对应订阅事件参数数组</p> <p><code>EventBus.unregister</code>代码如下：</p> <div class=codehilite><pre><span></span><span class=cm>/** Unregisters the given subscriber from all event classes. */</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 先通过subscriber订阅者对象从`typesBySubscriber`中获取订阅事件参数数组</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>subscribedTypes</span> <span class=o>=</span> <span class=n>typesBySubscriber</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>subscriber</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscribedTypes</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 以订阅事件参数为key，从`subscriptionsByEventType`中获取到对应的`Subscrition`对象</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span> <span class=p>:</span> <span class=n>subscribedTypes</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>unsubscribeByEventType</span><span class=p>(</span><span class=n>subscriber</span><span class=p>,</span> <span class=n>eventType</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>typesBySubscriber</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>subscriber</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>logger</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>WARNING</span><span class=p>,</span> <span class=s>&quot;Subscriber to unregister was not registered before: &quot;</span> <span class=o>+</span> <span class=n>subscriber</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=cm>/** Only updates subscriptionsByEventType, not typesBySubscriber! Caller must update typesBySubscriber. */</span>
<span class=kd>private</span> <span class=kt>void</span> <span class=nf>unsubscribeByEventType</span><span class=p>(</span><span class=n>Object</span> <span class=n>subscriber</span><span class=p>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>eventType</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span> <span class=n>subscriptions</span> <span class=o>=</span> <span class=n>subscriptionsByEventType</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>subscriptions</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Subscription</span> <span class=n>subscription</span> <span class=o>=</span> <span class=n>subscriptions</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriber</span> <span class=o>==</span> <span class=n>subscriber</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>subscription</span><span class=p>.</span><span class=na>active</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
                <span class=n>subscriptions</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
                <span class=n>i</span><span class=o>--</span><span class=p>;</span>
                <span class=n>size</span><span class=o>--</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>显然，先通过subscriber订阅者对象从<code>typesBySubscriber</code>中获取订阅事件参数数组；然后以订阅事件参数为key，从<code>subscriptionsByEventType</code>中获取到对应的<code>Subscrition</code>对象。</p> <p>以上就是EventBus的注销过程了。</p> <h2 id=3-eventbus>3. 跨进程EventBus<a class=headerlink href=#3-eventbus title="Permanent link">&para;</a></h2> <p>跨进程EventBus的难点在于如何将一个进程中的事件传递到另一个进程中，技术点还是离不来IPC的几种常用方式，这里比较实用的是AIDL方式。</p> <p>下面先简单的说一下原理： 1. 弄一个主进程的Service作为消息中心，用来向各个进程转发事件 2. 主进程和子进程在初始化的时候都绑定到该Service上面，这样就得到了各进程向消息中心Service发送消息的通道 3. 在绑定到Service后，各个进程向Service注册本进程的消息转发器，这样消息中心Service就可以对各进程发送消息了，至此C/S之间双向的联系通道已经打通</p> <p>下面分别考虑一下消息的传递，可以分为三种情况讨论。 1. 主进程向子进程的通信：获取主进程Service中各个进程（包括主进程自己）的消息转发器，依次转发消息 2. 子进程和主进程的通信：通过初始化绑定到Service时获取到的Service代理对象，向Service发送消息。Service收到消息后，会向各个进程的消息转发器依次转发消息，这样主进程以及所有子进程都会收到消息 3. 子进程和子进程的通信：先发送到主进程，主进程会进行转发。</p> <blockquote> <p>注意这里，主进程Service持有主进程以及所有子进程的消息转发器，这里不对主进程进行特别处理。此外，所有的事件都会由Service进行分发，Service分发时会对主进程和所有子进程进行分发。<br> 也就是说，如果子进程内部调用了跨进程EventBus进行事件分发的话，会在两次IPC之后再由改子进程内部的EventBus进行触发。这两次IPC是：子进程向主进程Service发出消息，主进程Service接收到消息后向所有进程进行分发。</p> </blockquote> <p><img alt=跨进程EventBus src=/assets/images/android/cross_process_eventbus.png><br> <center>跨进程EventBus</center></p> <h3 id=31>3.1 简单实现<a class=headerlink href=#31 title="Permanent link">&para;</a></h3> <p>文件清单如下：</p> <ol> <li>服务端：IEventBusManager.aidl</li> <li>客户端：IEventDispatcher.aidl</li> <li>传输的事件：IPCEvent.java、IPCEvent.aidl</li> <li>核心类：IPCEventBus.kt</li> </ol> <p><strong>src/main/aidl/xyz/yorek/eventbus/IEventBusManager.aidl</strong></p> <div class=codehilite><pre><span></span><span class=c1>// IEventBusManager.aidl</span>
<span class=kn>package</span> <span class=nn>xyz.yorek.eventbus</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IEventDispatcher</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IPCEvent</span><span class=p>;</span>

<span class=kd>interface</span> <span class=nc>IEventBusManager</span> <span class=p>{</span>
    <span class=kt>void</span> <span class=nf>register</span><span class=p>(</span><span class=n>IEventDispatcher</span> <span class=n>dispatcher</span><span class=p>);</span>

    <span class=kt>void</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>IEventDispatcher</span> <span class=n>dispatcher</span><span class=p>);</span>

    <span class=cm>/** 向主进程发送Event */</span>
    <span class=kt>void</span> <span class=nf>postToService</span><span class=p>(</span><span class=n>in</span> <span class=n>IPCEvent</span> <span class=n>event</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p><strong>src/main/aidl/xyz/yorek/eventbus/IEventDispatcher.aidl</strong></p> <div class=codehilite><pre><span></span><span class=c1>// IEventDispatcher.aidl</span>
<span class=kn>package</span> <span class=nn>xyz.yorek.eventbus</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>xyz.yorek.eventbus.IPCEvent</span><span class=p>;</span>

<span class=kd>interface</span> <span class=nc>IEventDispatcher</span> <span class=p>{</span>
    <span class=cm>/** 接收其他进程发送过来的Event */</span>
    <span class=kt>void</span> <span class=nf>dispatch</span><span class=p>(</span><span class=n>in</span> <span class=n>IPCEvent</span> <span class=n>event</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p><strong>src/main/aidl/xyz/yorek/eventbus/IPCEvent.aidl</strong></p> <div class=codehilite><pre><span></span><span class=c1>// IPCEvent.aidl</span>
<span class=kn>package</span> <span class=nn>xyz.yorek.eventbus</span><span class=p>;</span>

<span class=n>parcelable</span> <span class=n>IPCEvent</span><span class=p>;</span>
</pre></div> <p><strong>src/main/java/xyz/yorek/eventbus/IPCEvent.java</strong></p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>IPCEvent</span> <span class=kd>implements</span> <span class=n>Parcelable</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kt>int</span> <span class=n>code</span><span class=p>;</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=n>msg</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>IPCEvent</span><span class=p>()</span> <span class=p>{}</span>

    <span class=kd>public</span> <span class=nf>IPCEvent</span><span class=p>(</span><span class=kt>int</span> <span class=n>code</span><span class=p>,</span> <span class=n>String</span> <span class=n>msg</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>code</span> <span class=o>=</span> <span class=n>code</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=na>msg</span> <span class=o>=</span> <span class=n>msg</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>protected</span> <span class=nf>IPCEvent</span><span class=p>(</span><span class=n>Parcel</span> <span class=n>in</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>code</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span>
        <span class=k>this</span><span class=p>.</span><span class=na>msg</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readString</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=s>&quot;IPCEvent{&quot;</span> <span class=o>+</span>
                <span class=s>&quot;code=&quot;</span> <span class=o>+</span> <span class=n>code</span> <span class=o>+</span>
                <span class=s>&quot;, msg=&#39;&quot;</span> <span class=o>+</span> <span class=n>msg</span> <span class=o>+</span> <span class=sc>&#39;\&#39;&#39;</span> <span class=o>+</span>
                <span class=sc>&#39;}&#39;</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>describeContents</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>writeToParcel</span><span class=p>(</span><span class=n>Parcel</span> <span class=n>dest</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>dest</span><span class=p>.</span><span class=na>writeInt</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>code</span><span class=p>);</span>
        <span class=n>dest</span><span class=p>.</span><span class=na>writeString</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>msg</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Creator</span><span class=o>&lt;</span><span class=n>IPCEvent</span><span class=o>&gt;</span> <span class=n>CREATOR</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Creator</span><span class=o>&lt;</span><span class=n>IPCEvent</span><span class=o>&gt;</span><span class=p>()</span> <span class=p>{</span>
        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>IPCEvent</span> <span class=nf>createFromParcel</span><span class=p>(</span><span class=n>Parcel</span> <span class=n>source</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=n>IPCEvent</span><span class=p>(</span><span class=n>source</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>IPCEvent</span><span class=o>[]</span> <span class=nf>newArray</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=n>IPCEvent</span><span class=o>[</span><span class=n>size</span><span class=o>]</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>};</span>
<span class=p>}</span>
</pre></div> <p><strong>src/main/java/xyz/yorek/eventbus/IPCEventBus.kt</strong></p> <p>内含一个内部类<code>EventBusManagerService</code>，管理所有进程的事件转发器。<br> 需要注意一下这里面的<code>RemoteCallbackList</code>的独特用法</p> <div class=codehilite><pre><span></span><span class=k>object</span> <span class=nc>IPCEventBus</span> <span class=p>{</span>
    <span class=c1>// 本进程的事件分发器，服务端向本进程客户端发送数据</span>
    <span class=k>private</span> <span class=k>val</span> <span class=py>mEventDispatcher</span> <span class=p>=</span> <span class=k>object</span> <span class=p>:</span> <span class=nc>IEventDispatcher</span><span class=p>.</span><span class=n>Stub</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>override</span> <span class=k>fun</span> <span class=nf>dispatch</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
            <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>post</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 本进程获取的服务端代理，可以向服务端注册事件分发器，还可以发送数据</span>
    <span class=k>private</span> <span class=k>var</span> <span class=py>mEventBusManagerService</span><span class=p>:</span> <span class=n>IEventBusManager</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
    <span class=k>private</span> <span class=k>val</span> <span class=py>mServiceConnection</span> <span class=p>=</span> <span class=k>object</span> <span class=p>:</span> <span class=nc>ServiceConnection</span> <span class=p>{</span>
        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onServiceDisconnected</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=n>ComponentName</span><span class=p>?)</span> <span class=p>{</span>
            <span class=n>mEventBusManagerService</span> <span class=p>=</span> <span class=k>null</span>
        <span class=p>}</span>

        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onServiceConnected</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=n>ComponentName</span><span class=p>?,</span> <span class=n>service</span><span class=p>:</span> <span class=n>IBinder</span><span class=p>?)</span> <span class=p>{</span>
            <span class=n>service</span> <span class=o>?:</span> <span class=k>return</span>
            <span class=n>mEventBusManagerService</span> <span class=p>=</span> <span class=n>IEventBusManager</span><span class=p>.</span><span class=n>Stub</span><span class=p>.</span><span class=n>asInterface</span><span class=p>(</span><span class=n>service</span><span class=p>)</span>

            <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>register</span><span class=p>(</span><span class=n>mEventDispatcher</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * 初始化方法</span>
<span class=cm>     */</span>
    <span class=k>fun</span> <span class=nf>init</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Application</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=n>app</span> <span class=p>=</span> <span class=n>context</span>

        <span class=k>val</span> <span class=py>intent</span> <span class=p>=</span> <span class=n>Intent</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>EventBusManagerService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
        <span class=n>app</span><span class=p>.</span><span class=n>bindService</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>mServiceConnection</span><span class=p>,</span> <span class=n>Context</span><span class=p>.</span><span class=n>BIND_AUTO_CREATE</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * 销毁方法，进程不需要时调用</span>
<span class=cm>     */</span>
    <span class=k>fun</span> <span class=nf>destory</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>asBinder</span><span class=p>()</span><span class=o>?.</span><span class=n>isBinderAlive</span> <span class=p>==</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>unregister</span><span class=p>(</span><span class=n>mEventDispatcher</span><span class=p>)</span>
            <span class=n>app</span><span class=p>.</span><span class=n>unbindService</span><span class=p>(</span><span class=n>mServiceConnection</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>fun</span> <span class=nf>register</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=n>any</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>fun</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=n>any</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * 向服务端发送数据，经过服务端转发到各个进程（包括主进程）</span>
<span class=cm>     */</span>
    <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
        <span class=n>mEventBusManagerService</span><span class=o>?.</span><span class=n>postToService</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>app</span><span class=p>:</span> <span class=n>Application</span>

    <span class=cm>/**</span>
<span class=cm>     * 服务端</span>
<span class=cm>     */</span>
    <span class=k>class</span> <span class=nc>EventBusManagerService</span> <span class=p>:</span> <span class=n>Service</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// 各个进程的事件分发器</span>
        <span class=k>private</span> <span class=k>val</span> <span class=py>mDispatchers</span> <span class=p>=</span> <span class=n>RemoteCallbackList</span><span class=p>&lt;</span><span class=n>IEventDispatcher</span><span class=p>&gt;()</span>
        <span class=c1>// 服务端实现</span>
        <span class=k>private</span> <span class=k>val</span> <span class=py>mEventBusManagerService</span> <span class=p>=</span> <span class=k>object</span> <span class=p>:</span> <span class=nc>IEventBusManager</span><span class=p>.</span><span class=n>Stub</span><span class=p>()</span> <span class=p>{</span>
            <span class=k>override</span> <span class=k>fun</span> <span class=nf>register</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>:</span> <span class=n>IEventDispatcher</span><span class=p>?)</span> <span class=p>{</span>
                <span class=n>dispatcher</span> <span class=o>?:</span> <span class=k>return</span>
                <span class=n>mDispatchers</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>)</span>
            <span class=p>}</span>

            <span class=k>override</span> <span class=k>fun</span> <span class=nf>unregister</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>:</span> <span class=n>IEventDispatcher</span><span class=p>?)</span> <span class=p>{</span>
                <span class=n>dispatcher</span> <span class=o>?:</span> <span class=k>return</span>
                <span class=n>mDispatchers</span><span class=p>.</span><span class=n>unregister</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>)</span>
            <span class=p>}</span>

            <span class=k>override</span> <span class=k>fun</span> <span class=nf>postToService</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
                <span class=n>dispatchEvent</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>override</span> <span class=k>fun</span> <span class=nf>onBind</span><span class=p>(</span><span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>?)</span> <span class=p>=</span> <span class=n>mEventBusManagerService</span>

        <span class=cm>/**</span>
<span class=cm>         * 分发事件到各个进程</span>
<span class=cm>         */</span>
        <span class=k>private</span> <span class=k>fun</span> <span class=nf>dispatchEvent</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>IPCEvent</span><span class=p>?)</span> <span class=p>{</span>
            <span class=k>val</span> <span class=py>n</span> <span class=p>=</span> <span class=n>mDispatchers</span><span class=p>.</span><span class=n>beginBroadcast</span><span class=p>()</span>

            <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=k>in</span> <span class=m>0</span> <span class=n>until</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>val</span> <span class=py>dispatcher</span> <span class=p>=</span> <span class=n>mDispatchers</span><span class=p>.</span><span class=n>getBroadcastItem</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
                <span class=n>dispatcher</span><span class=p>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
            <span class=p>}</span>

            <span class=n>mDispatchers</span><span class=p>.</span><span class=n>finishBroadcast</span><span class=p>()</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <h3 id=32>3.2 使用示例<a class=headerlink href=#32 title="Permanent link">&para;</a></h3> <p>我们首先在AndroidMenifest中注册一下<code>IPCEventBus$EventBusManagerService</code>；顺便注册一下三个在不同进程的Activity，方便我们测试：</p> <div class=codehilite><pre><span></span><span class=c>&lt;!-- 主进程的Activity --&gt;</span>
<span class=nt>&lt;activity</span> <span class=na>android:name=</span><span class=s>&quot;.MainActivity&quot;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;intent-filter&gt;</span>
        <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&quot;android.intent.action.VIEW&quot;</span> <span class=nt>/&gt;</span>
        <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&quot;android.intent.action.MAIN&quot;</span> <span class=nt>/&gt;</span>

        <span class=nt>&lt;category</span> <span class=na>android:name=</span><span class=s>&quot;android.intent.category.LAUNCHER&quot;</span> <span class=nt>/&gt;</span>
    <span class=nt>&lt;/intent-filter&gt;</span>
<span class=nt>&lt;/activity&gt;</span>
<span class=c>&lt;!-- 子进程1的Activity --&gt;</span>
<span class=nt>&lt;activity</span> <span class=na>android:name=</span><span class=s>&quot;.SecondActivity&quot;</span> <span class=na>android:process=</span><span class=s>&quot;:second&quot;</span> <span class=nt>/&gt;</span>
<span class=c>&lt;!-- 子进程2的Activity --&gt;</span>
<span class=nt>&lt;activity</span> <span class=na>android:name=</span><span class=s>&quot;.ThirdActivity&quot;</span> <span class=na>android:process=</span><span class=s>&quot;:third&quot;</span> <span class=nt>/&gt;</span>

<span class=nt>&lt;service</span> <span class=na>android:name=</span><span class=s>&quot;xyz.yorek.eventbus.IPCEventBus$EventBusManagerService&quot;</span> <span class=nt>/&gt;</span>
</pre></div> <p>上面三个Activity引用了同样的布局文件，拥有同样的代码。唯一的区别就是三者的TAG不一样，用来区分发出的消息。<br> 下面是MainActivity的布局以及代码：</p> <p><strong>src/main/res/layout/activity_main.xml</strong></p> <div class=codehilite><pre><span></span><span class=cp>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class=nt>&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
    <span class=na>xmlns:android=</span><span class=s>&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class=na>xmlns:app=</span><span class=s>&quot;http://schemas.android.com/apk/res-auto&quot;</span>
    <span class=na>xmlns:tools=</span><span class=s>&quot;http://schemas.android.com/tools&quot;</span>
    <span class=na>android:layout_width=</span><span class=s>&quot;match_parent&quot;</span>
    <span class=na>android:layout_height=</span><span class=s>&quot;match_parent&quot;</span>
    <span class=na>tools:context=</span><span class=s>&quot;.MainActivity&quot;</span><span class=nt>&gt;</span>

    <span class=nt>&lt;Button</span>
        <span class=na>android:id=</span><span class=s>&quot;@+id/btnPost&quot;</span>
        <span class=na>android:layout_width=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:layout_height=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:text=</span><span class=s>&quot;post&quot;</span>
        <span class=na>android:onClick=</span><span class=s>&quot;post&quot;</span>
        <span class=na>app:layout_constraintBottom_toBottomOf=</span><span class=s>&quot;parent&quot;</span>
        <span class=na>app:layout_constraintLeft_toLeftOf=</span><span class=s>&quot;parent&quot;</span>
        <span class=na>app:layout_constraintRight_toRightOf=</span><span class=s>&quot;parent&quot;</span>
        <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&quot;parent&quot;</span> <span class=nt>/&gt;</span>

    <span class=nt>&lt;Button</span>
        <span class=na>android:id=</span><span class=s>&quot;@+id/btnFirst&quot;</span>
        <span class=na>android:layout_width=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:layout_height=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:text=</span><span class=s>&quot;first&quot;</span>
        <span class=na>android:onClick=</span><span class=s>&quot;first&quot;</span>
        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&quot;@id/btnPost&quot;</span>
        <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&quot;parent&quot;</span>
        <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&quot;@+id/btnSecond&quot;</span><span class=nt>/&gt;</span>

    <span class=nt>&lt;Button</span>
        <span class=na>android:id=</span><span class=s>&quot;@+id/btnSecond&quot;</span>
        <span class=na>android:layout_width=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:layout_height=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:text=</span><span class=s>&quot;second&quot;</span>
        <span class=na>android:onClick=</span><span class=s>&quot;second&quot;</span>
        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&quot;@id/btnPost&quot;</span>
        <span class=na>app:layout_constraintStart_toEndOf=</span><span class=s>&quot;@id/btnFirst&quot;</span>
        <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&quot;@+id/btnThird&quot;</span><span class=nt>/&gt;</span>

    <span class=nt>&lt;Button</span>
        <span class=na>android:id=</span><span class=s>&quot;@+id/btnThird&quot;</span>
        <span class=na>android:layout_width=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:layout_height=</span><span class=s>&quot;wrap_content&quot;</span>
        <span class=na>android:text=</span><span class=s>&quot;third&quot;</span>
        <span class=na>android:onClick=</span><span class=s>&quot;third&quot;</span>
        <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&quot;@id/btnPost&quot;</span>
        <span class=na>app:layout_constraintStart_toEndOf=</span><span class=s>&quot;@id/btnSecond&quot;</span>
        <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&quot;parent&quot;</span><span class=nt>/&gt;</span>

<span class=nt>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</pre></div> <p><strong>app/src/main/java/xyz/yorek/eventbus/MainActivity.kt</strong></p> <div class=codehilite><pre><span></span><span class=k>private</span> <span class=k>const</span> <span class=k>val</span> <span class=py>TAG</span> <span class=p>=</span> <span class=s>&quot;MainActivity&quot;</span>

<span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>

        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>init</span><span class=p>(</span><span class=n>application</span><span class=p>)</span>
        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>

        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_main</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
    <span class=p>}</span>

    <span class=n>@Subscribe</span>
    <span class=k>fun</span> <span class=nf>onEventReceived</span><span class=p>(</span><span class=n>any</span><span class=p>:</span> <span class=n>Any</span><span class=p>?)</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;receive message : $any&quot;</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>msg</span> <span class=p>=</span> <span class=s>&quot;Hello World, from $TAG&quot;</span>
        <span class=n>IPCEventBus</span><span class=p>.</span><span class=n>post</span><span class=p>(</span><span class=n>IPCEvent</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=n>msg</span><span class=p>))</span>
    <span class=p>}</span>

    <span class=k>fun</span> <span class=nf>first</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>MainActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
    <span class=p>}</span>

    <span class=k>fun</span> <span class=nf>second</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>SecondActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
    <span class=p>}</span>

    <span class=k>fun</span> <span class=nf>third</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>ThirdActivity</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在MainActivity中我们post一下消息，然后进入SecondActivity再次post，进入ThirdActivity后最后一次post。<br> 各个进程日志如下（按照日志时间顺序）：</p> <div class=codehilite><pre><span></span>1569683305.912 31157-31157/xyz.yorek.eventbus E/MainActivity: receive message : IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}

1569683307.622 31157-31169/xyz.yorek.eventbus E/MainActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
1569683307.625 31093-31093/xyz.yorek.eventbus:second E/SecondActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}

1569683309.245 31157-31169/xyz.yorek.eventbus E/MainActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
1569683309.245 31210-31210/xyz.yorek.eventbus:third E/ThirdActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
1569683309.246 31093-31246/xyz.yorek.eventbus:second E/SecondActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</pre></div> <p>从上面的日志来看，我们已经完成了跨进程EventBus的功能。</p> <p>下面的日志是一份详细记载了各个事件的日志。从日志的中可以看出：本进程的某线程发出的事件会由同一个线程来触发；其他进程发出的事件，会由本进程Binder线程池里面的线程触发。</p> <div class=codehilite><pre><span></span>1569683981.405 31484-31484/xyz.yorek.eventbus E/EventBusManagerService: dispatch begin : main
1569683981.405 31484-31484/xyz.yorek.eventbus E/MainActivity: receive message : main IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}
1569683981.406 31484-31484/xyz.yorek.eventbus E/EventBusManagerService: dispatch end : main
1569683981.406 31484-31484/xyz.yorek.eventbus E/MainActivity: post message done : main

1569684013.794 31484-31526/xyz.yorek.eventbus E/EventBusManagerService: dispatch begin : Binder:31484_1
1569684013.794 31484-31526/xyz.yorek.eventbus E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
1569684013.799 32016-32016/xyz.yorek.eventbus:second E/SecondActivity: receive message : main IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
1569684013.803 31484-31526/xyz.yorek.eventbus E/EventBusManagerService: dispatch end : Binder:31484_1
1569684013.804 32016-32016/xyz.yorek.eventbus:second E/SecondActivity: post message done : main

1569684035.762 31484-31526/xyz.yorek.eventbus E/EventBusManagerService: dispatch begin : Binder:31484_1
1569684035.762 31484-31526/xyz.yorek.eventbus E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
1569684035.764 32063-32063/xyz.yorek.eventbus:third E/ThirdActivity: receive message : main IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
1569684035.765 31484-31526/xyz.yorek.eventbus E/EventBusManagerService: dispatch end : Binder:31484_1
1569684035.765 32016-32089/xyz.yorek.eventbus:second E/SecondActivity: receive message : Binder:32016_4 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
1569684035.766 32063-32063/xyz.yorek.eventbus:third E/ThirdActivity: post message done : main
</pre></div> <hr> <div class=md-source-date> <small> 最后更新: 2020年3月13日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/3rd-library/eventbus/";
      this.page.identifier =
        "/android/3rd-library/eventbus/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../migrate-to-glide/ title=杂记：从Picasso迁移至Glide class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> 杂记：从Picasso迁移至Glide </span> </div> </a> <a href=../leakcanary/ title=LeakCanary2源码解析 class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> LeakCanary2源码解析 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
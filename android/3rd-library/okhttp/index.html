<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/3rd-library/okhttp/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>OkHttp3源码解析</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - OkHttp3源码解析"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/3rd-library/okhttp/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - OkHttp3源码解析"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1-okhttpclientrequest tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> OkHttp3源码解析 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1 checked> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> OkHttp3源码解析 </label> <a href=./ title=OkHttp3源码解析 class="md-nav__link md-nav__link--active"> OkHttp3源码解析 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-okhttpclientrequest class=md-nav__link> 1. OkHttpClient以及Request的构造器 </a> </li> <li class=md-nav__item> <a href=#2-call-realcall class=md-nav__link> 2. Call &amp; RealCall </a> </li> <li class=md-nav__item> <a href=#3-realcallexecute class=md-nav__link> 3. RealCall.execute </a> </li> <li class=md-nav__item> <a href=#4-realcallenqueue class=md-nav__link> 4. RealCall.enqueue </a> </li> <li class=md-nav__item> <a href=#5-getresponsewithinterceptorchain class=md-nav__link> 5. getResponseWithInterceptorChain </a> </li> <li class=md-nav__item> <a href=#6-retryandfollowupinterceptor class=md-nav__link> 6. RetryAndFollowUpInterceptor </a> </li> <li class=md-nav__item> <a href=#7-bridgeinterceptor class=md-nav__link> 7. BridgeInterceptor </a> </li> <li class=md-nav__item> <a href=#8-cacheinterceptor class=md-nav__link> 8. CacheInterceptor </a> </li> <li class=md-nav__item> <a href=#9-connectinterceptor class=md-nav__link> 9. ConnectInterceptor </a> </li> <li class=md-nav__item> <a href=#10-callserverinterceptor class=md-nav__link> 10. CallServerInterceptor </a> </li> <li class=md-nav__item> <a href=#11 class=md-nav__link> 11. 小结 </a> </li> <li class=md-nav__item> <a href=#faq class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 参考文献 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-okhttpclientrequest class=md-nav__link> 1. OkHttpClient以及Request的构造器 </a> </li> <li class=md-nav__item> <a href=#2-call-realcall class=md-nav__link> 2. Call &amp; RealCall </a> </li> <li class=md-nav__item> <a href=#3-realcallexecute class=md-nav__link> 3. RealCall.execute </a> </li> <li class=md-nav__item> <a href=#4-realcallenqueue class=md-nav__link> 4. RealCall.enqueue </a> </li> <li class=md-nav__item> <a href=#5-getresponsewithinterceptorchain class=md-nav__link> 5. getResponseWithInterceptorChain </a> </li> <li class=md-nav__item> <a href=#6-retryandfollowupinterceptor class=md-nav__link> 6. RetryAndFollowUpInterceptor </a> </li> <li class=md-nav__item> <a href=#7-bridgeinterceptor class=md-nav__link> 7. BridgeInterceptor </a> </li> <li class=md-nav__item> <a href=#8-cacheinterceptor class=md-nav__link> 8. CacheInterceptor </a> </li> <li class=md-nav__item> <a href=#9-connectinterceptor class=md-nav__link> 9. ConnectInterceptor </a> </li> <li class=md-nav__item> <a href=#10-callserverinterceptor class=md-nav__link> 10. CallServerInterceptor </a> </li> <li class=md-nav__item> <a href=#11 class=md-nav__link> 11. 小结 </a> </li> <li class=md-nav__item> <a href=#faq class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 参考文献 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>OkHttp3源码解析</h1> <p>OkHttp是一个默认有效的HTTP客户端：</p> <ul> <li>HTTP/2支持允许对同一主机的所有请求共享套接字。</li> <li>连接池减少了请求延迟（如果HTTP/2不可用）。</li> <li>transparent GZIP 压缩了下载大小。</li> <li>Response缓存可以完全避免网络的重复请求。 </li> </ul> <p>当网络故障时，OkHttp会自动重试：它将从常见的连接问题中静默地恢复。如果您的服务有多个IP地址，如果第一次连接失败，OkHttp将尝试备用地址；这对于IPv4 + IPv6以及在冗余数据中心中托管的服务是必需的。OkHttp还支持现代TLS功能（TLS 1.3，ALPN，certificate pinning）。It can be configured to fall back for broad connectivity.</p> <p><cite>--- <a href=https://github.com/square/okhttp/blob/master/README.md>okhttp/README.md</a></cite></p> <hr> <p>本章主要介绍<code>OkHttp</code>的实现，代码基于<a href=https://github.com/square/okhttp/tree/parent-3.8.0>okhttp-3.8.0</a><br> 使用<code>OkHttp</code>实现<code>GET</code>请求非常简单，例子如下：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GetExample</span> <span class=p>{</span>
  <span class=n>OkHttpClient</span> <span class=n>client</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=p>();</span>

  <span class=n>String</span> <span class=nf>run</span><span class=p>(</span><span class=n>String</span> <span class=n>url</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
    <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=p>.</span><span class=na>Builder</span><span class=p>()</span>
        <span class=p>.</span><span class=na>url</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
        <span class=p>.</span><span class=na>build</span><span class=p>();</span>

    <span class=k>try</span> <span class=p>(</span><span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>).</span><span class=na>execute</span><span class=p>())</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>response</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>string</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
    <span class=n>GetExample</span> <span class=n>example</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GetExample</span><span class=p>();</span>
    <span class=n>String</span> <span class=n>response</span> <span class=o>=</span> <span class=n>example</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=s>&quot;https://raw.github.com/square/okhttp/master/README.md&quot;</span><span class=p>);</span>
    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>这个简单的例子，展示了OkHttp的使用过程：</p> <ol> <li>创建<code>OkHttpClient</code>对象</li> <li>构造请求<code>Request</code></li> <li>调用<code>OkHttpClient</code>发送<code>Request</code></li> <li>解析请求结果</li> </ol> <p>下面，我们以这个简单的例子为切入点，开始分析OkHttp内部的实现。</p> <h2 id=1-okhttpclientrequest>1. OkHttpClient以及Request的构造器<a class=headerlink href=#1-okhttpclientrequest title="Permanent link">&para;</a></h2> <p>先看看<code>OkHttpClient</code>的构造器：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=nf>OkHttpClient</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>(</span><span class=k>new</span> <span class=n>Builder</span><span class=p>());</span>
<span class=p>}</span>

<span class=n>OkHttpClient</span><span class=p>(</span><span class=n>Builder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>dispatcher</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>dispatcher</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>proxy</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>proxy</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>protocols</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>protocols</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>connectionSpecs</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>connectionSpecs</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>interceptors</span> <span class=o>=</span> <span class=n>Util</span><span class=p>.</span><span class=na>immutableList</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=na>interceptors</span><span class=p>);</span>
  <span class=k>this</span><span class=p>.</span><span class=na>networkInterceptors</span> <span class=o>=</span> <span class=n>Util</span><span class=p>.</span><span class=na>immutableList</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=na>networkInterceptors</span><span class=p>);</span>
  <span class=k>this</span><span class=p>.</span><span class=na>eventListenerFactory</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>eventListenerFactory</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>proxySelector</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>proxySelector</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>cookieJar</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>cookieJar</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>cache</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>cache</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>internalCache</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>internalCache</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>socketFactory</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>socketFactory</span><span class=p>;</span>

  <span class=kt>boolean</span> <span class=n>isTLS</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>ConnectionSpec</span> <span class=n>spec</span> <span class=p>:</span> <span class=n>connectionSpecs</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>isTLS</span> <span class=o>=</span> <span class=n>isTLS</span> <span class=o>||</span> <span class=n>spec</span><span class=p>.</span><span class=na>isTls</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=na>sslSocketFactory</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>isTLS</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>sslSocketFactory</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>sslSocketFactory</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>certificateChainCleaner</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>certificateChainCleaner</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>X509TrustManager</span> <span class=n>trustManager</span> <span class=o>=</span> <span class=n>systemDefaultTrustManager</span><span class=p>();</span>
    <span class=k>this</span><span class=p>.</span><span class=na>sslSocketFactory</span> <span class=o>=</span> <span class=n>systemDefaultSslSocketFactory</span><span class=p>(</span><span class=n>trustManager</span><span class=p>);</span>
    <span class=k>this</span><span class=p>.</span><span class=na>certificateChainCleaner</span> <span class=o>=</span> <span class=n>CertificateChainCleaner</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>trustManager</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>this</span><span class=p>.</span><span class=na>hostnameVerifier</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>hostnameVerifier</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>certificatePinner</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>certificatePinner</span><span class=p>.</span><span class=na>withCertificateChainCleaner</span><span class=p>(</span>
      <span class=n>certificateChainCleaner</span><span class=p>);</span>
  <span class=k>this</span><span class=p>.</span><span class=na>proxyAuthenticator</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>proxyAuthenticator</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>authenticator</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>authenticator</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>connectionPool</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>connectionPool</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>dns</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>dns</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>followSslRedirects</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>followSslRedirects</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>followRedirects</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>followRedirects</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>retryOnConnectionFailure</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>retryOnConnectionFailure</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>connectTimeout</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>connectTimeout</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>readTimeout</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>readTimeout</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>writeTimeout</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>writeTimeout</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>pingInterval</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>pingInterval</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>构造器实现很简单，在默认构造器中传入了一个<code>OkHttpClient.Builder</code>建造者对象，然后将其中的参数复制给自己。<br> 在<code>OkHttpClient.Builder</code>的构造器中有很多默认的值，如下注释：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=nf>Builder</span><span class=p>()</span> <span class=p>{</span>
  <span class=n>dispatcher</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Dispatcher</span><span class=p>();</span>    <span class=c1>// 分发器，另有一个带线程池参数的构造器</span>
  <span class=n>protocols</span> <span class=o>=</span> <span class=n>DEFAULT_PROTOCOLS</span><span class=p>;</span>    <span class=c1>// 支持的协议，默认为HTTP_2、HTTP_1_1</span>
  <span class=n>connectionSpecs</span> <span class=o>=</span> <span class=n>DEFAULT_CONNECTION_SPECS</span><span class=p>;</span>  <span class=c1>// 传输层版本、连接协议</span>
  <span class=c1>// 事件监听器，3.8版本set方法还是package级别的，暂时不能设置</span>
  <span class=n>eventListenerFactory</span> <span class=o>=</span> <span class=n>EventListener</span><span class=p>.</span><span class=na>factory</span><span class=p>(</span><span class=n>EventListener</span><span class=p>.</span><span class=na>NONE</span><span class=p>);</span>
  <span class=n>proxySelector</span> <span class=o>=</span> <span class=n>ProxySelector</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span>   <span class=c1>// 代理选择器</span>
  <span class=n>cookieJar</span> <span class=o>=</span> <span class=n>CookieJar</span><span class=p>.</span><span class=na>NO_COOKIES</span><span class=p>;</span>             <span class=c1>// 读写Cookie的容器</span>
  <span class=n>socketFactory</span> <span class=o>=</span> <span class=n>SocketFactory</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span>   <span class=c1>// Socket工厂</span>
  <span class=n>hostnameVerifier</span> <span class=o>=</span> <span class=n>OkHostnameVerifier</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=c1>// 主机名验证器</span>
  <span class=n>certificatePinner</span> <span class=o>=</span> <span class=n>CertificatePinner</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>;</span>
  <span class=n>proxyAuthenticator</span> <span class=o>=</span> <span class=n>Authenticator</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span>      <span class=c1>// 代理认证器</span>
  <span class=n>authenticator</span> <span class=o>=</span> <span class=n>Authenticator</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span>           <span class=c1>// 本地认证器</span>
  <span class=n>connectionPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConnectionPool</span><span class=p>();</span>        <span class=c1>// 连接池</span>
  <span class=n>dns</span> <span class=o>=</span> <span class=n>Dns</span><span class=p>.</span><span class=na>SYSTEM</span><span class=p>;</span>                             <span class=c1>// 域名</span>
  <span class=n>followSslRedirects</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>                    <span class=c1>// SSL重定向</span>
  <span class=n>followRedirects</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>                       <span class=c1>// 普通重定向</span>
  <span class=n>retryOnConnectionFailure</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>              <span class=c1>// 连接失败重试</span>
  <span class=n>connectTimeout</span> <span class=o>=</span> <span class=mi>10_000</span><span class=p>;</span>                      <span class=c1>// 连接超时时间</span>
  <span class=n>readTimeout</span> <span class=o>=</span> <span class=mi>10_000</span><span class=p>;</span>                         <span class=c1>// 读超时时间</span>
  <span class=n>writeTimeout</span> <span class=o>=</span> <span class=mi>10_000</span><span class=p>;</span>                        <span class=c1>// 写超时时间</span>
  <span class=n>pingInterval</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>上面各种属性都从名字大致可以知道是干啥用的。 </p> <p>此外，<code>Request</code>的构造也很简单，字段如下：</p> <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=n>HttpUrl</span> <span class=n>url</span><span class=p>;</span>                <span class=c1>// 请求的url</span>
<span class=kd>final</span> <span class=n>String</span> <span class=n>method</span><span class=p>;</span>              <span class=c1>// 请求方式</span>
<span class=kd>final</span> <span class=n>Headers</span> <span class=n>headers</span><span class=p>;</span>            <span class=c1>// 请求头</span>
<span class=kd>final</span> <span class=nd>@Nullable</span> <span class=n>RequestBody</span> <span class=n>body</span><span class=p>;</span> <span class=c1>// 请求体</span>
<span class=kd>final</span> <span class=n>Object</span> <span class=n>tag</span><span class=p>;</span>                 <span class=c1>// 请求的tag</span>
</pre></div> <h2 id=2-call-realcall>2. Call &amp; RealCall<a class=headerlink href=#2-call-realcall title="Permanent link">&para;</a></h2> <p>我们接着看<code>client.newCall(request).execute()</code>这一行代码。<br> 首先是<code>OkHttpCient.newCall(Request)</code>方法：</p> <div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm>  * Prepares the {@code request} to be executed at some point in the future.</span>
<span class=cm>  */</span>
<span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Call</span> <span class=nf>newCall</span><span class=p>(</span><span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>RealCall</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* for web socket */</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>这里创建了一个<code>RealCall</code>对象，而<code>RealCall</code>实现了<code>Call</code>接口。<code>Call</code>接口声明如下：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Call</span> <span class=kd>extends</span> <span class=n>Cloneable</span> <span class=p>{</span>
  <span class=cm>/** 获得原始请求 */</span>
  <span class=n>Request</span> <span class=nf>request</span><span class=p>();</span>

  <span class=cm>/** 同步执行请求 */</span>
  <span class=n>Response</span> <span class=nf>execute</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=p>;</span>

  <span class=cm>/** 异步执行请求 */</span>
  <span class=kt>void</span> <span class=nf>enqueue</span><span class=p>(</span><span class=n>Callback</span> <span class=n>responseCallback</span><span class=p>);</span>

  <span class=cm>/** 尽可能取消请求。已经完成了的请求不能被取消 */</span>
  <span class=kt>void</span> <span class=nf>cancel</span><span class=p>();</span>

  <span class=cm>/**</span>
<span class=cm>   * 调用了execute()或者enqueue(Callback)后都是true</span>
<span class=cm>   */</span>
  <span class=kt>boolean</span> <span class=nf>isExecuted</span><span class=p>();</span>

  <span class=kt>boolean</span> <span class=nf>isCanceled</span><span class=p>();</span>

  <span class=cm>/** 创建一个新的、完全一样的Call对象，即使原对象状态为enqueued或者executed */</span>
  <span class=n>Call</span> <span class=nf>clone</span><span class=p>();</span>

  <span class=kd>interface</span> <span class=nc>Factory</span> <span class=p>{</span>
    <span class=n>Call</span> <span class=nf>newCall</span><span class=p>(</span><span class=n>Request</span> <span class=n>request</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>回到<code>RealCall</code>，看看其的构造器以及成员变量：</p> <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=n>OkHttpClient</span> <span class=n>client</span><span class=p>;</span>
<span class=kd>final</span> <span class=n>RetryAndFollowUpInterceptor</span> <span class=n>retryAndFollowUpInterceptor</span><span class=p>;</span>
<span class=kd>final</span> <span class=n>EventListener</span> <span class=n>eventListener</span><span class=p>;</span>

<span class=cm>/** The application&#39;s original request unadulterated by redirects or auth headers. */</span>
<span class=kd>final</span> <span class=n>Request</span> <span class=n>originalRequest</span><span class=p>;</span>
<span class=kd>final</span> <span class=kt>boolean</span> <span class=n>forWebSocket</span><span class=p>;</span>

<span class=c1>// Guarded by this.</span>
<span class=kd>private</span> <span class=kt>boolean</span> <span class=n>executed</span><span class=p>;</span>

<span class=n>RealCall</span><span class=p>(</span><span class=n>OkHttpClient</span> <span class=n>client</span><span class=p>,</span> <span class=n>Request</span> <span class=n>originalRequest</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// 事件监听器，默认为null，目前3.8版本也无法设置</span>
  <span class=kd>final</span> <span class=n>EventListener</span><span class=p>.</span><span class=na>Factory</span> <span class=n>eventListenerFactory</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>eventListenerFactory</span><span class=p>();</span>

  <span class=k>this</span><span class=p>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>originalRequest</span> <span class=o>=</span> <span class=n>originalRequest</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>forWebSocket</span> <span class=o>=</span> <span class=n>forWebSocket</span><span class=p>;</span>
  <span class=c1>// 创建一个重试、重定向拦截器</span>
  <span class=k>this</span><span class=p>.</span><span class=na>retryAndFollowUpInterceptor</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RetryAndFollowUpInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>forWebSocket</span><span class=p>);</span>

  <span class=c1>// TODO(jwilson): this is unsafe publication and not threadsafe.</span>
  <span class=k>this</span><span class=p>.</span><span class=na>eventListener</span> <span class=o>=</span> <span class=n>eventListenerFactory</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <h2 id=3-realcallexecute>3. RealCall.execute<a class=headerlink href=#3-realcallexecute title="Permanent link">&para;</a></h2> <p>接着看看重点<code>RealCall.execute</code>方法：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span> <span class=nf>execute</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>executed</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already Executed&quot;</span><span class=p>);</span>
    <span class=n>executed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>captureCallStackTrace</span><span class=p>();</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>client</span><span class=p>.</span><span class=na>dispatcher</span><span class=p>().</span><span class=na>executed</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
    <span class=n>Response</span> <span class=n>result</span> <span class=o>=</span> <span class=n>getResponseWithInterceptorChain</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Canceled&quot;</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>client</span><span class=p>.</span><span class=na>dispatcher</span><span class=p>().</span><span class=na>finished</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在上面的方法中我们可以到，一旦<code>Call.execute</code>方法被执行，那么其<code>executed</code>就会被设置为<code>true</code>，如果多次调用就会报错。<br> 然后调用<code>client.dispatcher().executed(this);</code>，该方法就是将call加入到<code>Dispatcher.runningSyncCalls</code>队列中，没有其他多余的代码：</p> <div class=codehilite><pre><span></span><span class=cm>/** Used by {@code Call#execute} to signal it is in-flight. */</span>
<span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>executed</span><span class=p>(</span><span class=n>RealCall</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>runningSyncCalls</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>call</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>接着调用<code>getResponseWithInterceptorChain</code>进行网络请求并获取Response，该方法是<code>OkHttp</code>中的最重要的点，我们稍后在介绍<code>RealCall.enqueue</code>方法时再一起说。<br> 紧接着就是finally代码块里面的<code>client.dispatcher().finished(this)</code>。该方法也很简单，就是<code>Call</code>执行完毕后将其从<code>Dispatcher.runningSyncCalls</code>队列中移除，见下面的代码；同时，如果<code>promoteCalls</code>为true（此处入参false），还会执行<code>promoteCalls</code>方法，此方法是给异步调用准备的，具体代码后面会谈到；最后如果<code>runningAsyncCalls</code>、<code>runningSyncCalls</code>这俩正在执行的同步、异步队列之和为0，说明dispatcher处理空闲状态，那么调用<code>idleCallback.run</code>通知外界dispatcher已经空闲了，<em>该方法目前仅在测试用例中发现</em>。</p> <div class=codehilite><pre><span></span><span class=cm>/** Used by {@code Call#execute} to signal completion. */</span>
<span class=kt>void</span> <span class=nf>finished</span><span class=p>(</span><span class=n>RealCall</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>finished</span><span class=p>(</span><span class=n>runningSyncCalls</span><span class=p>,</span> <span class=n>call</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>finished</span><span class=p>(</span><span class=n>Deque</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>calls</span><span class=p>,</span> <span class=n>T</span> <span class=n>call</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>promoteCalls</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>runningCallsCount</span><span class=p>;</span>
  <span class=n>Runnable</span> <span class=n>idleCallback</span><span class=p>;</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>calls</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>call</span><span class=p>))</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>AssertionError</span><span class=p>(</span><span class=s>&quot;Call wasn&#39;t in-flight!&quot;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>promoteCalls</span><span class=p>)</span> <span class=n>promoteCalls</span><span class=p>();</span>
    <span class=n>runningCallsCount</span> <span class=o>=</span> <span class=n>runningCallsCount</span><span class=p>();</span>
    <span class=n>idleCallback</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>idleCallback</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>runningCallsCount</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>idleCallback</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>idleCallback</span><span class=p>.</span><span class=na>run</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <h2 id=4-realcallenqueue>4. RealCall.enqueue<a class=headerlink href=#4-realcallenqueue title="Permanent link">&para;</a></h2> <p>顺便也说一下<code>RealCall.enqueue</code>的方法。<br> 同<code>execute</code>方法类似，一旦<code>Call.enqueue</code>方法被执行，那么其<code>executed</code>就会被设置为<code>true</code>，如果多次调用就会报错。<br> 然后调用<code>client.dispatcher().enqueue(new AsyncCall(responseCallback));</code>方法开始了异步调用。</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>enqueue</span><span class=p>(</span><span class=n>Callback</span> <span class=n>responseCallback</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>executed</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already Executed&quot;</span><span class=p>);</span>
    <span class=n>executed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>captureCallStackTrace</span><span class=p>();</span>
  <span class=n>client</span><span class=p>.</span><span class=na>dispatcher</span><span class=p>().</span><span class=na>enqueue</span><span class=p>(</span><span class=k>new</span> <span class=n>AsyncCall</span><span class=p>(</span><span class=n>responseCallback</span><span class=p>));</span>
<span class=p>}</span>
</pre></div> <p>这里先看一下<code>AsyncCall</code>的相关代码，<code>execute</code>方法具体代码下面再说：</p> <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=kd>class</span> <span class=nc>AsyncCall</span> <span class=kd>extends</span> <span class=n>NamedRunnable</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Callback</span> <span class=n>responseCallback</span><span class=p>;</span>

  <span class=n>AsyncCall</span><span class=p>(</span><span class=n>Callback</span> <span class=n>responseCallback</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>super</span><span class=p>(</span><span class=s>&quot;OkHttp %s&quot;</span><span class=p>,</span> <span class=n>redactedUrl</span><span class=p>());</span>
    <span class=k>this</span><span class=p>.</span><span class=na>responseCallback</span> <span class=o>=</span> <span class=n>responseCallback</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=nd>@Override</span> <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>()</span> <span class=p>{</span>
    <span class=p>...</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>AsyncCall</code>的父类<code>NamedRunnable</code>是一个有<code>name</code>属性的<code>Runnable</code>抽象类，在执行代码前，会将当前线程名设置为<code>name</code>，执行完毕后恢复。</p> <div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm> * Runnable implementation which always sets its thread name.</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>NamedRunnable</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=p>{</span>
  <span class=kd>protected</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>name</span><span class=p>;</span>

  <span class=kd>public</span> <span class=nf>NamedRunnable</span><span class=p>(</span><span class=n>String</span> <span class=n>format</span><span class=p>,</span> <span class=n>Object</span><span class=p>...</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>Util</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>format</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=nd>@Override</span> <span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>String</span> <span class=n>oldName</span> <span class=o>=</span> <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span>
    <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>setName</span><span class=p>(</span><span class=n>name</span><span class=p>);</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>execute</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
      <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>setName</span><span class=p>(</span><span class=n>oldName</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=kd>protected</span> <span class=kd>abstract</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>在了解了<code>AsyncCall</code>的大致结构，我们返回<code>Dispatcher.enqueue</code>方法：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>int</span> <span class=n>maxRequests</span> <span class=o>=</span> <span class=mi>64</span><span class=p>;</span>
<span class=kd>private</span> <span class=kt>int</span> <span class=n>maxRequestsPerHost</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>

<span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>enqueue</span><span class=p>(</span><span class=n>AsyncCall</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>maxRequests</span> <span class=o>&amp;&amp;</span> <span class=n>runningCallsForHost</span><span class=p>(</span><span class=n>call</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>maxRequestsPerHost</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>runningAsyncCalls</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>call</span><span class=p>);</span>
    <span class=n>executorService</span><span class=p>().</span><span class=na>execute</span><span class=p>(</span><span class=n>call</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>readyAsyncCalls</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>call</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>maxRequests</code>和<code>maxRequestsPerHost</code>都有默认值，且有setter方法可以设置具体值，两者的setter方法最后会执行<code>promoteCalls</code>方法尝试执行异步任务。<br> 在<code>enqueue</code>方法中，首先会检查「正在运行的异步请求数」以及「call对应的host上的异步请求数」是否达到了阈值。如果还没有达到阈值，那么加入到<code>runningAsyncCalls</code>队列中，同时开始执行请求；否则加入到<code>readyAsyncCalls</code>队列中进行等待。</p> <p>这里出现了一个<code>executorService()</code>，这是一个单例实现的线程池，该线程池也可以在<code>Dispatcher</code>的构造器中注入。 </p> <div class=codehilite><pre><span></span><span class=cm>/** Executes calls. Created lazily. */</span>
<span class=kd>private</span> <span class=nd>@Nullable</span> <span class=n>ExecutorService</span> <span class=n>executorService</span><span class=p>;</span>

<span class=kd>public</span> <span class=nf>Dispatcher</span><span class=p>(</span><span class=n>ExecutorService</span> <span class=n>executorService</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>executorService</span> <span class=o>=</span> <span class=n>executorService</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>ExecutorService</span> <span class=nf>executorService</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>executorService</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>executorService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>,</span> <span class=mi>60</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>,</span>
        <span class=k>new</span> <span class=n>SynchronousQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>(),</span> <span class=n>Util</span><span class=p>.</span><span class=na>threadFactory</span><span class=p>(</span><span class=s>&quot;OkHttp Dispatcher&quot;</span><span class=p>,</span> <span class=kc>false</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>executorService</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>这里我们可以看出来，这是一个典型的<code>CachedThreadPool</code>。<br> 这是一个线程数量不定的线程池，他只有非核心线程，并且其最大线程数为<code>Integer.MAX_VALUE</code>。线程池中的空闲线程都有超时机制，这个超时时常为60s，超过这个时间的闲置线程就会被回收。<code>SynchronousQueue</code>可以简单的理解为一个无法存储元素的队列，因此这将导致任何任务都会立刻执行。<br> 从其特性来看，这类线程池适合执行大量耗时较少的任务。当整个线程池处理闲置状态时，线程池中的线程都会因为超时而被停止，这个时候<code>CachedThreadPool</code>之中实际上是没有线程的，它几乎不占用任何系统资源。 </p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>关于线程池的更多知识，可以参考<a href=/android/framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/#3-android>Android中的线程池</a></p> </div> <p>提交到线程池后，<code>AsyncCall.run</code>方法就会被调用，又因为<code>AsyncCall</code>继承了<code>NamedRunnable</code>，所以最后执行的是<code>AsyncCall.execute</code>方法：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>()</span> <span class=p>{</span>
  <span class=kt>boolean</span> <span class=n>signalledCallback</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>getResponseWithInterceptorChain</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>retryAndFollowUpInterceptor</span><span class=p>.</span><span class=na>isCanceled</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>signalledCallback</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
      <span class=n>responseCallback</span><span class=p>.</span><span class=na>onFailure</span><span class=p>(</span><span class=n>RealCall</span><span class=p>.</span><span class=na>this</span><span class=p>,</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Canceled&quot;</span><span class=p>));</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>signalledCallback</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
      <span class=n>responseCallback</span><span class=p>.</span><span class=na>onResponse</span><span class=p>(</span><span class=n>RealCall</span><span class=p>.</span><span class=na>this</span><span class=p>,</span> <span class=n>response</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>signalledCallback</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Do not signal the callback twice!</span>
      <span class=n>Platform</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>log</span><span class=p>(</span><span class=n>INFO</span><span class=p>,</span> <span class=s>&quot;Callback failure for &quot;</span> <span class=o>+</span> <span class=n>toLoggableString</span><span class=p>(),</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>responseCallback</span><span class=p>.</span><span class=na>onFailure</span><span class=p>(</span><span class=n>RealCall</span><span class=p>.</span><span class=na>this</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>client</span><span class=p>.</span><span class=na>dispatcher</span><span class=p>().</span><span class=na>finished</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>首先调用<code>getResponseWithInterceptorChain</code>进行网络请求并获取Response，然后根据请求是否被取消，调用对应的回调方法。最后调用<code>client.dispatcher().finished(this)</code>方法在<code>runningAsyncCalls</code>方法中移除call，并尝试执行其他的异步方法。 </p> <p>我们先看<code>client.dispatcher().finished(this)</code>方法，最后再看<code>getResponseWithInterceptorChain</code>方法的实现：</p> <div class=codehilite><pre><span></span><span class=cm>/** Used by {@code AsyncCall#run} to signal completion. */</span>
<span class=kt>void</span> <span class=nf>finished</span><span class=p>(</span><span class=n>AsyncCall</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>finished</span><span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>,</span> <span class=n>call</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>finished</span><span class=p>(</span><span class=n>Deque</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>calls</span><span class=p>,</span> <span class=n>T</span> <span class=n>call</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>promoteCalls</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>runningCallsCount</span><span class=p>;</span>
  <span class=n>Runnable</span> <span class=n>idleCallback</span><span class=p>;</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>calls</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>call</span><span class=p>))</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>AssertionError</span><span class=p>(</span><span class=s>&quot;Call wasn&#39;t in-flight!&quot;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>promoteCalls</span><span class=p>)</span> <span class=n>promoteCalls</span><span class=p>();</span>
    <span class=n>runningCallsCount</span> <span class=o>=</span> <span class=n>runningCallsCount</span><span class=p>();</span>
    <span class=n>idleCallback</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>idleCallback</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>runningCallsCount</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>idleCallback</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>idleCallback</span><span class=p>.</span><span class=na>run</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>promoteCalls</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=n>maxRequests</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span> <span class=c1>// Already running max capacity.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>readyAsyncCalls</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=k>return</span><span class=p>;</span> <span class=c1>// No ready calls to promote.</span>

  <span class=k>for</span> <span class=p>(</span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>AsyncCall</span><span class=o>&gt;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>readyAsyncCalls</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span> <span class=n>i</span><span class=p>.</span><span class=na>hasNext</span><span class=p>();</span> <span class=p>)</span> <span class=p>{</span>
    <span class=n>AsyncCall</span> <span class=n>call</span> <span class=o>=</span> <span class=n>i</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>runningCallsForHost</span><span class=p>(</span><span class=n>call</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>maxRequestsPerHost</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>i</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
      <span class=n>runningAsyncCalls</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>call</span><span class=p>);</span>
      <span class=n>executorService</span><span class=p>().</span><span class=na>execute</span><span class=p>(</span><span class=n>call</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>runningAsyncCalls</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=n>maxRequests</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span> <span class=c1>// Reached max capacity.</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>两个<code>finished</code>方法不用多说；<code>promoteCalls</code>方法的代码也很清晰明了，这是一个将等待队列中的任务移到<code>runningAsyncCalls</code>且执行的过程。 </p> <h2 id=5-getresponsewithinterceptorchain>5. getResponseWithInterceptorChain<a class=headerlink href=#5-getresponsewithinterceptorchain title="Permanent link">&para;</a></h2> <p>最后，终于来到了<code>getResponseWithInterceptorChain</code>方法，如下所示。</p> <div class=codehilite><pre><span></span><span class=n>Response</span> <span class=nf>getResponseWithInterceptorChain</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=c1>// Build a full stack of interceptors.</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>Interceptor</span><span class=o>&gt;</span> <span class=n>interceptors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
  <span class=n>interceptors</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>interceptors</span><span class=p>());</span>
  <span class=n>interceptors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>retryAndFollowUpInterceptor</span><span class=p>);</span>
  <span class=n>interceptors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>BridgeInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>cookieJar</span><span class=p>()));</span>
  <span class=n>interceptors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>CacheInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>internalCache</span><span class=p>()));</span>
  <span class=n>interceptors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>ConnectInterceptor</span><span class=p>(</span><span class=n>client</span><span class=p>));</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>interceptors</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>networkInterceptors</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=n>interceptors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>CallServerInterceptor</span><span class=p>(</span><span class=n>forWebSocket</span><span class=p>));</span>

  <span class=n>Interceptor</span><span class=p>.</span><span class=na>Chain</span> <span class=n>chain</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RealInterceptorChain</span><span class=p>(</span>
      <span class=n>interceptors</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>originalRequest</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>chain</span><span class=p>.</span><span class=na>proceed</span><span class=p>(</span><span class=n>originalRequest</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>首先将以下拦截器依次加入到List中：</p> <ol> <li>OkHttpClient设置的拦截器<code>interceptors()</code></li> <li>重试、重定向拦截器<code>RetryAndFollowUpInterceptor</code></li> <li>把用户请求转换为服务器请求、把服务器返响应转换为用户响应的<code>BridgeInterceptor</code></li> <li>读取缓存直接返回、将响应写入到缓存中的<code>CacheInterceptor</code></li> <li>与服务器建立连接的<code>ConnectInterceptor</code></li> <li>OkHttpClient设置的网络拦截器<code>networkInterceptors()</code></li> <li>真正执行网络请求的<code>CallServerInterceptor</code></li> </ol> <p>将所有的拦截器保存在<code>interceptors</code>后，创建一个拦截器责任链<code>RealInterceptorChain</code>，并调用其<code>proceed</code>开始处理网络请求。</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>责任链模式的实例可以参考：<a href=/design-pattern/chain-of-responsibility/ >责任链模式(Chain of responsibility)</a></p> </div> <p><strong>下面解释一下责任链模式是如何表现出来的？</strong> </p> <p>首先看上面创建<code>RealInterceptorChain</code>的方法以及<code>RealInterceptorChain</code>的代码：</p> <div class=codehilite><pre><span></span><span class=c1>// RealCall.java</span>
<span class=n>Interceptor</span><span class=p>.</span><span class=na>Chain</span> <span class=n>chain</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RealInterceptorChain</span><span class=p>(</span>
    <span class=n>interceptors</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>originalRequest</span><span class=p>);</span>
<span class=k>return</span> <span class=n>chain</span><span class=p>.</span><span class=na>proceed</span><span class=p>(</span><span class=n>originalRequest</span><span class=p>);</span>

<span class=c1>// RealInterceptorChain.java</span>
<span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>RealInterceptorChain</span> <span class=kd>implements</span> <span class=n>Interceptor</span><span class=p>.</span><span class=na>Chain</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Interceptor</span><span class=o>&gt;</span> <span class=n>interceptors</span><span class=p>;</span>
  <span class=p>...</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>index</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Request</span> <span class=n>request</span><span class=p>;</span>

  <span class=kd>public</span> <span class=nf>RealInterceptorChain</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Interceptor</span><span class=o>&gt;</span> <span class=n>interceptors</span><span class=p>,</span> <span class=n>StreamAllocation</span> <span class=n>streamAllocation</span><span class=p>,</span>
      <span class=n>HttpCodec</span> <span class=n>httpCodec</span><span class=p>,</span> <span class=n>RealConnection</span> <span class=n>connection</span><span class=p>,</span> <span class=kt>int</span> <span class=n>index</span><span class=p>,</span> <span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>interceptors</span> <span class=o>=</span> <span class=n>interceptors</span><span class=p>;</span>
    <span class=p>...</span>
    <span class=k>this</span><span class=p>.</span><span class=na>index</span> <span class=o>=</span> <span class=n>index</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>request</span> <span class=o>=</span> <span class=n>request</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span> <span class=nf>proceed</span><span class=p>(</span><span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=n>httpCodec</span><span class=p>,</span> <span class=n>connection</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>public</span> <span class=n>Response</span> <span class=nf>proceed</span><span class=p>(</span><span class=n>Request</span> <span class=n>request</span><span class=p>,</span> <span class=n>StreamAllocation</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=n>HttpCodec</span> <span class=n>httpCodec</span><span class=p>,</span>
      <span class=n>RealConnection</span> <span class=n>connection</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&gt;=</span> <span class=n>interceptors</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>AssertionError</span><span class=p>();</span>
    <span class=p>...</span>
    <span class=c1>// Call the next interceptor in the chain.</span>
    <span class=n>RealInterceptorChain</span> <span class=n>next</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RealInterceptorChain</span><span class=p>(</span>
        <span class=n>interceptors</span><span class=p>,</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=n>httpCodec</span><span class=p>,</span> <span class=n>connection</span><span class=p>,</span> <span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>request</span><span class=p>);</span>
    <span class=n>Interceptor</span> <span class=n>interceptor</span> <span class=o>=</span> <span class=n>interceptors</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>);</span>
    <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>interceptor</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=n>next</span><span class=p>);</span>
    <span class=p>...</span>
    <span class=k>return</span> <span class=n>response</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在不考虑<code>OkHttpClient.interceptor()</code>的情况下，上面这段代码的解释如下：</p> <ol> <li>在<code>getResponseWithInterceptorChain</code>创建了一个<code>index</code>为0的<code>RealInterceptorChain</code>（下称链），接着就调用了其<code>proceed</code>方法</li> <li>在<code>RealInterceptorChain.proceed</code>方法中：<code>index=0</code></li> <li>创建了一个<code>index</code>为index+1的链<code>next</code></li> <li>然后对当前<code>index</code>的拦截器（即<code>RetryAndFollowUpInterceptor</code>）执行<code>interceptor.intercept(next)</code>。<br> 在<code>RetryAndFollowUpInterceptor</code>方法中执行了<code>chain.proceed</code>方法，而这里的<code>chain</code>是<code>RealInterceptorChain</code>实例，所以回到了<code>RealInterceptorChain.proceed</code>方法中</li> <li>此时<code>index=1</code>,同理链条可以一直执行下去；index=2..n-1</li> <li>直到遇到最后一个拦截器<code>CallServerInterceptor</code>，因此这是最后一个拦截器了，因此链肯定不能继续下去，不然就报错了<code>if (index &gt;= interceptors.size()) throw new AssertionError();</code>，而且在<code>CallServerInterceptor.intercept</code>方法中也所搜不到<code>proceed</code>关键字。<br> 又因为这是最后一个拦截器，所以肯定是负责和服务器建立实际通讯的。</li> <li>Response的返回与Request相反，会从最后一个开始依次往前经过这些<code>Intercetor</code></li> </ol> <p>下图为OkHttp工作的大致流程，参考自<a href=https://blog.piasy.com/2016/07/11/Understand-OkHttp/index.html>拆轮子系列：拆 OkHttp</a></p> <p><img alt=OkHttp总体工作流程 src=/assets/images/android/okhttp_overview.jpg></p> <p>接下来，我们看一下各个拦截器具体的代码。</p> <h2 id=6-retryandfollowupinterceptor>6. RetryAndFollowUpInterceptor<a class=headerlink href=#6-retryandfollowupinterceptor title="Permanent link">&para;</a></h2> <div class="admonition quote"> <p class=admonition-title>Comments</p> <p>This interceptor recovers from failures and follows redirects as necessary.<br> How many redirects and auth challenges should we attempt? Chrome follows 21 redirects; Firefox, curl, and wget follow 20; Safari follows 16; and HTTP/1.0 recommends 5.</p> </div> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>Chain</span> <span class=n>chain</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>chain</span><span class=p>.</span><span class=na>request</span><span class=p>();</span>

  <span class=n>streamAllocation</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StreamAllocation</span><span class=p>(</span>
      <span class=n>client</span><span class=p>.</span><span class=na>connectionPool</span><span class=p>(),</span> <span class=n>createAddress</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>url</span><span class=p>()),</span> <span class=n>callStackTrace</span><span class=p>);</span>

  <span class=kt>int</span> <span class=n>followUpCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>Response</span> <span class=n>priorResponse</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>canceled</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>streamAllocation</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Canceled&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>releaseConnection</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=c1>// 1️⃣</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>response</span> <span class=o>=</span> <span class=p>((</span><span class=n>RealInterceptorChain</span><span class=p>)</span> <span class=n>chain</span><span class=p>).</span><span class=na>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
      <span class=n>releaseConnection</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RouteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// The attempt to connect via a route failed. The request will not have been sent.</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>recover</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getLastConnectException</span><span class=p>(),</span> <span class=kc>false</span><span class=p>,</span> <span class=n>request</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=n>e</span><span class=p>.</span><span class=na>getLastConnectException</span><span class=p>();</span>
      <span class=p>}</span>
      <span class=n>releaseConnection</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// An attempt to communicate with a server failed. The request may have been sent.</span>
      <span class=kt>boolean</span> <span class=n>requestSendStarted</span> <span class=o>=</span> <span class=o>!</span><span class=p>(</span><span class=n>e</span> <span class=k>instanceof</span> <span class=n>ConnectionShutdownException</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>recover</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>requestSendStarted</span><span class=p>,</span> <span class=n>request</span><span class=p>))</span> <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
      <span class=n>releaseConnection</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
      <span class=c1>// We&#39;re throwing an unchecked exception. Release any resources.</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>releaseConnection</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>streamAllocation</span><span class=p>.</span><span class=na>streamFailed</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
        <span class=n>streamAllocation</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
      <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 2️⃣</span>
    <span class=c1>// Attach the prior response if it exists. Such responses never have a body.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>priorResponse</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>response</span> <span class=o>=</span> <span class=n>response</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
          <span class=p>.</span><span class=na>priorResponse</span><span class=p>(</span><span class=n>priorResponse</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
                  <span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span>
                  <span class=p>.</span><span class=na>build</span><span class=p>())</span>
          <span class=p>.</span><span class=na>build</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=c1>// 3️⃣</span>
    <span class=n>Request</span> <span class=n>followUp</span> <span class=o>=</span> <span class=n>followUpRequest</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>followUp</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>forWebSocket</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>streamAllocation</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
      <span class=p>}</span>
      <span class=k>return</span> <span class=n>response</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>closeQuietly</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>body</span><span class=p>());</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>followUpCount</span> <span class=o>&gt;</span> <span class=n>MAX_FOLLOW_UPS</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>streamAllocation</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>ProtocolException</span><span class=p>(</span><span class=s>&quot;Too many follow-up requests: &quot;</span> <span class=o>+</span> <span class=n>followUpCount</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>followUp</span><span class=p>.</span><span class=na>body</span><span class=p>()</span> <span class=k>instanceof</span> <span class=n>UnrepeatableRequestBody</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>streamAllocation</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpRetryException</span><span class=p>(</span><span class=s>&quot;Cannot retry streamed HTTP body&quot;</span><span class=p>,</span> <span class=n>response</span><span class=p>.</span><span class=na>code</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>sameConnection</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=n>followUp</span><span class=p>.</span><span class=na>url</span><span class=p>()))</span> <span class=p>{</span>
      <span class=n>streamAllocation</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
      <span class=n>streamAllocation</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StreamAllocation</span><span class=p>(</span>
          <span class=n>client</span><span class=p>.</span><span class=na>connectionPool</span><span class=p>(),</span> <span class=n>createAddress</span><span class=p>(</span><span class=n>followUp</span><span class=p>.</span><span class=na>url</span><span class=p>()),</span> <span class=n>callStackTrace</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>streamAllocation</span><span class=p>.</span><span class=na>codec</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Closing the body of &quot;</span> <span class=o>+</span> <span class=n>response</span>
          <span class=o>+</span> <span class=s>&quot; didn&#39;t close its backing stream. Bad interceptor?&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>request</span> <span class=o>=</span> <span class=n>followUp</span><span class=p>;</span>
    <span class=n>priorResponse</span> <span class=o>=</span> <span class=n>response</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>上面这些代码比较简单</p> <ol> <li>首先正常进行请求，如果遇到了异常，根据情况看是否可以恢复：若不能恢复，则抛出异常，结束请求；若正常请求成功，那么在finally块中释放资源</li> <li>如果请求是重试后的请求，那么将重试前请求的响应体设置为null并加到当前响应体<code>priorResponse</code>字段中</li> <li>根据Response的响应码判断是否需要重试：否不需要，则返回respone；若需要，则会检查重试次数是否达到阈值、是否可以继续重试</li> <li>继续执行while循环，返回步骤1</li> </ol> <p>这里需要注意的是，在调用<code>chain.proceed</code>方法时，将创建好的<code>StreamAllocation</code>对象作为参数传入了<code>proceed</code>方法，所以之后的<code>RealInterceptorChain.streamAllocation</code>就可以使用了。</p> <div class=codehilite><pre><span></span><span class=n>streamAllocation</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StreamAllocation</span><span class=p>(</span>
    <span class=n>client</span><span class=p>.</span><span class=na>connectionPool</span><span class=p>(),</span> <span class=n>createAddress</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>url</span><span class=p>()),</span> <span class=n>callStackTrace</span><span class=p>);</span>
<span class=n>response</span> <span class=o>=</span> <span class=p>((</span><span class=n>RealInterceptorChain</span><span class=p>)</span> <span class=n>chain</span><span class=p>).</span><span class=na>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
</pre></div> <h2 id=7-bridgeinterceptor>7. BridgeInterceptor<a class=headerlink href=#7-bridgeinterceptor title="Permanent link">&para;</a></h2> <div class="admonition quote"> <p class=admonition-title>Comments</p> <p>Bridges from application code to network code. First it builds a network request from a user request. Then it proceeds to call the network. Finally it builds a user response from the network response.</p> </div> <p>直接上代码：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>Chain</span> <span class=n>chain</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>Request</span> <span class=n>userRequest</span> <span class=o>=</span> <span class=n>chain</span><span class=p>.</span><span class=na>request</span><span class=p>();</span>
  <span class=n>Request</span><span class=p>.</span><span class=na>Builder</span> <span class=n>requestBuilder</span> <span class=o>=</span> <span class=n>userRequest</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>();</span>

  <span class=c1>// 1️⃣</span>
  <span class=n>RequestBody</span> <span class=n>body</span> <span class=o>=</span> <span class=n>userRequest</span><span class=p>.</span><span class=na>body</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>body</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>MediaType</span> <span class=n>contentType</span> <span class=o>=</span> <span class=n>body</span><span class=p>.</span><span class=na>contentType</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>contentType</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Content-Type&quot;</span><span class=p>,</span> <span class=n>contentType</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=kt>long</span> <span class=n>contentLength</span> <span class=o>=</span> <span class=n>body</span><span class=p>.</span><span class=na>contentLength</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>contentLength</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Content-Length&quot;</span><span class=p>,</span> <span class=n>Long</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>contentLength</span><span class=p>));</span>
      <span class=n>requestBuilder</span><span class=p>.</span><span class=na>removeHeader</span><span class=p>(</span><span class=s>&quot;Transfer-Encoding&quot;</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Transfer-Encoding&quot;</span><span class=p>,</span> <span class=s>&quot;chunked&quot;</span><span class=p>);</span>
      <span class=n>requestBuilder</span><span class=p>.</span><span class=na>removeHeader</span><span class=p>(</span><span class=s>&quot;Content-Length&quot;</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Host&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Host&quot;</span><span class=p>,</span> <span class=n>hostHeader</span><span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=na>url</span><span class=p>(),</span> <span class=kc>false</span><span class=p>));</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Connection&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Connection&quot;</span><span class=p>,</span> <span class=s>&quot;Keep-Alive&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// If we add an &quot;Accept-Encoding: gzip&quot; header field we&#39;re responsible for also decompressing</span>
  <span class=c1>// the transfer stream.</span>
  <span class=kt>boolean</span> <span class=n>transparentGzip</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Accept-Encoding&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>userRequest</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Range&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>transparentGzip</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Accept-Encoding&quot;</span><span class=p>,</span> <span class=s>&quot;gzip&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>List</span><span class=o>&lt;</span><span class=n>Cookie</span><span class=o>&gt;</span> <span class=n>cookies</span> <span class=o>=</span> <span class=n>cookieJar</span><span class=p>.</span><span class=na>loadForRequest</span><span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=na>url</span><span class=p>());</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cookies</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Cookie&quot;</span><span class=p>,</span> <span class=n>cookieHeader</span><span class=p>(</span><span class=n>cookies</span><span class=p>));</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;User-Agent&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;User-Agent&quot;</span><span class=p>,</span> <span class=n>Version</span><span class=p>.</span><span class=na>userAgent</span><span class=p>());</span>
  <span class=p>}</span>

  <span class=c1>// 2️⃣</span>
  <span class=n>Response</span> <span class=n>networkResponse</span> <span class=o>=</span> <span class=n>chain</span><span class=p>.</span><span class=na>proceed</span><span class=p>(</span><span class=n>requestBuilder</span><span class=p>.</span><span class=na>build</span><span class=p>());</span>

  <span class=n>HttpHeaders</span><span class=p>.</span><span class=na>receiveHeaders</span><span class=p>(</span><span class=n>cookieJar</span><span class=p>,</span> <span class=n>userRequest</span><span class=p>.</span><span class=na>url</span><span class=p>(),</span> <span class=n>networkResponse</span><span class=p>.</span><span class=na>headers</span><span class=p>());</span>

  <span class=n>Response</span><span class=p>.</span><span class=na>Builder</span> <span class=n>responseBuilder</span> <span class=o>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
      <span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>userRequest</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>transparentGzip</span>
      <span class=o>&amp;&amp;</span> <span class=s>&quot;gzip&quot;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Content-Encoding&quot;</span><span class=p>))</span>
      <span class=o>&amp;&amp;</span> <span class=n>HttpHeaders</span><span class=p>.</span><span class=na>hasBody</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>GzipSource</span> <span class=n>responseBody</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GzipSource</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>source</span><span class=p>());</span>
    <span class=n>Headers</span> <span class=n>strippedHeaders</span> <span class=o>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=na>headers</span><span class=p>().</span><span class=na>newBuilder</span><span class=p>()</span>
        <span class=p>.</span><span class=na>removeAll</span><span class=p>(</span><span class=s>&quot;Content-Encoding&quot;</span><span class=p>)</span>
        <span class=p>.</span><span class=na>removeAll</span><span class=p>(</span><span class=s>&quot;Content-Length&quot;</span><span class=p>)</span>
        <span class=p>.</span><span class=na>build</span><span class=p>();</span>
    <span class=n>responseBuilder</span><span class=p>.</span><span class=na>headers</span><span class=p>(</span><span class=n>strippedHeaders</span><span class=p>);</span>
    <span class=n>responseBuilder</span><span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=k>new</span> <span class=n>RealResponseBody</span><span class=p>(</span><span class=n>strippedHeaders</span><span class=p>,</span> <span class=n>Okio</span><span class=p>.</span><span class=na>buffer</span><span class=p>(</span><span class=n>responseBody</span><span class=p>)));</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>responseBuilder</span><span class=p>.</span><span class=na>build</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>上面代码总体来说干了两件事： 1. 对原始的Request进行检查，设置<code>Content-Type</code>、<code>Content-Length</code>、<code>Transfer-Encoding</code>、<code>Host</code>、<code>Connection</code>、<code>Accept-Encoding</code>、<code>Cookie</code>、<code>User-Agent</code>这些header 2. 进行网络请求。若是gzip编码，则对响应进行Gzip处理；否则直接返回</p> <p>在上面的过程中，用到了<code>CookieJar</code>的实例。<br> 在请求前，会调用下面的方法读取url的Cookie：</p> <div class=codehilite><pre><span></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Cookie</span><span class=o>&gt;</span> <span class=n>cookies</span> <span class=o>=</span> <span class=n>cookieJar</span><span class=p>.</span><span class=na>loadForRequest</span><span class=p>(</span><span class=n>userRequest</span><span class=p>.</span><span class=na>url</span><span class=p>());</span>
<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cookies</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
  <span class=n>requestBuilder</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Cookie&quot;</span><span class=p>,</span> <span class=n>cookieHeader</span><span class=p>(</span><span class=n>cookies</span><span class=p>));</span>
<span class=p>}</span>
</pre></div> <p><code>cookieHeader</code>就是将cookies里面的键值对拼接成一个字符串<code>k1=v1; k2=v2</code>，其实现如下：</p> <div class=codehilite><pre><span></span><span class=cm>/** Returns a &#39;Cookie&#39; HTTP request header with all cookies, like {@code a=b; c=d}. */</span>
<span class=kd>private</span> <span class=n>String</span> <span class=nf>cookieHeader</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Cookie</span><span class=o>&gt;</span> <span class=n>cookies</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>StringBuilder</span> <span class=n>cookieHeader</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>();</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>cookies</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>cookieHeader</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&quot;; &quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>Cookie</span> <span class=n>cookie</span> <span class=o>=</span> <span class=n>cookies</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
    <span class=n>cookieHeader</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>cookie</span><span class=p>.</span><span class=na>name</span><span class=p>()).</span><span class=na>append</span><span class=p>(</span><span class=sc>&#39;=&#39;</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=n>cookie</span><span class=p>.</span><span class=na>value</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>cookieHeader</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>收到响应后，会调用下面的方法存储url的Cookie：</p> <div class=codehilite><pre><span></span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>receiveHeaders</span><span class=p>(</span><span class=n>cookieJar</span><span class=p>,</span> <span class=n>userRequest</span><span class=p>.</span><span class=na>url</span><span class=p>(),</span> <span class=n>networkResponse</span><span class=p>.</span><span class=na>headers</span><span class=p>());</span>
</pre></div> <p><code>HttpHeaders.receiveHeaders</code>实现如下：</p> <div class=codehilite><pre><span></span><span class=c1>// HttpHeaders.java</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>receiveHeaders</span><span class=p>(</span><span class=n>CookieJar</span> <span class=n>cookieJar</span><span class=p>,</span> <span class=n>HttpUrl</span> <span class=n>url</span><span class=p>,</span> <span class=n>Headers</span> <span class=n>headers</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cookieJar</span> <span class=o>==</span> <span class=n>CookieJar</span><span class=p>.</span><span class=na>NO_COOKIES</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>

  <span class=n>List</span><span class=o>&lt;</span><span class=n>Cookie</span><span class=o>&gt;</span> <span class=n>cookies</span> <span class=o>=</span> <span class=n>Cookie</span><span class=p>.</span><span class=na>parseAll</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cookies</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=k>return</span><span class=p>;</span>

  <span class=n>cookieJar</span><span class=p>.</span><span class=na>saveFromResponse</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>cookies</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// Cookie.java</span>
<span class=cm>/** Returns all of the cookies from a set of HTTP response headers. */</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Cookie</span><span class=o>&gt;</span> <span class=nf>parseAll</span><span class=p>(</span><span class=n>HttpUrl</span> <span class=n>url</span><span class=p>,</span> <span class=n>Headers</span> <span class=n>headers</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>cookieStrings</span> <span class=o>=</span> <span class=n>headers</span><span class=p>.</span><span class=na>values</span><span class=p>(</span><span class=s>&quot;Set-Cookie&quot;</span><span class=p>);</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>Cookie</span><span class=o>&gt;</span> <span class=n>cookies</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>cookieStrings</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Cookie</span> <span class=n>cookie</span> <span class=o>=</span> <span class=n>Cookie</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>cookieStrings</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>cookie</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>cookies</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=n>cookies</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
    <span class=n>cookies</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>cookie</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>cookies</span> <span class=o>!=</span> <span class=kc>null</span>
      <span class=o>?</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>cookies</span><span class=p>)</span>
      <span class=p>:</span> <span class=n>Collections</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Cookie</span><span class=o>&gt;</span><span class=n>emptyList</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p><code>Cookie.parse</code>的实现比较复杂，我们只需要这是将每一个<code>Set-Cookie</code>的值取出来，然后解析成为一个个<code>Cookie</code>对象即可。 </p> <p><strong>所以，使用OkHttp的Cookie功能时，自定义一个CookieJar就好了，不需要新增拦截器专门处理Cookie问题。</strong></p> <h2 id=8-cacheinterceptor>8. CacheInterceptor<a class=headerlink href=#8-cacheinterceptor title="Permanent link">&para;</a></h2> <div class="admonition quote"> <p class=admonition-title>Comments</p> <p>Serves requests from the cache and writes responses to the cache.</p> </div> <p>首先需要注意的是，OkHttp中的Cache策略采用的是<code>DiskLruCache</code>，关于<code>DiskLruCache</code>可以参考<a href=/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/#22-disklrucache>DiskLruCache</a>。key的计算为：</p> <div class=codehilite><pre><span></span><span class=n>ByteString</span><span class=p>.</span><span class=na>encodeUtf8</span><span class=p>(</span><span class=n>url</span><span class=p>.</span><span class=na>toString</span><span class=p>()).</span><span class=na>md5</span><span class=p>().</span><span class=na>hex</span><span class=p>()</span>
</pre></div> <p>Cache的一般策略如下图：</p> <figure style="width: 90%" class=align-center> <img src=/assets/images/android/cache.webp> <figcaption>Cache的一般策略</figcaption> </figure> <p>下面是<code>CacheInterceptor</code>的主要代码：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>Chain</span> <span class=n>chain</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=c1>// 根据是否设置了缓存以及网络请求，得到一个候选缓存</span>
  <span class=n>Response</span> <span class=n>cacheCandidate</span> <span class=o>=</span> <span class=n>cache</span> <span class=o>!=</span> <span class=kc>null</span>
      <span class=o>?</span> <span class=n>cache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>chain</span><span class=p>.</span><span class=na>request</span><span class=p>())</span>
      <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>

  <span class=kt>long</span> <span class=n>now</span> <span class=o>=</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span>

  <span class=c1>// 根据当前时间、请求对象以及候选缓存，获取缓存策略</span>
  <span class=c1>// 在缓存策略中，有两个重要的对象</span>
  <span class=c1>// networkRequest: 网络请求，若为null表示不使用网络</span>
  <span class=c1>// cacheResponse: 响应缓存，若为null表示不使用缓存</span>
  <span class=n>CacheStrategy</span> <span class=n>strategy</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CacheStrategy</span><span class=p>.</span><span class=na>Factory</span><span class=p>(</span><span class=n>now</span><span class=p>,</span> <span class=n>chain</span><span class=p>.</span><span class=na>request</span><span class=p>(),</span> <span class=n>cacheCandidate</span><span class=p>).</span><span class=na>get</span><span class=p>();</span>
  <span class=n>Request</span> <span class=n>networkRequest</span> <span class=o>=</span> <span class=n>strategy</span><span class=p>.</span><span class=na>networkRequest</span><span class=p>;</span>
  <span class=n>Response</span> <span class=n>cacheResponse</span> <span class=o>=</span> <span class=n>strategy</span><span class=p>.</span><span class=na>cacheResponse</span><span class=p>;</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>cache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cache</span><span class=p>.</span><span class=na>trackResponse</span><span class=p>(</span><span class=n>strategy</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// 如果有候选缓存但是没有响应缓存，说明候选缓存不可用</span>
  <span class=c1>// 关闭它，以免内存泄漏</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cacheCandidate</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheResponse</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>closeQuietly</span><span class=p>(</span><span class=n>cacheCandidate</span><span class=p>.</span><span class=na>body</span><span class=p>());</span> <span class=c1>// The cache candidate wasn&#39;t applicable. Close it.</span>
  <span class=p>}</span>

  <span class=c1>// If we&#39;re forbidden from using the network and the cache is insufficient, fail.</span>
  <span class=c1>// 不进行网络请求，且缓存以及过期了，返回504错误</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>networkRequest</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheResponse</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>Response</span><span class=p>.</span><span class=na>Builder</span><span class=p>()</span>
        <span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>chain</span><span class=p>.</span><span class=na>request</span><span class=p>())</span>
        <span class=p>.</span><span class=na>protocol</span><span class=p>(</span><span class=n>Protocol</span><span class=p>.</span><span class=na>HTTP_1_1</span><span class=p>)</span>
        <span class=p>.</span><span class=na>code</span><span class=p>(</span><span class=mi>504</span><span class=p>)</span>
        <span class=p>.</span><span class=na>message</span><span class=p>(</span><span class=s>&quot;Unsatisfiable Request (only-if-cached)&quot;</span><span class=p>)</span>
        <span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>EMPTY_RESPONSE</span><span class=p>)</span>
        <span class=p>.</span><span class=na>sentRequestAtMillis</span><span class=p>(</span><span class=o>-</span><span class=mi>1L</span><span class=p>)</span>
        <span class=p>.</span><span class=na>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>())</span>
        <span class=p>.</span><span class=na>build</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// If we don&#39;t need the network, we&#39;re done.</span>
  <span class=c1>// 不需要网络请求，此时缓存命中，直接返回缓存，后面的拦截器的步骤也不会经过了</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>networkRequest</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>cacheResponse</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
        <span class=p>.</span><span class=na>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
        <span class=p>.</span><span class=na>build</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// 没有缓存命中，则进行网络请求</span>
  <span class=n>Response</span> <span class=n>networkResponse</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>networkResponse</span> <span class=o>=</span> <span class=n>chain</span><span class=p>.</span><span class=na>proceed</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=c1>// If we&#39;re crashing on I/O or otherwise, don&#39;t leak the cache body.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>networkResponse</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>cacheCandidate</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>closeQuietly</span><span class=p>(</span><span class=n>cacheCandidate</span><span class=p>.</span><span class=na>body</span><span class=p>());</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// If we have a cache response too, then we&#39;re doing a conditional get.</span>
  <span class=c1>// 如果缓存策略中，网络响应和响应缓存都不为null，需要更新响应缓存</span>
  <span class=c1>// (比如 需要向服务器确认缓存是否可用的情况)</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 304的返回是不带body的,此时必须获取cache的body</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=na>code</span><span class=p>()</span> <span class=o>==</span> <span class=n>HTTP_NOT_MODIFIED</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>cacheResponse</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
          <span class=p>.</span><span class=na>headers</span><span class=p>(</span><span class=n>combine</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>.</span><span class=na>headers</span><span class=p>(),</span> <span class=n>networkResponse</span><span class=p>.</span><span class=na>headers</span><span class=p>()))</span>
          <span class=p>.</span><span class=na>sentRequestAtMillis</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=na>sentRequestAtMillis</span><span class=p>())</span>
          <span class=p>.</span><span class=na>receivedResponseAtMillis</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>.</span><span class=na>receivedResponseAtMillis</span><span class=p>())</span>
          <span class=p>.</span><span class=na>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
          <span class=p>.</span><span class=na>networkResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>))</span>
          <span class=p>.</span><span class=na>build</span><span class=p>();</span>
      <span class=n>networkResponse</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>close</span><span class=p>();</span>

      <span class=c1>// Update the cache after combining headers but before stripping the</span>
      <span class=c1>// Content-Encoding header (as performed by initContentStream()).</span>
      <span class=n>cache</span><span class=p>.</span><span class=na>trackConditionalCacheHit</span><span class=p>();</span>
      <span class=n>cache</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>,</span> <span class=n>response</span><span class=p>);</span>
      <span class=k>return</span> <span class=n>response</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>closeQuietly</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>.</span><span class=na>body</span><span class=p>());</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// 走到这里，已经进行过网络请求了，请求响应不为空</span>
  <span class=c1>// 构建响应对象，等待返回</span>
  <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>networkResponse</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
      <span class=p>.</span><span class=na>cacheResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>))</span>
      <span class=p>.</span><span class=na>networkResponse</span><span class=p>(</span><span class=n>stripBody</span><span class=p>(</span><span class=n>networkResponse</span><span class=p>))</span>
      <span class=p>.</span><span class=na>build</span><span class=p>();</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>cache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 将请求放到缓存中</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>hasBody</span><span class=p>(</span><span class=n>response</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>CacheStrategy</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=n>networkRequest</span><span class=p>))</span> <span class=p>{</span>
      <span class=c1>// Offer this request to the cache.</span>
      <span class=n>CacheRequest</span> <span class=n>cacheRequest</span> <span class=o>=</span> <span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>
      <span class=k>return</span> <span class=n>cacheWritingResponse</span><span class=p>(</span><span class=n>cacheRequest</span><span class=p>,</span> <span class=n>response</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// 如果请求不能被缓存，则移除该请求</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=na>invalidatesCache</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>.</span><span class=na>method</span><span class=p>()))</span> <span class=p>{</span>
      <span class=k>try</span> <span class=p>{</span>
        <span class=n>cache</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>networkRequest</span><span class=p>);</span>
      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>ignored</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// The cache cannot be written.</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>response</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>接下来看看另外一个要点：<code>CacheStrategy</code>是如何决定使不使用网络请求、响应缓存的。</p> <p><strong>CacheStrategy.java</strong></p> <div class=codehilite><pre><span></span><span class=cm>/** Returns a strategy to use assuming the request can use the network. */</span>
<span class=kd>private</span> <span class=n>CacheStrategy</span> <span class=nf>getCandidate</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// No cached response.</span>
  <span class=c1>// 没有缓存</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cacheResponse</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>CacheStrategy</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// Drop the cached response if it&#39;s missing a required handshake.</span>
  <span class=c1>// https请求，但没有必要的握手信息，丢弃缓存</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isHttps</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>cacheResponse</span><span class=p>.</span><span class=na>handshake</span><span class=p>()</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>CacheStrategy</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// If this response shouldn&#39;t have been stored, it should never be used</span>
  <span class=c1>// as a response source. This check should be redundant as long as the</span>
  <span class=c1>// persistence store is well-behaved and the rules are constant.</span>
  <span class=c1>// 不应该被缓存，丢弃缓存</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isCacheable</span><span class=p>(</span><span class=n>cacheResponse</span><span class=p>,</span> <span class=n>request</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>CacheStrategy</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>CacheControl</span> <span class=n>requestCaching</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=na>cacheControl</span><span class=p>();</span>
  <span class=p>...</span>
  <span class=c1>// 根据缓存的缓存时间，缓存可接受最大过期时间等等HTTP协议上的规范，来判断缓存是否可用</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>responseCaching</span><span class=p>.</span><span class=na>noCache</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>ageMillis</span> <span class=o>+</span> <span class=n>minFreshMillis</span> <span class=o>&lt;</span> <span class=n>freshMillis</span> <span class=o>+</span> <span class=n>maxStaleMillis</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Response</span><span class=p>.</span><span class=na>Builder</span> <span class=n>builder</span> <span class=o>=</span> <span class=n>cacheResponse</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>ageMillis</span> <span class=o>+</span> <span class=n>minFreshMillis</span> <span class=o>&gt;=</span> <span class=n>freshMillis</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>builder</span><span class=p>.</span><span class=na>addHeader</span><span class=p>(</span><span class=s>&quot;Warning&quot;</span><span class=p>,</span> <span class=s>&quot;110 HttpURLConnection \&quot;Response is stale\&quot;&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=kt>long</span> <span class=n>oneDayMillis</span> <span class=o>=</span> <span class=mi>24</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>1000L</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>ageMillis</span> <span class=o>&gt;</span> <span class=n>oneDayMillis</span> <span class=o>&amp;&amp;</span> <span class=n>isFreshnessLifetimeHeuristic</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>builder</span><span class=p>.</span><span class=na>addHeader</span><span class=p>(</span><span class=s>&quot;Warning&quot;</span><span class=p>,</span> <span class=s>&quot;113 HttpURLConnection \&quot;Heuristic expiration\&quot;&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>CacheStrategy</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>());</span>
  <span class=p>}</span>

  <span class=c1>// Find a condition to add to the request. If the condition is satisfied, the response body</span>
  <span class=c1>// will not be transmitted.</span>
  <span class=c1>// 请求条件, 当etag、lastModified、servedDate这三种属性存在时，需要向服务器确认缓存的有效性</span>
  <span class=n>String</span> <span class=n>conditionName</span><span class=p>;</span>
  <span class=n>String</span> <span class=n>conditionValue</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>etag</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>conditionName</span> <span class=o>=</span> <span class=s>&quot;If-None-Match&quot;</span><span class=p>;</span>
    <span class=n>conditionValue</span> <span class=o>=</span> <span class=n>etag</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>lastModified</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>conditionName</span> <span class=o>=</span> <span class=s>&quot;If-Modified-Since&quot;</span><span class=p>;</span>
    <span class=n>conditionValue</span> <span class=o>=</span> <span class=n>lastModifiedString</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>servedDate</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>conditionName</span> <span class=o>=</span> <span class=s>&quot;If-Modified-Since&quot;</span><span class=p>;</span>
    <span class=n>conditionValue</span> <span class=o>=</span> <span class=n>servedDateString</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>CacheStrategy</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span> <span class=c1>// No condition! Make a regular request.</span>
  <span class=p>}</span>

  <span class=n>Headers</span><span class=p>.</span><span class=na>Builder</span> <span class=n>conditionalRequestHeaders</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=na>headers</span><span class=p>().</span><span class=na>newBuilder</span><span class=p>();</span>
  <span class=n>Internal</span><span class=p>.</span><span class=na>instance</span><span class=p>.</span><span class=na>addLenient</span><span class=p>(</span><span class=n>conditionalRequestHeaders</span><span class=p>,</span> <span class=n>conditionName</span><span class=p>,</span> <span class=n>conditionValue</span><span class=p>);</span>

  <span class=c1>// 构造一个请求询问服务器资源是否过期</span>
  <span class=n>Request</span> <span class=n>conditionalRequest</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
      <span class=p>.</span><span class=na>headers</span><span class=p>(</span><span class=n>conditionalRequestHeaders</span><span class=p>.</span><span class=na>build</span><span class=p>())</span>
      <span class=p>.</span><span class=na>build</span><span class=p>();</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>CacheStrategy</span><span class=p>(</span><span class=n>conditionalRequest</span><span class=p>,</span> <span class=n>cacheResponse</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <h2 id=9-connectinterceptor>9. ConnectInterceptor<a class=headerlink href=#9-connectinterceptor title="Permanent link">&para;</a></h2> <div class="admonition quote"> <p class=admonition-title>Comments</p> <p>Opens a connection to the target server and proceeds to the next interceptor.</p> </div> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>Chain</span> <span class=n>chain</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>RealInterceptorChain</span> <span class=n>realChain</span> <span class=o>=</span> <span class=p>(</span><span class=n>RealInterceptorChain</span><span class=p>)</span> <span class=n>chain</span><span class=p>;</span>
  <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>realChain</span><span class=p>.</span><span class=na>request</span><span class=p>();</span>
  <span class=n>StreamAllocation</span> <span class=n>streamAllocation</span> <span class=o>=</span> <span class=n>realChain</span><span class=p>.</span><span class=na>streamAllocation</span><span class=p>();</span>

  <span class=c1>// We need the network to satisfy this request. Possibly for validating a conditional GET.</span>
  <span class=kt>boolean</span> <span class=n>doExtensiveHealthChecks</span> <span class=o>=</span> <span class=o>!</span><span class=n>request</span><span class=p>.</span><span class=na>method</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;GET&quot;</span><span class=p>);</span>
  <span class=n>HttpCodec</span> <span class=n>httpCodec</span> <span class=o>=</span> <span class=n>streamAllocation</span><span class=p>.</span><span class=na>newStream</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>doExtensiveHealthChecks</span><span class=p>);</span>
  <span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>=</span> <span class=n>streamAllocation</span><span class=p>.</span><span class=na>connection</span><span class=p>();</span>

  <span class=k>return</span> <span class=n>realChain</span><span class=p>.</span><span class=na>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=n>httpCodec</span><span class=p>,</span> <span class=n>connection</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>上面的代码只有几行，其作用注释也说的很清楚了：与服务器建立连接，然后传递到下一个拦截器。 </p> <p>其中<code>StreamAllocation</code>是一个重点，它是<code>Connections</code>、<code>Streams</code>、<code>Calls</code>三者的一个纽带，此类的实例使用一个或多个connections上的一个或多个stream来执行call。</p> <ul> <li><strong>Connections:</strong> 连接到远程服务器的物理的socket。connections可能建立很慢，因此必须能够取消当前已经连接上的connection。</li> <li><strong>Streams:</strong> 位于Connections上的逻辑上的HTTP请求、响应对。每个connection都有自己的allocation limit，这决定了connection可以承载多少可以并发的stream。HTTP/1.x connections一次可以承载1个流，HTTP/2通常可以承载多个。</li> <li><strong>Calls:</strong> streams的逻辑序列，通常是初始请求及其后续请求。我们希望将单个call的所有streams保持在同一个connection上，以获得更好的表现。</li> </ul> <p><code>streamAllocation.newStream</code>方法就是打开连接的关键，看看到底怎么操作的：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=n>HttpCodec</span> <span class=nf>newStream</span><span class=p>(</span><span class=n>OkHttpClient</span> <span class=n>client</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>doExtensiveHealthChecks</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>connectTimeout</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>connectTimeoutMillis</span><span class=p>();</span>
  <span class=kt>int</span> <span class=n>readTimeout</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>readTimeoutMillis</span><span class=p>();</span>
  <span class=kt>int</span> <span class=n>writeTimeout</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>writeTimeoutMillis</span><span class=p>();</span>
  <span class=kt>boolean</span> <span class=n>connectionRetryEnabled</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>retryOnConnectionFailure</span><span class=p>();</span>

  <span class=k>try</span> <span class=p>{</span>
    <span class=n>RealConnection</span> <span class=n>resultConnection</span> <span class=o>=</span> <span class=n>findHealthyConnection</span><span class=p>(</span><span class=n>connectTimeout</span><span class=p>,</span> <span class=n>readTimeout</span><span class=p>,</span>
        <span class=n>writeTimeout</span><span class=p>,</span> <span class=n>connectionRetryEnabled</span><span class=p>,</span> <span class=n>doExtensiveHealthChecks</span><span class=p>);</span>
    <span class=n>HttpCodec</span> <span class=n>resultCodec</span> <span class=o>=</span> <span class=n>resultConnection</span><span class=p>.</span><span class=na>newCodec</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>

    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>connectionPool</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>codec</span> <span class=o>=</span> <span class=n>resultCodec</span><span class=p>;</span>
      <span class=k>return</span> <span class=n>resultCodec</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>RouteException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>该方法有两处要点，第一处就是调用<code>findHealthyConnection</code>得到一个可用的connection，第二处就是调用<code>resultConnection.newCodec</code>得到一个对HTTP请求进行编码、HTTP响应进行解码的<code>HttpCodec</code>。</p> <p>先看跟踪<code>findHealthyConnection</code>方法，该方法会调用<code>findConnection</code>得到一个connection，然后对其调用<code>isHealth(true)</code>方法进行健康诊断。如果健康，那么就可以返回该connection了；否则，从连接池中移除，并继续while循环。</p> <div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm>  * Finds a connection and returns it if it is healthy. If it is unhealthy the process is repeated</span>
<span class=cm>  * until a healthy connection is found.</span>
<span class=cm>  */</span>
<span class=kd>private</span> <span class=n>RealConnection</span> <span class=nf>findHealthyConnection</span><span class=p>(</span><span class=kt>int</span> <span class=n>connectTimeout</span><span class=p>,</span> <span class=kt>int</span> <span class=n>readTimeout</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>writeTimeout</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>connectionRetryEnabled</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>doExtensiveHealthChecks</span><span class=p>)</span>
    <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>RealConnection</span> <span class=n>candidate</span> <span class=o>=</span> <span class=n>findConnection</span><span class=p>(</span><span class=n>connectTimeout</span><span class=p>,</span> <span class=n>readTimeout</span><span class=p>,</span> <span class=n>writeTimeout</span><span class=p>,</span>
        <span class=n>connectionRetryEnabled</span><span class=p>);</span>

    <span class=c1>// If this is a brand new connection, we can skip the extensive health checks.</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>connectionPool</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>candidate</span><span class=p>.</span><span class=na>successCount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>candidate</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// Do a (potentially slow) check to confirm that the pooled connection is still good. If it</span>
    <span class=c1>// isn&#39;t, take it out of the pool and start again.</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>candidate</span><span class=p>.</span><span class=na>isHealthy</span><span class=p>(</span><span class=n>doExtensiveHealthChecks</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>noNewStreams</span><span class=p>();</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>candidate</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>在<code>findConnection</code>方法中，会先看已经存在的connection，然后再看连接池，最后都没有就创建新的connection。 </p> <div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm>  * Returns a connection to host a new stream. This prefers the existing connection if it exists,</span>
<span class=cm>  * then the pool, finally building a new connection.</span>
<span class=cm>  */</span>
<span class=kd>private</span> <span class=n>RealConnection</span> <span class=nf>findConnection</span><span class=p>(</span><span class=kt>int</span> <span class=n>connectTimeout</span><span class=p>,</span> <span class=kt>int</span> <span class=n>readTimeout</span><span class=p>,</span> <span class=kt>int</span> <span class=n>writeTimeout</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>connectionRetryEnabled</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>Route</span> <span class=n>selectedRoute</span><span class=p>;</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>connectionPool</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>released</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;released&quot;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>codec</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;codec != null&quot;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>canceled</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Canceled&quot;</span><span class=p>);</span>

    <span class=c1>// Attempt to use an already-allocated connection.</span>
    <span class=n>RealConnection</span> <span class=n>allocatedConnection</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>connection</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>allocatedConnection</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>allocatedConnection</span><span class=p>.</span><span class=na>noNewStreams</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>allocatedConnection</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// Attempt to get a connection from the pool.</span>
    <span class=n>Internal</span><span class=p>.</span><span class=na>instance</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>connectionPool</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>connection</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>connection</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>selectedRoute</span> <span class=o>=</span> <span class=n>route</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// If we need a route, make one. This is a blocking operation.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>selectedRoute</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>selectedRoute</span> <span class=o>=</span> <span class=n>routeSelector</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=n>RealConnection</span> <span class=n>result</span><span class=p>;</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>connectionPool</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>canceled</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Canceled&quot;</span><span class=p>);</span>

    <span class=c1>// Now that we have an IP address, make another attempt at getting a connection from the pool.</span>
    <span class=c1>// This could match due to connection coalescing.</span>
    <span class=n>Internal</span><span class=p>.</span><span class=na>instance</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>connectionPool</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=n>selectedRoute</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>connection</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=k>return</span> <span class=n>connection</span><span class=p>;</span>

    <span class=c1>// Create a connection and assign it to this allocation immediately. This makes it possible</span>
    <span class=c1>// for an asynchronous cancel() to interrupt the handshake we&#39;re about to do.</span>
    <span class=n>route</span> <span class=o>=</span> <span class=n>selectedRoute</span><span class=p>;</span>
    <span class=n>refusedStreamCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RealConnection</span><span class=p>(</span><span class=n>connectionPool</span><span class=p>,</span> <span class=n>selectedRoute</span><span class=p>);</span>
    <span class=n>acquire</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// Do TCP + TLS handshakes. This is a blocking operation.</span>
  <span class=n>result</span><span class=p>.</span><span class=na>connect</span><span class=p>(</span><span class=n>connectTimeout</span><span class=p>,</span> <span class=n>readTimeout</span><span class=p>,</span> <span class=n>writeTimeout</span><span class=p>,</span> <span class=n>connectionRetryEnabled</span><span class=p>);</span>
  <span class=n>routeDatabase</span><span class=p>().</span><span class=na>connected</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>route</span><span class=p>());</span>

  <span class=n>Socket</span> <span class=n>socket</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>connectionPool</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Pool the connection.</span>
    <span class=n>Internal</span><span class=p>.</span><span class=na>instance</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>connectionPool</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>

    <span class=c1>// If another multiplexed connection to the same address was created concurrently, then</span>
    <span class=c1>// release this connection and acquire that one.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>isMultiplexed</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>socket</span> <span class=o>=</span> <span class=n>Internal</span><span class=p>.</span><span class=na>instance</span><span class=p>.</span><span class=na>deduplicate</span><span class=p>(</span><span class=n>connectionPool</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
      <span class=n>result</span> <span class=o>=</span> <span class=n>connection</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=n>closeQuietly</span><span class=p>(</span><span class=n>socket</span><span class=p>);</span>

  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在创建新connection时，会执行TCP + TLS握手，然后放入连接池中。<br> 在调用<code>connect</code>进行握手时会调用<code>establishProtocol</code>方法确定协议：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>establishProtocol</span><span class=p>(</span><span class=n>ConnectionSpecSelector</span> <span class=n>connectionSpecSelector</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>route</span><span class=p>.</span><span class=na>address</span><span class=p>().</span><span class=na>sslSocketFactory</span><span class=p>()</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>protocol</span> <span class=o>=</span> <span class=n>Protocol</span><span class=p>.</span><span class=na>HTTP_1_1</span><span class=p>;</span>
    <span class=n>socket</span> <span class=o>=</span> <span class=n>rawSocket</span><span class=p>;</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>connectTls</span><span class=p>(</span><span class=n>connectionSpecSelector</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>protocol</span> <span class=o>==</span> <span class=n>Protocol</span><span class=p>.</span><span class=na>HTTP_2</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>socket</span><span class=p>.</span><span class=na>setSoTimeout</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// HTTP/2 connection timeouts are set per-stream.</span>
    <span class=n>http2Connection</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Http2Connection</span><span class=p>.</span><span class=na>Builder</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
        <span class=p>.</span><span class=na>socket</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span> <span class=n>route</span><span class=p>.</span><span class=na>address</span><span class=p>().</span><span class=na>url</span><span class=p>().</span><span class=na>host</span><span class=p>(),</span> <span class=n>source</span><span class=p>,</span> <span class=n>sink</span><span class=p>)</span>
        <span class=p>.</span><span class=na>listener</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
        <span class=p>.</span><span class=na>build</span><span class=p>();</span>
    <span class=n>http2Connection</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>也就是说，在建立连接时，如果是HTTP_2，就会初始化一个<code>http2Connection</code>。 </p> <p>我们回到<code>streamAllocation.newStream</code>方法的<code>resultConnection.newCodec</code>语句中：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=n>HttpCodec</span> <span class=nf>newCodec</span><span class=p>(</span>
    <span class=n>OkHttpClient</span> <span class=n>client</span><span class=p>,</span> <span class=n>StreamAllocation</span> <span class=n>streamAllocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>SocketException</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>http2Connection</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>Http2Codec</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=n>http2Connection</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>socket</span><span class=p>.</span><span class=na>setSoTimeout</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>readTimeoutMillis</span><span class=p>());</span>
    <span class=n>source</span><span class=p>.</span><span class=na>timeout</span><span class=p>().</span><span class=na>timeout</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>readTimeoutMillis</span><span class=p>(),</span> <span class=n>MILLISECONDS</span><span class=p>);</span>
    <span class=n>sink</span><span class=p>.</span><span class=na>timeout</span><span class=p>().</span><span class=na>timeout</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>writeTimeoutMillis</span><span class=p>(),</span> <span class=n>MILLISECONDS</span><span class=p>);</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>Http1Codec</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>streamAllocation</span><span class=p>,</span> <span class=n>source</span><span class=p>,</span> <span class=n>sink</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>我们发现，这里根据<code>http2Connection</code>有没有初始化，也就是是不是HTTP_2协议来创建对应的<code>HttpCodec</code>对象。</p> <p>在拦截器的最后，调用<code>realChain.proceed(request, streamAllocation, httpCodec, connection)</code>将请求传递给下一个拦截器。</p> <h2 id=10-callserverinterceptor>10. CallServerInterceptor<a class=headerlink href=#10-callserverinterceptor title="Permanent link">&para;</a></h2> <div class="admonition quote"> <p class=admonition-title>Comments</p> <p>This is the last interceptor in the chain. It makes a network call to the server.</p> </div> <p>下面这些代码看起来也很清晰，就是利用<code>HttpCodec</code>进行请求数据、响应数据的读写。其中读写的不详细描述。</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Response</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>Chain</span> <span class=n>chain</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>RealInterceptorChain</span> <span class=n>realChain</span> <span class=o>=</span> <span class=p>(</span><span class=n>RealInterceptorChain</span><span class=p>)</span> <span class=n>chain</span><span class=p>;</span>
  <span class=n>HttpCodec</span> <span class=n>httpCodec</span> <span class=o>=</span> <span class=n>realChain</span><span class=p>.</span><span class=na>httpStream</span><span class=p>();</span>
  <span class=n>StreamAllocation</span> <span class=n>streamAllocation</span> <span class=o>=</span> <span class=n>realChain</span><span class=p>.</span><span class=na>streamAllocation</span><span class=p>();</span>
  <span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>=</span> <span class=p>(</span><span class=n>RealConnection</span><span class=p>)</span> <span class=n>realChain</span><span class=p>.</span><span class=na>connection</span><span class=p>();</span>
  <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>realChain</span><span class=p>.</span><span class=na>request</span><span class=p>();</span>

  <span class=kt>long</span> <span class=n>sentRequestMillis</span> <span class=o>=</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span>
  <span class=n>httpCodec</span><span class=p>.</span><span class=na>writeRequestHeaders</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>

  <span class=n>Response</span><span class=p>.</span><span class=na>Builder</span> <span class=n>responseBuilder</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=na>permitsRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>method</span><span class=p>())</span> <span class=o>&amp;&amp;</span> <span class=n>request</span><span class=p>.</span><span class=na>body</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// If there&#39;s a &quot;Expect: 100-continue&quot; header on the request, wait for a &quot;HTTP/1.1 100</span>
    <span class=c1>// Continue&quot; response before transmitting the request body. If we don&#39;t get that, return what</span>
    <span class=c1>// we did get (such as a 4xx response) without ever transmitting the request body.</span>
    <span class=k>if</span> <span class=p>(</span><span class=s>&quot;100-continue&quot;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Expect&quot;</span><span class=p>)))</span> <span class=p>{</span>
      <span class=n>httpCodec</span><span class=p>.</span><span class=na>flushRequest</span><span class=p>();</span>
      <span class=n>responseBuilder</span> <span class=o>=</span> <span class=n>httpCodec</span><span class=p>.</span><span class=na>readResponseHeaders</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>responseBuilder</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Write the request body if the &quot;Expect: 100-continue&quot; expectation was met.</span>
      <span class=n>Sink</span> <span class=n>requestBodyOut</span> <span class=o>=</span> <span class=n>httpCodec</span><span class=p>.</span><span class=na>createRequestBody</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>request</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>contentLength</span><span class=p>());</span>
      <span class=n>BufferedSink</span> <span class=n>bufferedRequestBody</span> <span class=o>=</span> <span class=n>Okio</span><span class=p>.</span><span class=na>buffer</span><span class=p>(</span><span class=n>requestBodyOut</span><span class=p>);</span>
      <span class=n>request</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>writeTo</span><span class=p>(</span><span class=n>bufferedRequestBody</span><span class=p>);</span>
      <span class=n>bufferedRequestBody</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>connection</span><span class=p>.</span><span class=na>isMultiplexed</span><span class=p>())</span> <span class=p>{</span>
      <span class=c1>// If the &quot;Expect: 100-continue&quot; expectation wasn&#39;t met, prevent the HTTP/1 connection from</span>
      <span class=c1>// being reused. Otherwise we&#39;re still obligated to transmit the request body to leave the</span>
      <span class=c1>// connection in a consistent state.</span>
      <span class=n>streamAllocation</span><span class=p>.</span><span class=na>noNewStreams</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=n>httpCodec</span><span class=p>.</span><span class=na>finishRequest</span><span class=p>();</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>responseBuilder</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>responseBuilder</span> <span class=o>=</span> <span class=n>httpCodec</span><span class=p>.</span><span class=na>readResponseHeaders</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>responseBuilder</span>
      <span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
      <span class=p>.</span><span class=na>handshake</span><span class=p>(</span><span class=n>streamAllocation</span><span class=p>.</span><span class=na>connection</span><span class=p>().</span><span class=na>handshake</span><span class=p>())</span>
      <span class=p>.</span><span class=na>sentRequestAtMillis</span><span class=p>(</span><span class=n>sentRequestMillis</span><span class=p>)</span>
      <span class=p>.</span><span class=na>receivedResponseAtMillis</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>())</span>
      <span class=p>.</span><span class=na>build</span><span class=p>();</span>

  <span class=kt>int</span> <span class=n>code</span> <span class=o>=</span> <span class=n>response</span><span class=p>.</span><span class=na>code</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>forWebSocket</span> <span class=o>&amp;&amp;</span> <span class=n>code</span> <span class=o>==</span> <span class=mi>101</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Connection is upgrading, but we need to ensure interceptors see a non-null response body.</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>response</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
        <span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>EMPTY_RESPONSE</span><span class=p>)</span>
        <span class=p>.</span><span class=na>build</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>response</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span>
        <span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=n>httpCodec</span><span class=p>.</span><span class=na>openResponseBody</span><span class=p>(</span><span class=n>response</span><span class=p>))</span>
        <span class=p>.</span><span class=na>build</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=s>&quot;close&quot;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>request</span><span class=p>().</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Connection&quot;</span><span class=p>))</span>
      <span class=o>||</span> <span class=s>&quot;close&quot;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&quot;Connection&quot;</span><span class=p>)))</span> <span class=p>{</span>
    <span class=n>streamAllocation</span><span class=p>.</span><span class=na>noNewStreams</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>((</span><span class=n>code</span> <span class=o>==</span> <span class=mi>204</span> <span class=o>||</span> <span class=n>code</span> <span class=o>==</span> <span class=mi>205</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>response</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>contentLength</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>ProtocolException</span><span class=p>(</span>
        <span class=s>&quot;HTTP &quot;</span> <span class=o>+</span> <span class=n>code</span> <span class=o>+</span> <span class=s>&quot; had non-zero Content-Length: &quot;</span> <span class=o>+</span> <span class=n>response</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>contentLength</span><span class=p>());</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>response</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <h2 id=11>11. 小结<a class=headerlink href=#11 title="Permanent link">&para;</a></h2> <p>至此，OkHttp3的源码大致就过了一遍，这里小结一下。 </p> <p>在OkHttp中，<code>RealCall</code>是Call的实现类，负责执行网络请求。其中，异步请求由<code>Dispatcher</code>进行调度，并放到线程池（一个典型的<code>CachedThreadPool</code>）中执行。 </p> <p>执行网络请求的过程中，请求会依次经过下列拦截器组成的责任链，最后发送到服务器。</p> <ol> <li><code>interceptors()</code></li> <li>重试、重定向拦截器<code>RetryAndFollowUpInterceptor</code></li> <li>把用户请求转换为服务器请求、把服务器返响应转换为用户响应的<code>BridgeInterceptor</code></li> <li>读取缓存直接返回、将响应写入到缓存中的<code>CacheInterceptor</code></li> <li>与服务器建立连接的<code>ConnectInterceptor</code></li> <li><code>networkInterceptors()</code></li> <li>真正执行网络请求的<code>CallServerInterceptor</code></li> </ol> <p>而响应会从<code>CallServerInterceptor</code>开始往前依次经过这些拦截器，最后客户端进行处理。</p> <p>下图为OkHttp工作的大致流程，参考自<a href=https://blog.piasy.com/2016/07/11/Understand-OkHttp/index.html>拆轮子系列：拆 OkHttp</a> <figure style="width: 66%" class=align-center> <img src=/assets/images/android/okhttp_overview.jpg> <figcaption>OkHttp总体工作流程</figcaption> </figure></p> <h2 id=faq>FAQ<a class=headerlink href=#faq title="Permanent link">&para;</a></h2> <p><a href=/android/3rd-library/retrofit/#faq>Retrofit/FAQ</a></p> <h2 id=_1>参考文献<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <ul> <li><a href=https://www.jianshu.com/p/e0dd6791653d>Retrofit和OkHttp使用网络缓存数据</a></li> </ul> <hr> <div class=md-source-date> <small> 最后更新: 2020年1月13日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/3rd-library/okhttp/";
      this.page.identifier =
        "/android/3rd-library/okhttp/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> Matrix-SQLiteLint解析 </span> </div> </a> <a href=../retrofit/ title=Retrofit2源码解析 class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> Retrofit2源码解析 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/framework/Window与WindowManager/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Window与WindowManager</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - Window与WindowManager"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/framework/Window与WindowManager/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - Window与WindowManager"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1-windowwindowmanager tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> Window与WindowManager </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../3rd-library/3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3rd-library/3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../3rd-library/eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3 checked> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Window与WindowManager </label> <a href=./ title=Window与WindowManager class="md-nav__link md-nav__link--active"> Window与WindowManager </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-windowwindowmanager class=md-nav__link> 1 Window与WindowManager </a> </li> <li class=md-nav__item> <a href=#2-window class=md-nav__link> 2 Window内部机制 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-window class=md-nav__link> 2.1 Window的添加过程 </a> </li> <li class=md-nav__item> <a href=#22-window class=md-nav__link> 2.2 Window的删除过程 </a> </li> <li class=md-nav__item> <a href=#23-window class=md-nav__link> 2.3 Window的更新过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-window class=md-nav__link> 3. Window的创建过程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-activitywindow class=md-nav__link> 3.1 Activity的Window创建过程 </a> </li> <li class=md-nav__item> <a href=#32-dialogwindow class=md-nav__link> 3.2 Dialog的Window创建过程 </a> </li> <li class=md-nav__item> <a href=#33-toastwindow class=md-nav__link> 3.3 Toast的Window创建过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-windowwindowmanager class=md-nav__link> 1 Window与WindowManager </a> </li> <li class=md-nav__item> <a href=#2-window class=md-nav__link> 2 Window内部机制 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-window class=md-nav__link> 2.1 Window的添加过程 </a> </li> <li class=md-nav__item> <a href=#22-window class=md-nav__link> 2.2 Window的删除过程 </a> </li> <li class=md-nav__item> <a href=#23-window class=md-nav__link> 2.3 Window的更新过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-window class=md-nav__link> 3. Window的创建过程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-activitywindow class=md-nav__link> 3.1 Activity的Window创建过程 </a> </li> <li class=md-nav__item> <a href=#32-dialogwindow class=md-nav__link> 3.2 Dialog的Window创建过程 </a> </li> <li class=md-nav__item> <a href=#33-toastwindow class=md-nav__link> 3.3 Toast的Window创建过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Window与WindowManager</h1> <p>Window表示一个窗口的概念，它存在于Window、Dialog以及Toast中，但是日常开发中并不多见，它可以实现悬浮窗。Window是一个抽象类，其具体实现是<code>PhoneWindow</code>。WindowManager是外界访问Window的入口，Window的具体实现在<code>WindowManagerService</code>中，WindowManager与<code>WindowManagerService</code>之间的交互是一个IPC过程。 </p> <p>Android中所有的视图都是通过Window来呈现的，不管是Activity、Dialog还是Toast，它们的视图实际上都是附加在Window上的，因此Window实际是View的直接管理者。在View的事件分发机制也可以知道，单击事件由Window传递给DecorView，再由DecorView传递给我们的View，就连Activity的设置视图的方法<code>setContentView</code>在底层也是通过Window来实现的。</p> <h2 id=1-windowwindowmanager>1 Window与WindowManager<a class=headerlink href=#1-windowwindowmanager title="Permanent link">&para;</a></h2> <p>我们先看下面这段通过WindowManager添加Window的代码：</p> <p><div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WindowTestActivity</span> <span class=kd>extends</span> <span class=n>BaseActivity</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>OVERLAY_PERMISSION_REQ_CODE</span> <span class=o>=</span> <span class=mh>0x0001</span><span class=p>;</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span> <span class=n>savedInstanceState</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span>
        <span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_window_test</span><span class=p>);</span>

        <span class=n>addFloatingView</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>addFloatingView</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>M</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>requestDrawOverLaysPermission</span><span class=p>();</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>addFloatingViewInternal</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>addFloatingViewInternal</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>Button</span> <span class=n>mButton</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Button</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
        <span class=n>mButton</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=s>&quot;Button&quot;</span><span class=p>);</span>
        <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>layoutParams</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>(</span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>,</span>
                <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>,</span>
                <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>TYPE_SYSTEM_ERROR</span><span class=p>,</span>
                <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_NOT_TOUCH_MODAL</span>
                <span class=o>|</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_NOT_FOCUSABLE</span>
                <span class=o>|</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_SHOW_WHEN_LOCKED</span><span class=p>,</span>
                <span class=n>PixelFormat</span><span class=p>.</span><span class=na>TRANSLUCENT</span><span class=p>);</span>
        <span class=n>layoutParams</span><span class=p>.</span><span class=na>gravity</span> <span class=o>=</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>LEFT</span> <span class=o>|</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>TOP</span><span class=p>;</span>
        <span class=n>layoutParams</span><span class=p>.</span><span class=na>x</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
        <span class=n>layoutParams</span><span class=p>.</span><span class=na>y</span> <span class=o>=</span> <span class=mi>300</span><span class=p>;</span>

        <span class=n>WindowManager</span> <span class=n>windowManager</span> <span class=o>=</span> <span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span> <span class=n>getSystemService</span><span class=p>(</span><span class=n>WINDOW_SERVICE</span><span class=p>);</span>
        <span class=n>windowManager</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>mButton</span><span class=p>,</span> <span class=n>layoutParams</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>M</span><span class=p>)</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>requestDrawOverLaysPermission</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>Settings</span><span class=p>.</span><span class=na>canDrawOverlays</span><span class=p>(</span><span class=k>this</span><span class=p>))</span> <span class=p>{</span>
            <span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s>&quot;can not DrawOverlays&quot;</span><span class=p>,</span> <span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span>
            <span class=n>Intent</span> <span class=n>intent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=p>(</span><span class=n>Settings</span><span class=p>.</span><span class=na>ACTION_MANAGE_OVERLAY_PERMISSION</span><span class=p>,</span> <span class=n>Uri</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&quot;package:&quot;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>()));</span>
            <span class=n>startActivityForResult</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>OVERLAY_PERMISSION_REQ_CODE</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// Already hold the SYSTEM_ALERT_WINDOW permission, do add view or something.</span>
            <span class=n>addFloatingViewInternal</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onActivityResult</span><span class=p>(</span><span class=kt>int</span> <span class=n>requestCode</span><span class=p>,</span> <span class=kt>int</span> <span class=n>resultCode</span><span class=p>,</span> <span class=n>Intent</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>requestCode</span> <span class=o>==</span> <span class=n>OVERLAY_PERMISSION_REQ_CODE</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>M</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>Settings</span><span class=p>.</span><span class=na>canDrawOverlays</span><span class=p>(</span><span class=k>this</span><span class=p>))</span> <span class=p>{</span>
                    <span class=c1>// SYSTEM_ALERT_WINDOW permission not granted...</span>
                    <span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s>&quot;Permission Denied by user. Please Check it in Settings&quot;</span><span class=p>,</span> <span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span>
                    <span class=n>requestDrawOverLaysPermission</span><span class=p>();</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s>&quot;Permission Allowed&quot;</span><span class=p>,</span> <span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span>
                    <span class=c1>// Already hold the SYSTEM_ALERT_WINDOW permission, do addview or something.</span>
                    <span class=n>addFloatingViewInternal</span><span class=p>();</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> 这段代码适配了Android M，在M及以后使用系统级别悬浮窗需要引导用户打开此设置。</p> <p>实际添加Window的方法是<code>addFloatView</code>。这个方法可以将Button添加到屏幕坐标的(100, 300)处。当然使用系统级别的悬浮窗不要忘记注册权限(<code>&lt;uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /&gt;</code>)，不然在L上会报错，在M上没有<code>Draw over other apps</code>设置项。</p> <blockquote> <p><strong>注意</strong>： <strong>WindowManager.LayoutParams的x和y是与gravity的相对值。也就是说window会会先根据gravity确定位置，然后根据x,y确定偏移量。</strong> gravity参数表示Window出现的位置，默认是屏幕中间。x、y的值是相对于gravity的。<br> 通过Google Play Store(Version 6.05 or heigher is required)下载的需要该权限的应用，会被framework自动授予该权限。These are the commits <a href=https://github.com/android/platform_frameworks_base/commit/01af6a42a6a008d4b208a92510537791b261168c>[1]</a> <a href=https://github.com/android/platform_frameworks_base/commit/4ff3b614ab73539763343e0981869c7ab5ee9979>[2]</a> that allow the Play Store to give the automatic grant of the SYSTEM_ALERT_WINDOW permission.</p> </blockquote> <p>WindowManager的flags、type属性比较重要。上面构造函数的第三个、第四个就是它们：<code>layoutParams(int w, int h, int _type, int _flags, int _format)</code>。</p> <p>flags属性表示Window的属性，它有很多选项，我们这里只说三种，剩下的可以查看<a href=https://developer.android.com/reference/android/view/WindowManager.LayoutParams.html>官方文档</a></p> <ul> <li> <p><code>FLAG_NOT_FOCUSABLE</code><br> Window不需要获得焦点，因此也不会接收各种输入事件，此标记会同时启用<code>FLAG_NOT_TOUCH_MODAL</code>标记位，无论代码中有没有明确设置这个标记位。<br> 设置了此状态意味着不需要和软键盘进行交互，因为它是Z-ordered的，独立于任何激活状态的软键盘。因此，它可以处于激活状态软键盘的上面，如果必要，可以覆盖软键盘。我们可以使用<code>FLAG_ALT_FOCUSABLE_IM</code>修改这个行为。</p> </li> <li> <p><code>FLAG_NOT_TOUCH_MODAL</code><br> Window是否是modal状态。<br> 即使Window是可以获得焦点的（<code>FLAG_NOT_FOCUSABLE</code>没有设置），在Window外面的点击事件都会传递给后面的Window。否则，Window将会处理所有的点击事件，无论是否在它的范围内。</p> </li> <li> <p><code>FLAG_SHOW_WHEN_LOCKED</code><br> Window可以显示在KeyGuard或者其他锁屏界面上。和<code>FLAG_KEEP_SCREEN_ON</code>一起使用可以在屏幕打开后直接显示Window，而不用经历KeyGuard。与<code>FLAG_DISMISS_KEYGUARD</code>一起使用可以自动跳过non-secure KeyGuard。此Flag只能用于最顶层全屏Window上。</p> </li> </ul> <p>type参数表示Window的类型，<strong>Window可以分为三种类型：Application Window、子Window以及系统Window</strong>：</p> <ul> <li>Application Window对应着一个Activity；</li> <li>子Window不能单独存在，它需要附属在特定的父Window中，比如Dialog就是一个子Window；</li> <li>系统Window需要申明权限才能创建，比如Toast以及系统状态栏就是系统Window。</li> </ul> <p>Window是分层的，每个Window都有对应的Z-ordered，层级大的会覆盖在层级小的Window上面。在三种Window中，Application Window是1<sub>99，子Window是1000</sub>1999，系统Window是2000~2999。<br> 系统层级是最大的，我们一般可以选用<code>TYPE_SYSTEM_OVERLAY</code>或者<code>TYPE_SYSTEM_ERROR</code>，同时声明权限(<code>&lt;uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /&gt;</code>)。</p> <p>WindowManager提供的功能很简单，常用的方法只有三个：添加、更新、删除View。这三个方法定义在ViewManager中，而WindowManager继承至ViewManager：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ViewManager</span>
<span class=p>{</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addView</span><span class=p>(</span><span class=n>View</span> <span class=n>view</span><span class=p>,</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=p>);</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateViewLayout</span><span class=p>(</span><span class=n>View</span> <span class=n>view</span><span class=p>,</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=p>);</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>removeView</span><span class=p>(</span><span class=n>View</span> <span class=n>view</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <h2 id=2-window>2 Window内部机制<a class=headerlink href=#2-window title="Permanent link">&para;</a></h2> <p>Window是一个抽象的概念，每一个Window都对应着一个View和一个ViewRootImpl，Window与View通过ViewRootImpl来建立联系，因此Window实际上并不存在，它是以View的形式存在的。在实际使用中无法访问Window，对Window的访问必须通过WindowManager。我们接下来分析下Window的三个方法。</p> <h3 id=21-window>2.1 Window的添加过程<a class=headerlink href=#21-window title="Permanent link">&para;</a></h3> <blockquote> <p>本章源码基于Android 7.1</p> </blockquote> <p>Window的添加过程通过WindowManager的<code>addView</code>来实现，<strong>WindowManager是一个接口，其真正实现是WindowManagerImpl类</strong>。WindowManagerImpl中三个操作如下：</p> <p><div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addView</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>applyDefaultToken</span><span class=p>(</span><span class=n>params</span><span class=p>);</span>
    <span class=n>mGlobal</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>mContext</span><span class=p>.</span><span class=na>getDisplay</span><span class=p>(),</span> <span class=n>mParentWindow</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateViewLayout</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>applyDefaultToken</span><span class=p>(</span><span class=n>params</span><span class=p>);</span>
    <span class=n>mGlobal</span><span class=p>.</span><span class=na>updateViewLayout</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>params</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>removeView</span><span class=p>(</span><span class=n>View</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>mGlobal</span><span class=p>.</span><span class=na>removeView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>applyDefaultToken</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Only use the default token if we don&#39;t have a parent window.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mDefaultToken</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mParentWindow</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>params</span> <span class=k>instanceof</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Params must be WindowManager.LayoutParams&quot;</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// Only use the default token if we don&#39;t already have a token.</span>
        <span class=kd>final</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>wparams</span> <span class=o>=</span> <span class=p>(</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span> <span class=n>params</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>wparams</span><span class=p>.</span><span class=na>token</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>wparams</span><span class=p>.</span><span class=na>token</span> <span class=o>=</span> <span class=n>mDefaultToken</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <code>applyDefaultToken</code>方法将会为Window设置默认token，这个token只有在<code>AccessibilityService</code>中才会设置。所以，一般情况下该方法没有任何效果，可以忽略。</p> <p>WindowManagerImpl并没有直接实现Window的三大操作，而是全部交给了WindowManagerGlobal处理。WindowManagerGlobal以单例的模式向外提供自己的实例：<code>private final WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</code>。WindowManagerImpl的这种工作模式是典型的<a href=/design-pattern/bridge/ >桥接模式</a>，将所有的操作全部委托给WindowManagerGlobal来实现。</p> <p>接下来我们看WindowManagerGlobal的<code>addView</code>方法，该方法分为以下几部分： </p> <ol> <li> <p>检查传入参数，并调整子Window布局参数<br> <div class=codehilite><pre><span></span><span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;view must not be null&quot;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>(</span><span class=n>display</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;display must not be null&quot;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>params</span> <span class=k>instanceof</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Params must be WindowManager.LayoutParams&quot;</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>final</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>wparams</span> <span class=o>=</span> <span class=p>(</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span> <span class=n>params</span><span class=p>;</span>
<span class=k>if</span> <span class=p>(</span><span class=n>parentWindow</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>parentWindow</span><span class=p>.</span><span class=na>adjustLayoutParamsForSubWindow</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// If there&#39;s no parent, then hardware acceleration for this view is</span>
    <span class=c1>// set from the application&#39;s hardware acceleration setting.</span>
    <span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>!=</span> <span class=kc>null</span>
            <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationInfo</span><span class=p>().</span><span class=na>flags</span>
                    <span class=o>&amp;</span> <span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>wparams</span><span class=p>.</span><span class=na>flags</span> <span class=o>|=</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <code>adjustLayoutParamsForSubWindow</code>方法实现是在<code>Window</code>中，该方法的作用就是根据<code>wparams</code>的type判断属于哪种Window。如果是子Window，会使用DecorView的getWindowToken来设置其token；如果是应用Window，也会根据是否有父Parent来决定将应用Token还是父Parent的应用Token设置其Token。之后会设置其packageName以及是否使用硬件加速的flags。</p> </li> <li> <p>设置系统属性监听器、检查View状态、为子Window查找parentView <div class=codehilite><pre><span></span><span class=c1>// Start watching for system property changes.</span>
<span class=k>if</span> <span class=p>(</span><span class=n>mSystemPropertyUpdater</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>mSystemPropertyUpdater</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
        <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
            <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>mRoots</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>--</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>loadSystemProperties</span><span class=p>();</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>};</span>
    <span class=n>SystemProperties</span><span class=p>.</span><span class=na>addChangeCallback</span><span class=p>(</span><span class=n>mSystemPropertyUpdater</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>findViewLocked</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mDyingViews</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>view</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// Don&#39;t wait for MSG_DIE to make it&#39;s way through root&#39;s queue.</span>
        <span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>).</span><span class=na>doDie</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;View &quot;</span> <span class=o>+</span> <span class=n>view</span>
                <span class=o>+</span> <span class=s>&quot; has already been added to the window manager.&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// The previous removeView() had not completed executing. Now it has.</span>
<span class=p>}</span>

<span class=c1>// If this is a panel window, then find the window it is being</span>
<span class=c1>// attached to for future reference.</span>
<span class=k>if</span> <span class=p>(</span><span class=n>wparams</span><span class=p>.</span><span class=na>type</span> <span class=o>&gt;=</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FIRST_SUB_WINDOW</span> <span class=o>&amp;&amp;</span>
        <span class=n>wparams</span><span class=p>.</span><span class=na>type</span> <span class=o>&lt;=</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>LAST_SUB_WINDOW</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>mViews</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>mWindow</span><span class=p>.</span><span class=na>asBinder</span><span class=p>()</span> <span class=o>==</span> <span class=n>wparams</span><span class=p>.</span><span class=na>token</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>panelParentView</span> <span class=o>=</span> <span class=n>mViews</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> 在View的检查操作中，如果View已经添加过了，且正在被删除，那么会立刻执行<code>doDie</code>进行一些相关的销毁操作；否则，如果View已经添加过，但是不在mDyingViews数组中，这说明是重复添加，会报<code>IllegalStateException("View " + view + " has already been added to the window manager.")</code>错。</p> </li> <li> <p>创建ViewRootImpl并将View添加到列表中<br> 在<code>WindowManagerGlobal</code>中有四个很重要的成员变量： <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kd>final</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>View</span><span class=o>&gt;</span> <span class=n>mViews</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>View</span><span class=o>&gt;</span><span class=p>();</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ViewRootImpl</span><span class=o>&gt;</span> <span class=n>mRoots</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ViewRootImpl</span><span class=o>&gt;</span><span class=p>();</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=o>&gt;</span> <span class=n>mParams</span> <span class=o>=</span>
        <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=o>&gt;</span><span class=p>();</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>ArraySet</span><span class=o>&lt;</span><span class=n>View</span><span class=o>&gt;</span> <span class=n>mDyingViews</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArraySet</span><span class=o>&lt;</span><span class=n>View</span><span class=o>&gt;</span><span class=p>();</span>
</pre></div></p> <ul> <li>mViews保存的是所有Window对应的View</li> <li>mRoots存储的所有Window对应的ViewRootImpl，</li> <li>mParams存储的所有Window对应的布局参数</li> <li>mDyingViews保存的正在被删除的View对象，或者说是已经调用了<code>removeView</code>方法但是删除操作还未完成的Window对象</li> </ul> <p>在addView中通过如下方式将Window的一系列对象添加到列表中： <div class=codehilite><pre><span></span><span class=n>root</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ViewRootImpl</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>(),</span> <span class=n>display</span><span class=p>);</span>

<span class=n>view</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span>

<span class=n>mViews</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
<span class=n>mRoots</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>root</span><span class=p>);</span>
<span class=n>mParams</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span>
</pre></div></p> </li> <li> <p>通过ViewRootImpl更新界面并完成Window的添加过程 <div class=codehilite><pre><span></span><span class=c1>// do this last because it fires off messages to start doing things</span>
<span class=k>try</span> <span class=p>{</span>
    <span class=n>root</span><span class=p>.</span><span class=na>setView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>wparams</span><span class=p>,</span> <span class=n>panelParentView</span><span class=p>);</span>
<span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RuntimeException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// BadTokenException or InvalidDisplayException, clean up.</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>findViewLocked</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>removeViewLocked</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> 我们可以看出，该方法最后调用的是ViewRootImpl的<code>setView(view, wparams, panelParentView);</code>方法。该方法内部会调用<code>requestLayout ()</code>来完成异步刷新请求，进行View的测量、布局以及绘制。<code>requestLayout</code>的内部接着会调用<code>scheduleTraversals</code>方法，这实际上是View绘制 的入口： <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>requestLayout</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mHandlingLayoutInLayoutRequest</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>checkThread</span><span class=p>();</span>
        <span class=n>mLayoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=n>scheduleTraversals</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> 在<code>setView</code>方法中，调用<code>requestLayout</code>方法后，接着会通过<code>WindowSession</code>来完成Window的添加过程。 <div class=codehilite><pre><span></span><span class=k>try</span> <span class=p>{</span>
    <span class=n>mOrigWindowType</span> <span class=o>=</span> <span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>type</span><span class=p>;</span>
    <span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRecomputeGlobalAttributes</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=n>collectViewAttributes</span><span class=p>();</span>
    <span class=n>res</span> <span class=o>=</span> <span class=n>mWindowSession</span><span class=p>.</span><span class=na>addToDisplay</span><span class=p>(</span><span class=n>mWindow</span><span class=p>,</span> <span class=n>mSeq</span><span class=p>,</span> <span class=n>mWindowAttributes</span><span class=p>,</span>
            <span class=n>getHostVisibility</span><span class=p>(),</span> <span class=n>mDisplay</span><span class=p>.</span><span class=na>getDisplayId</span><span class=p>(),</span>
            <span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>,</span> <span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mStableInsets</span><span class=p>,</span>
            <span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOutsets</span><span class=p>,</span> <span class=n>mInputChannel</span><span class=p>);</span>
<span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
<span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=p>...</span>
<span class=p>}</span>
</pre></div> mWindowSession的类型是IWindowSession，它的真正实现类是<code>Session</code>，是一个Binder对象，因此Window的添加过程是一次IPC操作。下面是 <code>mWindowSession</code>结构的部分代码： <div class=codehilite><pre><span></span><span class=c1>// ViewRootImpl</span>
<span class=n>mWindowSession</span> <span class=o>=</span> <span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>getWindowSession</span><span class=p>();</span>

<span class=c1>// WindowManagerGlobal</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>IWindowSession</span> <span class=nf>getWindowSession</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>sWindowSession</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=n>InputMethodManager</span> <span class=n>imm</span> <span class=o>=</span> <span class=n>InputMethodManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>();</span>
                <span class=n>IWindowManager</span> <span class=n>windowManager</span> <span class=o>=</span> <span class=n>getWindowManagerService</span><span class=p>();</span>
                <span class=n>sWindowSession</span> <span class=o>=</span> <span class=n>windowManager</span><span class=p>.</span><span class=na>openSession</span><span class=p>(</span>
                        <span class=k>new</span> <span class=n>IWindowSessionCallback</span><span class=p>.</span><span class=na>Stub</span><span class=p>()</span> <span class=p>{</span>
                            <span class=nd>@Override</span>
                            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onAnimatorScaleChanged</span><span class=p>(</span><span class=kt>float</span> <span class=n>scale</span><span class=p>)</span> <span class=p>{</span>
                                <span class=n>ValueAnimator</span><span class=p>.</span><span class=na>setDurationScale</span><span class=p>(</span><span class=n>scale</span><span class=p>);</span>
                            <span class=p>}</span>
                        <span class=p>},</span>
                        <span class=n>imm</span><span class=p>.</span><span class=na>getClient</span><span class=p>(),</span> <span class=n>imm</span><span class=p>.</span><span class=na>getInputContext</span><span class=p>());</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>throw</span> <span class=n>e</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>sWindowSession</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>static</span> <span class=n>IWindowManager</span> <span class=nf>getWindowManagerService</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>sWindowManagerService</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>sWindowManagerService</span> <span class=o>=</span> <span class=n>IWindowManager</span><span class=p>.</span><span class=na>Stub</span><span class=p>.</span><span class=na>asInterface</span><span class=p>(</span>
                    <span class=n>ServiceManager</span><span class=p>.</span><span class=na>getService</span><span class=p>(</span><span class=s>&quot;window&quot;</span><span class=p>));</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>sWindowManagerService</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>ValueAnimator</span><span class=p>.</span><span class=na>setDurationScale</span><span class=p>(</span>
                            <span class=n>sWindowManagerService</span><span class=p>.</span><span class=na>getCurrentAnimatorScale</span><span class=p>());</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>throw</span> <span class=n>e</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>sWindowManagerService</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// WindowManagerService</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>IWindowSession</span> <span class=nf>openSession</span><span class=p>(</span><span class=n>IWindowSessionCallback</span> <span class=n>callback</span><span class=p>,</span> <span class=n>IInputMethodClient</span> <span class=n>client</span><span class=p>,</span>
        <span class=n>IInputContext</span> <span class=n>inputContext</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>client</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;null client&quot;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>inputContext</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;null inputContext&quot;</span><span class=p>);</span>
    <span class=n>Session</span> <span class=n>session</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Session</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>callback</span><span class=p>,</span> <span class=n>client</span><span class=p>,</span> <span class=n>inputContext</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>session</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// Session</span>
<span class=kd>final</span> <span class=kd>class</span> <span class=nc>Session</span> <span class=kd>extends</span> <span class=n>IWindowSession</span><span class=p>.</span><span class=na>Stub</span> <span class=kd>implements</span> <span class=n>IBinder</span><span class=p>.</span><span class=na>DeathRecipient</span>
</pre></div></p> <p>我们再看一下Session的<code>addToDisplay</code>方法： <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>int</span> <span class=nf>addToDisplay</span><span class=p>(</span><span class=n>IWindow</span> <span class=n>window</span><span class=p>,</span> <span class=kt>int</span> <span class=n>seq</span><span class=p>,</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>attrs</span><span class=p>,</span>
        <span class=kt>int</span> <span class=n>viewVisibility</span><span class=p>,</span> <span class=kt>int</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>Rect</span> <span class=n>outContentInsets</span><span class=p>,</span> <span class=n>Rect</span> <span class=n>outStableInsets</span><span class=p>,</span>
        <span class=n>Rect</span> <span class=n>outOutsets</span><span class=p>,</span> <span class=n>InputChannel</span> <span class=n>outInputChannel</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>mService</span><span class=p>.</span><span class=na>addWindow</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>window</span><span class=p>,</span> <span class=n>seq</span><span class=p>,</span> <span class=n>attrs</span><span class=p>,</span> <span class=n>viewVisibility</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span>
            <span class=n>outContentInsets</span><span class=p>,</span> <span class=n>outStableInsets</span><span class=p>,</span> <span class=n>outOutsets</span><span class=p>,</span> <span class=n>outInputChannel</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> mService就是WindowManagerService。如此一来，Window的添加请求就交给WindowManagerService了，在WindowManagerService内部会将传入的session、client等封装成WindowState并以client为key保存在<code>mWindowMap</code>中。具体Window在WindowManagerService内部是怎么添加的，不在这里进行进一步的分析，因为都是一些细节，深入没有太大意义。到目前为止，我们对Window的添加流程已经很清楚了。</p> </li> </ol> <h3 id=22-window>2.2 Window的删除过程<a class=headerlink href=#22-window title="Permanent link">&para;</a></h3> <p>Window的删除过程也是WindowManagerImpl通过WindowManagerGlobal来实现的。我们看一下<code>WindowManagerGlobal#removeView</code>方法：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>removeView</span><span class=p>(</span><span class=n>View</span> <span class=n>view</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>immediate</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;view must not be null&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>findViewLocked</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
        <span class=n>View</span> <span class=n>curView</span> <span class=o>=</span> <span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>).</span><span class=na>getView</span><span class=p>();</span>
        <span class=n>removeViewLocked</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>immediate</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>curView</span> <span class=o>==</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Calling with view &quot;</span> <span class=o>+</span> <span class=n>view</span>
                <span class=o>+</span> <span class=s>&quot; but the ViewAncestor is attached to &quot;</span> <span class=o>+</span> <span class=n>curView</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>此方法的逻辑很清楚，首先通过<code>findViewLocked</code>找到待删除View的索引，然后再调用<code>removeViewLocked</code>做进一步的删除操作：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>removeViewLocked</span><span class=p>(</span><span class=kt>int</span> <span class=n>index</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>immediate</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>ViewRootImpl</span> <span class=n>root</span> <span class=o>=</span> <span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>);</span>
    <span class=n>View</span> <span class=n>view</span> <span class=o>=</span> <span class=n>root</span><span class=p>.</span><span class=na>getView</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>InputMethodManager</span> <span class=n>imm</span> <span class=o>=</span> <span class=n>InputMethodManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>imm</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>imm</span><span class=p>.</span><span class=na>windowDismissed</span><span class=p>(</span><span class=n>mViews</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>).</span><span class=na>getWindowToken</span><span class=p>());</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=kt>boolean</span> <span class=n>deferred</span> <span class=o>=</span> <span class=n>root</span><span class=p>.</span><span class=na>die</span><span class=p>(</span><span class=n>immediate</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>view</span><span class=p>.</span><span class=na>assignParent</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>deferred</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>mDyingViews</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>removeViewLocked</code>是通过ViewRootImpl的<code>die(boolean)</code>来完成删除操作的。在<code>WindowManager</code>中提供了两种删除接口<code>removeView</code>和<code>removeViewImmediate</code>，他们会分别调用WindowManagerGlobal的<code>remove(view, false)</code>和<code>remove(view, true)</code>，后面的boolean变量就是这里的immediate，他们分别表示异步删除和同步删除。其中<code>removeViewImmediate</code>需要特别注意，一般不需要使用该方法来删除Window以免发生意外的错误。 </p> <p>这里主要说说异步删除的情况，具体操作由<code>ViewRootImpl#die</code>方法完成：</p> <div class=codehilite><pre><span></span><span class=kt>boolean</span> <span class=nf>die</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>immediate</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Make sure we do execute immediately if we are in the middle of a traversal or the damage</span>
    <span class=c1>// done by dispatchDetachedFromWindow will cause havoc on return.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>immediate</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mIsInTraversal</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>doDie</span><span class=p>();</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mIsDrawing</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>destroyHardwareRenderer</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span> <span class=s>&quot;Attempting to destroy the window while drawing!\n&quot;</span> <span class=o>+</span>
                <span class=s>&quot;  window=&quot;</span> <span class=o>+</span> <span class=k>this</span> <span class=o>+</span> <span class=s>&quot;, title=&quot;</span> <span class=o>+</span> <span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>getTitle</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=n>mHandler</span><span class=p>.</span><span class=na>sendEmptyMessage</span><span class=p>(</span><span class=n>MSG_DIE</span><span class=p>);</span>
    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在immediate为false的情况下，die方法只是发送了一个<code>MSG_DIE</code>消息后返回true了，并没有完成删除操作。因此从上面的<code>removeViewLocked</code>中可以看到，View没有立刻完成删除操作，只会将其加入mDyingViews中。<br> 这里的mHandler是一个<code>ViewRootHandler</code>对象，MSG_DIE消息会执行<code>doDie()</code>方法。因此在<code>die</code>方法中，如果参数immediate为true就会立刻调用<code>doDie</code>方法，这就是同步删除；如果为false，则会通过Handler来调用<code>doDie</code>方法，这就是两者的区别。</p> <p>关于<code>ViewRootHandler</code>，我们在<a href=/android/framework/Android消息机制/ >Android消息机制</a>中我们提到过，<code>View.post(Runnable)</code>所抛出的Runnable对象都会由此Handler来执行。</p> <p>下面我们看看<code>doDie</code>方法：</p> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>doDie</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>checkThread</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>LOCAL_LOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span> <span class=s>&quot;DIE in &quot;</span> <span class=o>+</span> <span class=k>this</span> <span class=o>+</span> <span class=s>&quot; of &quot;</span> <span class=o>+</span> <span class=n>mSurface</span><span class=p>);</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mRemoved</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>mRemoved</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mAdded</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>dispatchDetachedFromWindow</span><span class=p>();</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>mAdded</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mFirst</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>destroyHardwareRenderer</span><span class=p>();</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>mView</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=kt>int</span> <span class=n>viewVisibility</span> <span class=o>=</span> <span class=n>mView</span><span class=p>.</span><span class=na>getVisibility</span><span class=p>();</span>
                <span class=kt>boolean</span> <span class=n>viewVisibilityChanged</span> <span class=o>=</span> <span class=n>mViewVisibility</span> <span class=o>!=</span> <span class=n>viewVisibility</span><span class=p>;</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>mWindowAttributesChanged</span> <span class=o>||</span> <span class=n>viewVisibilityChanged</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// If layout params have been changed, first give them</span>
                    <span class=c1>// to the window manager to make sure it has the correct</span>
                    <span class=c1>// animation info.</span>
                    <span class=k>try</span> <span class=p>{</span>
                        <span class=k>if</span> <span class=p>((</span><span class=n>relayoutWindow</span><span class=p>(</span><span class=n>mWindowAttributes</span><span class=p>,</span> <span class=n>viewVisibility</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
                                <span class=o>&amp;</span> <span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>RELAYOUT_RES_FIRST_TIME</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                            <span class=n>mWindowSession</span><span class=p>.</span><span class=na>finishDrawing</span><span class=p>(</span><span class=n>mWindow</span><span class=p>);</span>
                        <span class=p>}</span>
                    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=p>}</span>
                <span class=p>}</span>

                <span class=n>mSurface</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=n>mAdded</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>doRemoveView</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p><code>doDie</code>方法会首先检查是否是UI线程，然后调用<code>dispatchDetachedFromWindow</code>方法，真正删除View的逻辑就在这里。 </p> <p><code>dispatchDetachedFromWindow</code>干了这三件事：</p> <ol> <li>通知ViewTree调用<code>onWindowDetached</code>；调用View的<code>dispatchDetachedFromWindow</code>方法，此方法会调用<code>onDetachedFromWindow</code>以及<code>onDetachedFromWindowInternal</code>方法。前者我们可以重写来在其内部做一些资源回收的操作；后者framework已经做了一些垃圾回收操作，如果我们重写了该方法，一定要调用<code>super</code>的该方法。</li> <li>进行垃圾回收操作，比如清除数据、移除回调；</li> <li>通过Session的remove方法删除Window：<code>mWindowSession.remove(mWindow);</code>。这也是一个IPC过程，最终会调用<code>WindowManagerService</code>的<code>removeWindow</code>方法。</li> </ol> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>dispatchDetachedFromWindow</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mView</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mView</span><span class=p>.</span><span class=na>mAttachInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnWindowAttachedChange</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
        <span class=n>mView</span><span class=p>.</span><span class=na>dispatchDetachedFromWindow</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=n>mAccessibilityInteractionConnectionManager</span><span class=p>.</span><span class=na>ensureNoConnection</span><span class=p>();</span>
    <span class=n>mAccessibilityManager</span><span class=p>.</span><span class=na>removeAccessibilityStateChangeListener</span><span class=p>(</span>
            <span class=n>mAccessibilityInteractionConnectionManager</span><span class=p>);</span>
    <span class=n>mAccessibilityManager</span><span class=p>.</span><span class=na>removeHighTextContrastStateChangeListener</span><span class=p>(</span>
            <span class=n>mHighContrastTextManager</span><span class=p>);</span>
    <span class=n>removeSendWindowContentChangedCallback</span><span class=p>();</span>

    <span class=n>destroyHardwareRenderer</span><span class=p>();</span>

    <span class=n>setAccessibilityFocus</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>

    <span class=n>mView</span><span class=p>.</span><span class=na>assignParent</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
    <span class=n>mView</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRootView</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>

    <span class=n>mSurface</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>mInputQueueCallback</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mInputQueue</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mInputQueueCallback</span><span class=p>.</span><span class=na>onInputQueueDestroyed</span><span class=p>(</span><span class=n>mInputQueue</span><span class=p>);</span>
        <span class=n>mInputQueue</span><span class=p>.</span><span class=na>dispose</span><span class=p>();</span>
        <span class=n>mInputQueueCallback</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
        <span class=n>mInputQueue</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mInputEventReceiver</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mInputEventReceiver</span><span class=p>.</span><span class=na>dispose</span><span class=p>();</span>
        <span class=n>mInputEventReceiver</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>try</span> <span class=p>{</span>
        <span class=n>mWindowSession</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>mWindow</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>}</span>

    <span class=c1>// Dispose the input channel after removing the window so the Window Manager</span>
    <span class=c1>// doesn&#39;t interpret the input channel being closed as an abnormal termination.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mInputChannel</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mInputChannel</span><span class=p>.</span><span class=na>dispose</span><span class=p>();</span>
        <span class=n>mInputChannel</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>mDisplayManager</span><span class=p>.</span><span class=na>unregisterDisplayListener</span><span class=p>(</span><span class=n>mDisplayListener</span><span class=p>);</span>

    <span class=n>unscheduleTraversals</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>最后在<code>doDie</code>方法中调用了<code>WindowManagerGlobal#doRemoveView</code>方法，此方法会删除当前View的数据，包括<code>mRoots</code>、<code>mParams</code>、<code>mViews</code>以及<code>mDyingViews</code>。至此，Window的删除过程已经完成了。</p> <h3 id=23-window>2.3 Window的更新过程<a class=headerlink href=#23-window title="Permanent link">&para;</a></h3> <p>Window的更新过程通过<code>WindowManagerGlobal#updateViewLayout</code>开始：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateViewLayout</span><span class=p>(</span><span class=n>View</span> <span class=n>view</span><span class=p>,</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>params</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;view must not be null&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>params</span> <span class=k>instanceof</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Params must be WindowManager.LayoutParams&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>final</span> <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>wparams</span> <span class=o>=</span> <span class=p>(</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span><span class=n>params</span><span class=p>;</span>

    <span class=n>view</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span>

    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>findViewLocked</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
        <span class=n>ViewRootImpl</span> <span class=n>root</span> <span class=o>=</span> <span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>);</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>index</span><span class=p>);</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>wparams</span><span class=p>);</span>
        <span class=n>root</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>此方法很简单，首先检查参数是否合法，然后更新View的LayoutParams，接着更新mParams数组，最后调用<code>ViewRootImpl#setLayoutParams</code>方法来更新Window。<code>setLayoutParams</code>方法中最后调用了<code>scheduleTraversals</code>，该方法在View的工作原理时讲解过，它是View测量、布局、绘制的入口。<code>scheduleTraversals</code>方法会在最后调用<code>performTraversals</code>方法，在此方法内部会实现View的重绘，此外还会调用<code>relayoutWindow</code>方法进而调用<code>mWindowSession.relayout</code>方法来实现Window的更新，当然同以往一样，这也是一个IPC过程。</p> <h2 id=3-window>3. Window的创建过程<a class=headerlink href=#3-window title="Permanent link">&para;</a></h2> <p>从上面的分析可以看出，View是Android中视图的呈现方式，但是View不能单独存在，它必须依附于Window，因此有视图的地方就有Window。</p> <h3 id=31-activitywindow>3.1 Activity的Window创建过程<a class=headerlink href=#31-activitywindow title="Permanent link">&para;</a></h3> <p>要分析Activity中Window的创建过程，需要了解Activity的启动过程。Activity的启动过程非常复杂，这里只说与本节内容有关的部分。Activity的启动最终会通过<code>ActivityThread#performLaunchActivity</code>来完成启动过程。此方法内部会通过类加载器创建Activity的实例，然后调用<code>attach</code>方法为其关联运行中所依赖的一些变量：</p> <div class=codehilite><pre><span></span><span class=n>Activity</span> <span class=n>activity</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<span class=k>try</span> <span class=p>{</span>
    <span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span> <span class=n>cl</span> <span class=o>=</span> <span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>();</span>
    <span class=n>activity</span> <span class=o>=</span> <span class=n>mInstrumentation</span><span class=p>.</span><span class=na>newActivity</span><span class=p>(</span>
            <span class=n>cl</span><span class=p>,</span> <span class=n>component</span><span class=p>.</span><span class=na>getClassName</span><span class=p>(),</span> <span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>);</span>
    <span class=n>StrictMode</span><span class=p>.</span><span class=na>incrementExpectedActivityCount</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
    <span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>setExtrasClassLoader</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span>
    <span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>prepareToEnterProcess</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>setClassLoader</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>onException</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span> <span class=n>e</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span>
            <span class=s>&quot;Unable to instantiate activity &quot;</span> <span class=o>+</span> <span class=n>component</span>
            <span class=o>+</span> <span class=s>&quot;: &quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>try</span> <span class=p>{</span>
    <span class=n>Application</span> <span class=n>app</span> <span class=o>=</span> <span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=p>.</span><span class=na>makeApplication</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=n>mInstrumentation</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Performing launch of &quot;</span> <span class=o>+</span> <span class=n>r</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span>
            <span class=n>TAG</span><span class=p>,</span> <span class=n>r</span> <span class=o>+</span> <span class=s>&quot;: app=&quot;</span> <span class=o>+</span> <span class=n>app</span>
            <span class=o>+</span> <span class=s>&quot;, appName=&quot;</span> <span class=o>+</span> <span class=n>app</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>()</span>
            <span class=o>+</span> <span class=s>&quot;, pkg=&quot;</span> <span class=o>+</span> <span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>()</span>
            <span class=o>+</span> <span class=s>&quot;, comp=&quot;</span> <span class=o>+</span> <span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>toShortString</span><span class=p>()</span>
            <span class=o>+</span> <span class=s>&quot;, dir=&quot;</span> <span class=o>+</span> <span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=p>.</span><span class=na>getAppDir</span><span class=p>());</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>activity</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Context</span> <span class=n>appContext</span> <span class=o>=</span> <span class=n>createBaseContextForActivity</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>activity</span><span class=p>);</span>
        <span class=n>CharSequence</span> <span class=n>title</span> <span class=o>=</span> <span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>loadLabel</span><span class=p>(</span><span class=n>appContext</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>());</span>
        <span class=n>Configuration</span> <span class=n>config</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Configuration</span><span class=p>(</span><span class=n>mCompatConfiguration</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>config</span><span class=p>.</span><span class=na>updateFrom</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span> <span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Launching activity &quot;</span>
                <span class=o>+</span> <span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>name</span> <span class=o>+</span> <span class=s>&quot; with config &quot;</span> <span class=o>+</span> <span class=n>config</span><span class=p>);</span>
        <span class=n>Window</span> <span class=n>window</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>r</span><span class=p>.</span><span class=na>mPreserveWindow</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>window</span> <span class=o>=</span> <span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span><span class=p>;</span>
            <span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
            <span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindowManager</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>activity</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>appContext</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=n>getInstrumentation</span><span class=p>(),</span> <span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span>
                <span class=n>r</span><span class=p>.</span><span class=na>ident</span><span class=p>,</span> <span class=n>app</span><span class=p>,</span> <span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span> <span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>,</span> <span class=n>title</span><span class=p>,</span> <span class=n>r</span><span class=p>.</span><span class=na>parent</span><span class=p>,</span>
                <span class=n>r</span><span class=p>.</span><span class=na>embeddedID</span><span class=p>,</span> <span class=n>r</span><span class=p>.</span><span class=na>lastNonConfigurationInstances</span><span class=p>,</span> <span class=n>config</span><span class=p>,</span>
                <span class=n>r</span><span class=p>.</span><span class=na>referrer</span><span class=p>,</span> <span class=n>r</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>,</span> <span class=n>window</span><span class=p>);</span>
        <span class=p>...</span>
    <span class=p>}</span>
<span class=p>...</span>
</pre></div> <p>在<code>Activity#attach</code>方法中，系统会为Activity创建一个Window并为其设置一些回调接口。由于Activity实现了Window的回调接口，因此当Window接收到外界的状态改变时就会回调Activity的方法。这些回调接口里面有一个Callback接口，里面有我们熟知的<code>dispatchTouchEvent</code>、<code>onAttachedToWindow</code>、<code>onDetachedFromWindow</code>、<code>onMenuItemSelected</code>等一些接口。</p> <div class=codehilite><pre><span></span><span class=p>...</span>
<span class=n>attachBaseContext</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<span class=n>mFragments</span><span class=p>.</span><span class=na>attachHost</span><span class=p>(</span><span class=kc>null</span> <span class=cm>/*parent*/</span><span class=p>);</span>
<span class=n>mWindow</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PhoneWindow</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>window</span><span class=p>);</span>
<span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowControllerCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=n>mWindow</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=n>mWindow</span><span class=p>.</span><span class=na>setOnWindowDismissedCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=p>...</span>
</pre></div> <p>上面在<code>Activity.attach</code>方法中完成了Window的创建；而Activity的视图附属在Window是通过<code>Activity#setContentView</code>来实现的：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=p>(</span><span class=nd>@LayoutRes</span> <span class=kt>int</span> <span class=n>layoutResID</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>getWindow</span><span class=p>().</span><span class=na>setContentView</span><span class=p>(</span><span class=n>layoutResID</span><span class=p>);</span>
    <span class=n>initWindowDecorActionBar</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p><code>Activity#setContentView</code>调用了<code>Window#setContentView</code>方法设置View到content上，然后<code>initWindowDecorActionBar</code>方法会判断需不需要自动初始化ActionBar。<br> 接下来我们看一下<code>Window#setContentView</code>方法：</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=p>(</span><span class=kt>int</span> <span class=n>layoutResID</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span>
    <span class=c1>// decor, when theme attributes and the like are crystalized. Do not check the feature</span>
    <span class=c1>// before this happens.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>installDecor</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hasFeature</span><span class=p>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>mContentParent</span><span class=p>.</span><span class=na>removeAllViews</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>hasFeature</span><span class=p>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=p>))</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=n>Scene</span> <span class=n>newScene</span> <span class=o>=</span> <span class=n>Scene</span><span class=p>.</span><span class=na>getSceneForLayout</span><span class=p>(</span><span class=n>mContentParent</span><span class=p>,</span> <span class=n>layoutResID</span><span class=p>,</span>
                <span class=n>getContext</span><span class=p>());</span>
        <span class=n>transitionTo</span><span class=p>(</span><span class=n>newScene</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>mLayoutInflater</span><span class=p>.</span><span class=na>inflate</span><span class=p>(</span><span class=n>layoutResID</span><span class=p>,</span> <span class=n>mContentParent</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>mContentParent</span><span class=p>.</span><span class=na>requestApplyInsets</span><span class=p>();</span>
    <span class=kd>final</span> <span class=n>Callback</span> <span class=n>cb</span> <span class=o>=</span> <span class=n>getCallback</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>cb</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isDestroyed</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>cb</span><span class=p>.</span><span class=na>onContentChanged</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=n>mContentParentExplicitlySet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p><code>PhoneWindow.setContentView</code>方法大致遵循如下几个步骤：</p> <ol> <li> <p>如果DecorView还没有创建，那么创建它<br> 上面代码第6行的if语句，mContentParent就是id为<code>android.R.id.content</code>的FrameLayout，如果它为null，说明DecorView还没有创建，因此会调用<code>installDecor</code>方法来完成DecorView的创建。 <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>installDecor</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>mForceDecorInstall</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mDecor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mDecor</span> <span class=o>=</span> <span class=n>generateDecor</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
        <span class=p>...</span>
    <span class=p>}</span>
    <span class=p>...</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mContentParent</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mContentParent</span> <span class=o>=</span> <span class=n>generateLayout</span><span class=p>(</span><span class=n>mDecor</span><span class=p>);</span>
        <span class=p>...</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <code>installDecor</code>方法完成的事情比较简单，首先如果没有DecorView，那么通过<code>generateDecor</code>方法new一个<code>DecorView</code>，此时DecorView还没有任何内容，是一个空白的FrameLayout。其次，如果mContentParent为null，通过<code>generateLayout</code>创建mContentParent并加载具体的布局文件到DecorView中，这个过程如下： <div class=codehilite><pre><span></span><span class=c1>// PhoneWindow#generateLayout</span>
<span class=n>mDecor</span><span class=p>.</span><span class=na>startChanging</span><span class=p>();</span>
<span class=n>mDecor</span><span class=p>.</span><span class=na>onResourcesLoaded</span><span class=p>(</span><span class=n>mLayoutInflater</span><span class=p>,</span> <span class=n>layoutResource</span><span class=p>);</span>
<span class=n>ViewGroup</span> <span class=n>contentParent</span> <span class=o>=</span> <span class=p>(</span><span class=n>ViewGroup</span><span class=p>)</span><span class=n>findViewById</span><span class=p>(</span><span class=n>ID_ANDROID_CONTENT</span><span class=p>);</span>

<span class=c1>// DecorView</span>
<span class=kt>void</span> <span class=nf>onResourcesLoaded</span><span class=p>(</span><span class=n>LayoutInflater</span> <span class=n>inflater</span><span class=p>,</span> <span class=kt>int</span> <span class=n>layoutResource</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=n>mDecorCaptionView</span> <span class=o>=</span> <span class=n>createDecorCaptionView</span><span class=p>(</span><span class=n>inflater</span><span class=p>);</span>
    <span class=kd>final</span> <span class=n>View</span> <span class=n>root</span> <span class=o>=</span> <span class=n>inflater</span><span class=p>.</span><span class=na>inflate</span><span class=p>(</span><span class=n>layoutResource</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mDecorCaptionView</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mDecorCaptionView</span><span class=p>.</span><span class=na>getParent</span><span class=p>()</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>addView</span><span class=p>(</span><span class=n>mDecorCaptionView</span><span class=p>,</span>
                    <span class=k>new</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>(</span><span class=n>MATCH_PARENT</span><span class=p>,</span> <span class=n>MATCH_PARENT</span><span class=p>));</span>
        <span class=p>}</span>
        <span class=n>mDecorCaptionView</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>root</span><span class=p>,</span>
                <span class=k>new</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>MarginLayoutParams</span><span class=p>(</span><span class=n>MATCH_PARENT</span><span class=p>,</span> <span class=n>MATCH_PARENT</span><span class=p>));</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>

        <span class=c1>// Put it below the color views.</span>
        <span class=n>addView</span><span class=p>(</span><span class=n>root</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>new</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>(</span><span class=n>MATCH_PARENT</span><span class=p>,</span> <span class=n>MATCH_PARENT</span><span class=p>));</span>
    <span class=p>}</span>
    <span class=n>mContentRoot</span> <span class=o>=</span> <span class=p>(</span><span class=n>ViewGroup</span><span class=p>)</span> <span class=n>root</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>}</span>
</pre></div> 我们可以看到在<code>DecorView#onResourcesLoaded</code>方法中，通过<code>inflater.inflate(layoutResource, null)</code>填充了布局，在后面通过<code>mDecorCaptionView.addView(root, ...)</code>或者<code>addView(root, ...)</code>的方式将content添加到了DecorView中。</p> </li> <li> <p>将View添加至DecorView的mContentParent中<br> FEATURE_CONTENT_TRANSITIONS标志表示需要使用动画。如果带有这个FEATURE_CONTENT_TRANSITIONS，那么通过Scene处理填充，这样其内部可以播放enterAction、exitAction；否则直接使用<code>mLayoutInflater.inflate(layoutResID, mContentParent);</code>填充布局。<br> 无论通过哪种方式，最后都会调用<code>LayoutInflater.inflate</code>进行填充，这样Activity的布局文件就已经添加到DecorView中的mContentParent中了，所以这就是<code>setContentView</code>的由来了。</p> </li> <li> <p>回调Activity的<code>onContentChanged</code>方法通知Activity视图已经发生改变<br> <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=n>Callback</span> <span class=n>cb</span> <span class=o>=</span> <span class=n>getCallback</span><span class=p>();</span>
<span class=k>if</span> <span class=p>(</span><span class=n>cb</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isDestroyed</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onContentChanged</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <code>onContentChanged</code>方法在Activity内部是一个空实现。</p> </li> </ol> <p>经过<code>setContentView</code>方法后，DecorView已经创建且初始化完毕了，Activity的布局文件也已经添加到了DecorView的mContentParent中，但是这个时候Window还没有被WindowManage添加。<br> 真正的添加操作发生在<code>Activity#makeVisible</code>方法中，此方法在<code>ActivityThread.handleResumeActivity</code>中进行调用。此外，在调用之前，还会调用下列方法让Activity进入resume状态：<code>performResumeActivity</code>-&gt;<code>r.activity.performResume();</code>-&gt;<code>mInstrumentation.callActivityOnResume(this)</code>-&gt;<code>Activity.onResume</code>方法。</p> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>makeVisible</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mWindowAdded</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ViewManager</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>getWindowManager</span><span class=p>();</span>
        <span class=n>wm</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>mDecor</span><span class=p>,</span> <span class=n>getWindow</span><span class=p>().</span><span class=na>getAttributes</span><span class=p>());</span>
        <span class=n>mWindowAdded</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>mDecor</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <h3 id=32-dialogwindow>3.2 Dialog的Window创建过程<a class=headerlink href=#32-dialogwindow title="Permanent link">&para;</a></h3> <p>Dialog中Window的创建过程和Activity类似，不过比Activity的要简单的多，还是可以分为几个步骤来分析： </p> <ol> <li> <p>创建Window<br> 在Dialog的构造器中创建了Window，仍然是一个PhoneWindow对象。该过程和Activity的Window创建过程一致： <div class=codehilite><pre><span></span><span class=n>Dialog</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@StyleRes</span> <span class=kt>int</span> <span class=n>themeResId</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>createContextThemeWrapper</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>

    <span class=n>mWindowManager</span> <span class=o>=</span> <span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span> <span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>WINDOW_SERVICE</span><span class=p>);</span>

    <span class=kd>final</span> <span class=n>Window</span> <span class=n>w</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PhoneWindow</span><span class=p>(</span><span class=n>mContext</span><span class=p>);</span>
    <span class=n>mWindow</span> <span class=o>=</span> <span class=n>w</span><span class=p>;</span>
    <span class=n>w</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
    <span class=n>w</span><span class=p>.</span><span class=na>setOnWindowDismissedCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
    <span class=n>w</span><span class=p>.</span><span class=na>setWindowManager</span><span class=p>(</span><span class=n>mWindowManager</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
    <span class=n>w</span><span class=p>.</span><span class=na>setGravity</span><span class=p>(</span><span class=n>Gravity</span><span class=p>.</span><span class=na>CENTER</span><span class=p>);</span>

    <span class=n>mListenersHandler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ListenersHandler</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></p> </li> <li> <p>初始化DecorView并将Dialog的视图添加到DecorView<br> 此过程也和Window类似，通过调用<code>Window.setContentView</code>来实现 <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setContentView</span><span class=p>(</span><span class=nd>@LayoutRes</span> <span class=kt>int</span> <span class=n>layoutResID</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>mWindow</span><span class=p>.</span><span class=na>setContentView</span><span class=p>(</span><span class=n>layoutResID</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></p> </li> <li> <p>将DecorView添加到Window中显示<br> 在Dialog的show方法中会完成这步操作。和Activity一样，都是在自身要出现在前台时才会将添加Window。 <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>show</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mShowing</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mDecor</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>mWindow</span><span class=p>.</span><span class=na>hasFeature</span><span class=p>(</span><span class=n>Window</span><span class=p>.</span><span class=na>FEATURE_ACTION_BAR</span><span class=p>))</span> <span class=p>{</span>
                <span class=n>mWindow</span><span class=p>.</span><span class=na>invalidatePanelMenu</span><span class=p>(</span><span class=n>Window</span><span class=p>.</span><span class=na>FEATURE_ACTION_BAR</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>mDecor</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>mCanceled</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mCreated</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>dispatchOnCreate</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Fill the DecorView in on any configuration changes that</span>
        <span class=c1>// may have occured while it was removed from the WindowManager.</span>
        <span class=kd>final</span> <span class=n>Configuration</span> <span class=n>config</span> <span class=o>=</span> <span class=n>mContext</span><span class=p>.</span><span class=na>getResources</span><span class=p>().</span><span class=na>getConfiguration</span><span class=p>();</span>
        <span class=n>mWindow</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>().</span><span class=na>dispatchConfigurationChanged</span><span class=p>(</span><span class=n>config</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>onStart</span><span class=p>();</span>
    <span class=n>mDecor</span> <span class=o>=</span> <span class=n>mWindow</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>mActionBar</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mWindow</span><span class=p>.</span><span class=na>hasFeature</span><span class=p>(</span><span class=n>Window</span><span class=p>.</span><span class=na>FEATURE_ACTION_BAR</span><span class=p>))</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=n>ApplicationInfo</span> <span class=n>info</span> <span class=o>=</span> <span class=n>mContext</span><span class=p>.</span><span class=na>getApplicationInfo</span><span class=p>();</span>
        <span class=n>mWindow</span><span class=p>.</span><span class=na>setDefaultIcon</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>icon</span><span class=p>);</span>
        <span class=n>mWindow</span><span class=p>.</span><span class=na>setDefaultLogo</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>logo</span><span class=p>);</span>
        <span class=n>mActionBar</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WindowDecorActionBar</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=p>...</span>

    <span class=n>mWindowManager</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>mDecor</span><span class=p>,</span> <span class=n>l</span><span class=p>);</span>
    <span class=n>mShowing</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>

    <span class=n>sendShowMessage</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> 当Dialog被dismiss时，会调用<code>mWindowManager.removeViewImmediate(mDecor)</code>移除DecorView。</p> </li> </ol> <p>普通Dialog必须采用Activity的Context来构造，否则会报<code>BadTokenException</code>，因为token一般只有Activity拥有。但是系统Dialog可以不需要token，使用系统级别Dialog时注意需要声明权限。</p> <h3 id=33-toastwindow>3.3 Toast的Window创建过程<a class=headerlink href=#33-toastwindow title="Permanent link">&para;</a></h3> <p>Toast的工作流程稍显复杂，因为其内部有两个IPC过程：</p> <ol> <li>Toast访问NotificationManagerService（NMS）</li> <li>NMS回调TN接口。</li> </ol> <p>Toast属于系统Window，它内部的View可以由两种方式指定，系统默认样式或者通过<code>setView</code>指定的自定义View，但不管怎么样，它们都对应Toast的<code>mNextView</code>。<br> Toast提供了<code>show</code>和<code>cancel</code>分别用于显示和隐藏Toast，其内部都是一个IPC过程，实现如下：</p> <div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm> * Show the view for the specified duration.</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>show</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mNextView</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=s>&quot;setView must have been called&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>INotificationManager</span> <span class=n>service</span> <span class=o>=</span> <span class=n>getService</span><span class=p>();</span>
    <span class=n>String</span> <span class=n>pkg</span> <span class=o>=</span> <span class=n>mContext</span><span class=p>.</span><span class=na>getOpPackageName</span><span class=p>();</span>
    <span class=n>TN</span> <span class=n>tn</span> <span class=o>=</span> <span class=n>mTN</span><span class=p>;</span>
    <span class=n>tn</span><span class=p>.</span><span class=na>mNextView</span> <span class=o>=</span> <span class=n>mNextView</span><span class=p>;</span>

    <span class=k>try</span> <span class=p>{</span>
        <span class=n>service</span><span class=p>.</span><span class=na>enqueueToast</span><span class=p>(</span><span class=n>pkg</span><span class=p>,</span> <span class=n>tn</span><span class=p>,</span> <span class=n>mDuration</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Empty</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=cm>/**</span>
<span class=cm> * Close the view if it&#39;s showing, or don&#39;t show it if it isn&#39;t showing yet.</span>
<span class=cm> * You do not normally have to call this.  Normally view will disappear on its own</span>
<span class=cm> * after the appropriate duration.</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>cancel</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>mTN</span><span class=p>.</span><span class=na>hide</span><span class=p>();</span>

    <span class=k>try</span> <span class=p>{</span>
        <span class=n>getService</span><span class=p>().</span><span class=na>cancelToast</span><span class=p>(</span><span class=n>mContext</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>(),</span> <span class=n>mTN</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Empty</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>从上面的代码来看，显示和隐藏Toast都需要通过NMS来实现，由于NMS运行在系统的进程中，所以只能通过远程调用的方式来显示、隐藏Toast。<br> 上面的TN继承至<code>ITransientNotification.Stub</code>，是一个Binder，在Toast与NMS进行IPC，NMS处理Toast的显示或隐藏时会回调TN中的方法，此过程发生在客户端的Binder线程池中，所以需要通过Handler将其切换到当前线程。<br> 这里的service的服务端是NMS的<code>mService</code>成员变量，它是实现了<code>INotificationManager.Stub()</code>的内部匿名类。</p> <p>我们先看一下NMS的<code>enqueueToast</code>操作： <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>enqueueToast</span><span class=p>(</span><span class=n>String</span> <span class=n>pkg</span><span class=p>,</span> <span class=n>ITransientNotification</span> <span class=n>callback</span><span class=p>,</span> <span class=kt>int</span> <span class=n>duration</span><span class=p>)</span>
<span class=p>{</span>
    <span class=p>...</span>

    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isSystemToast</span> <span class=o>=</span> <span class=n>isCallerSystem</span><span class=p>()</span> <span class=o>||</span> <span class=p>(</span><span class=s>&quot;android&quot;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>pkg</span><span class=p>));</span>
    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isPackageSuspended</span> <span class=o>=</span>
            <span class=n>isPackageSuspendedForUser</span><span class=p>(</span><span class=n>pkg</span><span class=p>,</span> <span class=n>Binder</span><span class=p>.</span><span class=na>getCallingUid</span><span class=p>());</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>ENABLE_BLOCKED_TOASTS</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=n>noteNotificationOp</span><span class=p>(</span><span class=n>pkg</span><span class=p>,</span> <span class=n>Binder</span><span class=p>.</span><span class=na>getCallingUid</span><span class=p>())</span>
            <span class=o>||</span> <span class=n>isPackageSuspended</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isSystemToast</span><span class=p>)</span> <span class=p>{</span>
            <span class=p>...</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mToastQueue</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>callingPid</span> <span class=o>=</span> <span class=n>Binder</span><span class=p>.</span><span class=na>getCallingPid</span><span class=p>();</span>
        <span class=kt>long</span> <span class=n>callingId</span> <span class=o>=</span> <span class=n>Binder</span><span class=p>.</span><span class=na>clearCallingIdentity</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>ToastRecord</span> <span class=n>record</span><span class=p>;</span>
            <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>indexOfToastLocked</span><span class=p>(</span><span class=n>pkg</span><span class=p>,</span> <span class=n>callback</span><span class=p>);</span>
            <span class=c1>// If it&#39;s already in the queue, we update it in place, we don&#39;t</span>
            <span class=c1>// move it to the end of the queue.</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>record</span> <span class=o>=</span> <span class=n>mToastQueue</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>);</span>
                <span class=n>record</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>duration</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// Limit the number of toasts that any given package except the android</span>
                <span class=c1>// package can enqueue.  Prevents DOS attacks and deals with leaks.</span>
                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isSystemToast</span><span class=p>)</span> <span class=p>{</span>
                    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
                    <span class=kd>final</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=n>mToastQueue</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
                    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                         <span class=kd>final</span> <span class=n>ToastRecord</span> <span class=n>r</span> <span class=o>=</span> <span class=n>mToastQueue</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
                         <span class=k>if</span> <span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>pkg</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>pkg</span><span class=p>))</span> <span class=p>{</span>
                             <span class=n>count</span><span class=o>++</span><span class=p>;</span>
                             <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&gt;=</span> <span class=n>MAX_PACKAGE_NOTIFICATIONS</span><span class=p>)</span> <span class=p>{</span>
                                 <span class=n>Slog</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Package has already posted &quot;</span> <span class=o>+</span> <span class=n>count</span>
                                        <span class=o>+</span> <span class=s>&quot; toasts. Not showing more. Package=&quot;</span> <span class=o>+</span> <span class=n>pkg</span><span class=p>);</span>
                                 <span class=k>return</span><span class=p>;</span>
                             <span class=p>}</span>
                         <span class=p>}</span>
                    <span class=p>}</span>
                <span class=p>}</span>

                <span class=n>Binder</span> <span class=n>token</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Binder</span><span class=p>();</span>
                <span class=n>mWindowManagerInternal</span><span class=p>.</span><span class=na>addWindowToken</span><span class=p>(</span><span class=n>token</span><span class=p>,</span>
                        <span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>TYPE_TOAST</span><span class=p>);</span>
                <span class=n>record</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ToastRecord</span><span class=p>(</span><span class=n>callingPid</span><span class=p>,</span> <span class=n>pkg</span><span class=p>,</span> <span class=n>callback</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>token</span><span class=p>);</span>
                <span class=n>mToastQueue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>record</span><span class=p>);</span>
                <span class=n>index</span> <span class=o>=</span> <span class=n>mToastQueue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
                <span class=n>keepProcessAliveIfNeededLocked</span><span class=p>(</span><span class=n>callingPid</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=c1>// If it&#39;s at index 0, it&#39;s the current toast.  It doesn&#39;t matter if it&#39;s</span>
            <span class=c1>// new or just been updated.  Call back and tell it to show itself.</span>
            <span class=c1>// If the callback fails, this will remove it from the list, so don&#39;t</span>
            <span class=c1>// assume that it&#39;s valid after this.</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>showNextToastLocked</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>Binder</span><span class=p>.</span><span class=na>restoreCallingIdentity</span><span class=p>(</span><span class=n>callingId</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></p> <p>这段代码也很清楚，首先如果不是系统进程发出的Toast且应用处于挂起状态，那么return。然后会根据包名以及TN判断是否已经处于队列中，如果是那么更新duration，否则将Toast封装成一个<code>ToastRecord</code>然后插入<code>mToastQueue</code>队列中。当然如果是非系统应用，那么此应用最多有<code>MAX_PACKAGE_NOTIFICATIONS</code>也就是50个Toast存在。上述操作完成后，如果当前的Toast处于Toast队列第0个位置，那么会调用<code>showNextToastLocked</code>显示当前的Toast。</p> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>showNextToastLocked</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>ToastRecord</span> <span class=n>record</span> <span class=o>=</span> <span class=n>mToastQueue</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>record</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>DBG</span><span class=p>)</span> <span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Show pkg=&quot;</span> <span class=o>+</span> <span class=n>record</span><span class=p>.</span><span class=na>pkg</span> <span class=o>+</span> <span class=s>&quot; callback=&quot;</span> <span class=o>+</span> <span class=n>record</span><span class=p>.</span><span class=na>callback</span><span class=p>);</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>record</span><span class=p>.</span><span class=na>callback</span><span class=p>.</span><span class=na>show</span><span class=p>(</span><span class=n>record</span><span class=p>.</span><span class=na>token</span><span class=p>);</span>
            <span class=n>scheduleTimeoutLocked</span><span class=p>(</span><span class=n>record</span><span class=p>);</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemoteException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Object died trying to show notification &quot;</span> <span class=o>+</span> <span class=n>record</span><span class=p>.</span><span class=na>callback</span>
                    <span class=o>+</span> <span class=s>&quot; in package &quot;</span> <span class=o>+</span> <span class=n>record</span><span class=p>.</span><span class=na>pkg</span><span class=p>);</span>
            <span class=c1>// remove it from the list and let the process die</span>
            <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>mToastQueue</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=n>record</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>mToastQueue</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>index</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>keepProcessAliveIfNeededLocked</span><span class=p>(</span><span class=n>record</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>mToastQueue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>record</span> <span class=o>=</span> <span class=n>mToastQueue</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>record</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>此段代码也好理解，首先取Toast队列第0个，会回调TN中的<code>show</code>方法，让Toast显示出来。然后调用<code>scheduleTimeoutLocked</code>方法，该方法的作用是根据duration的值延时发送MESSAGE_TIMEOUT消息，此消息会触发<code>cancelToastLocked</code>方法，<code>cancelToastLocked</code>又会通过TN回调<code>hide</code>方法，这样在指定时间后就让Toast消失。这就是Toast的工作原理了。<br> 在<code>cancelToastLocked</code>方法的最后，后当Toast队列还有Toast时，继续调用<code>showNextToastLocked</code>，这就是Toast的处理循环。 </p> <p>我们看一下<code>scheduleTimeoutLocked</code>方法：</p> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>scheduleTimeoutLocked</span><span class=p>(</span><span class=n>ToastRecord</span> <span class=n>r</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>mHandler</span><span class=p>.</span><span class=na>removeCallbacksAndMessages</span><span class=p>(</span><span class=n>r</span><span class=p>);</span>
    <span class=n>Message</span> <span class=n>m</span> <span class=o>=</span> <span class=n>Message</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>mHandler</span><span class=p>,</span> <span class=n>MESSAGE_TIMEOUT</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
    <span class=kt>long</span> <span class=n>delay</span> <span class=o>=</span> <span class=n>r</span><span class=p>.</span><span class=na>duration</span> <span class=o>==</span> <span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_LONG</span> <span class=o>?</span> <span class=n>LONG_DELAY</span> <span class=p>:</span> <span class=n>SHORT_DELAY</span><span class=p>;</span>
    <span class=n>mHandler</span><span class=p>.</span><span class=na>sendMessageDelayed</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>delay</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>这里有两个Toast显示的固定值：<code>LONG_DELAY</code>为3500ms，<code>SHORT_DELAY</code>为2000ms。</p> <p>通过上面的代码，我们知道了Toast的显示与隐藏实际上是通过Toast中TN这个类来实现的，<code>show</code>和<code>hide</code>分别与其对应。我们接着看一下TN中这两个方法:</p> <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=n>Runnable</span> <span class=n>mHide</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>handleHide</span><span class=p>();</span>
        <span class=c1>// Don&#39;t do this in handleHide() because it is also invoked by handleShow()</span>
        <span class=n>mNextView</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>};</span>

<span class=kd>final</span> <span class=n>Handler</span> <span class=n>mHandler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>()</span> <span class=p>{</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=p>(</span><span class=n>Message</span> <span class=n>msg</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>IBinder</span> <span class=n>token</span> <span class=o>=</span> <span class=p>(</span><span class=n>IBinder</span><span class=p>)</span> <span class=n>msg</span><span class=p>.</span><span class=na>obj</span><span class=p>;</span>
        <span class=n>handleShow</span><span class=p>(</span><span class=n>token</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>};</span>

<span class=cm>/**</span>
<span class=cm> * schedule handleShow into the right thread</span>
<span class=cm> */</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>show</span><span class=p>(</span><span class=n>IBinder</span> <span class=n>windowToken</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;SHOW: &quot;</span> <span class=o>+</span> <span class=k>this</span><span class=p>);</span>
    <span class=n>mHandler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>windowToken</span><span class=p>).</span><span class=na>sendToTarget</span><span class=p>();</span>
<span class=p>}</span>

<span class=cm>/**</span>
<span class=cm> * schedule handleHide into the right thread</span>
<span class=cm> */</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>hide</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;HIDE: &quot;</span> <span class=o>+</span> <span class=k>this</span><span class=p>);</span>
    <span class=n>mHandler</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=n>mHide</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleShow</span><span class=p>(</span><span class=n>IBinder</span> <span class=n>windowToken</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;HANDLE SHOW: &quot;</span> <span class=o>+</span> <span class=k>this</span> <span class=o>+</span> <span class=s>&quot; mView=&quot;</span> <span class=o>+</span> <span class=n>mView</span>
            <span class=o>+</span> <span class=s>&quot; mNextView=&quot;</span> <span class=o>+</span> <span class=n>mNextView</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mView</span> <span class=o>!=</span> <span class=n>mNextView</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// remove the old view if necessary</span>
        <span class=n>handleHide</span><span class=p>();</span>
        <span class=n>mView</span> <span class=o>=</span> <span class=n>mNextView</span><span class=p>;</span>
        <span class=n>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>mView</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>();</span>
        <span class=n>String</span> <span class=n>packageName</span> <span class=o>=</span> <span class=n>mView</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getOpPackageName</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>context</span> <span class=o>=</span> <span class=n>mView</span><span class=p>.</span><span class=na>getContext</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=n>mWM</span> <span class=o>=</span> <span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>WINDOW_SERVICE</span><span class=p>);</span>
        <span class=c1>// We can resolve the Gravity here by using the Locale for getting</span>
        <span class=c1>// the layout direction</span>
        <span class=kd>final</span> <span class=n>Configuration</span> <span class=n>config</span> <span class=o>=</span> <span class=n>mView</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getResources</span><span class=p>().</span><span class=na>getConfiguration</span><span class=p>();</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>gravity</span> <span class=o>=</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>getAbsoluteGravity</span><span class=p>(</span><span class=n>mGravity</span><span class=p>,</span> <span class=n>config</span><span class=p>.</span><span class=na>getLayoutDirection</span><span class=p>());</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>gravity</span> <span class=o>=</span> <span class=n>gravity</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>gravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>HORIZONTAL_GRAVITY_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>FILL_HORIZONTAL</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>mParams</span><span class=p>.</span><span class=na>horizontalWeight</span> <span class=o>=</span> <span class=mf>1.0f</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>gravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>VERTICAL_GRAVITY_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>FILL_VERTICAL</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>mParams</span><span class=p>.</span><span class=na>verticalWeight</span> <span class=o>=</span> <span class=mf>1.0f</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>x</span> <span class=o>=</span> <span class=n>mX</span><span class=p>;</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>y</span> <span class=o>=</span> <span class=n>mY</span><span class=p>;</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>verticalMargin</span> <span class=o>=</span> <span class=n>mVerticalMargin</span><span class=p>;</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>horizontalMargin</span> <span class=o>=</span> <span class=n>mHorizontalMargin</span><span class=p>;</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>packageName</span> <span class=o>=</span> <span class=n>packageName</span><span class=p>;</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>hideTimeoutMilliseconds</span> <span class=o>=</span> <span class=n>mDuration</span> <span class=o>==</span>
            <span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_LONG</span> <span class=o>?</span> <span class=n>LONG_DURATION_TIMEOUT</span> <span class=p>:</span> <span class=n>SHORT_DURATION_TIMEOUT</span><span class=p>;</span>
        <span class=n>mParams</span><span class=p>.</span><span class=na>token</span> <span class=o>=</span> <span class=n>windowToken</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mView</span><span class=p>.</span><span class=na>getParent</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;REMOVE! &quot;</span> <span class=o>+</span> <span class=n>mView</span> <span class=o>+</span> <span class=s>&quot; in &quot;</span> <span class=o>+</span> <span class=k>this</span><span class=p>);</span>
            <span class=n>mWM</span><span class=p>.</span><span class=na>removeView</span><span class=p>(</span><span class=n>mView</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;ADD! &quot;</span> <span class=o>+</span> <span class=n>mView</span> <span class=o>+</span> <span class=s>&quot; in &quot;</span> <span class=o>+</span> <span class=k>this</span><span class=p>);</span>
        <span class=n>mWM</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>mView</span><span class=p>,</span> <span class=n>mParams</span><span class=p>);</span>
        <span class=n>trySendAccessibilityEvent</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>handleHide</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;HANDLE HIDE: &quot;</span> <span class=o>+</span> <span class=k>this</span> <span class=o>+</span> <span class=s>&quot; mView=&quot;</span> <span class=o>+</span> <span class=n>mView</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mView</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// note: checking parent() just to make sure the view has</span>
        <span class=c1>// been added...  i have seen cases where we get here when</span>
        <span class=c1>// the view isn&#39;t yet added, so let&#39;s try not to crash.</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mView</span><span class=p>.</span><span class=na>getParent</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span> <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;REMOVE! &quot;</span> <span class=o>+</span> <span class=n>mView</span> <span class=o>+</span> <span class=s>&quot; in &quot;</span> <span class=o>+</span> <span class=k>this</span><span class=p>);</span>
            <span class=n>mWM</span><span class=p>.</span><span class=na>removeViewImmediate</span><span class=p>(</span><span class=n>mView</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=n>mView</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p><code>show</code>方法会通过Handler调用<code>handleShow</code>方法。<code>hide</code>方法会通过Handler最后调用<code>handleHide</code>方法。<code>handleShow</code>最后会调用<code>mWM.addView(mView, mParams);</code>将Toast视图添加到Window中；而<code>handleHide</code>最后会调用<code>mWM.removeViewImmediate(mView);</code>将Toast视图从Window中移除。<br> 在上面的分析中我们知道，Toast的显示与隐藏都是NMS通过调用TN的方法来控制的，因此它们运行在Binder线程池中。为了将执行环境切换到Toast请求所在的线程，这里在发出Toast请求的线程中创建了一个Handler。这也是为什么在子线程中Toast不出来的原因了。</p> <p>到这里Toast的Window创建过程已经分析完毕了。出了上面提到的Activity、Dialog和Toast外，PopupWindow、状态栏等都是通过Window来实现的。</p> <hr> <div class=md-source-date> <small> 最后更新: 2020年1月14日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/framework/Window与WindowManager/";
      this.page.identifier =
        "/android/framework/Window与WindowManager/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../Android动画/ title=Android动画 class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> Android动画 </span> </div> </a> <a href=../四大组件启动过程/ title=四大组件启动过程 class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> 四大组件启动过程 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
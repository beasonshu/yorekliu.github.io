<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/framework/binder1-mediaservice/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Binder深入理解——以MediaService为例</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - Binder深入理解——以MediaService为例"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/framework/binder1-mediaservice/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - Binder深入理解——以MediaService为例"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1-processstate tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> Binder深入理解——以MediaService为例 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../3rd-library/3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3rd-library/3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../3rd-library/eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3 checked> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Binder深入理解——以MediaService为例 </label> <a href=./ title=Binder深入理解——以MediaService为例 class="md-nav__link md-nav__link--active"> Binder深入理解——以MediaService为例 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-processstate class=md-nav__link> 1 ProcessState </a> </li> <li class=md-nav__item> <a href=#2-defaultservicemanager class=md-nav__link> 2 defaultServiceManager </a> </li> <li class=md-nav__item> <a href=#3-bpbinder class=md-nav__link> 3 BpBinder </a> </li> <li class=md-nav__item> <a href=#4-interface_cast class=md-nav__link> 4 interface_cast </a> </li> <li class=md-nav__item> <a href=#5-bpservicemanager class=md-nav__link> 5 BpServiceManager </a> </li> <li class=md-nav__item> <a href=#6-mediaplayerservice class=md-nav__link> 6 MediaPlayerService </a> </li> <li class=md-nav__item> <a href=#7-bpserviewmanageraddservice class=md-nav__link> 7 BpServiewManager#addService </a> </li> <li class=md-nav__item> <a href=#8-bnservicemanager class=md-nav__link> 8 BnServiceManager </a> </li> <li class=md-nav__item> <a href=#9-servicemanager class=md-nav__link> 9 ServiceManager存在的意义 </a> </li> <li class=md-nav__item> <a href=#10-mediaservice class=md-nav__link> 10 MediaService的运行 </a> </li> <li class=md-nav__item> <a href=#11 class=md-nav__link> 11 小结 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-processstate class=md-nav__link> 1 ProcessState </a> </li> <li class=md-nav__item> <a href=#2-defaultservicemanager class=md-nav__link> 2 defaultServiceManager </a> </li> <li class=md-nav__item> <a href=#3-bpbinder class=md-nav__link> 3 BpBinder </a> </li> <li class=md-nav__item> <a href=#4-interface_cast class=md-nav__link> 4 interface_cast </a> </li> <li class=md-nav__item> <a href=#5-bpservicemanager class=md-nav__link> 5 BpServiceManager </a> </li> <li class=md-nav__item> <a href=#6-mediaplayerservice class=md-nav__link> 6 MediaPlayerService </a> </li> <li class=md-nav__item> <a href=#7-bpserviewmanageraddservice class=md-nav__link> 7 BpServiewManager#addService </a> </li> <li class=md-nav__item> <a href=#8-bnservicemanager class=md-nav__link> 8 BnServiceManager </a> </li> <li class=md-nav__item> <a href=#9-servicemanager class=md-nav__link> 9 ServiceManager存在的意义 </a> </li> <li class=md-nav__item> <a href=#10-mediaservice class=md-nav__link> 10 MediaService的运行 </a> </li> <li class=md-nav__item> <a href=#11 class=md-nav__link> 11 小结 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Binder深入理解——以MediaService为例</h1> <p>本博客Binder系列：</p> <ol> <li><a href=/android/paid/zsxq/week11-binder/ >Binder简介</a></li> <li><a href=/android/framework/binder1-mediaservice/ >Binder深入理解——以MediaService为例</a>，基于<a href=http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html>Android深入浅出之Binder机制</a></li> <li><a href=/android/framework/binder2/ >Binder深入理解——罗老师系列</a>，基于<a href=https://blog.csdn.net/luoshengyang/article/details/6618363>Android进程间通信（IPC）机制Binder简要介绍和学习计划</a></li> </ol> <hr> <blockquote> <p>本节内容源于<a href=http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html>参考文献1——Android深入浅出之Binder机制</a>，代码版本为<a href=http://androidxref.com/2.3.6/ >2.3.6</a>，摘抄部分代码略有删减。</p> </blockquote> <p>MediaService的<code>main</code>函数如下：<br> <strong>frameworks/base/media/mediaserver/main_mediaserver.cpp</strong></p> <div class=codehilite><pre><span></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>**</span> <span class=n>argv</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// 获得一个ProcessState实例</span>
    <span class=n>sp</span><span class=o>&lt;</span><span class=n>ProcessState</span><span class=o>&gt;</span> <span class=n>proc</span><span class=p>(</span><span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>());</span>
    <span class=c1>// 得到一个ServiceManager对象</span>
    <span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span> <span class=n>sm</span> <span class=o>=</span> <span class=n>defaultServiceManager</span><span class=p>();</span>
    <span class=c1>// 初始化MediaPlayerService服务等</span>
    <span class=n>AudioFlinger</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span>
    <span class=n>MediaPlayerService</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span>
    <span class=n>CameraService</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span>
    <span class=n>AudioPolicyService</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span>
    <span class=c1>// 启动Process的线程池?</span>
    <span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>startThreadPool</span><span class=p>();</span>
    <span class=c1>// 将自己加入到刚才的线程池?</span>
    <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>joinThreadPool</span><span class=p>();</span>
<span class=p>}</span>
</pre></div> <p>正式开始分析之前，我们先看看sp是个什么。<br> sp是一个定义在RefBase.h文件中的模板类，意思是strong pointer，这么做是为了方便C/C++程序员管理指针的分配和释放。与之对应的还有一个wp，也就是weak pointer。该文件位于frameworks/base/include/utils/RefBase.h。<br> 可以简单地将sp<t>理解为T*。</p> <h2 id=1-processstate>1 ProcessState<a class=headerlink href=#1-processstate title="Permanent link">&para;</a></h2> <p>第一个调用的函数是<code>ProcessState::self()</code>，然后赋值给了proc这个变量，由于sp的特性，程序执行完之后系统会自动释放proc指向的资源。</p> <p><code>ProcessState::self()</code>的相关代码如下：<br> <strong>frameworks/base/libs/binder/ProcessState.cpp</strong> </p> <div class=codehilite><pre><span></span><span class=c1>// 创建一个ProcessState对象</span>
<span class=n>sp</span><span class=o>&lt;</span><span class=n>ProcessState</span><span class=o>&gt;</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>gProcess</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=k>return</span> <span class=n>gProcess</span><span class=p>;</span>

    <span class=n>AutoMutex</span> <span class=nf>_l</span><span class=p>(</span><span class=n>gProcessMutex</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>gProcess</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=n>gProcess</span> <span class=o>=</span> <span class=n>new</span> <span class=n>ProcessState</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>gProcess</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>ProcessState</span><span class=o>::</span><span class=n>ProcessState</span><span class=p>()</span>
<span class=o>:</span> <span class=n>mDriverFD</span><span class=p>(</span><span class=n>open_driver</span><span class=p>())</span> <span class=c1>// 创建ProcessState时调用了关键函数open_driver</span>
<span class=p>,</span> <span class=n>mVMStart</span><span class=p>(</span><span class=n>MAP_FAILED</span><span class=p>)</span>     <span class=c1>// 映射内存的起始地址</span>
<span class=p>,</span> <span class=n>mManagesContexts</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span>
<span class=p>,</span> <span class=n>mBinderContextCheckFunc</span><span class=p>(</span><span class=nb>NULL</span><span class=p>)</span>
<span class=p>,</span> <span class=n>mBinderContextUserData</span><span class=p>(</span><span class=nb>NULL</span><span class=p>)</span>
<span class=p>,</span> <span class=n>mThreadPoolStarted</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span>
<span class=p>,</span> <span class=n>mThreadPoolSeq</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mDriverFD</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// mmap the binder, providing a chunk of virtual address space to receive transactions.</span>
        <span class=c1>// #define BINDER_VM_SIZE ((1*1024*1024) - (4096 *2)) 也就是1M-4*2K</span>
        <span class=c1>// mmap系统调用使得进程之间通过映射同一个普通文件实现共享内存。</span>
        <span class=c1>// 普通文件被映射到进程地址空间后，进程可以像访问普通内存一样对文件进行访问，不必再调用rw等操作</span>
        <span class=n>mVMStart</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>BINDER_VM_SIZE</span><span class=p>,</span> <span class=n>PROT_READ</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span> <span class=o>|</span> <span class=n>MAP_NORESERVE</span><span class=p>,</span> <span class=n>mDriverFD</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mVMStart</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// *sigh*</span>
            <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Using /dev/binder failed: unable to mmap transaction memory.</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span>
            <span class=n>close</span><span class=p>(</span><span class=n>mDriverFD</span><span class=p>);</span>
            <span class=n>mDriverFD</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// open_driver就是打开/dev/binder设备</span>
<span class=c1>// 该设备就是在内核中一个专门用于完成进程间通讯而设置的一个虚拟的设备</span>
<span class=c1>// BTW，说白了就是内核的提供的一个机制，这个和我们用socket加NET_LINK方式和内核通讯是一个道理。</span>
<span class=k>static</span> <span class=kt>int</span> <span class=n>open_driver</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>gSingleProcess</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&quot;/dev/binder&quot;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>F_SETFD</span><span class=p>,</span> <span class=n>FD_CLOEXEC</span><span class=p>);</span>
        <span class=c1>// 检查binder的状态</span>
        <span class=kt>int</span> <span class=n>vers</span><span class=p>;</span>
        <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>BINDER_VERSION</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>vers</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Binder ioctl to obtain version failed: %s&quot;</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
            <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
            <span class=n>fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>vers</span> <span class=o>!=</span> <span class=n>BINDER_CURRENT_PROTOCOL_VERSION</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Binder driver protocol does not match user space protocol!&quot;</span><span class=p>);</span>
            <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
            <span class=n>fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 通过ioctl方式告诉内核，这个fd支持最大线程数是15个。</span>
        <span class=kt>size_t</span> <span class=n>maxThreads</span> <span class=o>=</span> <span class=mi>15</span><span class=p>;</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>BINDER_SET_MAX_THREADS</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>maxThreads</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Binder ioctl to set max threads failed: %s&quot;</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>LOGW</span><span class=p>(</span><span class=s>&quot;Opening &#39;/dev/binder&#39; failed: %s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>通过以上分析，我们可以看出<code>ProcessState::self()</code>实际上就是open binder，然后将得到的fd mmap到内存。</p> <h2 id=2-defaultservicemanager>2 defaultServiceManager<a class=headerlink href=#2-defaultservicemanager title="Permanent link">&para;</a></h2> <p>该方法的实现在IServiceManager.cpp中：<br> <strong>frameworks/base/include/binder/IServiceManager.cpp</strong></p> <div class=codehilite><pre><span></span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span> <span class=n>defaultServiceManager</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>gDefaultServiceManager</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=k>return</span> <span class=n>gDefaultServiceManager</span><span class=p>;</span>

    <span class=p>{</span>
        <span class=n>AutoMutex</span> <span class=n>_l</span><span class=p>(</span><span class=n>gDefaultServiceManagerLock</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>gDefaultServiceManager</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>gDefaultServiceManager</span> <span class=o>=</span> <span class=n>interface_cast</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=p>(</span>
                <span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getContextObject</span><span class=p>(</span><span class=nb>NULL</span><span class=p>));</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>gDefaultServiceManager</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>这也是一个单例模式的实现，我们注意到创建<code>IServiceManager</code>时的语句：<br> <code>interface_cast&lt;IServiceManager&gt;(ProcessState::self()-&gt;getContextObject(NULL))</code>。<br> <code>ProcessState::self()</code>就是上一步中创建的gProcess，然后调用了其<code>getContextObject(NULL)</code>方法。</p> <p>我们跟踪一下调用过程：</p> <div class=codehilite><pre><span></span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>getContextObject</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>caller</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>supportsProcesses</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// mDriverFD肯定是&gt;=0的，所以满足条件</span>
        <span class=k>return</span> <span class=n>getStrongProxyForHandle</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>getContextObject</span><span class=p>(</span><span class=n>String16</span><span class=p>(</span><span class=s>&quot;default&quot;</span><span class=p>),</span> <span class=n>caller</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kt>bool</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>supportsProcesses</span><span class=p>()</span> <span class=k>const</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=n>mDriverFD</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// handle在MFC中接触过，中文名为句柄，是对资源的一种标示。此处传入的值为0</span>
<span class=c1>// handle可以理解为某个数据结构在其数组中的索引。</span>
<span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>getStrongProxyForHandle</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>handle</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span> <span class=n>result</span><span class=p>;</span>

    <span class=n>AutoMutex</span> <span class=nf>_l</span><span class=p>(</span><span class=n>mLock</span><span class=p>);</span>

    <span class=c1>// lookupHandleLocked会在一个Vector中查找或插入handle</span>
    <span class=c1>// 当插入时，其binder和refs都置为NULL，见下面贴出来的函数代码</span>
    <span class=c1>// struct handle_entry {</span>
    <span class=c1>//     IBinder* binder;</span>
    <span class=c1>//     RefBase::weakref_type* refs;</span>
    <span class=c1>// };</span>
    <span class=n>handle_entry</span><span class=o>*</span> <span class=n>e</span> <span class=o>=</span> <span class=n>lookupHandleLocked</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>e</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// We need to create a new BpBinder if there isn&#39;t currently one, OR we</span>
        <span class=c1>// are unable to acquire a weak reference on this current one.  See comment</span>
        <span class=c1>// in getWeakProxyForHandle() for more info about this.</span>
        <span class=n>IBinder</span><span class=o>*</span> <span class=n>b</span> <span class=o>=</span> <span class=n>e</span><span class=o>-&gt;</span><span class=n>binder</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>b</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=o>!</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>refs</span><span class=o>-&gt;</span><span class=n>attemptIncWeak</span><span class=p>(</span><span class=n>this</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 由于handle值为0，所以N &lt;= (size_t)handle肯定成立，因此b肯定为null</span>
            <span class=c1>// 这里创建了一个BpBinder对象</span>
            <span class=n>b</span> <span class=o>=</span> <span class=n>new</span> <span class=n>BpBinder</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span>
            <span class=n>e</span><span class=o>-&gt;</span><span class=n>binder</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>b</span><span class=p>)</span> <span class=n>e</span><span class=o>-&gt;</span><span class=n>refs</span> <span class=o>=</span> <span class=n>b</span><span class=o>-&gt;</span><span class=n>getWeakRefs</span><span class=p>();</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// This little bit of nastyness is to allow us to add a primary</span>
            <span class=c1>// reference to the remote proxy when this team doesn&#39;t have one</span>
            <span class=c1>// but another team is sending the handle to us.</span>
            <span class=n>result</span><span class=p>.</span><span class=n>force_set</span><span class=p>(</span><span class=n>b</span><span class=p>);</span>
            <span class=n>e</span><span class=o>-&gt;</span><span class=n>refs</span><span class=o>-&gt;</span><span class=n>decWeak</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 返回上面创建的BpBinder</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>ProcessState</span><span class=o>::</span><span class=n>handle_entry</span><span class=o>*</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>lookupHandleLocked</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>handle</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>const</span> <span class=kt>size_t</span> <span class=n>N</span><span class=o>=</span><span class=n>mHandleToObject</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>N</span> <span class=o>&lt;=</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=n>handle</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 在上面的分析中，由于handle值为0，所以N &lt;= (size_t)handle肯定成立</span>
        <span class=n>handle_entry</span> <span class=n>e</span><span class=p>;</span>
        <span class=n>e</span><span class=p>.</span><span class=n>binder</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=n>e</span><span class=p>.</span><span class=n>refs</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>mHandleToObject</span><span class=p>.</span><span class=n>insertAt</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>N</span><span class=p>,</span> <span class=n>handle</span><span class=o>+</span><span class=mi>1</span><span class=o>-</span><span class=n>N</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>&lt;</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=n>mHandleToObject</span><span class=p>.</span><span class=n>editItemAt</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>在上面的调用过程之后，我们发现<code>ProcessState::self()-&gt;getContextObject(NULL)</code>实际上就等价于<code>new BpBinder(0)</code>;<br> 于是，开始的代码就变成了<code>gDefaultServiceManager = interface_cast&lt;IServiceManager&gt;(new BpBinder(0))</code>。</p> <p>那么BpBinder又是个什么呢？</p> <h2 id=3-bpbinder>3 BpBinder<a class=headerlink href=#3-bpbinder title="Permanent link">&para;</a></h2> <p><strong>frameworks/base/libs/binder/BpBinder.cpp</strong></p> <div class=codehilite><pre><span></span><span class=n>BpBinder</span><span class=o>::</span><span class=n>BpBinder</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>handle</span><span class=p>)</span>    <span class=c1>// 接上面分析，这里的handle值为0</span>
<span class=o>:</span> <span class=n>mHandle</span><span class=p>(</span><span class=n>handle</span><span class=p>)</span>
<span class=p>,</span> <span class=n>mAlive</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=p>,</span> <span class=n>mObitsSent</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=p>,</span> <span class=n>mObituaries</span><span class=p>(</span><span class=nb>NULL</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;Creating BpBinder %p handle %d</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span> <span class=n>this</span><span class=p>,</span> <span class=n>mHandle</span><span class=p>);</span>

    <span class=n>extendObjectLifetime</span><span class=p>(</span><span class=n>OBJECT_LIFETIME_WEAK</span><span class=p>);</span>
    <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>incWeakHandle</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>我们来到了IPCThreadState类。<br> <strong>frameworks/base/include/binder/IPCThreadState.cpp</strong></p> <div class=codehilite><pre><span></span><span class=k>static</span> <span class=kt>bool</span> <span class=n>gHaveTLS</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
<span class=n>IPCThreadState</span><span class=o>*</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span>
<span class=p>{</span>
    <span class=c1>// 初始值为false，所有先走if后面的代码，然后goto进来</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>gHaveTLS</span><span class=p>)</span> <span class=p>{</span>
    <span class=nl>restart</span><span class=p>:</span>
        <span class=k>const</span> <span class=n>pthread_key_t</span> <span class=n>k</span> <span class=o>=</span> <span class=n>gTLS</span><span class=p>;</span>
        <span class=c1>// TLS是Thread Local Storage，Java中也有这个概念，对应ThreadLocal</span>
        <span class=c1>// 从线程本地存储空间中获得保存在其中的IPCThreadState对象</span>
        <span class=c1>// 这里是pthread_getspecific，那么肯定有对应的pthread_setspecific</span>
        <span class=n>IPCThreadState</span><span class=o>*</span> <span class=n>st</span> <span class=o>=</span> <span class=p>(</span><span class=n>IPCThreadState</span><span class=o>*</span><span class=p>)</span><span class=n>pthread_getspecific</span><span class=p>(</span><span class=n>k</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>st</span><span class=p>)</span> <span class=k>return</span> <span class=n>st</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>new</span> <span class=n>IPCThreadState</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>gShutdown</span><span class=p>)</span> <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>

    <span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLSMutex</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>gHaveTLS</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>pthread_key_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLS</span><span class=p>,</span> <span class=n>threadDestructor</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLSMutex</span><span class=p>);</span>
            <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>gHaveTLS</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLSMutex</span><span class=p>);</span>
    <span class=k>goto</span> <span class=n>restart</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p><a href=/android/framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/#21-threadlocal>→Java层ThreadLocal的工作原理</a></p> <p>我们找一下<code>pthread_setspecific</code>的地方，在构造函数中</p> <div class=codehilite><pre><span></span><span class=n>IPCThreadState</span><span class=o>::</span><span class=n>IPCThreadState</span><span class=p>()</span>
<span class=o>:</span> <span class=n>mProcess</span><span class=p>(</span><span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()),</span> <span class=n>mMyThreadId</span><span class=p>(</span><span class=n>androidGetTid</span><span class=p>())</span>
<span class=p>{</span>
    <span class=n>pthread_setspecific</span><span class=p>(</span><span class=n>gTLS</span><span class=p>,</span> <span class=n>this</span><span class=p>);</span>
    <span class=n>clearCaller</span><span class=p>();</span>
    <span class=c1>// in、out理解为命令的buffer</span>
    <span class=n>mIn</span><span class=p>.</span><span class=n>setDataCapacity</span><span class=p>(</span><span class=mi>256</span><span class=p>);</span>
    <span class=n>mOut</span><span class=p>.</span><span class=n>setDataCapacity</span><span class=p>(</span><span class=mi>256</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>由上可知，在new BpBinder的过程中创建了一个<code>IPCThreadState</code>。</p> <p>我们回到defaultServiceManager的创建过程，接下来是<code>interface_cast</code>。</p> <h2 id=4-interface_cast>4 interface_cast<a class=headerlink href=#4-interface_cast title="Permanent link">&para;</a></h2> <p><code>interface_cast</code>定义在IInterface.h文件中 </p> <p><strong>frameworks/base/include/binder/IInterface.h</strong></p> <div class=codehilite><pre><span></span><span class=n>template</span><span class=o>&lt;</span><span class=kr>typename</span> <span class=n>INTERFACE</span><span class=o>&gt;</span>
<span class=kr>inline</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>INTERFACE</span><span class=o>&gt;</span> <span class=n>interface_cast</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>obj</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=n>INTERFACE</span><span class=o>::</span><span class=n>asInterface</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>看来还是要看<code>IServiceManager::asInterface</code>的定义以及实现 </p> <p><strong>frameworks/base/include/binder/IServiceManager.h</strong></p> <div class=codehilite><pre><span></span><span class=n>class</span> <span class=nl>IServiceManager</span> <span class=p>:</span> <span class=n>public</span> <span class=n>IInterface</span>
<span class=p>{</span>
<span class=nl>public</span><span class=p>:</span>
    <span class=n>DECLARE_META_INTERFACE</span><span class=p>(</span><span class=n>ServiceManager</span><span class=p>);</span>
    <span class=p>...</span>
<span class=p>};</span>
</pre></div> <p>上面这个<code>DECLARE_META_INTERFACE</code>是个好东西，与之对应的是宏<code>IMPLEMENT_META_INTERFACE</code>。<br> 这两个宏定义在IInterface.h文件中</p> <p><strong>frameworks/base/include/binder/IInterface.h</strong></p> <div class=codehilite><pre><span></span><span class=cp>#define DECLARE_META_INTERFACE(INTERFACE)                               \</span>
<span class=cp>    static const String16 descriptor;                                   \</span>
<span class=cp>    static sp&lt;I##INTERFACE&gt; asInterface(const sp&lt;IBinder&gt;&amp; obj);        \</span>
<span class=cp>    virtual const String16&amp; getInterfaceDescriptor() const;             \</span>
<span class=cp>    I##INTERFACE();                                                     \</span>
<span class=cp>    virtual ~I##INTERFACE();                                            \</span>


<span class=cp>#define IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                       \</span>
<span class=cp>    const String16 I##INTERFACE::descriptor(NAME);                      \</span>
<span class=cp>    const String16&amp; I##INTERFACE::getInterfaceDescriptor() const {      \</span>
<span class=cp>        return I##INTERFACE::descriptor;                                \</span>
<span class=cp>    }                                                                   \</span>
<span class=cp>    sp&lt;I##INTERFACE&gt; I##INTERFACE::asInterface(const sp&lt;IBinder&gt;&amp; obj)  \</span>
<span class=cp>    {                                                                   \</span>
<span class=cp>        sp&lt;I##INTERFACE&gt; intr;                                          \</span>
<span class=cp>        if (obj != NULL) {                                              \</span>
<span class=cp>            intr = static_cast&lt;I##INTERFACE*&gt;(                          \</span>
<span class=cp>                obj-&gt;queryLocalInterface(                               \</span>
<span class=cp>                    I##INTERFACE::descriptor).get());               \</span>
<span class=cp>            if (intr == NULL) {                                         \</span>
<span class=cp>                intr = new Bp##INTERFACE(obj);                          \</span>
<span class=cp>            }                                                           \</span>
<span class=cp>        }                                                               \</span>
<span class=cp>        return intr;                                                    \</span>
<span class=cp>    }                                                                   \</span>
<span class=cp>    I##INTERFACE::I##INTERFACE() { }                                    \</span>
<span class=cp>    I##INTERFACE::~I##INTERFACE() { }                                   \</span>
</pre></div> <p>在上面的代码中，把INTERFACE换成ServiceManager理解就行了。这就是这两个宏为IServiceManager类声明、实现了一些变量和函数。</p> <p>也就是说<code>IServiceManager::asInterface</code>等于下面这段代码：</p> <div class=codehilite><pre><span></span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span> <span class=n>IServiceManager</span><span class=o>::</span><span class=n>asInterface</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>obj</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span> <span class=n>intr</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>obj</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>intr</span> <span class=o>=</span> <span class=n>static_cast</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>*&gt;</span><span class=p>(</span>
            <span class=n>obj</span><span class=o>-&gt;</span><span class=n>queryLocalInterface</span><span class=p>(</span>
                <span class=n>IServiceManager</span><span class=o>::</span><span class=n>descriptor</span><span class=p>).</span><span class=n>get</span><span class=p>());</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>intr</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>intr</span> <span class=o>=</span> <span class=n>new</span> <span class=n>BpServiceManager</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>intr</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>所以<code>interface_cast&lt;IServiceManager&gt;(new BpBinder(0))</code>等于<code>new BpServiceManager(new BpBinder(0))</code>。 </p> <p>这里又是一个Bp...</p> <h2 id=5-bpservicemanager>5 BpServiceManager<a class=headerlink href=#5-bpservicemanager title="Permanent link">&para;</a></h2> <p>啥是佩奇(Bp)？？这里的p就是proxy的意思，Bp就是BinderProxy，BpServiceManager，就是ServiceManager的Binder代理。<br> BpServiceManager就在IServiceManager.cpp中 </p> <div class=codehilite><pre><span></span><span class=n>class</span> <span class=nl>BpServiceManager</span> <span class=p>:</span> <span class=n>public</span> <span class=n>BpInterface</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span>
<span class=p>{</span>
<span class=nl>public</span><span class=p>:</span>
    <span class=c1>// 这个传入的impl就是BpBinder(0)</span>
    <span class=n>BpServiceManager</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>impl</span><span class=p>)</span>
    <span class=o>:</span> <span class=n>BpInterface</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=p>(</span><span class=n>impl</span><span class=p>)</span>
    <span class=p>{</span>
    <span class=p>}</span>

    <span class=c1>// 见后续</span>
    <span class=n>virtual</span> <span class=n>status_t</span> <span class=n>addService</span><span class=p>(</span><span class=k>const</span> <span class=n>String16</span><span class=o>&amp;</span> <span class=n>name</span><span class=p>,</span> <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>service</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=p>...</span>
    <span class=p>}</span>
<span class=p>};</span>

<span class=n>IMPLEMENT_META_INTERFACE</span><span class=p>(</span><span class=n>ServiceManager</span><span class=p>,</span> <span class=s>&quot;android.os.IServiceManager&quot;</span><span class=p>);</span>
</pre></div> <p>接着看一下BpInterface<iservicemanager>(impl)干了什么。 </p> <div class=codehilite><pre><span></span><span class=n>template</span><span class=o>&lt;</span><span class=kr>typename</span> <span class=n>INTERFACE</span><span class=o>&gt;</span>
<span class=kr>inline</span> <span class=n>BpInterface</span><span class=o>&lt;</span><span class=n>INTERFACE</span><span class=o>&gt;::</span><span class=n>BpInterface</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>remote</span><span class=p>)</span>
<span class=o>:</span> <span class=n>BpRefBase</span><span class=p>(</span><span class=n>remote</span><span class=p>)</span>
<span class=p>{</span>
<span class=p>}</span>

<span class=n>BpRefBase</span><span class=o>::</span><span class=n>BpRefBase</span><span class=p>(</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>o</span><span class=p>)</span>
<span class=o>:</span> <span class=n>mRemote</span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=n>get</span><span class=p>()),</span> <span class=n>mRefs</span><span class=p>(</span><span class=nb>NULL</span><span class=p>),</span> <span class=n>mState</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>extendObjectLifetime</span><span class=p>(</span><span class=n>OBJECT_LIFETIME_WEAK</span><span class=p>);</span>
    <span class=c1>// 这里的mRemote就是BpBinder(0)</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mRemote</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mRemote</span><span class=o>-&gt;</span><span class=n>incStrong</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>           <span class=c1>// Removed on first IncStrong().</span>
        <span class=n>mRefs</span> <span class=o>=</span> <span class=n>mRemote</span><span class=o>-&gt;</span><span class=n>createWeak</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>  <span class=c1>// Held for our entire lifetime.</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>因此，我们知道了创建<code>BpServiceManager</code>时的<code>BpBinder(0)</code>就存在其<code>mRemote</code>字段中。</p> <p>重新回到<code>main</code>函数，现在我们打开了binder设备，并且创建了一个<code>BpServiceManager</code>对象。我们接下来看看<code>MediaPlayerService::instantiate();</code>操作。 </p> <h2 id=6-mediaplayerservice>6 MediaPlayerService<a class=headerlink href=#6-mediaplayerservice title="Permanent link">&para;</a></h2> <p><strong>frameworks/base/media/libmediaplayerservice/MediaPlayerService.cpp</strong> </p> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=n>MediaPlayerService</span><span class=o>::</span><span class=n>instantiate</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// 调用BpServiceManager的addService方法，</span>
    <span class=c1>// 传入服务的名字以及服务</span>
    <span class=n>defaultServiceManager</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>addService</span><span class=p>(</span>
                                        <span class=n>String16</span><span class=p>(</span><span class=s>&quot;media.player&quot;</span><span class=p>),</span> <span class=n>new</span> <span class=n>MediaPlayerService</span><span class=p>());</span>
<span class=p>}</span>

<span class=n>MediaPlayerService</span><span class=o>::</span><span class=n>MediaPlayerService</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;MediaPlayerService created&quot;</span><span class=p>);</span>
    <span class=n>mNextConnId</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>从头文件可以看出，<code>MediaPlayerService</code>是从<code>BnMediaPlayerService</code>派生出来的。 </p> <div class=codehilite><pre><span></span><span class=n>class</span> <span class=nl>MediaPlayerService</span> <span class=p>:</span> <span class=n>public</span> <span class=n>BnMediaPlayerService</span>
</pre></div> <p><strong>Bn是Binder Native的意思，与Bp相对应。</strong><br> 到目前为止，我们已经构造出来了<code>BpServiceManager</code>和<code>BnMediaPlayerService</code>。但这俩不是对应的两端，因为Bp/Bn后面的名称不相同。</p> <h2 id=7-bpserviewmanageraddservice>7 BpServiewManager#addService<a class=headerlink href=#7-bpserviewmanageraddservice title="Permanent link">&para;</a></h2> <p>再回头看一下<code>BpServiewManager#addService</code>方法的实现。</p> <div class=codehilite><pre><span></span><span class=n>virtual</span> <span class=n>status_t</span> <span class=nf>addService</span><span class=p>(</span><span class=k>const</span> <span class=n>String16</span><span class=o>&amp;</span> <span class=n>name</span><span class=p>,</span> <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span> <span class=n>service</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// data是发送到BnServiceManager的命令包  </span>
    <span class=c1>// reply是收到的答复</span>
    <span class=n>Parcel</span> <span class=n>data</span><span class=p>,</span> <span class=n>reply</span><span class=p>;</span>
    <span class=c1>// IServiceManager::getInterfaceDescriptor()就是包名:android.os.IServiceManager</span>
    <span class=n>data</span><span class=p>.</span><span class=n>writeInterfaceToken</span><span class=p>(</span><span class=n>IServiceManager</span><span class=o>::</span><span class=n>getInterfaceDescriptor</span><span class=p>());</span>
    <span class=c1>// 写入Service的名字以及引用</span>
    <span class=n>data</span><span class=p>.</span><span class=n>writeString16</span><span class=p>(</span><span class=n>name</span><span class=p>);</span>
    <span class=n>data</span><span class=p>.</span><span class=n>writeStrongBinder</span><span class=p>(</span><span class=n>service</span><span class=p>);</span>
    <span class=c1>// 调用BpBinder的transact函数</span>
    <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>remote</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span><span class=n>ADD_SERVICE_TRANSACTION</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reply</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>err</span> <span class=o>==</span> <span class=n>NO_ERROR</span> <span class=o>?</span> <span class=n>reply</span><span class=p>.</span><span class=n>readInt32</span><span class=p>()</span> <span class=o>:</span> <span class=n>err</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>接着看<code>BpBinder#transact</code>函数 </p> <div class=codehilite><pre><span></span><span class=n>status_t</span> <span class=n>BpBinder</span><span class=o>::</span><span class=n>transact</span><span class=p>(</span>
                            <span class=kt>uint32_t</span> <span class=n>code</span><span class=p>,</span> <span class=k>const</span> <span class=n>Parcel</span><span class=o>&amp;</span> <span class=n>data</span><span class=p>,</span> <span class=n>Parcel</span><span class=o>*</span> <span class=n>reply</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>flags</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// Once a binder has died, it will never come back to life.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mAlive</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 调用了IPCThreadState的transact函数</span>
        <span class=c1>// mHandle=0, code=ADD_SERVICE_TRANSACTION, data、reply同上, flags默认为0</span>
        <span class=n>status_t</span> <span class=n>status</span> <span class=o>=</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span>
                                                            <span class=n>mHandle</span><span class=p>,</span> <span class=n>code</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>reply</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>DEAD_OBJECT</span><span class=p>)</span> <span class=n>mAlive</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>DEAD_OBJECT</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>IPCThreadState在创建BpBinder的时候就创建了，再看看<code>IPCThreadState#transact</code>函数 </p> <div class=codehilite><pre><span></span><span class=n>status_t</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>transact</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>handle</span><span class=p>,</span>
                                    <span class=kt>uint32_t</span> <span class=n>code</span><span class=p>,</span> <span class=k>const</span> <span class=n>Parcel</span><span class=o>&amp;</span> <span class=n>data</span><span class=p>,</span>
                                    <span class=n>Parcel</span><span class=o>*</span> <span class=n>reply</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>flags</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>errorCheck</span><span class=p>();</span>

    <span class=n>flags</span> <span class=o>|=</span> <span class=n>TF_ACCEPT_FDS</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
         <span class=c1>// 调用writeTransactionData函数发送数据</span>
        <span class=n>err</span> <span class=o>=</span> <span class=n>writeTransactionData</span><span class=p>(</span><span class=n>BC_TRANSACTION</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>handle</span><span class=p>,</span> <span class=n>code</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>reply</span><span class=p>)</span> <span class=n>reply</span><span class=o>-&gt;</span><span class=n>setError</span><span class=p>(</span><span class=n>err</span><span class=p>);</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>mLastError</span> <span class=o>=</span> <span class=n>err</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// TF_ONE_WAY = 0x01</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>TF_ONE_WAY</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>reply</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 应该走这个</span>
            <span class=n>err</span> <span class=o>=</span> <span class=n>waitForResponse</span><span class=p>(</span><span class=n>reply</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>Parcel</span> <span class=n>fakeReply</span><span class=p>;</span>
            <span class=n>err</span> <span class=o>=</span> <span class=n>waitForResponse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fakeReply</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>err</span> <span class=o>=</span> <span class=n>waitForResponse</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>err</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// 写数据到mOut中</span>
<span class=n>status_t</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>writeTransactionData</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>cmd</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>binderFlags</span><span class=p>,</span>
                                                <span class=kt>int32_t</span> <span class=n>handle</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>code</span><span class=p>,</span> <span class=k>const</span> <span class=n>Parcel</span><span class=o>&amp;</span> <span class=n>data</span><span class=p>,</span> <span class=n>status_t</span><span class=o>*</span> <span class=n>statusBuffer</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>binder_transaction_data</span> <span class=n>tr</span><span class=p>;</span>

    <span class=n>tr</span><span class=p>.</span><span class=n>target</span><span class=p>.</span><span class=n>handle</span> <span class=o>=</span> <span class=n>handle</span><span class=p>;</span>
    <span class=n>tr</span><span class=p>.</span><span class=n>code</span> <span class=o>=</span> <span class=n>code</span><span class=p>;</span>
    <span class=n>tr</span><span class=p>.</span><span class=n>flags</span> <span class=o>=</span> <span class=n>binderFlags</span><span class=p>;</span>

    <span class=k>const</span> <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>errorCheck</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>data_size</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>ipcDataSize</span><span class=p>();</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>buffer</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>ipcData</span><span class=p>();</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>offsets_size</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>ipcObjectsCount</span><span class=p>()</span><span class=o>*</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>size_t</span><span class=p>);</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>offsets</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>ipcObjects</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>statusBuffer</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>flags</span> <span class=o>|=</span> <span class=n>TF_STATUS_CODE</span><span class=p>;</span>
        <span class=o>*</span><span class=n>statusBuffer</span> <span class=o>=</span> <span class=n>err</span><span class=p>;</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>data_size</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>status_t</span><span class=p>);</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>buffer</span> <span class=o>=</span> <span class=n>statusBuffer</span><span class=p>;</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>offsets_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>offsets</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>mLastError</span> <span class=o>=</span> <span class=n>err</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// 上面把命令数据封装成binder_transaction_data，然后</span>
    <span class=c1>// 写到mOut中，mOut是命令的缓冲区，也是一个Parcel</span>
    <span class=n>mOut</span><span class=p>.</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span>
    <span class=n>mOut</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tr</span><span class=p>));</span>

    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>status_t</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>waitForResponse</span><span class=p>(</span><span class=n>Parcel</span> <span class=o>*</span><span class=n>reply</span><span class=p>,</span> <span class=n>status_t</span> <span class=o>*</span><span class=n>acquireResult</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>int32_t</span> <span class=n>cmd</span><span class=p>;</span>
    <span class=kt>int32_t</span> <span class=n>err</span><span class=p>;</span>

    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// talkWithDriver，挺关键的</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>err</span><span class=o>=</span><span class=n>talkWithDriver</span><span class=p>())</span> <span class=o>&lt;</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
        <span class=n>err</span> <span class=o>=</span> <span class=n>mIn</span><span class=p>.</span><span class=n>errorCheck</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>&lt;</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mIn</span><span class=p>.</span><span class=n>dataAvail</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>

        <span class=c1>// talkWithDriver中应该把mOut发出去，然后接受数据到mIn中</span>
        <span class=n>cmd</span> <span class=o>=</span> <span class=n>mIn</span><span class=p>.</span><span class=n>readInt32</span><span class=p>();</span>

        <span class=k>switch</span> <span class=p>(</span><span class=n>cmd</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>case</span> <span class=nl>BR_TRANSACTION_COMPLETE</span><span class=p>:</span>
                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>reply</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>acquireResult</span><span class=p>)</span> <span class=k>goto</span> <span class=n>finish</span><span class=p>;</span>
                <span class=k>break</span><span class=p>;</span>
                <span class=p>...</span>
        <span class=p>}</span>
    <span class=p>}</span>

<span class=nl>finish</span><span class=p>:</span>
    <span class=p>...</span>

    <span class=k>return</span> <span class=n>err</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>status_t</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>talkWithDriver</span><span class=p>(</span><span class=kt>bool</span> <span class=n>doReceive</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>binder_write_read</span> <span class=n>bwr</span><span class=p>;</span>

    <span class=c1>// ...省略一堆判断</span>
    <span class=n>status_t</span> <span class=n>err</span><span class=p>;</span>
    <span class=k>do</span> <span class=p>{</span>
        <span class=c1>// ioctl来对binder进行读写</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>ioctl</span><span class=p>(</span><span class=n>mProcess</span><span class=o>-&gt;</span><span class=n>mDriverFD</span><span class=p>,</span> <span class=n>BINDER_WRITE_READ</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bwr</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
            <span class=n>err</span> <span class=o>=</span> <span class=n>NO_ERROR</span><span class=p>;</span>
        <span class=k>else</span>
            <span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>errno</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=o>-</span><span class=n>EINTR</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>&gt;=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>ssize_t</span><span class=p>)</span><span class=n>mOut</span><span class=p>.</span><span class=n>dataSize</span><span class=p>())</span>
                <span class=n>mOut</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span><span class=p>);</span>
            <span class=k>else</span>
                <span class=n>mOut</span><span class=p>.</span><span class=n>setDataSize</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=c1>// 回复数据会写入mIn中</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>mIn</span><span class=p>.</span><span class=n>setDataSize</span><span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span><span class=p>);</span>
            <span class=n>mIn</span><span class=p>.</span><span class=n>setDataPosition</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>err</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>至此，<code>BpServiceManager</code>发送<code>addService</code>消息，然后收到了回复。 </p> <p>说道<code>BpServiceManager</code>，顺便先说说<code>BnServiceManager</code>。</p> <h2 id=8-bnservicemanager>8 BnServiceManager<a class=headerlink href=#8-bnservicemanager title="Permanent link">&para;</a></h2> <p><code>defaultServiceManager</code>返回的是一个<code>BpServiceManager</code>，通过它可以把命令请求发送到binder设备，而且handle的值为0。<br> 那么，系统的另外一端肯定有个接收命令的。虽然<code>BnServiceManager</code>接收到了命令，但是并没有完成它应该干的的工作。<code>service_manager.c</code>干了这份工作，我们看看它就好了。 </p> <p>关于Service Manager更详细的内容，可以看2.2节。</p> <p><strong>frameworks/base/cmds/servicemanager/service_manager.c</strong></p> <div class=codehilite><pre><span></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>;</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>svcmgr</span> <span class=o>=</span> <span class=n>BINDER_SERVICE_MANAGER</span><span class=p>;</span>
    <span class=c1>// 打开binder设备</span>
    <span class=n>bs</span> <span class=o>=</span> <span class=n>binder_open</span><span class=p>(</span><span class=mi>128</span><span class=o>*</span><span class=mi>1024</span><span class=p>);</span>

    <span class=c1>// 成为manager</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>binder_become_context_manager</span><span class=p>(</span><span class=n>bs</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;cannot become context manager (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>svcmgr_handle</span> <span class=o>=</span> <span class=n>svcmgr</span><span class=p>;</span>
    <span class=c1>// 不断循环，处理BpServiceManager发过来的命令</span>
    <span class=n>binder_loop</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>svcmgr_handler</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p><strong>frameworks/base/cmds/servicemanager/binder.c</strong></p> <div class=codehilite><pre><span></span><span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=nf>binder_open</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>mapsize</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>;</span>

    <span class=n>bs</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>bs</span><span class=p>));</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>bs</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>errno</span> <span class=o>=</span> <span class=n>ENOMEM</span><span class=p>;</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// 打开binder设备</span>
    <span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&quot;/dev/binder&quot;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&quot;binder: cannot open device (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span>
                <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
        <span class=k>goto</span> <span class=n>fail_open</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>bs</span><span class=o>-&gt;</span><span class=n>mapsize</span> <span class=o>=</span> <span class=n>mapsize</span><span class=p>;</span>
    <span class=n>bs</span><span class=o>-&gt;</span><span class=n>mapped</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>mapsize</span><span class=p>,</span> <span class=n>PROT_READ</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=p>,</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>mapped</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&quot;binder: cannot map device (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span>
                <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
        <span class=k>goto</span> <span class=n>fail_map</span><span class=p>;</span>
    <span class=p>}</span>

        <span class=cm>/* TODO: check version */</span>

    <span class=k>return</span> <span class=n>bs</span><span class=p>;</span>

<span class=nl>fail_map</span><span class=p>:</span>
    <span class=n>close</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>);</span>
<span class=nl>fail_open</span><span class=p>:</span>
    <span class=n>free</span><span class=p>(</span><span class=n>bs</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>返回来看看<code>binder_become_context_manager</code>和<code>binder_loop</code>函数 </p> <div class=codehilite><pre><span></span><span class=kt>int</span> <span class=nf>binder_become_context_manager</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// 通过ioctl，使自己成为manager</span>
    <span class=k>return</span> <span class=n>ioctl</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span> <span class=n>BINDER_SET_CONTEXT_MGR</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>binder_loop</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>,</span> <span class=n>binder_handler</span> <span class=n>func</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>res</span><span class=p>;</span>
    <span class=k>struct</span> <span class=n>binder_write_read</span> <span class=n>bwr</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=n>readbuf</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>

    <span class=n>bwr</span><span class=p>.</span><span class=n>write_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>bwr</span><span class=p>.</span><span class=n>write_buffer</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=n>readbuf</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>BC_ENTER_LOOPER</span><span class=p>;</span>
    <span class=n>binder_write</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>readbuf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>unsigned</span><span class=p>));</span>

    <span class=k>for</span> <span class=p>(;;)</span> <span class=p>{</span>
        <span class=c1>// 循环读写binder</span>
        <span class=n>bwr</span><span class=p>.</span><span class=n>read_size</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>readbuf</span><span class=p>);</span>
        <span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=n>bwr</span><span class=p>.</span><span class=n>read_buffer</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span><span class=p>)</span> <span class=n>readbuf</span><span class=p>;</span>

        <span class=n>res</span> <span class=o>=</span> <span class=n>ioctl</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span> <span class=n>BINDER_WRITE_READ</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bwr</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;binder_loop: ioctl failed (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 调用func解析收到的命令</span>
        <span class=c1>// func就是svcmgr_handler</span>
        <span class=n>res</span> <span class=o>=</span> <span class=n>binder_parse</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>readbuf</span><span class=p>,</span> <span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span><span class=p>,</span> <span class=n>func</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;binder_loop: unexpected reply?!</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;binder_loop: io error %d %s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span> <span class=n>res</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>svcmgr_handler</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>,</span>
                   <span class=k>struct</span> <span class=n>binder_txn</span> <span class=o>*</span><span class=n>txn</span><span class=p>,</span>
                   <span class=k>struct</span> <span class=n>binder_io</span> <span class=o>*</span><span class=n>msg</span><span class=p>,</span>
                   <span class=k>struct</span> <span class=n>binder_io</span> <span class=o>*</span><span class=n>reply</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>struct</span> <span class=n>svcinfo</span> <span class=o>*</span><span class=n>si</span><span class=p>;</span>
    <span class=kt>uint16_t</span> <span class=o>*</span><span class=n>s</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=n>len</span><span class=p>;</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>

    <span class=n>s</span> <span class=o>=</span> <span class=n>bio_get_string16</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>);</span>

    <span class=k>switch</span><span class=p>(</span><span class=n>txn</span><span class=o>-&gt;</span><span class=n>code</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>...</span>
        <span class=k>case</span> <span class=nl>SVC_MGR_ADD_SERVICE</span><span class=p>:</span>
            <span class=n>s</span> <span class=o>=</span> <span class=n>bio_get_string16</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>);</span>
            <span class=n>ptr</span> <span class=o>=</span> <span class=n>bio_get_ref</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
            <span class=c1>// 此方法就是真正添加BnMediaService的函数</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>do_add_service</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=n>ptr</span><span class=p>,</span> <span class=n>txn</span><span class=o>-&gt;</span><span class=n>sender_euid</span><span class=p>))</span>
                <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>...</span>
    <span class=p>}</span>

    <span class=n>bio_put_uint32</span><span class=p>(</span><span class=n>reply</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// do_add_service是真正添加BnMediaService的函数</span>
<span class=kt>int</span> <span class=nf>do_add_service</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_state</span> <span class=o>*</span><span class=n>bs</span><span class=p>,</span>
                   <span class=kt>uint16_t</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=n>len</span><span class=p>,</span>
                   <span class=kt>void</span> <span class=o>*</span><span class=n>ptr</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=n>uid</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>struct</span> <span class=n>svcinfo</span> <span class=o>*</span><span class=n>si</span><span class=p>;</span>
    <span class=p>...</span>
    <span class=n>si</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>si</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>len</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>uint16_t</span><span class=p>));</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>si</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;add_service(&#39;%s&#39;,%p) uid=%d - OUT OF MEMORY</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span>
                <span class=n>str8</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>ptr</span><span class=p>,</span> <span class=n>uid</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>si</span><span class=o>-&gt;</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>ptr</span><span class=p>;</span>
    <span class=n>si</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>=</span> <span class=n>len</span><span class=p>;</span>
    <span class=n>memcpy</span><span class=p>(</span><span class=n>si</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=p>(</span><span class=n>len</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>uint16_t</span><span class=p>));</span>
    <span class=n>si</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>[</span><span class=n>len</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
    <span class=n>si</span><span class=o>-&gt;</span><span class=n>death</span><span class=p>.</span><span class=n>func</span> <span class=o>=</span> <span class=n>svcinfo_death</span><span class=p>;</span>
    <span class=n>si</span><span class=o>-&gt;</span><span class=n>death</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>si</span><span class=p>;</span>
    <span class=n>si</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=n>svclist</span><span class=p>;</span>

    <span class=c1>// struct svcinfo</span>
    <span class=c1>// {</span>
    <span class=c1>//     struct svcinfo *next;</span>
    <span class=c1>//     void *ptr;</span>
    <span class=c1>//     struct binder_death death;</span>
    <span class=c1>//     unsigned len;</span>
    <span class=c1>//     uint16_t name[0];</span>
    <span class=c1>// };</span>
    <span class=c1>// struct svcinfo *svclist = 0;</span>
    <span class=c1>//</span>
    <span class=c1>// svclist是一个链表，将si插入到链表的头部</span>
    <span class=c1>// 这样就保存了当前注册到ServiceManager中的信息</span>
    <span class=n>svclist</span> <span class=o>=</span> <span class=n>si</span><span class=p>;</span>

    <span class=n>binder_acquire</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>ptr</span><span class=p>);</span>
    <span class=n>binder_link_to_death</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span> <span class=n>ptr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>si</span><span class=o>-&gt;</span><span class=n>death</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在上面的过程中，我们已经看到了<code>MediaPlayerService</code>是如何注册到<code>ServiceManager</code>中的。</p> <h2 id=9-servicemanager>9 ServiceManager存在的意义<a class=headerlink href=#9-servicemanager title="Permanent link">&para;</a></h2> <p><strong>Service Manager是一个守护进程，用来管理Server，并向Client提供查询Server接口的能力</strong>。Android系统中Service信息都是先add到ServiceManager中，由ServiceManager来集中管理，这样就可以查询当前系统有哪些服务。而且，Android系统中某个服务例如MediaPlayerService的客户端想要和MediaPlayerService通讯的话，必须先向ServiceManager查询MediaPlayerService的信息，然后通过ServiceManager返回的东西再来和MediaPlayerService交互。</p> <p>毕竟，要是MediaPlayerService身体不好，老是挂掉的话，客户的代码就麻烦了，就不知道后续新生的MediaPlayerService的信息了，所以只能这样：</p> <ul> <li>MediaPlayerService向ServiceManager注册</li> <li>MediaPlayerClient查询当前注册在ServiceManager中的MediaPlayerService的信息</li> <li>根据这个信息，MediaPlayerClient和MediaPlayerService交互</li> </ul> <p>另外，ServiceManager的handle标示是0，所以只要往handle是0的服务发送消息了，最终都会被传递到ServiceManager中去。</p> <h2 id=10-mediaservice>10 MediaService的运行<a class=headerlink href=#10-mediaservice title="Permanent link">&para;</a></h2> <p>在上一节的分析中，我们知道了：<code>defaultServiceManager()</code>得到了一个<code>BpServiceManager</code>，然后在<code>MediaPlayerService::instantiate()</code>的过程中会进行<code>addService</code>的操作。<br> 然后service_manager会进行<code>binder_looper</code>，专门等着从binder中接收请求。虽然service_manager没有从<code>BnServiceManager</code>中派生，但是它肯定完成了<code>BnServiceManager</code>的功能。</p> <p>同样，我们在上面已经看到了创建<code>MediaPlayerService</code>的过程，它继承至<code>BnMediaPlayerService</code>。那么，它也应该打开binder，然后进入loop状态。</p> <p>在<a href=#1-processstate>ProcessState</a>中，我们看到这里已经打开了binder。一个进程只需要打开binder一次就行了，接下来看看哪里有loop。</p> <p>在<code>main_mediaserver.cpp</code>文件中还有最后的两行代码没有分析，我们接着往下面分析。 </p> <p>首先看<code>ProcessState::self()-&gt;startThreadPool();</code><br> <strong>frameworks/base/libs/binder/ProcessState.cpp</strong> </p> <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>startThreadPool</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>AutoMutex</span> <span class=n>_l</span><span class=p>(</span><span class=n>mLock</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mThreadPoolStarted</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mThreadPoolStarted</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
        <span class=n>spawnPooledThread</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>ProcessState</span><span class=o>::</span><span class=n>spawnPooledThread</span><span class=p>(</span><span class=kt>bool</span> <span class=n>isMain</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mThreadPoolStarted</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int32_t</span> <span class=n>s</span> <span class=o>=</span> <span class=n>android_atomic_add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mThreadPoolSeq</span><span class=p>);</span>
        <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
        <span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&quot;Binder Thread #%d&quot;</span><span class=p>,</span> <span class=n>s</span><span class=p>);</span>
        <span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;Spawning new pooled thread, name=%s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
        <span class=c1>// 创建一个PoolThread，isMain为true，然后run起来</span>
        <span class=n>sp</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span> <span class=n>t</span> <span class=o>=</span> <span class=n>new</span> <span class=n>PoolThread</span><span class=p>(</span><span class=n>isMain</span><span class=p>);</span>
        <span class=n>t</span><span class=o>-&gt;</span><span class=n>run</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>接着看一下<code>ThreadPool</code>和<code>Thread</code>的构造函数 </p> <div class=codehilite><pre><span></span><span class=c1>// PoolThread继承至Thread</span>
<span class=n>class</span> <span class=nl>PoolThread</span> <span class=p>:</span> <span class=n>public</span> <span class=n>Thread</span>
<span class=p>{</span>
<span class=nl>public</span><span class=p>:</span>
    <span class=n>PoolThread</span><span class=p>(</span><span class=kt>bool</span> <span class=n>isMain</span><span class=p>)</span>
    <span class=o>:</span> <span class=n>mIsMain</span><span class=p>(</span><span class=n>isMain</span><span class=p>)</span>
    <span class=p>{</span>
    <span class=p>}</span>

<span class=nl>protected</span><span class=p>:</span>
    <span class=p>...</span>
<span class=p>};</span>


<span class=c1>// frameworks/base/include/utils/threads.h</span>
<span class=n>class</span> <span class=nl>Thread</span> <span class=p>:</span> <span class=n>virtual</span> <span class=n>public</span> <span class=n>RefBase</span>
<span class=p>{</span>
<span class=nl>public</span><span class=p>:</span>
    <span class=c1>// Create a Thread object, but doesn&#39;t create or start the associated</span>
    <span class=c1>// thread. See the run() method.</span>
                        <span class=n>Thread</span><span class=p>(</span><span class=kt>bool</span> <span class=n>canCallJava</span> <span class=o>=</span> <span class=nb>true</span><span class=p>);</span>
    <span class=p>...</span>

    <span class=c1>// Start the thread in threadLoop() which needs to be implemented.</span>
    <span class=n>virtual</span> <span class=n>status_t</span>    <span class=n>run</span><span class=p>(</span>    <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
                                <span class=kt>int32_t</span> <span class=n>priority</span> <span class=o>=</span> <span class=n>PRIORITY_DEFAULT</span><span class=p>,</span>
                                <span class=kt>size_t</span> <span class=n>stack</span> <span class=o>=</span> <span class=mi>0</span><span class=p>);</span>
    <span class=p>...</span>
<span class=p>};</span>

<span class=c1>// frameworks/base/libs/utils/Threads.cpp</span>
<span class=c1>//</span>
<span class=c1>// canCallJava从声明来看默认是true</span>
<span class=n>Thread</span><span class=o>::</span><span class=n>Thread</span><span class=p>(</span><span class=kt>bool</span> <span class=n>canCallJava</span><span class=p>)</span>
    <span class=o>:</span>   <span class=n>mCanCallJava</span><span class=p>(</span><span class=n>canCallJava</span><span class=p>),</span>
        <span class=n>mThread</span><span class=p>(</span><span class=n>thread_id_t</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)),</span>
        <span class=n>mLock</span><span class=p>(</span><span class=s>&quot;Thread::mLock&quot;</span><span class=p>),</span>
        <span class=n>mStatus</span><span class=p>(</span><span class=n>NO_ERROR</span><span class=p>),</span>
        <span class=n>mExitPending</span><span class=p>(</span><span class=nb>false</span><span class=p>),</span> <span class=n>mRunning</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span>
<span class=p>{</span>
<span class=p>}</span>

<span class=c1>// new PoolThread(isMain);  t-&gt;run(buf);</span>
<span class=c1>// 实际上调用的是基类也就是下面的run方法</span>
<span class=c1>// priority默认是PRIORITY_DEFAULT， stack默认为0</span>
<span class=n>status_t</span> <span class=n>Thread</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int32_t</span> <span class=n>priority</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>stack</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>Mutex</span><span class=o>::</span><span class=n>Autolock</span> <span class=n>_l</span><span class=p>(</span><span class=n>mLock</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>mRunning</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// thread already started</span>
        <span class=k>return</span> <span class=n>INVALID_OPERATION</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// reset status and exitPending to their default value, so we can</span>
    <span class=c1>// try again after an error happened (either below, or in readyToRun())</span>
    <span class=n>mStatus</span> <span class=o>=</span> <span class=n>NO_ERROR</span><span class=p>;</span>
    <span class=n>mExitPending</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
    <span class=n>mThread</span> <span class=o>=</span> <span class=n>thread_id_t</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>

    <span class=c1>// hold a strong reference on ourself</span>
    <span class=n>mHoldSelf</span> <span class=o>=</span> <span class=n>this</span><span class=p>;</span>

    <span class=n>mRunning</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>

    <span class=kt>bool</span> <span class=n>res</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mCanCallJava</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Create thread with lots of parameters</span>
        <span class=c1>// mCanCallJava默认是true，entryFunction是_threadLoop</span>
        <span class=n>res</span> <span class=o>=</span> <span class=n>createThreadEtc</span><span class=p>(</span><span class=n>_threadLoop</span><span class=p>,</span>
                <span class=n>this</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>priority</span><span class=p>,</span> <span class=n>stack</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mThread</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>res</span> <span class=o>=</span> <span class=n>androidCreateRawThreadEtc</span><span class=p>(</span><span class=n>_threadLoop</span><span class=p>,</span>
                <span class=n>this</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>priority</span><span class=p>,</span> <span class=n>stack</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mThread</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=nb>false</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mStatus</span> <span class=o>=</span> <span class=n>UNKNOWN_ERROR</span><span class=p>;</span>   <span class=c1>// something happened!</span>
        <span class=n>mRunning</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
        <span class=n>mThread</span> <span class=o>=</span> <span class=n>thread_id_t</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
        <span class=n>mHoldSelf</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>  <span class=c1>// &quot;this&quot; may have gone away after this.</span>

        <span class=k>return</span> <span class=n>UNKNOWN_ERROR</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// Do not refer to mStatus here: The thread is already running (may, in fact</span>
    <span class=c1>// already have exited with a valid mStatus result). The NO_ERROR indication</span>
    <span class=c1>// here merely indicates successfully starting the thread and does not</span>
    <span class=c1>// imply successful termination/execution.</span>
    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在<code>createThreadEtc(_threadLoop, this, name, priority, stack, &amp;mThread)</code>函数中开始创建了线程，并在过程中会调用<code>_threadLoop</code>函数。<br> 我们看看<code>_threadLoop</code>里面干了啥： </p> <div class=codehilite><pre><span></span><span class=kt>int</span> <span class=n>Thread</span><span class=o>::</span><span class=n>_threadLoop</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span> <span class=n>user</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>Thread</span><span class=o>*</span> <span class=k>const</span> <span class=n>self</span> <span class=o>=</span> <span class=n>static_cast</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>user</span><span class=p>);</span>
    <span class=n>sp</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span> <span class=n>strong</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mHoldSelf</span><span class=p>);</span>
    <span class=n>wp</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span> <span class=n>weak</span><span class=p>(</span><span class=n>strong</span><span class=p>);</span>
    <span class=n>self</span><span class=o>-&gt;</span><span class=n>mHoldSelf</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>

    <span class=c1>// this is very useful for debugging with gdb</span>
    <span class=n>self</span><span class=o>-&gt;</span><span class=n>mTid</span> <span class=o>=</span> <span class=n>gettid</span><span class=p>();</span>

    <span class=kt>bool</span> <span class=n>first</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>

    <span class=k>do</span> <span class=p>{</span>
        <span class=kt>bool</span> <span class=n>result</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>first</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>first</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
            <span class=n>self</span><span class=o>-&gt;</span><span class=n>mStatus</span> <span class=o>=</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>readyToRun</span><span class=p>();</span>
            <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mStatus</span> <span class=o>==</span> <span class=n>NO_ERROR</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mExitPending</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// Binder threads (and maybe others) rely on threadLoop</span>
                <span class=c1>// running at least once after a successful ::readyToRun()</span>
                <span class=c1>// (unless, of course, the thread has already been asked to exit</span>
                <span class=c1>// at that point).</span>
                <span class=c1>// This is because threads are essentially used like this:</span>
                <span class=c1>//   (new ThreadSubclass())-&gt;run();</span>
                <span class=c1>// The caller therefore does not retain a strong reference to</span>
                <span class=c1>// the thread and the thread would simply disappear after the</span>
                <span class=c1>// successful ::readyToRun() call instead of entering the</span>
                <span class=c1>// threadLoop at least once.</span>
                <span class=c1>//</span>
                <span class=c1>// 调用自己的threadLoop</span>
                <span class=n>result</span> <span class=o>=</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>threadLoop</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 调用自己的threadLoop</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>threadLoop</span><span class=p>();</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=nb>false</span> <span class=o>||</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>mExitPending</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>self</span><span class=o>-&gt;</span><span class=n>mExitPending</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
            <span class=n>self</span><span class=o>-&gt;</span><span class=n>mLock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
            <span class=n>self</span><span class=o>-&gt;</span><span class=n>mRunning</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
            <span class=n>self</span><span class=o>-&gt;</span><span class=n>mThreadExitedCondition</span><span class=p>.</span><span class=n>broadcast</span><span class=p>();</span>
            <span class=n>self</span><span class=o>-&gt;</span><span class=n>mLock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// Release our strong reference, to let a chance to the thread</span>
        <span class=c1>// to die a peaceful death.</span>
        <span class=n>strong</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
        <span class=c1>// And immediately, re-acquire a strong reference for the next loop</span>
        <span class=n>strong</span> <span class=o>=</span> <span class=n>weak</span><span class=p>.</span><span class=n>promote</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>while</span><span class=p>(</span><span class=n>strong</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>

    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>virtual</span> <span class=kt>bool</span> <span class=n>threadLoop</span><span class=p>()</span>
<span class=p>{</span>
    <span class=c1>// mIsMain为true。</span>
    <span class=c1>// 而且注意，这是一个新的线程，所以必然会创建一个</span>
    <span class=c1>// 新的IPCThreadState对象（TLS）</span>
    <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>joinThreadPool</span><span class=p>(</span><span class=n>mIsMain</span><span class=p>);</span>
    <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>主线程和Binder工作线程都调用了<code>IPCThreadState::joinThreadPool();</code>方法，看看干了什么 </p> <div class=codehilite><pre><span></span><span class=c1>// frameworks/base/include/binder/IPCThreadState.h</span>
<span class=n>class</span> <span class=n>IPCThreadState</span>
<span class=p>{</span>
<span class=nl>public</span><span class=p>:</span>
    <span class=k>static</span>  <span class=n>IPCThreadState</span><span class=o>*</span>     <span class=n>self</span><span class=p>();</span>
    <span class=p>...</span>
    <span class=kt>void</span>                <span class=n>joinThreadPool</span><span class=p>(</span><span class=kt>bool</span> <span class=n>isMain</span> <span class=o>=</span> <span class=nb>true</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// frameworks/base/include/binder/IPCThreadState.cpp</span>
<span class=kt>void</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>joinThreadPool</span><span class=p>(</span><span class=kt>bool</span> <span class=n>isMain</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>mOut</span><span class=p>.</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>isMain</span> <span class=o>?</span> <span class=nl>BC_ENTER_LOOPER</span> <span class=p>:</span> <span class=n>BC_REGISTER_LOOPER</span><span class=p>);</span>
    <span class=p>...</span>
    <span class=n>status_t</span> <span class=n>result</span><span class=p>;</span>

    <span class=c1>// 这个do-while循环就完成了loop的事情</span>
    <span class=k>do</span> <span class=p>{</span>
        <span class=kt>int32_t</span> <span class=n>cmd</span><span class=p>;</span>
        <span class=p>...</span>
        <span class=c1>// now get the next command to be processed, waiting if necessary</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>talkWithDriver</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>&gt;=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
            <span class=p>...</span>
            <span class=n>cmd</span> <span class=o>=</span> <span class=n>mIn</span><span class=p>.</span><span class=n>readInt32</span><span class=p>();</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>executeCommand</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=p>...</span>

        <span class=c1>// Let this thread exit the thread pool if it is no longer</span>
        <span class=c1>// needed and it is not the main process thread.</span>
        <span class=k>if</span><span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>TIMED_OUT</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isMain</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=o>-</span><span class=n>ECONNREFUSED</span> <span class=o>&amp;&amp;</span> <span class=n>result</span> <span class=o>!=</span> <span class=o>-</span><span class=n>EBADF</span><span class=p>);</span>

    <span class=p>...</span>

    <span class=n>mOut</span><span class=p>.</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>BC_EXIT_LOOPER</span><span class=p>);</span>
    <span class=n>talkWithDriver</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>在上面我们终于看到了loop的操作，接下来看一下里面的<code>executeCommand</code>函数干了什么： </p> <div class=codehilite><pre><span></span><span class=n>status_t</span> <span class=n>IPCThreadState</span><span class=o>::</span><span class=n>executeCommand</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>cmd</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>BBinder</span><span class=o>*</span> <span class=n>obj</span><span class=p>;</span>
    <span class=n>RefBase</span><span class=o>::</span><span class=n>weakref_type</span><span class=o>*</span> <span class=n>refs</span><span class=p>;</span>
    <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>NO_ERROR</span><span class=p>;</span>

    <span class=k>switch</span> <span class=p>(</span><span class=n>cmd</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>...</span>
        <span class=k>case</span> <span class=nl>BR_TRANSACTION</span><span class=p>:</span>
        <span class=p>{</span>
            <span class=c1>// 来了一个BR_TRANSACTION命令，解析成binder_transaction_data结构</span>
            <span class=n>binder_transaction_data</span> <span class=n>tr</span><span class=p>;</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>mIn</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tr</span><span class=p>));</span>
            <span class=n>LOG_ASSERT</span><span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>NO_ERROR</span><span class=p>,</span>
                        <span class=s>&quot;Not enough command data for brTRANSACTION&quot;</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>

            <span class=n>Parcel</span> <span class=n>buffer</span><span class=p>;</span>
            <span class=n>buffer</span><span class=p>.</span><span class=n>ipcSetDataReference</span><span class=p>(</span>
                                           <span class=n>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span> <span class=kt>uint8_t</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>buffer</span><span class=p>),</span>
                                           <span class=n>tr</span><span class=p>.</span><span class=n>data_size</span><span class=p>,</span>
                                           <span class=n>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span> <span class=kt>size_t</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>offsets</span><span class=p>),</span>
                                           <span class=n>tr</span><span class=p>.</span><span class=n>offsets_size</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>size_t</span><span class=p>),</span> <span class=n>freeBuffer</span><span class=p>,</span> <span class=n>this</span><span class=p>);</span>
            <span class=p>...</span>
            <span class=n>Parcel</span> <span class=n>reply</span><span class=p>;</span>
            <span class=p>...</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>target</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 这里调用了BBinder的transact函数</span>
                <span class=n>sp</span><span class=o>&lt;</span><span class=n>BBinder</span><span class=o>&gt;</span> <span class=n>b</span><span class=p>((</span><span class=n>BBinder</span><span class=o>*</span><span class=p>)</span><span class=n>tr</span><span class=p>.</span><span class=n>cookie</span><span class=p>);</span>
                <span class=k>const</span> <span class=n>status_t</span> <span class=n>error</span> <span class=o>=</span> <span class=n>b</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>code</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reply</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>&lt;</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=n>reply</span><span class=p>.</span><span class=n>setError</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=k>const</span> <span class=n>status_t</span> <span class=n>error</span> <span class=o>=</span> <span class=n>the_context_object</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>code</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reply</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>&lt;</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=n>reply</span><span class=p>.</span><span class=n>setError</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
            <span class=p>}</span>

            <span class=c1>//LOGI(&quot;&lt;&lt;&lt;&lt; TRANSACT from pid %d restore pid %d uid %d\n&quot;,</span>
            <span class=c1>//     mCallingPid, origPid, origUid);</span>

            <span class=k>if</span> <span class=p>((</span><span class=n>tr</span><span class=p>.</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>TF_ONE_WAY</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>LOG_ONEWAY</span><span class=p>(</span><span class=s>&quot;Sending reply to %d!&quot;</span><span class=p>,</span> <span class=n>mCallingPid</span><span class=p>);</span>
                <span class=n>sendReply</span><span class=p>(</span><span class=n>reply</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>LOG_ONEWAY</span><span class=p>(</span><span class=s>&quot;NOT sending reply to %d!&quot;</span><span class=p>,</span> <span class=n>mCallingPid</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=p>...</span>
        <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>...</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>mLastError</span> <span class=o>=</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>在上面的代码中，发现了一个<code>BBinder</code>类，<strong>实际上理解为<code>BnBinder</code>更好</strong>。<br> 在创建<code>MediaPlayerService</code>时，其继承至<code>BnMediaPlayerService</code>；而<code>BnMediaPlayerService</code>的定义如下</p> <div class=codehilite><pre><span></span><span class=n>class</span> <span class=nl>BnMediaPlayerService</span><span class=p>:</span> <span class=n>public</span> <span class=n>BnInterface</span><span class=o>&lt;</span><span class=n>IMediaPlayerService</span><span class=o>&gt;</span>
</pre></div> <p><code>BnInterface</code>是一个类模板：</p> <div class=codehilite><pre><span></span><span class=n>template</span><span class=o>&lt;</span><span class=kr>typename</span> <span class=n>INTERFACE</span><span class=o>&gt;</span>
<span class=n>class</span> <span class=nl>BnInterface</span> <span class=p>:</span> <span class=n>public</span> <span class=n>INTERFACE</span><span class=p>,</span> <span class=n>public</span> <span class=n>BBinder</span>
<span class=p>{</span>
<span class=nl>public</span><span class=p>:</span>
    <span class=n>virtual</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IInterface</span><span class=o>&gt;</span>      <span class=n>queryLocalInterface</span><span class=p>(</span><span class=k>const</span> <span class=n>String16</span><span class=o>&amp;</span> <span class=n>_descriptor</span><span class=p>);</span>
    <span class=n>virtual</span> <span class=k>const</span> <span class=n>String16</span><span class=o>&amp;</span>     <span class=n>getInterfaceDescriptor</span><span class=p>()</span> <span class=k>const</span><span class=p>;</span>

<span class=nl>protected</span><span class=p>:</span>
    <span class=n>virtual</span> <span class=n>IBinder</span><span class=o>*</span>            <span class=n>onAsBinder</span><span class=p>();</span>
<span class=p>};</span>
</pre></div> <p><code>BBinder#transit</code>函数调用了自身的<code>onTransit</code>函数，也就是说最后还是调用了<code>BnMediaPlayerService::onTransact</code>：</p> <div class=codehilite><pre><span></span><span class=n>status_t</span> <span class=n>BBinder</span><span class=o>::</span><span class=n>transact</span><span class=p>(</span>
                            <span class=kt>uint32_t</span> <span class=n>code</span><span class=p>,</span> <span class=k>const</span> <span class=n>Parcel</span><span class=o>&amp;</span> <span class=n>data</span><span class=p>,</span> <span class=n>Parcel</span><span class=o>*</span> <span class=n>reply</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>flags</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>data</span><span class=p>.</span><span class=n>setDataPosition</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>

    <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>NO_ERROR</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>code</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nl>PING_TRANSACTION</span><span class=p>:</span>
            <span class=n>reply</span><span class=o>-&gt;</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>pingBinder</span><span class=p>());</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>default</span><span class=o>:</span>
            <span class=n>err</span> <span class=o>=</span> <span class=n>onTransact</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>reply</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>reply</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>reply</span><span class=o>-&gt;</span><span class=n>setDataPosition</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>err</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>status_t</span> <span class=n>BnMediaPlayerService</span><span class=o>::</span><span class=n>onTransact</span><span class=p>(</span>
    <span class=kt>uint32_t</span> <span class=n>code</span><span class=p>,</span> <span class=k>const</span> <span class=n>Parcel</span><span class=o>&amp;</span> <span class=n>data</span><span class=p>,</span> <span class=n>Parcel</span><span class=o>*</span> <span class=n>reply</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>flags</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// BnMediaPlayerService从BBinder和IMediaPlayerService派生</span>
    <span class=c1>// 所有IMediaPlayerService提供的函数都通过命令类型来区分</span>
    <span class=k>switch</span><span class=p>(</span><span class=n>code</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nl>CREATE_URL</span><span class=p>:</span> <span class=p>{</span>
            <span class=n>CHECK_INTERFACE</span><span class=p>(</span><span class=n>IMediaPlayerService</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>reply</span><span class=p>);</span>
            <span class=p>...</span>

            <span class=c1>// create是一个由MediaPlayerService实现的虚函数</span>
            <span class=n>sp</span><span class=o>&lt;</span><span class=n>IMediaPlayer</span><span class=o>&gt;</span> <span class=n>player</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span>
                    <span class=n>pid</span><span class=p>,</span> <span class=n>client</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>numHeaders</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=o>&amp;</span><span class=nl>headers</span> <span class=p>:</span> <span class=nb>NULL</span><span class=p>);</span>

            <span class=n>reply</span><span class=o>-&gt;</span><span class=n>writeStrongBinder</span><span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>asBinder</span><span class=p>());</span>
            <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>break</span><span class=p>;</span>
        <span class=p>...</span>
        <span class=k>default</span><span class=o>:</span>
            <span class=k>return</span> <span class=n>BBinder</span><span class=o>::</span><span class=n>onTransact</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>reply</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>看到上面我们就知道了，其实<code>BnXxx::onTransact</code>函数接收命令，然后转发到派生类的函数<code>IXxx</code>，由他们完成实际的工作。</p> <p><strong>说明</strong>：这里有点特殊，<code>startThreadPool</code>和<code>joinThreadPool</code>完后确实有两个线程：主线程和工作线程，而且都在做消息循环。<br> 为什么要这么做呢？他们参数isMain都是true。不知道google搞什么。难道是怕一个线程工作量太多，所以搞两个线程来工作？这种解释应该也是合理的。<br> 网上有人测试过把最后一句屏蔽掉，也能正常工作。但是难道主线程提出了，程序还能不退出吗？这个...管它的，反正知道有两个线程在那处理就行了。</p> <p><strong>此外，看看<code>MediaPlayerClient</code>如何与<code>MediaPlayerService</code>进行交互。</strong> <br> 使用<code>MediaPlayerService</code>时，要先创建它的<code>BpMediaPlayerService</code>： </p> <p><strong>frameworks/base/media/libmedia/IMediaDeathNotifier.cpp</strong><br> <div class=codehilite><pre><span></span><span class=c1>// establish binder interface to MediaPlayerService</span>
<span class=cm>/*static*/</span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>IMediaPlayerService</span><span class=o>&gt;&amp;</span>
<span class=n>IMediaDeathNotifier</span><span class=o>::</span><span class=n>getMediaPlayerService</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;getMediaPlayerService&quot;</span><span class=p>);</span>
    <span class=n>Mutex</span><span class=o>::</span><span class=n>Autolock</span> <span class=n>_l</span><span class=p>(</span><span class=n>sServiceLock</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>sMediaPlayerService</span><span class=p>.</span><span class=n>get</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span> <span class=n>sm</span> <span class=o>=</span> <span class=n>defaultServiceManager</span><span class=p>();</span>
        <span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span> <span class=n>binder</span><span class=p>;</span>
        <span class=k>do</span> <span class=p>{</span>
            <span class=c1>// 向ServiceManager查询对应服务的信息，返回binder</span>
            <span class=n>binder</span> <span class=o>=</span> <span class=n>sm</span><span class=o>-&gt;</span><span class=n>getService</span><span class=p>(</span><span class=n>String16</span><span class=p>(</span><span class=s>&quot;media.player&quot;</span><span class=p>));</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>binder</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>break</span><span class=p>;</span>
             <span class=p>}</span>
             <span class=n>LOGW</span><span class=p>(</span><span class=s>&quot;Media player service not published, waiting...&quot;</span><span class=p>);</span>
             <span class=n>usleep</span><span class=p>(</span><span class=mi>500000</span><span class=p>);</span> <span class=c1>// 0.5 s</span>
        <span class=p>}</span> <span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>sDeathNotifier</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>sDeathNotifier</span> <span class=o>=</span> <span class=n>new</span> <span class=n>DeathNotifier</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=n>binder</span><span class=o>-&gt;</span><span class=n>linkToDeath</span><span class=p>(</span><span class=n>sDeathNotifier</span><span class=p>);</span>
    <span class=c1>// 通过interface_cast，将这个binder转化成BpMediaPlayerService</span>
    <span class=c1>// 注意，此处的binder只是用来和binder设备进行通讯</span>
    <span class=c1>// 实际上和IMediaPlayerService的功能一点关系都没有</span>
    <span class=c1>// BpMediaPlayerService用这个binder和BnMediaPlayerService通讯</span>
    <span class=n>sMediaPlayerService</span> <span class=o>=</span> <span class=n>interface_cast</span><span class=o>&lt;</span><span class=n>IMediaPlayerService</span><span class=o>&gt;</span><span class=p>(</span><span class=n>binder</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>LOGE_IF</span><span class=p>(</span><span class=n>sMediaPlayerService</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&quot;no media player service!?&quot;</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>sMediaPlayerService</span><span class=p>;</span>
<span class=p>}</span>
</pre></div></p> <p>Binder其实就是一个和binder设备打交道的接口，而上层IMediaPlayerService只不过把它当做一个类似socket使用罢了。 </p> <h2 id=11>11 小结<a class=headerlink href=#11 title="Permanent link">&para;</a></h2> <p><img alt=ServiceManager的UML类图 src=/assets/images/android/binder_service_manager_uml.png></p> <p>整个MediaServer流程的简单描述如下图：</p> <p><a href=/assets/images/android/binder_mediaserver_progress.png><img alt=MediaServer流程的简单描述 src=/assets/images/android/binder_mediaserver_progress.png></a></p> <ul> <li>client调用service</li> <li>client调用<code>defaultServiceManager-&gt;getService</code>获得一个binder，然后通过<code>interface_cast&lt;IXxxService&gt;(binder)</code>转换成对应的<code>BpXxxService</code></li> <li>调用<code>BpXxxService#foo</code>函数，将需要的参数写入一个<code>Parcel</code>，然后调用<code>remote()-&gt;transact(FOO_CODE_TRANSACTION, data, &amp;reply)</code>函数（可参考BpServiceManager中addService等方法的写法）</li> <li><code>remote()</code>其实就是一个<code>BpBinder</code>对象，其<code>transact</code>函数会调用<code>IPCThreadState::self()-&gt;transact</code>发送数据</li> <li>service回调client</li> <li>在<code>IPCThreadState#joinThreadPool</code>的loop过程中收到了client的请求，会调用<code>BBinder#transact</code>函数</li> <li>该函数会调用<code>BBinder#onTransact</code>虚拟函数，其实现部分由<code>BnXxxService</code>实现</li> <li>在<code>BnXxxService#onTransact</code>函数中会经过code判断是哪种命令，然后解析client数据，执行<code>foo</code>函数的实现部分，最后将结果写入reply中</li> </ul> <hr> <div class=md-source-date> <small> 最后更新: 2020年1月14日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/framework/binder1-mediaservice/";
      this.page.identifier =
        "/android/framework/binder1-mediaservice/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../性能优化/ title=Android性能优化 class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> Android性能优化 </span> </div> </a> <a href=../binder2/ title=Binder深入理解——罗老师系列 class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> Binder深入理解——罗老师系列 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
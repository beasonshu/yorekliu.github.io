<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/framework/View的绘制原理/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>View的绘制原理 - Yorek's</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=manifest href=../../../manifest.webmanifest><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="Yorek's - View的绘制原理"><meta property=og:description content="An Android Developer."><meta content=https://blog.yorek.xyz/about-me/android/framework/View的绘制原理/ property=og:url><meta property=og:image content=https://blog.yorek.xyz/about-meassets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Yorek's - View的绘制原理"><meta name=twitter:description content="An Android Developer."><meta name=twitter:image content=https://blog.yorek.xyz/about-meassets/images/banner.png></head> <body dir=ltr data-md-color-primary=white data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#1-viewrootimpldecorview tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> View的绘制原理 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../3rd-library/3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <img src=../../../assets/images/favicon.ico width=48 height=48> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3rd-library/3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix/ title="微信APM Matrix解析" class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace/ title=Matrix-TraceCanary解析 class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-io/ title=Matrix-IOCanary解析 class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-resource/ title=Matrix-ResourceCanary解析 class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-sqlitelint/ title=Matrix-SQLiteLint解析 class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/rxjava&rxandroid/ title=RxJava源码解析及使用实例 class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/migrate-to-glide/ title=杂记：从Picasso迁移至Glide class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../3rd-library/eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ title="35 | Native Hook 技术，天使还是魔鬼？" class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3 checked> <label class=md-nav__link for=nav-2-3> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> View的绘制原理 </label> <a href=./ title=View的绘制原理 class="md-nav__link md-nav__link--active"> View的绘制原理 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-viewrootimpldecorview class=md-nav__link> 1 ViewRootImpl和DecorView </a> </li> <li class=md-nav__item> <a href=#2-measurespec class=md-nav__link> 2 MeasureSpec </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-measurespec class=md-nav__link> 2.1 MeasureSpec的详细描述 </a> </li> <li class=md-nav__item> <a href=#22-measurespeclayoutparams class=md-nav__link> 2.2 MeasureSpec和LayoutParams的对应关系 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-view class=md-nav__link> 3 View的工作流程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-measure class=md-nav__link> 3.1 measure过程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#311-viewmeasure class=md-nav__link> 3.1.1 View的measure过程 </a> </li> <li class=md-nav__item> <a href=#312-viewonmeasure class=md-nav__link> 3.1.2 自定义View为何需要重写onMeasure方法 </a> </li> <li class=md-nav__item> <a href=#313-viewgroupmeasure class=md-nav__link> 3.1.3 ViewGroup的measure过程 </a> </li> <li class=md-nav__item> <a href=#314-activityview class=md-nav__link> 3.1.4 Activity中获取View宽高的几种方式 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32-layout class=md-nav__link> 3.2 layout过程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#321-viewlayout class=md-nav__link> 3.2.1 View的layout过程 </a> </li> <li class=md-nav__item> <a href=#322-viewgrouplayout class=md-nav__link> 3.2.2 ViewGroup的layout过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#33-draw class=md-nav__link> 3.3 draw过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-view class=md-nav__link> 4 如何让View刷新 </a> </li> <li class=md-nav__item> <a href=#5-view class=md-nav__link> 5 自定义View </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#51-view class=md-nav__link> 5.1 自定义View的分类 </a> </li> <li class=md-nav__item> <a href=#52-view class=md-nav__link> 5.2 自定义View注意事项 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ title=类文件结构 class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ title=虚拟机类加载机制 class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-viewrootimpldecorview class=md-nav__link> 1 ViewRootImpl和DecorView </a> </li> <li class=md-nav__item> <a href=#2-measurespec class=md-nav__link> 2 MeasureSpec </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-measurespec class=md-nav__link> 2.1 MeasureSpec的详细描述 </a> </li> <li class=md-nav__item> <a href=#22-measurespeclayoutparams class=md-nav__link> 2.2 MeasureSpec和LayoutParams的对应关系 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-view class=md-nav__link> 3 View的工作流程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-measure class=md-nav__link> 3.1 measure过程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#311-viewmeasure class=md-nav__link> 3.1.1 View的measure过程 </a> </li> <li class=md-nav__item> <a href=#312-viewonmeasure class=md-nav__link> 3.1.2 自定义View为何需要重写onMeasure方法 </a> </li> <li class=md-nav__item> <a href=#313-viewgroupmeasure class=md-nav__link> 3.1.3 ViewGroup的measure过程 </a> </li> <li class=md-nav__item> <a href=#314-activityview class=md-nav__link> 3.1.4 Activity中获取View宽高的几种方式 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32-layout class=md-nav__link> 3.2 layout过程 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#321-viewlayout class=md-nav__link> 3.2.1 View的layout过程 </a> </li> <li class=md-nav__item> <a href=#322-viewgrouplayout class=md-nav__link> 3.2.2 ViewGroup的layout过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#33-draw class=md-nav__link> 3.3 draw过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-view class=md-nav__link> 4 如何让View刷新 </a> </li> <li class=md-nav__item> <a href=#5-view class=md-nav__link> 5 自定义View </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#51-view class=md-nav__link> 5.1 自定义View的分类 </a> </li> <li class=md-nav__item> <a href=#52-view class=md-nav__link> 5.2 自定义View注意事项 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>View的绘制原理</h1> <p>本文主要讲述View的绘制原理以及自定义View。</p> <h2 id=1-viewrootimpldecorview>1 ViewRootImpl和DecorView<a class=headerlink href=#1-viewrootimpldecorview title="Permanent link">&para;</a></h2> <p>在介绍View的三大流程之前，我们先介绍一下ViewRootImpl和DecorView的基本概念。 </p> <p>ViewRootImpl是连接WindowManager和DecorView的纽带，View的measure、layout、draw三大流程均是通过ViewRootImpl开始的。 </p> <p>View的绘制流程是从ViewRoot的<code>performTraversals</code>开始的，经过measure、layout、draw才能将一个View绘制出来。<br> <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>performTraversals</span><span class=p>()</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
        <span class=p>...</span>
        <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
            <span class=p>...</span>
            <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
                <span class=p>...</span>
                <span class=n>performMeasure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span> <span class=n>childHeightMeasureSpec</span><span class=p>);</span>
                <span class=p>...</span>
                <span class=n>layoutRequested</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}...</span>

    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>didLayout</span> <span class=o>=</span> <span class=n>layoutRequested</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=n>mStopped</span> <span class=o>||</span> <span class=n>mReportNextDraw</span><span class=p>);</span>
    <span class=p>...</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>didLayout</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>performLayout</span><span class=p>(</span><span class=n>lp</span><span class=p>,</span> <span class=n>mWidth</span><span class=p>,</span> <span class=n>mHeight</span><span class=p>);</span>
        <span class=p>...</span>
    <span class=p>}</span>

    <span class=p>...</span>
    <span class=kt>boolean</span> <span class=n>cancelDraw</span> <span class=o>=</span> <span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnPreDraw</span><span class=p>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>isViewVisible</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cancelDraw</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>newSurface</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>...</span>
        <span class=n>performDraw</span><span class=p>();</span>
    <span class=p>}...</span>
<span class=p>}</span>
</pre></div></p> <p><code>performTraversals</code>方法会由<code>doTraversal</code>调用，<code>doTraversal</code>又被封装在<code>TraversalRunnable</code>里面，<code>TraversalRunnable</code>会在<code>scheduleTraversals</code>方法注册到<code>Choreographer</code>中，在下一个VSync信号到达的时候进行触发。 <code>invalidate</code>、<code>requestLayout</code>等等方法都会调用<code>scheduleTraversals</code>。如图：</p> <p><img alt=View绘制基本流程 src=/assets/images/android/View绘制基本流程.png></p> <p>measure过程决定了View的宽高，Measure完成后，可以通过getMeasuredWidth和getMeasuredHeight方法来获取View测量后的宽高。</p> <p>需要注意的ViewGroup继承至View，所以ViewGroup的measure方法实际上就是View的measure方法。View会在measure方法中调用onMeasure方法，而ViewGroup会在onMeasure中完成对子View的measure操作。如果子元素也是ViewGroup，也会沿着控件树继续传递下去，直到最后的节点是View为止。</p> <p>View会在onMeasure方法中设置自己的宽高；而ViewGroup并没有实现此方法，该方法需要ViewGroup的具体子类去实现。下面是<code>View.onMeasure</code>方法的代码：</p> <div class=codehilite><pre><span></span><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>setMeasuredDimension</span><span class=p>(</span><span class=n>getDefaultSize</span><span class=p>(</span><span class=n>getSuggestedMinimumWidth</span><span class=p>(),</span> <span class=n>widthMeasureSpec</span><span class=p>),</span>
            <span class=n>getDefaultSize</span><span class=p>(</span><span class=n>getSuggestedMinimumHeight</span><span class=p>(),</span> <span class=n>heightMeasureSpec</span><span class=p>));</span>
<span class=p>}</span>
</pre></div> <p>layout调用过程和measure调用过程一致。layout过程将会决定View怎么进行摆放。 </p> <p>draw调用过程与上面的两个过程有点不一样，顶层View的draw在<code>ViewRootImpl#drawSoftware</code>方法中调用，其传递是通过<code>dispatchDraw</code>来实现的，<code>onDraw</code>仅仅用来draw自身的内容。</p> <p>DecorView是一个继承至FrameLayout的顶级View，一般情况下它内部会包含一个竖直方向的LinearLayout。这个LinearLayout有两个部分，上面部分是标题栏，下面部分是id为content的内容栏，所谓的setContentView就是指这个View。</p> <p><img alt=DecorView示意图 src=/assets/images/android/DecorView.png></p> <blockquote> <p>DecorView为何叫做Decor View，前面的Decor表明了这是一个<a href=/design-pattern/decorator/ >装饰者模式</a>的View。更多关于DecorView的知识，参考<a href=/android/framework/Window%E4%B8%8EWindowManager/ >Window与WindowManager</a></p> </blockquote> <h2 id=2-measurespec>2 MeasureSpec<a class=headerlink href=#2-measurespec title="Permanent link">&para;</a></h2> <p>MeasureSpec会在测量过程中将View的LayoutParams根据父容器的规则进行转换，通过这个MeasureSpec可以测量View的宽高。</p> <h3 id=21-measurespec>2.1 MeasureSpec的详细描述<a class=headerlink href=#21-measurespec title="Permanent link">&para;</a></h3> <p>MeasureSpec类是View的内部类，我们可以在View的代码中找到这个类。 <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MeasureSpec</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODE_SHIFT</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MODE_MASK</span>  <span class=o>=</span> <span class=mh>0x3</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=p>;</span>
    <span class=p>...</span>

    <span class=cm>/**</span>
<span class=cm>     * Measure specification mode: The parent has not imposed any constraint</span>
<span class=cm>     * on the child. It can be whatever size it wants.</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>UNSPECIFIED</span> <span class=o>=</span> <span class=mi>0</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=p>;</span>

    <span class=cm>/**</span>
<span class=cm>     * Measure specification mode: The parent has determined an exact size</span>
<span class=cm>     * for the child. The child is going to be given those bounds regardless</span>
<span class=cm>     * of how big it wants to be.</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>EXACTLY</span>     <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=p>;</span>

    <span class=cm>/**</span>
<span class=cm>     * Measure specification mode: The child can be as large as it wants up</span>
<span class=cm>     * to the specified size.</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>AT_MOST</span>     <span class=o>=</span> <span class=mi>2</span> <span class=o>&lt;&lt;</span> <span class=n>MODE_SHIFT</span><span class=p>;</span>

    <span class=cm>/**</span>
<span class=cm>     * Creates a measure specification based on the supplied size and mode.</span>
<span class=cm>     *</span>
<span class=cm>     * The mode must always be one of the following:</span>
<span class=cm>     * &lt;ul&gt;</span>
<span class=cm>     *  &lt;li&gt;{@link android.view.View.MeasureSpec#UNSPECIFIED}&lt;/li&gt;</span>
<span class=cm>     *  &lt;li&gt;{@link android.view.View.MeasureSpec#EXACTLY}&lt;/li&gt;</span>
<span class=cm>     *  &lt;li&gt;{@link android.view.View.MeasureSpec#AT_MOST}&lt;/li&gt;</span>
<span class=cm>     * &lt;/ul&gt;</span>
<span class=cm>     *</span>
<span class=cm>     * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; On API level 17 and lower, makeMeasureSpec&#39;s</span>
<span class=cm>     * implementation was such that the order of arguments did not matter</span>
<span class=cm>     * and overflow in either value could impact the resulting MeasureSpec.</span>
<span class=cm>     * {@link android.widget.RelativeLayout} was affected by this bug.</span>
<span class=cm>     * Apps targeting API levels greater than 17 will get the fixed, more strict</span>
<span class=cm>     * behavior.&lt;/p&gt;</span>
<span class=cm>     *</span>
<span class=cm>     * @param size the size of the measure specification</span>
<span class=cm>     * @param mode the mode of the measure specification</span>
<span class=cm>     * @return the measure specification based on size and mode</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>makeMeasureSpec</span><span class=p>(</span><span class=nd>@IntRange</span><span class=p>(</span><span class=n>from</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>to</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>MODE_SHIFT</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=kt>int</span> <span class=n>size</span><span class=p>,</span>
                                      <span class=nd>@MeasureSpecMode</span> <span class=kt>int</span> <span class=n>mode</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>sUseBrokenMakeMeasureSpec</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>size</span> <span class=o>+</span> <span class=n>mode</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>return</span> <span class=p>(</span><span class=n>size</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MODE_MASK</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>mode</span> <span class=o>&amp;</span> <span class=n>MODE_MASK</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=p>...</span>   

    <span class=cm>/**</span>
<span class=cm>     * Extracts the mode from the supplied measure specification.</span>
<span class=cm>     *</span>
<span class=cm>     * @param measureSpec the measure specification to extract the mode from</span>
<span class=cm>     * @return {@link android.view.View.MeasureSpec#UNSPECIFIED},</span>
<span class=cm>     *         {@link android.view.View.MeasureSpec#AT_MOST} or</span>
<span class=cm>     *         {@link android.view.View.MeasureSpec#EXACTLY}</span>
<span class=cm>     */</span>
    <span class=nd>@MeasureSpecMode</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getMode</span><span class=p>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>//noinspection ResourceType</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>measureSpec</span> <span class=o>&amp;</span> <span class=n>MODE_MASK</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * Extracts the size from the supplied measure specification.</span>
<span class=cm>     *</span>
<span class=cm>     * @param measureSpec the measure specification to extract the size from</span>
<span class=cm>     * @return the size in pixels defined in the supplied measure specification</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=p>(</span><span class=kt>int</span> <span class=n>measureSpec</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>measureSpec</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MODE_MASK</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>
</pre></div></p> <p>MeasureSpec是一个32位int型值，高两位代表测量模式SpecMode，低30位代表测量规格SpecSize。MeasureSpec将SpecMode和SpecSize打包成一个int值来存储。上面就是其提供的打包、解包方法。</p> <p>SpecMode有三类：</p> <ul> <li><strong>UNSPECIFIED</strong><br> <strong>00</strong> 000000 00000000 00000000 00000000<br> 父容器对View没有任何限制，要多大给多大。这种情况一般用于系统内部。</li> <li><strong>EXACTLY</strong><br> <strong>01</strong> 000000 00000000 00000000 00000000<br> 父容器已经决定了View的精确尺寸，View的最终大小就是此时SpecSize所指定的大小。它对应于match_parent以及具体的数值。</li> <li><strong>AT_MOST</strong><br> <strong>10</strong> 000000 00000000 00000000 00000000<br> View想要多大就有多大，但是不能超过SpecSize。它对应于wrap_content。</li> </ul> <h3 id=22-measurespeclayoutparams>2.2 MeasureSpec和LayoutParams的对应关系<a class=headerlink href=#22-measurespeclayoutparams title="Permanent link">&para;</a></h3> <p>系统内部是通过MeasureSpec来进行View的测量，但是我们可以使用LayoutParams来更改这个结果。在View测量时，系统会将View的LayoutParams在父容器的约束下转换成对应的MeasureSpec，然后在根据这个MeasureSpec来确定View的最后宽高。注意：MeasureSpec不仅仅由LayoutParams决定，它还有父容器一起决定。<br> 另外，对于DecorView和普通View来说，MeasureSpec的转换过程略有不同。对于DecorView，因为其本身已经是顶级View了，没有父容器，所以其MeasureSpec由窗口尺寸和自身LayoutParams共同确定。 </p> <p>下面看看DecorView的测量过程，具体代码在<code>ViewRootImpl#measureHierarchy</code>方法中，desiredWindowWidth、desiredWindowHeight是Window的尺寸： <div class=codehilite><pre><span></span><span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getRootMeasureSpec</span><span class=p>(</span><span class=n>desiredWindowWidth</span><span class=p>,</span> <span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=p>);</span>
<span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getRootMeasureSpec</span><span class=p>(</span><span class=n>desiredWindowHeight</span><span class=p>,</span> <span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=p>);</span>
<span class=n>performMeasure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span> <span class=n>childHeightMeasureSpec</span><span class=p>);</span>
</pre></div> 接着是<code>getRootMeasureSpec</code>方法： <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getRootMeasureSpec</span><span class=p>(</span><span class=kt>int</span> <span class=n>windowSize</span><span class=p>,</span> <span class=kt>int</span> <span class=n>rootDimension</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>measureSpec</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>rootDimension</span><span class=p>)</span> <span class=p>{</span>

    <span class=k>case</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>:</span>
        <span class=c1>// Window can&#39;t resize. Force root view to be windowSize.</span>
        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>windowSize</span><span class=p>,</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>:</span>
        <span class=c1>// Window can resize. Set max size for root view.</span>
        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>windowSize</span><span class=p>,</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=k>default</span><span class=p>:</span>
        <span class=c1>// Window wants to be an exact size. Force root view to be that size.</span>
        <span class=n>measureSpec</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>rootDimension</span><span class=p>,</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>measureSpec</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> 在上面代码中，DecorView的MeasureSpec的产生过程已经很明确了：</p> <ul> <li>MATCH_PARENT：精确模式，大小为窗口尺寸</li> <li>WRAP_CONTENT：最大模式，大小不能超过窗口</li> <li>固定大小：精确模式，大小为LayoutParams中指定的大小。</li> </ul> <p>对普通View来说，View的测量过程由ViewGroup传递而来，先看一下<code>ViewGroup#measureChild</code>方法： <div class=codehilite><pre><span></span><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>measureChild</span><span class=p>(</span><span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=kt>int</span> <span class=n>parentWidthMeasureSpec</span><span class=p>,</span>
        <span class=kt>int</span> <span class=n>parentHeightMeasureSpec</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>final</span> <span class=n>LayoutParams</span> <span class=n>lp</span> <span class=o>=</span> <span class=n>child</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span>

    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childWidthMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=p>(</span><span class=n>parentWidthMeasureSpec</span><span class=p>,</span>
            <span class=n>mPaddingLeft</span> <span class=o>+</span> <span class=n>mPaddingRight</span><span class=p>,</span> <span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=p>);</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeightMeasureSpec</span> <span class=o>=</span> <span class=n>getChildMeasureSpec</span><span class=p>(</span><span class=n>parentHeightMeasureSpec</span><span class=p>,</span>
            <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=n>mPaddingBottom</span><span class=p>,</span> <span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=p>);</span>

    <span class=n>child</span><span class=p>.</span><span class=na>measure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span> <span class=n>childHeightMeasureSpec</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></p> <p>上面代码会对子View进行measure，在调用之前会通过<code>getChildMeasureSpec</code>来得到子View的MeasureSpec，参数中spec是Parent的spec：</p> <p><div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getChildMeasureSpec</span><span class=p>(</span><span class=kt>int</span> <span class=n>spec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>padding</span><span class=p>,</span> <span class=kt>int</span> <span class=n>childDimension</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>specMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>spec</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>specSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>spec</span><span class=p>);</span>

    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>specSize</span> <span class=o>-</span> <span class=n>padding</span><span class=p>);</span>

    <span class=kt>int</span> <span class=n>resultSize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>resultMode</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=k>switch</span> <span class=p>(</span><span class=n>specMode</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Parent has imposed an exact size on us</span>
    <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>:</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants to be our size. So be it.</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants to determine its own size. It can&#39;t be</span>
            <span class=c1>// bigger than us.</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>break</span><span class=p>;</span>

    <span class=c1>// Parent has imposed a maximum size on us</span>
    <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>:</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants a specific size... so be it</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants to be our size, but our size is not fixed.</span>
            <span class=c1>// Constrain child to not be bigger than us.</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants to determine its own size. It can&#39;t be</span>
            <span class=c1>// bigger than us.</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>break</span><span class=p>;</span>

    <span class=c1>// Parent asked to see how big we want to be</span>
    <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>:</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants a specific size... let him have it</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>childDimension</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants to be our size... find out how big it should</span>
            <span class=c1>// be</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>View</span><span class=p>.</span><span class=na>sUseZeroUnspecifiedMeasureSpec</span> <span class=o>?</span> <span class=mi>0</span> <span class=p>:</span> <span class=n>size</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>childDimension</span> <span class=o>==</span> <span class=n>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Child wants to determine its own size.... find out how</span>
            <span class=c1>// big it should be</span>
            <span class=n>resultSize</span> <span class=o>=</span> <span class=n>View</span><span class=p>.</span><span class=na>sUseZeroUnspecifiedMeasureSpec</span> <span class=o>?</span> <span class=mi>0</span> <span class=p>:</span> <span class=n>size</span><span class=p>;</span>
            <span class=n>resultMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>//noinspection ResourceType</span>
    <span class=k>return</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>resultSize</span><span class=p>,</span> <span class=n>resultMode</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> 从代码中不难看出，子View的MeasureSpec是由父容器MeasureSpec和自身LayoutParams有关。padding是父容器中已经占用的空间大小，因此子元素可用大小需要减去这部分。此方法清除的展示了普通View的MeasureSpec的创建过程，由该方法转化而来的表如下：</p> <figcaption>子View如何根据父MeasureSpec以及自身LayoutParams来确定尺寸</figcaption> <table> <thead> <tr> <th align=center></th> <th>EXACTLY</th> <th>AT_MOST</th> <th>UNSPECIFIED</th> </tr> </thead> <tbody> <tr> <td align=center>dp/px</td> <td>EXACTLY<br>childSize</td> <td>EXACTLY<br>childSize</td> <td>EXACTLY<br>childSize</td> </tr> <tr> <td align=center>match_parent</td> <td>EXACTLY<br>parentSize</td> <td>AT_MOST<br>parentSize</td> <td>UNSPECIFIED<br>0</td> </tr> <tr> <td align=center>wrap_content</td> <td>AT_MOST<br>parentSize</td> <td>AT_MOST<br>parentSize</td> <td>UNSPECIFIED<br>0</td> </tr> </tbody> </table> <h2 id=3-view>3 View的工作流程<a class=headerlink href=#3-view title="Permanent link">&para;</a></h2> <p>View的工作流程指measure、layout、draw三大流程，即测量、布局和绘制。其中，measure确定View的测量宽高，layout确定View的最终宽高和四个顶点的位置，而draw则将View绘制到屏幕上。</p> <h3 id=31-measure>3.1 measure过程<a class=headerlink href=#31-measure title="Permanent link">&para;</a></h3> <h4 id=311-viewmeasure>3.1.1 View的measure过程<a class=headerlink href=#311-viewmeasure title="Permanent link">&para;</a></h4> <p>View的measure过程由其<code>measure</code>方法来完成，这是一个final类型的方法，这意味着子类不能重写其方法。在View的<code>measure</code>方法中回去调用View的<code>onMeasure</code>方法，因此只需要看<code>onMeasure</code>的实现即可。 <div class=codehilite><pre><span></span><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>setMeasuredDimension</span><span class=p>(</span><span class=n>getDefaultSize</span><span class=p>(</span><span class=n>getSuggestedMinimumWidth</span><span class=p>(),</span> <span class=n>widthMeasureSpec</span><span class=p>),</span>
            <span class=n>getDefaultSize</span><span class=p>(</span><span class=n>getSuggestedMinimumHeight</span><span class=p>(),</span> <span class=n>heightMeasureSpec</span><span class=p>));</span>
<span class=p>}</span>
</pre></div> <code>setMeasuredDimension</code>方法会设置View的测量宽高。我们接着看<code>getDefaultSize</code>和<code>getSuggestedMinimumWidth()</code>。 <div class=codehilite><pre><span></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getDefaultSize</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>,</span> <span class=kt>int</span> <span class=n>measureSpec</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
        <span class=kt>int</span> <span class=n>specMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>measureSpec</span><span class=p>);</span>
        <span class=kt>int</span> <span class=n>specSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>measureSpec</span><span class=p>);</span>

        <span class=k>switch</span> <span class=p>(</span><span class=n>specMode</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>:</span>
        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>specSize</span><span class=p>;</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getSuggestedMinimumWidth</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>mBackground</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=o>?</span> <span class=n>mMinWidth</span> <span class=p>:</span> <span class=n>max</span><span class=p>(</span><span class=n>mMinWidth</span><span class=p>,</span> <span class=n>mBackground</span><span class=p>.</span><span class=na>getMinimumWidth</span><span class=p>());</span>
    <span class=p>}</span>
</pre></div></p> <p><code>getDefaultSize</code>我们只看AT_MOST和EXACTLY的情况，因此可以简单的理解为此方法就是返回的size就是specSize。 至于UNSPECIFIED，一般用于系统内部的测量过程，此时，View的大小为<code>getSuggestedMinimumWidth</code>和<code>getSuggestedMinimumHeight</code>。从源码中可以看出，如果View没有背景，那么View的宽度为mMinWidth（即android:minWidth指定的值）；如果View有背景，则宽度为<code>max(mMinWidth, mBackground.getMinimumWidth())</code>。mBackground是一个Drawable对象，其<code>getMinimumWidth</code>方法如下：</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>int</span> <span class=nf>getMinimumWidth</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>intrinsicWidth</span> <span class=o>=</span> <span class=n>getIntrinsicWidth</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>intrinsicWidth</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=n>intrinsicWidth</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> <p>因此<code>getMinimumWidth</code>返回的就是Drawable的原始宽度，若没有原始宽度则返回0。不是所有的Drawable对象都有原始宽度，ShapeDrawable没有原始宽高，而BitmapDrawable就有。</p> <h4 id=312-viewonmeasure>3.1.2 自定义View为何需要重写onMeasure方法<a class=headerlink href=#312-viewonmeasure title="Permanent link">&para;</a></h4> <p>从<code>getDefaultSize</code>的实现来看，View的宽高从specSize决定，所以**直接继承View的自定义控件需要重写<code>onMeasure</code>方法并设置wrap_content时的自身大小，否则在布局中使用wrap_content相当于使用match_parent**。 </p> <p>这是因为如果View使用wrap_content，那么其specMode对应AT_MOST，且由上面代码可以看出宽高为specSize；在由上面的表得知，此时View的specSize就是parentSize，而parentSize就是父容器可用剩余空间。这种效果和在布局中使用match_parent效果一样。解决办法就是给View指定一个默认的内部宽高，在wrap_content时设置即可。</p> <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>super</span><span class=p>.</span><span class=na>onMeasure</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=n>heightMeasureSpec</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>widthSpecMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>heightSpecMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>widthSpecMode</span> <span class=o>==</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span> <span class=o>&amp;&amp;</span> <span class=n>heightSpecMode</span> <span class=o>==</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>setMeasuredDimension</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=mi>200</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>widthSpecMode</span> <span class=o>==</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span> <span class=p>)</span> <span class=p>{</span>
        <span class=n>setMeasuredDimension</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=n>heightMeasureSpec</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>heightSpecMode</span> <span class=o>==</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>setMeasuredDimension</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=mi>200</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <h4 id=313-viewgroupmeasure>3.1.3 ViewGroup的measure过程<a class=headerlink href=#313-viewgroupmeasure title="Permanent link">&para;</a></h4> <p>对于ViewGroup来说，除了完成自己的measure外，还会遍历调用所有子元素的<code>measure</code>方法，各个子元素再递归执行这个过程。ViewGroup是一个抽象类，因此它并没有重写View的<code>onMeasure</code>方法，这个方法需要具体的ViewGroup类（比如LinearLayout、RelativeLayout等）来实现。下面我们通过LinearLayout来分析。 首先我们看一下<code>LinearLayout#onMeasure</code>方法： <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mOrientation</span> <span class=o>==</span> <span class=n>VERTICAL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>measureVertical</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=n>heightMeasureSpec</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>measureHorizontal</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=n>heightMeasureSpec</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> LinearLayout会根据orientation的值来调用不同的方法，此处我们选择竖直方向的<code>measureVertical</code>方法： <div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>measureVertical</span><span class=p>(</span><span class=kt>int</span> <span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>heightMeasureSpec</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=c1>// See how tall everyone is. Also remember max width.</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=n>View</span> <span class=n>child</span> <span class=o>=</span> <span class=n>getVirtualChildAt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>

        <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>useExcessSpace</span> <span class=o>=</span> <span class=n>lp</span><span class=p>.</span><span class=na>height</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>lp</span><span class=p>.</span><span class=na>weight</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>heightMode</span> <span class=o>==</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span> <span class=o>&amp;&amp;</span> <span class=n>useExcessSpace</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Optimization: don&#39;t bother measuring children who are only</span>
            <span class=c1>// laid out using excess space. These views will get measured</span>
            <span class=c1>// later if we have space to distribute.</span>
            <span class=kd>final</span> <span class=kt>int</span> <span class=n>totalLength</span> <span class=o>=</span> <span class=n>mTotalLength</span><span class=p>;</span>
            <span class=n>mTotalLength</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>totalLength</span><span class=p>,</span> <span class=n>totalLength</span> <span class=o>+</span> <span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span> <span class=o>+</span> <span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span><span class=p>);</span>
            <span class=n>skippedMeasure</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
           <span class=p>...</span>
            <span class=c1>// Determine how big this child would like to be. If this or</span>
            <span class=c1>// previous children have given a weight, then we allow it to</span>
            <span class=c1>// use all available space (and we will shrink things later</span>
            <span class=c1>// if needed).</span>
            <span class=kd>final</span> <span class=kt>int</span> <span class=n>usedHeight</span> <span class=o>=</span> <span class=n>totalWeight</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>?</span> <span class=n>mTotalLength</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
            <span class=n>measureChildBeforeLayout</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>
                    <span class=n>heightMeasureSpec</span><span class=p>,</span> <span class=n>usedHeight</span><span class=p>);</span>

            <span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeight</span> <span class=o>=</span> <span class=n>child</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span>
            <span class=p>...</span>

            <span class=kd>final</span> <span class=kt>int</span> <span class=n>totalLength</span> <span class=o>=</span> <span class=n>mTotalLength</span><span class=p>;</span>
            <span class=n>mTotalLength</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>totalLength</span><span class=p>,</span> <span class=n>totalLength</span> <span class=o>+</span> <span class=n>childHeight</span> <span class=o>+</span> <span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span> <span class=o>+</span>
                   <span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span> <span class=o>+</span> <span class=n>getNextLocationOffset</span><span class=p>(</span><span class=n>child</span><span class=p>));</span>
            <span class=p>...</span>
        <span class=p>}</span>
    <span class=p>...</span>
    <span class=c1>// Add in our padding</span>
    <span class=n>mTotalLength</span> <span class=o>+=</span> <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=n>mPaddingBottom</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>heightSize</span> <span class=o>=</span> <span class=n>mTotalLength</span><span class=p>;</span>

    <span class=c1>// Check against our minimum height</span>
    <span class=n>heightSize</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>heightSize</span><span class=p>,</span> <span class=n>getSuggestedMinimumHeight</span><span class=p>());</span>

    <span class=c1>// Reconcile our calculated size with the heightMeasureSpec</span>
    <span class=kt>int</span> <span class=n>heightSizeAndState</span> <span class=o>=</span> <span class=n>resolveSizeAndState</span><span class=p>(</span><span class=n>heightSize</span><span class=p>,</span> <span class=n>heightMeasureSpec</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=n>heightSize</span> <span class=o>=</span> <span class=n>heightSizeAndState</span> <span class=o>&amp;</span> <span class=n>MEASURED_SIZE_MASK</span><span class=p>;</span>

    <span class=p>...</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>allFillParent</span> <span class=o>&amp;&amp;</span> <span class=n>widthMode</span> <span class=o>!=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>maxWidth</span> <span class=o>=</span> <span class=n>alternativeMaxWidth</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>maxWidth</span> <span class=o>+=</span> <span class=n>mPaddingLeft</span> <span class=o>+</span> <span class=n>mPaddingRight</span><span class=p>;</span>

    <span class=c1>// Check against our minimum width</span>
    <span class=n>maxWidth</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxWidth</span><span class=p>,</span> <span class=n>getSuggestedMinimumWidth</span><span class=p>());</span>

    <span class=n>setMeasuredDimension</span><span class=p>(</span><span class=n>resolveSizeAndState</span><span class=p>(</span><span class=n>maxWidth</span><span class=p>,</span> <span class=n>widthMeasureSpec</span><span class=p>,</span> <span class=n>childState</span><span class=p>),</span>
            <span class=n>heightSizeAndState</span><span class=p>);</span>
    <span class=p>...</span>
<span class=p>}</span>
</pre></div> 上面的代码描述了主要逻辑，我们可以看出在LinearLayout的<code>measureVertical</code>方法会在会判断LinearLayout的heightSpecMode。如果是精确模式且子元素高为0、有权重，则直接设置高度，然后跳过测量；如果是AT_MOST，则需要测量。系统会通过<code>measureChildBeforeLayout</code>---&gt;<code>measureChildWithMargins</code>---&gt;<code>child.measure</code>，这样各个子元素就依次进入measure过程，然后系统会通过mTotalLength变量存储自身测量出来的高度。每测量一个元素，mTotalLength就会增加，增加部分包括子元素的高度以及子元素的在竖直方向上的margin。 子元素测量完成后，LinearLayout会测量自己的大小，其具体过程是通过<code>View#resolveSizeAndState</code>方法来完成的： <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>resolveSizeAndState</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>,</span> <span class=kt>int</span> <span class=n>measureSpec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>childMeasuredState</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>specMode</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>measureSpec</span><span class=p>);</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>specSize</span> <span class=o>=</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>measureSpec</span><span class=p>);</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>result</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>specMode</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>:</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>specSize</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>result</span> <span class=o>=</span> <span class=n>specSize</span> <span class=o>|</span> <span class=n>MEASURED_STATE_TOO_SMALL</span><span class=p>;</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>specSize</span><span class=p>;</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>:</span>
        <span class=k>default</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>result</span> <span class=o>|</span> <span class=p>(</span><span class=n>childMeasuredState</span> <span class=o>&amp;</span> <span class=n>MEASURED_STATE_MASK</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> 针对竖直的LinearLayout而言，它在水平方向的测量过程遵循View的测量过程。在竖直方向的测量过程和View稍有不同：如果是match_parent或具体数字（也就是EXACTLY模式），那么其过程和View一样；如果是wrap_content，那么其高度是所有子元素加上竖直方向padding之和，但是不能超过父容器的剩余空间。</p> <p>View的measure过程是三大流程中最复杂的一个，measure完成后，可以通过<code>getMeasuredWidth/Height</code>方法来获取View的测量宽高。需要注意，在某些极端情况下，系统会进行多次测量，此时在<code>onMeasure</code>中拿到的测量宽高可能是不准确的，比较好的方式是在<code>onLayout</code>中去获取测量宽高。</p> <h4 id=314-activityview>3.1.4 Activity中获取View宽高的几种方式<a class=headerlink href=#314-activityview title="Permanent link">&para;</a></h4> <p><strong>1. Activity/View#onWindowFocusChanged</strong><br> 注意，此方法伴随着Activity的生命周期会被多次回调，具体来说，当Activity得到焦点和失去焦点时会被回调。 <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onWindowFocusChanged</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>hasWindowFocus</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>super</span><span class=p>.</span><span class=na>onWindowFocusChanged</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span>
        <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div></p> <p><strong>2. View#post(Runnable)</strong><br> 使用post可以将一个runnable投递到消息队列的尾部，然后等待Looper调用此runnable，View也初始化好了。 <div class=codehilite><pre><span></span><span class=n>view</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span>
        <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>});</span>
</pre></div></p> <p><strong>3. ViewTreeObserver#onGlobalLayoutListener</strong><br> <code>ViewTreeObserver#onGlobalLayoutListener</code>接口会在View树的状态发生改变或者View树内部View可见性发生改变时回调。需要注意的是，伴随着View树的状态改变，此接口会被多次回调，因此可以在适当的时候取消监听。 <div class=codehilite><pre><span></span><span class=n>ViewTreeObserver</span> <span class=n>observer</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getViewTreeObserver</span><span class=p>();</span>
<span class=n>observer</span><span class=p>.</span><span class=na>addOnGlobalLayoutListener</span><span class=p>(</span><span class=k>new</span> <span class=n>ViewTreeObserver</span><span class=p>.</span><span class=na>OnGlobalLayoutListener</span><span class=p>()</span> <span class=p>{</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onGlobalLayout</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>view</span><span class=p>.</span><span class=na>getViewTreeObserver</span><span class=p>().</span><span class=na>removeOnGlobalLayoutListener</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
        <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span>
        <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>view</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>});</span>
</pre></div></p> <p><strong>4. View#measure</strong><br> 可以手动对View进行measure操作来获取View的宽高。但是此方法比较复杂，且有局限性。但在某些情景下（比如，自定义ViewGroup，需要事先获取子View的宽高）非常适用了。</p> <h3 id=32-layout>3.2 layout过程<a class=headerlink href=#32-layout title="Permanent link">&para;</a></h3> <p>Layout过程比Measure过程简单多了，ViewGroup的位置被确定后，会在onLayout中遍历所有的子元素并调用其layout方法，在layout方法又会调用onLayout方法。layout方法确定View本身的位置，onLayout方法会确定所有子元素的位置。</p> <h4 id=321-viewlayout>3.2.1 View的layout过程<a class=headerlink href=#321-viewlayout title="Permanent link">&para;</a></h4> <p>View的layout过程非常简单。 <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>layout</span><span class=p>(</span><span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>t</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>mPrivateFlags3</span> <span class=o>&amp;</span> <span class=n>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>onMeasure</span><span class=p>(</span><span class=n>mOldWidthMeasureSpec</span><span class=p>,</span> <span class=n>mOldHeightMeasureSpec</span><span class=p>);</span>
        <span class=n>mPrivateFlags3</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kt>int</span> <span class=n>oldL</span> <span class=o>=</span> <span class=n>mLeft</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>oldT</span> <span class=o>=</span> <span class=n>mTop</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>oldB</span> <span class=o>=</span> <span class=n>mBottom</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>oldR</span> <span class=o>=</span> <span class=n>mRight</span><span class=p>;</span>

    <span class=kt>boolean</span> <span class=n>changed</span> <span class=o>=</span> <span class=n>isLayoutModeOptical</span><span class=p>(</span><span class=n>mParent</span><span class=p>)</span> <span class=o>?</span>
            <span class=n>setOpticalFrame</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span> <span class=p>:</span> <span class=n>setFrame</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>changed</span> <span class=o>||</span> <span class=p>(</span><span class=n>mPrivateFlags</span> <span class=o>&amp;</span> <span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=p>)</span> <span class=o>==</span> <span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>onLayout</span><span class=p>(</span><span class=n>changed</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>shouldDrawRoundScrollbar</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>if</span><span class=p>(</span><span class=n>mRoundScrollbarRenderer</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>mRoundScrollbarRenderer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RoundScrollbarRenderer</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>mRoundScrollbarRenderer</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>mPrivateFlags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=p>;</span>

        <span class=n>ListenerInfo</span> <span class=n>li</span> <span class=o>=</span> <span class=n>mListenerInfo</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>li</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>li</span><span class=p>.</span><span class=na>mOnLayoutChangeListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>OnLayoutChangeListener</span><span class=o>&gt;</span> <span class=n>listenersCopy</span> <span class=o>=</span>
                    <span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>OnLayoutChangeListener</span><span class=o>&gt;</span><span class=p>)</span><span class=n>li</span><span class=p>.</span><span class=na>mOnLayoutChangeListeners</span><span class=p>.</span><span class=na>clone</span><span class=p>();</span>
            <span class=kt>int</span> <span class=n>numListeners</span> <span class=o>=</span> <span class=n>listenersCopy</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>numListeners</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>listenersCopy</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>onLayoutChange</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>oldL</span><span class=p>,</span> <span class=n>oldT</span><span class=p>,</span> <span class=n>oldR</span><span class=p>,</span> <span class=n>oldB</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=n>mPrivateFlags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>PFLAG_FORCE_LAYOUT</span><span class=p>;</span>
    <span class=n>mPrivateFlags3</span> <span class=o>|=</span> <span class=n>PFLAG3_IS_LAID_OUT</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> 对于View来说，最终都会通过<code>setFrame</code>方法来设定View的四个位置参数，这些参数一旦确定，View在父容器中的位置也就确定了。然后会调用<code>onLayout</code>方法，此方法会让父容器用来确定子元素位置，在View和ViewGroup中都是一个空实现，在各个ViewGroup的子类中会实现。最后，如果View设置有<code>OnLayoutChangeListener</code>监听器，会回调这些监听器的方法。 下面是<code>setFrame</code>的部分代码，这里我们看到有对四个位置参数的赋值操作： <div class=codehilite><pre><span></span><span class=n>mLeft</span> <span class=o>=</span> <span class=n>left</span><span class=p>;</span>
<span class=n>mTop</span> <span class=o>=</span> <span class=n>top</span><span class=p>;</span>
<span class=n>mRight</span> <span class=o>=</span> <span class=n>right</span><span class=p>;</span>
<span class=n>mBottom</span> <span class=o>=</span> <span class=n>bottom</span><span class=p>;</span>
</pre></div></p> <h4 id=322-viewgrouplayout>3.2.2 ViewGroup的layout过程<a class=headerlink href=#322-viewgrouplayout title="Permanent link">&para;</a></h4> <p>ViewGroup本身的layout过程调用的是<code>super.layout</code>方法，不同的是ViewGroup还要对子元素进行layout操作。但是由于ViewGroup是一个抽象类，所以<code>onLayout</code>在ViewGroup中是一个空实现。我们这里看LinearLayout的方法： <div class=codehilite><pre><span></span><span class=nd>@Override</span>
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onLayout</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>changed</span><span class=p>,</span> <span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>t</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mOrientation</span> <span class=o>==</span> <span class=n>VERTICAL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>layoutVertical</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>layoutHorizontal</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>layoutVertical</span><span class=p>(</span><span class=kt>int</span> <span class=n>left</span><span class=p>,</span> <span class=kt>int</span> <span class=n>top</span><span class=p>,</span> <span class=kt>int</span> <span class=n>right</span><span class=p>,</span> <span class=kt>int</span> <span class=n>bottom</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>paddingLeft</span> <span class=o>=</span> <span class=n>mPaddingLeft</span><span class=p>;</span>

    <span class=kt>int</span> <span class=n>childTop</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>childLeft</span><span class=p>;</span>

    <span class=c1>// Where right end of child should go</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>right</span> <span class=o>-</span> <span class=n>left</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>childRight</span> <span class=o>=</span> <span class=n>width</span> <span class=o>-</span> <span class=n>mPaddingRight</span><span class=p>;</span>

    <span class=c1>// Space available for child</span>
    <span class=kt>int</span> <span class=n>childSpace</span> <span class=o>=</span> <span class=n>width</span> <span class=o>-</span> <span class=n>paddingLeft</span> <span class=o>-</span> <span class=n>mPaddingRight</span><span class=p>;</span>

    <span class=kd>final</span> <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>getVirtualChildCount</span><span class=p>();</span>

    <span class=kd>final</span> <span class=kt>int</span> <span class=n>majorGravity</span> <span class=o>=</span> <span class=n>mGravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>VERTICAL_GRAVITY_MASK</span><span class=p>;</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>minorGravity</span> <span class=o>=</span> <span class=n>mGravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>RELATIVE_HORIZONTAL_GRAVITY_MASK</span><span class=p>;</span>

    <span class=k>switch</span> <span class=p>(</span><span class=n>majorGravity</span><span class=p>)</span> <span class=p>{</span>
       <span class=k>case</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>BOTTOM</span><span class=p>:</span>
           <span class=c1>// mTotalLength contains the padding already</span>
           <span class=n>childTop</span> <span class=o>=</span> <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span> <span class=o>-</span> <span class=n>mTotalLength</span><span class=p>;</span>
           <span class=k>break</span><span class=p>;</span>

           <span class=c1>// mTotalLength contains the padding already</span>
       <span class=k>case</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>CENTER_VERTICAL</span><span class=p>:</span>
           <span class=n>childTop</span> <span class=o>=</span> <span class=n>mPaddingTop</span> <span class=o>+</span> <span class=p>(</span><span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span> <span class=o>-</span> <span class=n>mTotalLength</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
           <span class=k>break</span><span class=p>;</span>

       <span class=k>case</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>TOP</span><span class=p>:</span>
       <span class=k>default</span><span class=p>:</span>
           <span class=n>childTop</span> <span class=o>=</span> <span class=n>mPaddingTop</span><span class=p>;</span>
           <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=n>View</span> <span class=n>child</span> <span class=o>=</span> <span class=n>getVirtualChildAt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>child</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>childTop</span> <span class=o>+=</span> <span class=n>measureNullChild</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>child</span><span class=p>.</span><span class=na>getVisibility</span><span class=p>()</span> <span class=o>!=</span> <span class=n>GONE</span><span class=p>)</span> <span class=p>{</span>
            <span class=kd>final</span> <span class=kt>int</span> <span class=n>childWidth</span> <span class=o>=</span> <span class=n>child</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span>
            <span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeight</span> <span class=o>=</span> <span class=n>child</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span>

            <span class=kd>final</span> <span class=n>LinearLayout</span><span class=p>.</span><span class=na>LayoutParams</span> <span class=n>lp</span> <span class=o>=</span>
                    <span class=p>(</span><span class=n>LinearLayout</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span> <span class=n>child</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span>

            <span class=kt>int</span> <span class=n>gravity</span> <span class=o>=</span> <span class=n>lp</span><span class=p>.</span><span class=na>gravity</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>gravity</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>gravity</span> <span class=o>=</span> <span class=n>minorGravity</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=kd>final</span> <span class=kt>int</span> <span class=n>layoutDirection</span> <span class=o>=</span> <span class=n>getLayoutDirection</span><span class=p>();</span>
            <span class=kd>final</span> <span class=kt>int</span> <span class=n>absoluteGravity</span> <span class=o>=</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>getAbsoluteGravity</span><span class=p>(</span><span class=n>gravity</span><span class=p>,</span> <span class=n>layoutDirection</span><span class=p>);</span>
            <span class=k>switch</span> <span class=p>(</span><span class=n>absoluteGravity</span> <span class=o>&amp;</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>HORIZONTAL_GRAVITY_MASK</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>case</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>CENTER_HORIZONTAL</span><span class=p>:</span>
                    <span class=n>childLeft</span> <span class=o>=</span> <span class=n>paddingLeft</span> <span class=o>+</span> <span class=p>((</span><span class=n>childSpace</span> <span class=o>-</span> <span class=n>childWidth</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
                            <span class=o>+</span> <span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span> <span class=o>-</span> <span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=p>;</span>
                    <span class=k>break</span><span class=p>;</span>

                <span class=k>case</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>RIGHT</span><span class=p>:</span>
                    <span class=n>childLeft</span> <span class=o>=</span> <span class=n>childRight</span> <span class=o>-</span> <span class=n>childWidth</span> <span class=o>-</span> <span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=p>;</span>
                    <span class=k>break</span><span class=p>;</span>

                <span class=k>case</span> <span class=n>Gravity</span><span class=p>.</span><span class=na>LEFT</span><span class=p>:</span>
                <span class=k>default</span><span class=p>:</span>
                    <span class=n>childLeft</span> <span class=o>=</span> <span class=n>paddingLeft</span> <span class=o>+</span> <span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span><span class=p>;</span>
                    <span class=k>break</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>hasDividerBeforeChildAt</span><span class=p>(</span><span class=n>i</span><span class=p>))</span> <span class=p>{</span>
                <span class=n>childTop</span> <span class=o>+=</span> <span class=n>mDividerHeight</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=n>childTop</span> <span class=o>+=</span> <span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=p>;</span>
            <span class=n>setChildFrame</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>childLeft</span><span class=p>,</span> <span class=n>childTop</span> <span class=o>+</span> <span class=n>getLocationOffset</span><span class=p>(</span><span class=n>child</span><span class=p>),</span>
                    <span class=n>childWidth</span><span class=p>,</span> <span class=n>childHeight</span><span class=p>);</span>
            <span class=n>childTop</span> <span class=o>+=</span> <span class=n>childHeight</span> <span class=o>+</span> <span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span> <span class=o>+</span> <span class=n>getNextLocationOffset</span><span class=p>(</span><span class=n>child</span><span class=p>);</span>

            <span class=n>i</span> <span class=o>+=</span> <span class=n>getChildrenSkipCount</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> 我们还是只看竖直方向的<code>layoutVertical</code>方法，这个方法逻辑还是很清楚的。它会对所有子元素调用<code>setChildFrame</code>方法，其中childTop会不断累加，这就意味着后面的元素被放置在靠下的位置。并且<code>setFrame</code>中传入的width、height两个参数就是这个子元素的测量宽高。 <div class=codehilite><pre><span></span><span class=kd>final</span> <span class=kt>int</span> <span class=n>childWidth</span> <span class=o>=</span> <span class=n>child</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span>
<span class=kd>final</span> <span class=kt>int</span> <span class=n>childHeight</span> <span class=o>=</span> <span class=n>child</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span>
<span class=n>setChildFrame</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>childLeft</span><span class=p>,</span> <span class=n>childTop</span> <span class=o>+</span> <span class=n>getLocationOffset</span><span class=p>(</span><span class=n>child</span><span class=p>),</span> <span class=n>childWidth</span><span class=p>,</span> <span class=n>childHeight</span><span class=p>);</span>
</pre></div> 至于<code>setChildFrame</code>方法，它仅仅是调用子元素的<code>layout</code>方法。这样layout操作就会传递到子元素中，子元素会继续这么执行，一直到完成整个View树的layout过程。 <div class=codehilite><pre><span></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>setChildFrame</span><span class=p>(</span><span class=n>View</span> <span class=n>child</span><span class=p>,</span> <span class=kt>int</span> <span class=n>left</span><span class=p>,</span> <span class=kt>int</span> <span class=n>top</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>)</span> <span class=p>{</span>        
    <span class=n>child</span><span class=p>.</span><span class=na>layout</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>top</span><span class=p>,</span> <span class=n>left</span> <span class=o>+</span> <span class=n>width</span><span class=p>,</span> <span class=n>top</span> <span class=o>+</span> <span class=n>height</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></p> <h3 id=33-draw>3.3 draw过程<a class=headerlink href=#33-draw title="Permanent link">&para;</a></h3> <p>draw过程更简单，我们看下<code>View#draw</code>： <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>draw</span><span class=p>(</span><span class=n>Canvas</span> <span class=n>canvas</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>privateFlags</span> <span class=o>=</span> <span class=n>mPrivateFlags</span><span class=p>;</span>
    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>dirtyOpaque</span> <span class=o>=</span> <span class=p>(</span><span class=n>privateFlags</span> <span class=o>&amp;</span> <span class=n>PFLAG_DIRTY_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=n>PFLAG_DIRTY_OPAQUE</span> <span class=o>&amp;&amp;</span>
            <span class=p>(</span><span class=n>mAttachInfo</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mIgnoreDirtyState</span><span class=p>);</span>
    <span class=n>mPrivateFlags</span> <span class=o>=</span> <span class=p>(</span><span class=n>privateFlags</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>PFLAG_DIRTY_MASK</span><span class=p>)</span> <span class=o>|</span> <span class=n>PFLAG_DRAWN</span><span class=p>;</span>

    <span class=cm>/*</span>
<span class=cm>     * Draw traversal performs several drawing steps which must be executed</span>
<span class=cm>     * in the appropriate order:</span>
<span class=cm>     *</span>
<span class=cm>     *      1. Draw the background</span>
<span class=cm>     *      2. If necessary, save the canvas&#39; layers to prepare for fading</span>
<span class=cm>     *      3. Draw view&#39;s content</span>
<span class=cm>     *      4. Draw children</span>
<span class=cm>     *      5. If necessary, draw the fading edges and restore layers</span>
<span class=cm>     *      6. Draw decorations (scrollbars for instance)</span>
<span class=cm>     */</span>

    <span class=c1>// Step 1, draw the background, if needed</span>
    <span class=kt>int</span> <span class=n>saveCount</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dirtyOpaque</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>drawBackground</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// skip step 2 &amp; 5 if possible (common case)</span>
    <span class=kd>final</span> <span class=kt>int</span> <span class=n>viewFlags</span> <span class=o>=</span> <span class=n>mViewFlags</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>horizontalEdges</span> <span class=o>=</span> <span class=p>(</span><span class=n>viewFlags</span> <span class=o>&amp;</span> <span class=n>FADING_EDGE_HORIZONTAL</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>verticalEdges</span> <span class=o>=</span> <span class=p>(</span><span class=n>viewFlags</span> <span class=o>&amp;</span> <span class=n>FADING_EDGE_VERTICAL</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>verticalEdges</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>horizontalEdges</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Step 3, draw the content</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dirtyOpaque</span><span class=p>)</span> <span class=n>onDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>

        <span class=c1>// Step 4, draw the children</span>
        <span class=n>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>

        <span class=c1>// Overlay is part of the content and draws beneath Foreground</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mOverlay</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mOverlay</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>mOverlay</span><span class=p>.</span><span class=na>getOverlayView</span><span class=p>().</span><span class=na>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// Step 6, draw decorations (foreground, scrollbars)</span>
        <span class=n>onDrawForeground</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>

        <span class=c1>// we&#39;re done...</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/*</span>
<span class=cm>     * Here we do the full fledged routine...</span>
<span class=cm>     * (this is an uncommon case where speed matters less,</span>
<span class=cm>     * this is why we repeat some of the tests that have been</span>
<span class=cm>     * done above)</span>
<span class=cm>     */</span>

    <span class=kt>boolean</span> <span class=n>drawTop</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>drawBottom</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>drawLeft</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=kt>boolean</span> <span class=n>drawRight</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>

    <span class=kt>float</span> <span class=n>topFadeStrength</span> <span class=o>=</span> <span class=mf>0.0f</span><span class=p>;</span>
    <span class=kt>float</span> <span class=n>bottomFadeStrength</span> <span class=o>=</span> <span class=mf>0.0f</span><span class=p>;</span>
    <span class=kt>float</span> <span class=n>leftFadeStrength</span> <span class=o>=</span> <span class=mf>0.0f</span><span class=p>;</span>
    <span class=kt>float</span> <span class=n>rightFadeStrength</span> <span class=o>=</span> <span class=mf>0.0f</span><span class=p>;</span>

    <span class=c1>// Step 2, save the canvas&#39; layers</span>
    <span class=kt>int</span> <span class=n>paddingLeft</span> <span class=o>=</span> <span class=n>mPaddingLeft</span><span class=p>;</span>

    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>offsetRequired</span> <span class=o>=</span> <span class=n>isPaddingOffsetRequired</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>offsetRequired</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>paddingLeft</span> <span class=o>+=</span> <span class=n>getLeftPaddingOffset</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kt>int</span> <span class=n>left</span> <span class=o>=</span> <span class=n>mScrollX</span> <span class=o>+</span> <span class=n>paddingLeft</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>right</span> <span class=o>=</span> <span class=n>left</span> <span class=o>+</span> <span class=n>mRight</span> <span class=o>-</span> <span class=n>mLeft</span> <span class=o>-</span> <span class=n>mPaddingRight</span> <span class=o>-</span> <span class=n>paddingLeft</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>top</span> <span class=o>=</span> <span class=n>mScrollY</span> <span class=o>+</span> <span class=n>getFadeTop</span><span class=p>(</span><span class=n>offsetRequired</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>bottom</span> <span class=o>=</span> <span class=n>top</span> <span class=o>+</span> <span class=n>getFadeHeight</span><span class=p>(</span><span class=n>offsetRequired</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>offsetRequired</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>right</span> <span class=o>+=</span> <span class=n>getRightPaddingOffset</span><span class=p>();</span>
        <span class=n>bottom</span> <span class=o>+=</span> <span class=n>getBottomPaddingOffset</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kd>final</span> <span class=n>ScrollabilityCache</span> <span class=n>scrollabilityCache</span> <span class=o>=</span> <span class=n>mScrollCache</span><span class=p>;</span>
    <span class=kd>final</span> <span class=kt>float</span> <span class=n>fadeHeight</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>fadingEdgeLength</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>fadeHeight</span><span class=p>;</span>

    <span class=c1>// clip the fade length if top and bottom fades overlap</span>
    <span class=c1>// overlapping fades produce odd-looking artifacts</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>verticalEdges</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>top</span> <span class=o>+</span> <span class=n>length</span> <span class=o>&gt;</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>length</span> <span class=o>=</span> <span class=p>(</span><span class=n>bottom</span> <span class=o>-</span> <span class=n>top</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// also clip horizontal fades if necessary</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>horizontalEdges</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>left</span> <span class=o>+</span> <span class=n>length</span> <span class=o>&gt;</span> <span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>length</span> <span class=o>=</span> <span class=p>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>left</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>verticalEdges</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>topFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=mf>0.0f</span><span class=p>,</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=mf>1.0f</span><span class=p>,</span> <span class=n>getTopFadingEdgeStrength</span><span class=p>()));</span>
        <span class=n>drawTop</span> <span class=o>=</span> <span class=n>topFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=mf>1.0f</span><span class=p>;</span>
        <span class=n>bottomFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=mf>0.0f</span><span class=p>,</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=mf>1.0f</span><span class=p>,</span> <span class=n>getBottomFadingEdgeStrength</span><span class=p>()));</span>
        <span class=n>drawBottom</span> <span class=o>=</span> <span class=n>bottomFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=mf>1.0f</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>horizontalEdges</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>leftFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=mf>0.0f</span><span class=p>,</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=mf>1.0f</span><span class=p>,</span> <span class=n>getLeftFadingEdgeStrength</span><span class=p>()));</span>
        <span class=n>drawLeft</span> <span class=o>=</span> <span class=n>leftFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=mf>1.0f</span><span class=p>;</span>
        <span class=n>rightFadeStrength</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=mf>0.0f</span><span class=p>,</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=mf>1.0f</span><span class=p>,</span> <span class=n>getRightFadingEdgeStrength</span><span class=p>()));</span>
        <span class=n>drawRight</span> <span class=o>=</span> <span class=n>rightFadeStrength</span> <span class=o>*</span> <span class=n>fadeHeight</span> <span class=o>&gt;</span> <span class=mf>1.0f</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>saveCount</span> <span class=o>=</span> <span class=n>canvas</span><span class=p>.</span><span class=na>getSaveCount</span><span class=p>();</span>

    <span class=kt>int</span> <span class=n>solidColor</span> <span class=o>=</span> <span class=n>getSolidColor</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>solidColor</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>Canvas</span><span class=p>.</span><span class=na>HAS_ALPHA_LAYER_SAVE_FLAG</span><span class=p>;</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>drawTop</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>top</span><span class=p>,</span> <span class=n>right</span><span class=p>,</span> <span class=n>top</span> <span class=o>+</span> <span class=n>length</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>drawBottom</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=p>,</span> <span class=n>right</span><span class=p>,</span> <span class=n>bottom</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>drawLeft</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>top</span><span class=p>,</span> <span class=n>left</span> <span class=o>+</span> <span class=n>length</span><span class=p>,</span> <span class=n>bottom</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>drawRight</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=p>,</span> <span class=n>top</span><span class=p>,</span> <span class=n>right</span><span class=p>,</span> <span class=n>bottom</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>setFadeColor</span><span class=p>(</span><span class=n>solidColor</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Step 3, draw the content</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dirtyOpaque</span><span class=p>)</span> <span class=n>onDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>

    <span class=c1>// Step 4, draw the children</span>
    <span class=n>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>

    <span class=c1>// Step 5, draw the fade effect and restore layers</span>
    <span class=kd>final</span> <span class=n>Paint</span> <span class=n>p</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>paint</span><span class=p>;</span>
    <span class=kd>final</span> <span class=n>Matrix</span> <span class=n>matrix</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>matrix</span><span class=p>;</span>
    <span class=kd>final</span> <span class=n>Shader</span> <span class=n>fade</span> <span class=o>=</span> <span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>shader</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>drawTop</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>topFadeStrength</span><span class=p>);</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>top</span><span class=p>);</span>
        <span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span>
        <span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span>
        <span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>top</span><span class=p>,</span> <span class=n>right</span><span class=p>,</span> <span class=n>top</span> <span class=o>+</span> <span class=n>length</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>drawBottom</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>bottomFadeStrength</span><span class=p>);</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>postRotate</span><span class=p>(</span><span class=mi>180</span><span class=p>);</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>bottom</span><span class=p>);</span>
        <span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span>
        <span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span>
        <span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>bottom</span> <span class=o>-</span> <span class=n>length</span><span class=p>,</span> <span class=n>right</span><span class=p>,</span> <span class=n>bottom</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>drawLeft</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>leftFadeStrength</span><span class=p>);</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>postRotate</span><span class=p>(</span><span class=o>-</span><span class=mi>90</span><span class=p>);</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>top</span><span class=p>);</span>
        <span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span>
        <span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span>
        <span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>top</span><span class=p>,</span> <span class=n>left</span> <span class=o>+</span> <span class=n>length</span><span class=p>,</span> <span class=n>bottom</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>drawRight</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>fadeHeight</span> <span class=o>*</span> <span class=n>rightFadeStrength</span><span class=p>);</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>postRotate</span><span class=p>(</span><span class=mi>90</span><span class=p>);</span>
        <span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>right</span><span class=p>,</span> <span class=n>top</span><span class=p>);</span>
        <span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span>
        <span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span>
        <span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>right</span> <span class=o>-</span> <span class=n>length</span><span class=p>,</span> <span class=n>top</span><span class=p>,</span> <span class=n>right</span><span class=p>,</span> <span class=n>bottom</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>canvas</span><span class=p>.</span><span class=na>restoreToCount</span><span class=p>(</span><span class=n>saveCount</span><span class=p>);</span>

    <span class=c1>// Overlay is part of the content and draws beneath Foreground</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>mOverlay</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>mOverlay</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>mOverlay</span><span class=p>.</span><span class=na>getOverlayView</span><span class=p>().</span><span class=na>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Step 6, draw decorations (foreground, scrollbars)</span>
    <span class=n>onDrawForeground</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></p> <p>上面的代码比较长，但是注释非常清楚，View的绘制过程遵循以下6步：</p> <ol> <li>绘制背景 <code>drawBackground(canvas)</code> -&gt; <code>background.draw(canvas);</code></li> <li>如果必要，为滚动的fading效果保存图层</li> <li>绘制自己 <code>onDraw(canvas)</code></li> <li>绘制children <code>dispatchDraw(canvas)</code></li> <li>如果必要，绘制滚动的fading效果并恢复图层</li> <li>绘制装饰（比如foreground、scrollbars）<code>onDrawForeground(canvas)</code></li> </ol> <p>其中，如果View本身是透明的，则不需要绘制背景以及自身，所以跳过了1、3两步；其次，如果View本身不处于滑动状态，则不需要绘制滑动状态的fading效果，所以跳过2、5两步。</p> <p><code>onDraw</code>方法在View是一个空实现，供具体的View来实现draw效果；ViewGroup也更加不会实现该方法，但具体ViewGroup子类会根据自身需要进行重写该方法（比如LinearLayout）。<br> <code>dispatchDraw</code>方法在View内部也是一个空实现，因为其没有children，ViewGroup会重写该方法，ViewGroup子类不会重写该方法。</p> <p><strong>注意：View有一个特殊的方法</strong><code>setWillNotDraw</code>。<strong>如果View不需要绘制任何内容，那么可以设置这个标记为true，系统会进行相应的优化。默认情况下，View没有开启这个标记位，而ViewGroup会默认开启。</strong> 所以，当我们的自定义控件继承至ViewGroup并且本身需要通过<code>onDraw</code>来绘制内容时，需要关闭WILL_NOT_DRAW标记位。 <div class=codehilite><pre><span></span><span class=cm>/**</span>
<span class=cm> * If this view doesn&#39;t do any drawing on its own, set this flag to</span>
<span class=cm> * allow further optimizations. By default, this flag is not set on</span>
<span class=cm> * View, but could be set on some View subclasses such as ViewGroup.</span>
<span class=cm> *</span>
<span class=cm> * Typically, if you override {@link #onDraw(android.graphics.Canvas)}</span>
<span class=cm> * you should clear this flag.</span>
<span class=cm> *</span>
<span class=cm> * @param willNotDraw whether or not this View draw on its own</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setWillNotDraw</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>willNotDraw</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>setFlags</span><span class=p>(</span><span class=n>willNotDraw</span> <span class=o>?</span> <span class=n>WILL_NOT_DRAW</span> <span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=n>DRAW_MASK</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></p> <h2 id=4-view>4 如何让View刷新<a class=headerlink href=#4-view title="Permanent link">&para;</a></h2> <p>View重绘和更新可以使用<code>invalidate()</code>和<code>requestLayout()</code>方法，其主要区别如下：</p> <ul> <li><code>invalidate()</code>方法只会执行onDraw方法</li> <li><code>requestLayout()</code>只会执行onMeasure方法和onLayout方法，并不会执行onDraw方法</li> </ul> <p>所以当我们进行View更新时，若仅View的显示内容发生改变且新显示内容不影响View的大小、位置，则只需调用<code>invalidate()</code>方法；若View宽高、位置发生改变且显示内容不变，只需调用<code>requestLayout()</code>方法；若两者均发生改变，则需调用两者，按照View的绘制流程，推荐先调用<code>requestLayout()</code>方法再调用<code>invalidate()</code>方法。</p> <p>与<code>invalidate()</code>方法类似的还有一个<code>postInvalidate()</code>，两者作用都是刷新View，区别在于：</p> <ul> <li><code>invalidate</code>方法用于UI线程中重新刷新View</li> <li><code>postInvalidate</code>方法用于非UI线程中重新刷新View，这里借助了<code>ViewRootHandler</code>来达成目的 </li> </ul> <p><code>ViewRootHandler</code>看着比较陌生，其实我们经常接触到。比如我们调用<code>View.post(Runnable)</code>方法，处理Runnable的就是这个<code>ViewRootHandler</code>了。详细可以参考<a href=/android/framework/Android消息机制/#3>Android消息机制——主线程的消息循环</a>中的第二个问题。</p> <h2 id=5-view>5 自定义View<a class=headerlink href=#5-view title="Permanent link">&para;</a></h2> <h3 id=51-view>5.1 自定义View的分类<a class=headerlink href=#51-view title="Permanent link">&para;</a></h3> <p>自定义View大致可以分为四类：</p> <ol> <li>继承View重写onDraw方法<br> 此方法主要用于实现一些不方便通过组合控件的方式来实现的不规则的效果。很显然，这只能通过<code>onDraw</code>绘制实现。<strong>采用这种方式需要支持wrap_content，且padding也需要处理。</strong></li> <li>继承ViewGroup重写onMeasure、onLayout<br> 这种方式主要实现组合控件的自定义布局。<strong>需要合适的处理ViewGroup的测量、布局这两个过程，并同时处理子元素的测量和布局。</strong></li> <li>继承特定的View<br> 此方法一般用于拓展某种已有的View功能，不需要自己支持wrap_content以及padding。</li> <li>继承特定的ViewGroup<br> 一般用来实现组合控件。采用这种方式不需要自己处理测量和布局两个过程。</li> </ol> <h3 id=52-view>5.2 自定义View注意事项<a class=headerlink href=#52-view title="Permanent link">&para;</a></h3> <ol> <li>让View支持wrap_content<br> 直接继承View或ViewGroup的控件，如果不在<code>onMeasure</code>对wrap_content特殊处理，那么wrap_content无法正常使用。</li> <li>如有必要，让View支持padding<br> 直接继承View的控件，如果不在draw方法中处理paidding，那么padding属性无法起作用。直接继承ViewGroup的控件需要在<code>onMeasure</code>和<code>onLayout</code>中考虑自身的padding和子元素的margin，不然导致失效。</li> <li>如要需要在View中使用Handler，用<code>post(Runnable)</code>方法代替 </li> <li>View中如果有线程或者动画，需要在适当的时候停止<br> 如果有线程或者动画需要停止时，可以在<code>onDetachedFromWindow</code>中停止。当包含View的Activity退出或者当前View被remove时，View的此方法会回调。与此方法对应的是<code>onAttachedFromWindow</code>。当包含此View的Activity启动时会回调。同时，当View变得不可见时，我们也需要停止，否则有可能会造成内存泄露。</li> </ol> <hr> <div class=md-source-date> <small> 最后更新: 2020年1月14日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/framework/View的绘制原理/";
      this.page.identifier =
        "/android/framework/View的绘制原理/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../View的事件体系/ title=View的事件体系 class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> View的事件体系 </span> </div> </a> <a href=../RemoteViews/ title=RemoteViews class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> RemoteViews </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>